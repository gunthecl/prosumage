GAMS 24.2.1  r43572 Released Dec  9, 2013 WEX-WEI x86_64/MS Windows 10/22/18 14:44:43 Page 1
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


   1   
   2  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2018.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
  12  **************************************************************************
      ******
  13   
  14   
  15   
  16   
  17  **************************
  18  ***** GLOBAL OPTIONS *****
  19  **************************
  20   
  21  * Set star to skip Excel upload and load data from gdx
  23   
  24  * Choose base year
  26   
  27  * Germany only - also adjust Excel inputs!
  29   
  30  * Set star to activate options
  32   
  35   
  37   
  39   
  42  * Set star to indicate renewables constraint on electric vehicles - DEFAUL
      T is same quota as for the rest of the electricity system
  46   
  47  * Set star to select run-of-river options either as exogenous parameter or
       as endogenous variable including reserve provision:
  48  * if nothing is selected, ROR capacity will be set to zero
  49  * if parameter option is selected, set appropriate values in fix.gmx
  50  * if variable option is selected, set appropriate bound in data_input exce
      l
  53   
  54  * Set star to determine loops, otherwise default 100% renewables
  56   
  57  * Set star for no crossover to speed up calculation time by skipping cross
      over in LP solver
  59   
  60  * Set star for reporting to Excel
  62   
  63   
  64  **************************************************************************
      ******
  65   
  66  * Definition of strings for report parameters and sanity checks
  67  * (Do not change settings below)
  69   
  71   
  72  * Sanity checks
  74   
  76   
  78   
  82   
  86   
  87   
  88   
  89   
  90  **************************************************************************
      ******
  91   
  92  ****************************
  93  ***** INITIALIZE LOOPS *****
  94  ****************************
  95   
  96  sets
  97  *$ontext
  98  loop_res_share   Solution loop for different shares of renewables       /1
      0/
 101   
      loop_ev          Solution loop for different fleets of EVs              /4
      e+6/
      $ontext
 106   
      loop_prosumage   Solution loop for different prosumer self-consumption lev
      els    /50/
      $ontext
 111   
 112  *      loop_res_share                          /100/
 113                               loop_ev                                 /0/
 114                        loop_prosumage                          /0/
 115  ;
 116   
 117   
 118   
 119   
 120  **************************************************************************
      ******
 121   
 122  **************************
 123  ***** SOLVER OPTIONS *****
 124  **************************
 125   
 126  options
 127  optcr = 0.00
 128  reslim = 10000000
 129  lp = cplex
 130  mip = cplex
 131  nlp = conopt
 132  limrow = 0
 133  limcol = 0
 134  ;
 135   
 136  options
 137  dispwidth = 15
 138  limrow = 0
 139  limcol = 0
 140  solprint = off
 141  sysout = off
 142  ;
 143   
 144   
 145   
 146   
 147  **************************************************************************
      ******
 148   
 149  **************************
 150  ***** Dataload *****
 151  **************************
 152   
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\dataload.gms
 154   
 155  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
 165  **************************************************************************
      ******
 166   
 167   
 168   
 169   
 170  ***************  SETS  ***************************************************
      ******
 171   
 172  ***** Sets used in the model *****
 173  Sets
 174  tech                     Generation technologies
 175   dis(tech)               Dispatchable generation technologies
 176   nondis(tech)            Nondispatchable generation technologies
 177   con(tech)               Conventional generation technologies
 178   res(tech)               Renewable generation technologies
 179  sto                      Storage technologies
 180  rsvr                     Reservoir technologies
 181  dsm                      DSM technologies
 182   dsm_shift(dsm)          DSM load shifting technologies
 183   dsm_curt(dsm)           DSM load curtailment technologies
 184  year                     Base year for temporal data
 185  h                        Hours
 186  n                        Nodes
 187  l                        Lines
 188  ev                       EV types
 189  reserves                         Reserve qualities
 190   reserves_up(reserves)           Positive reserves
 191   reserves_do(reserves)           Negative reserves
 192   reserves_spin(reserves)         Spinning reserves
 193   reserves_nonspin(reserves)      Nonspinning reserves
 194   reserves_prim(reserves)         Primary reserves
 195   reserves_nonprim(reserves)      Nonprimary reserves
 196   reserves_prim_up(reserves)      Primary positive reserves
 197   reserves_nonprim_up(reserves)   Nonprimary positive reserves
 198   reserves_prim_do(reserves)      Primary negative reserves
 199   reserves_nonprim_do(reserves)   Nonprimary negative reserves
 200  bu                       Building archtypes
 201  ch                       Heating combination type
 202   hst(ch)                 Heating technology that feeds to storage
 203   hp(ch)                  Heat pump technologies
 204   hel(ch)                 Hybrid electric heating technologies - electric p
      art
 205   hfo(ch)                 Hybrid electric heating technologies - fossil par
      t
 206   
 207   
 208  ***** Sets used for data upload *****
 209  headers_tech                     Generation technologies - upload headers
 210   tech_dispatch                   Generation technologies - dispatchable or
       nondispatchable
 211   tech_res_con                    Generation technologies - renewable or "c
      onventional"
 212  headers_sto                      Storage technologies - upload headers
 213  headers_reservoir                Reservoir technologies - upload headers
 214  headers_dsm                      DSM technologies - upload headers
 215   dsm_type                        DSM technologies - shifting or curtailmen
      t
 216  headers_time                     Temporal data - upload headers
 217  headers_topology                 Spatial data - upload headers
 218  headers_ev                       EV data - upload headers
 219  headers_time_ev                  EV temporal data - upload headers
 220  headers_prosumage_generation     Prosumage generation data - upload header
      s
 221  headers_prosumage_storage        Prosumage storage data - upload headers
 222  headers_reserves                 Reserve data - upload headers
 223   reserves_up_down                Reserve data - positive and neagtive rese
      rves
 224   reserves_spin_nonspin           Reserve data - spinning and nonspinning r
      eserves
 225   reserves_prim_nonprim           Reserve data - primary and nonprimary res
      erves
 226  headers_heat                     Heat data - upload headers
 227   heat_storage                    Heat data - storage technologies
 228   heat_hp                         Heat data - heat pump technologies
 229   heat_elec                       Heat data - hybrid heating technologies -
       electric part
 230   heat_fossil                     Heat data - hybrid heating technologies -
       fossil part
 231  headers_time_heat                Heat data - upload headers time data
 232  headers_time_dhw                 Heat data - upload headers time data on D
      HW
 233  ;
 234   
 235   
 236   
 237   
 238  ***************  PARAMETERS  *********************************************
      ******
 239   
 240  Parameters
 241   
 242  ***** Generation technologies *****
 243  *--- Variable and fixed costs ---*
 244  eta              Efficiency of conventional technologies [0 1]
 245  carbon_content   CO2 emissions per fuel unit used [tons per MWh thermal]
 246  c_up             Load change costs UP [EUR per MWh]
 247  c_do             Load change costs DOWN [EUR per MWh]
 248  c_fix            Annual fixed costs [EUR per MW per year]
 249  c_vom            Variable O&M costs [EUR per MWh]
 250  CO2price         CO2 price in [EUR per ton]
 251   
 252  *--- Investment ---*
 253  c_inv_overnight  Investment costs: Overnight [EUR per MW]
 254  lifetime         Investment costs: technical lifetime [a]
 255  recovery         Investment costs: Recovery period according to depreciati
      on tables [a]
 256  interest_rate    Investment costs: Interest rate [%]
 257  m_p              Investment: maximum installable capacity per technology [
      MW]
 258  m_e              Investment: maximum installable energy [TWh per a]
 259   
 260  *--- Flexibility ---*
 261  grad_per_min     Maximum load change relative to installed capacity [% of 
      installed capacity per minute]
 262   
 263   
 264  ***** Fuel and CO2 costs *****
 265  fuelprice        Fuel price conventionals [EUR per MWh thermal]
 266   
 267   
 268  ***** Renewables *****
 269  c_cu             Hourly Curtailment costs for renewables [Euro per MW]
 270  phi_min_res      Minimum renewables share [0 1]
 271   
 272   
 273  ***** Storage *****
 274  *--- Variable and fixed costs ---*
 275  c_m_sto          Marginal costs of storing in or out [EUR per MWh]
 276  eta_sto          Storage efficiency [0 1]
 277  phi_sto_ini      Initial storage level [0 1]
 278  etop_max         Maximum E to P ratio of storage types [#]
 279  c_fix_sto        Annual fixed costs [EUR per MW]
 280   
 281  *--- Investment ---*
 282  c_inv_overnight_sto_e       Investment costs for storage energy: Overnight
       [EUR per MWh]
 283  c_inv_overnight_sto_p       Investment costs for storage capacity: Overnig
      ht [EUR per MW]
 284  m_sto_e                     Investment into storage: maximum installable e
      nergy [MWh]
 285  m_sto_p                     Investment into storage: maximum installable p
      ower [MW]
 286   
 287   
 288  ***** Reservoir*****
 289  *--- Variable and fixed costs ---*
 290  c_m_rsvr                 Marginal costs of generating energy from reservoi
      r [EUR per MWh]
 291  eta_rsvr                 Generation efficiency [0 1]
 292  phi_rsvr_ini             Initial reservoir level [0 1]
 293  c_fix_rsvr               Annual fixed costs [EUR per MW per a]
 294  phi_rsvr_min             Minimum hourly reservoir outflow as fraction of a
      nnual energy [0 1]
 295  phi_rsvr_lev_min         Minimum filling level [0 1]
 296   
 297  *--- Investment ---*
 298  c_inv_overnight_rsvr_e   Investment costs for reservoir energy: Overnight 
      [EUR per MWh]
 299  c_inv_overnight_rsvr_p   Investment costs for reservoir capacity: Overnigh
      t [EUR per MW]
 300  inv_lifetime_rsvr        Investment costs for reservoir: technical lifetim
      e [a]
 301  inv_interest_rsvr        Investment costs for reservoir: Interest rate [%]
 302  m_rsvr_e                 Investment into reservoir: maximum installable en
      ergy [MWh]
 303  m_rsvr_p                 Investment into reservoir: maximum installable ca
      pacity [MW]
 304   
 305   
 306  ***** DSM *****
 307  *--- Variable and fixed costs ---*
 308  c_m_dsm_cu       DSM: hourly costs of load curtailment [EUR per MWh]
 309  c_m_dsm_shift    DSM: costs for load shifting [EUR per MWh]
 310  c_fix_dsm_cu     Annual fixed costs load curtailment capacity [EUR per MW 
      per a]
 311  c_fix_dsm_shift  Annual fixed costs load shifting capacity [EUR per MW per
       a]
 312   
 313  *--- Flexibility, efficiency, recovery ---*
 314  t_dur_dsm_cu     DSM: Maximum duration load curtailment [h]
 315  t_off_dsm_cu     DSM: Minimum recovery time between two load curtailment i
      nstances [h]
 316   
 317  t_dur_dsm_shift  DSM: Maximum duration load shifting [h]
 318  t_off_dsm_shift  DSM: Minimum recovery time between two granular load upsh
      ift instances [h]
 319  eta_dsm_shift    DSM: Efficiency of load shifting technologies [0 1]
 320   
 321  *--- Investment ---*
 322  c_inv_overnight_dsm_cu           Investment costs for DSM load curtailment
      : Overnight [EUR per MW]
 323  c_inv_overnight_dsm_shift        Investment costs for DSM load shifting: O
      vernight [EUR per MW]
 324  inv_recovery_dsm_cu              Investment costs for DSM load curtailment
      : Recovery period [a]
 325  inv_recovery_dsm_shift           Investment costs for DSM load shifting: R
      ecovery period [a]
 326  inv_interest_dsm_cu              Investment costs for DSM load curtailment
      : Interest rate [%]
 327  inv_interest_dsm_shift           Investment costs for DSM load shifting: I
      nterest rate [%]
 328  m_dsm_cu                         DSM: Maximum installable capacity load cu
      rtailment [MW]
 329  m_dsm_shift                      DSM: Maximum installable capacity load sh
      ifting [MW]
 330   
 331   
 332  ***** Time Data *****
 333  d_y                      Demand hour h for different years [MWh]
 334  d                        Demand hour h [MWh]
 335  phi_res_y                Renewables availability technology res in hour h 
      for different years [0 1]
 336  phi_res                  Renewables availability technology res in hour h 
      [0 1]
 337  phi_ror_y                Run-of-river availability technology ror in hour 
      h for different years [0 1]
 338  phi_ror                  Run-of-river availability technology ror in hour 
      h [0 1]
 339  rsvr_in_y                Reservoir inflow in hour h for different years [0
       1]
 340  rsvr_in                  Reservoir inflow in hour h [0 1]
 341  n_ev_p_upload            Power rating of the charging connection in hour h
       [MW - 0 when car is in use or parked without grid connection]
 342  ev_ed_upload             Electricity demand for mobility vehicle profile e
      v in hour h [MW]
 343  ev_ged_exog_upload       Electricity demand for mobility in case of uncont
      rolled charging vehicle profile ev in hour h [MW]
 344  phi_reserves_call_y      Hourly share of reserve provision that is actuall
      y activated for different years [0 1]
 345  phi_reserves_call        Hourly share of reserve provision that is actuall
      y activated [0 1]
 346  reserves_exogenous_y     Hourly reserve provision for different years [MW]
 347  reserves_exogenous       Hourly reserve provision [MW]
 348   
 349  ***** Transmission *****
 350  *--- Investment ---*
 351  c_inv_overnight_ntc       Investment costs in: overnight [EUR per MW]
 352  c_fix_ntc                 Fixed costs [EUR per MW per a]
 353  inv_lifetime_ntc          Investment costs: technical lifetime [a]
 354  inv_recovery_ntc          Investment costs: Recovery period in [a]
 355  inv_interest_ntc          Investment costs: Interest rate [%]
 356  m_ntc                     Investment into NTC: maximum installable capacit
      y [MW]
 357   
 358  *--- Topology and distance ---*
 359  inc              Incidence index of link l on node n
 360  dist             Distance covered by link l [km]
 361   
 362   
 363  ***** Electric vehicles *****
 364  *--- Costs and attributes ---*
 365  c_m_ev           Marginal costs of discharging V2G [EUR per MWh]
 366  pen_phevfuel     Penalty for non-electric PHEV operation mode [EUR per MWh
      ]
 367  eta_ev_in        Electric vehicle efficiency of charging (G2V) [0 1]
 368  eta_ev_out       Electric vehicle efficiency of discharging (V2G) [0 1]
 369  phi_ev_ini       Electric vehicle charging level in initial period [0 1]
 370   
 371  n_ev_e           Electric vehicle battery capacity [MWh]
 372  ev_quant         Overall number of electirc vehicles [#]
 373  phi_ev           Share of electric vehicles per load profile in actual sce
      nario [0 1]
 374  ev_phev          Defines whether an electric vehicle is a PHEV REEV [1 if 
      yes 0 otherwise]
 375   
 376  *--- Temporal data ---*
 377  n_ev_p           Electric vehicle power rating [MWh]
 378  ev_ed            Electric vehicle electricity demand [MWh]
 379  ev_ged_exog      Electric vehicle grid electricity demand for exogenous ch
      arging pattern [MWh]
 380   
 381   
 382  ***** Prosumage *****
 383  phi_pro_load             Share of prosumagers among total load [0 1]
 384  phi_pro_self             Minimum self-generation shares for prosumagers [0
       1]
 385  m_res_pro                Maximum installable: renewables capacity [MW]
 386  m_sto_pro_e              Maximum installable: storage energy [MWh]
 387  m_sto_pro_p              Maximum installable: storage capacity [MW]
 388  phi_sto_pro_ini          Prosumagers' initial storage loading [0 1]
 389   
 390   
 391  ***** Reserves *****
 392  phi_reserves_share       Shares of SRL and MRL up and down [0 1]
 393  reserves_intercept       Intercept of regression line determining reserves
       demand
 394  reserves_slope           Slope of regression line determining reserves dem
      and
 395  reserves_reaction        Activation reaction time for reserves qualities [
      min]
 396  phi_reserves_pr_up       Positive primary reserves fraction of total nonpr
      imary reserves demand [0 1]
 397  phi_reserves_pr_do       Negative primary reserves fraction of total nonpr
      imary reserves demand [0 1]
 398  *reserves_exog
 399   
 400   
 401  ***** Heat *****
 402  *--- Time data ---*
 403  dh_upload                Hourly heat demand per year for upload [MWh per m
      2]
 404  dh_y                     Hourly heat demand per year [MWh per m2]
 405  dh                       Hourly heat demand [MWh per m2]
 406  temp_source              Heat pumps - source temperature [°Celsius]
 407  d_dhw_upload             Hourly DHW demand per year for upload [MWh per m2
      ]
 408  d_dhw_y                  Hourly DHW demand per year [MWh per m2]
 409  d_dhw                    Hourly DHW demand [MWh per m2]
 410  nets_profile(h)          Hourly exogenous heat demand by nonsmart night-ti
      me storage heaters [MWh per m2]
 411   
 412  *--- Technololgy attributes ---*
 413  phi_heat_type            Share of heating type ch per building archetype b
      u [0 1]
 414  eta_heat_stat            Static efficiency for heating technologies [0 1]
 415  eta_heat_dyn             Static efficiency for heating technologies [0 1]
 416  eta_dhw_aux_stat         Static efficiency for auxiliary DHW technologies 
      [0 1]
 417  n_heat_p_in              Maximum power inflow into heating technologies [M
      W]
 418  n_heat_p_out             Maximum power outflow from heating technologies [
      MW]
 419  n_heat_e                 Maximum energy level of heating storage technolog
      ies [MWh]
 420  n_sets_p_in              SETS - Power rating - electricity intake [MW]
 421  n_sets_p_out             SETS - Power rating - heat output [MW]
 422  n_sets_e                 SETS - Energy storage capacity [MWh]
 423  n_sets_dhw_p_in          SETS auxiliary DHW module - power rating - electr
      icity intake [MW]
 424  n_sets_dhw_p_out         SETS auxiliary DHW module - power rating - DHW ou
      tput [MW]
 425  n_sets_dhw_e             SETS auxiliary DHW module - energy storage capaci
      ty [MWh]
 426  phi_heat_ini             Inititial storage level of heating technologies [
      0 1]
 427  temp_sink                Heat pumps - sink temperature [°Celsius]
 428  pen_heat_fuel            Penalty term for non-electric fuel usage for hybr
      id heating technologies [EUR per MWh]
 429  area_floor               Floor area subject to specific heating technology
       in specific building type [m2]
 430  theta_night              Indicator for night hours {0 1}
 431   
 432   
 433   
 434  ***************  DERIVED PARAMETERS  *************************************
      ******
 435   
 436  c_m              Marginal production costs for conventional plants includi
      ng variable O and M costs [EUR per MWh]
 437  c_i              Annualized investment costs by conventioanl plant [EUR pe
      r MW]
 438   
 439  c_i_res          Annualized investment costs by renewable plant [EUR per M
      W]
 440  c_fix_res        Annualized fixed costs by renewable plant [EUR per MW per
       a]
 441   
 442  c_i_sto_e        Annualized investment costs storage energy [EUR per MWh]
 443  c_i_sto_p        Annualized investment costs storage capacity [EUR per MW]
 444   
 445  c_i_rsvr_e       Annualized investment costs storage energy [EUR per MWh]
 446  c_i_rsvr_p       Annualized investment costs storage capacity [EUR per MW]
 447   
 448  c_i_dsm_cu       DSM: Annualized investment costs load curtailment [EUR pe
      r MW]
 449  c_i_dsm_shift    DSM: Annualized investment costs load shifting [EUR per M
      W]
 450   
 451  c_i_ntc          Investment for net transfer capacity [EUR per MW and km]
 452   
 453  phi_mean_reserves_call_y         Hourly mean of share reserves called per 
      year [0 1]
 454  phi_mean_reserves_call           Hourly mean of share reserves called [0 1
      ]
 455   
 456  theta_dir        Dummy equal to 1 if building type bu has direct heating t
      ype ch [0 1]
 457  theta_sets       Dummy equal to 1 if building type bu has SETS heating typ
      e ch [0 1]
 458  theta_hp         Dummy equal to 1 if building type bu has heat pump heatin
      g type ch [0 1]
 459  theta_elec       Dummy equal to 1 if building type bu has hybrif electric 
      heating - electric part [0 1]
 460  theta_fossil     Dummy equal to 1 if building type bu has hybrif electric 
      heating - fossil part [0 1]
 461  theta_storage    Dummy equal to 1 if building type ch has storage heating 
      type ch [0 1]
 462   
 463   
 464   
 465   
 466  ***************  PARAMETERS FOR DATA UPLOAD  *****************************
      ******
 467   
 468  technology_data_upload(n,tech,tech_res_con,tech_dispatch,headers_tech)
 469  technology_data(n,tech,headers_tech)
 470  storage_data(n,sto,headers_sto)
 471  reservoir_data(n,rsvr,headers_reservoir)
 472  time_data_upload(h,n,year,headers_time)
 473  dsm_data_upload(n,dsm,dsm_type,headers_dsm)
 474  dsm_data(n,dsm,headers_dsm)
 475  topology_data(l,headers_topology)
 476  ev_data(n,ev,headers_ev)
 477  ev_time_data_upload(h,headers_time_ev,ev)
 478  prosumage_data_generation(n,tech,headers_prosumage_generation)
 479  prosumage_data_storage(n,sto,headers_prosumage_storage)
 480  reserves_time_data_activation(h,year,reserves)
 481  reserves_time_data_provision(h,year,reserves)
 482  reserves_data_upload(n,reserves,reserves_up_down,reserves_spin_nonspin,res
      erves_prim_nonprim,headers_reserves)
 483  reserves_data(n,reserves,headers_reserves)
 484  heat_data_upload(n,bu,ch,heat_storage,heat_hp,heat_elec,heat_fossil,header
      s_heat)
 485  heat_data(n,bu,ch,headers_heat)
 486  dh_upload(h,n,year,headers_time_heat,bu)
 487  d_dhw_upload(h,n,year,headers_time_heat,bu)
 488  temp_source_upload
 489  ;
 490   
 491   
 492   
 493   
 494  ***************  UPLOAD TIME-CONSTANT SETS AND PARAMETERS  ***************
      ******
 495   
 555   
 556  *$call "gdxxrw data_input.xlsx @temp.tmp o=Data_input maxdupeerrors=100";
 557   
GDXIN   C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Dieter_
        Module\Modified_MCP\Data_input.gdx
--- LOAD  n = 1:n
--- LOAD  tech = 2:tech
--- LOAD  headers_tech = 3:headers_tech
--- LOAD  tech_dispatch = 4:tech_dispatch
--- LOAD  tech_res_con = 5:tech_res_con
--- LOAD  sto = 6:sto
--- LOAD  headers_sto = 7:headers_sto
--- LOAD  rsvr = 8:rsvr
--- LOAD  headers_reservoir = 9:headers_reservoir
--- LOAD  reservoir_data = 33:reservoir_data
--- LOAD  dsm = 10:dsm
--- LOAD  headers_dsm = 11:headers_dsm
--- LOAD  dsm_type = 12:dsm_type
--- LOAD  technology_data_upload = 31:technology_data_upload
--- LOAD  storage_data = 32:storage_data
--- LOAD  dsm_data_upload = 34:dsm_data_upload
 562  *$load l headers_topology topology_data inc
 563  *$ontext
--- LOAD  l = 13:l
--- LOAD  headers_topology = 14:headers_topology
--- LOAD  topology_data = 35:topology_data
--- LOAD  ev = 15:ev
--- LOAD  headers_ev = 16:headers_ev
--- LOAD  ev_data = 36:ev_data
--- LOAD  headers_prosumage_generation = 17:headers_prosumage_generation
--- LOAD  headers_prosumage_storage = 18:headers_prosumage_storage
--- LOAD  prosumage_data_generation = 37:prosumage_data_generation
--- LOAD  prosumage_data_storage = 38:prosumage_data_storage
--- LOAD  reserves = 19:reserves
--- LOAD  reserves_up_down = 21:reserves_up_down
--- LOAD  reserves_spin_nonspin = 22:reserves_spin_nonspin
--- LOAD  reserves_prim_nonprim = 23:reserves_prim_nonprim
--- LOAD  headers_reserves = 20:headers_reserves
--- LOAD  reserves_data_upload = 39:reserves_data_upload
--- LOAD  bu = 24:bu
--- LOAD  ch = 25:ch
--- LOAD  heat_storage = 26:heat_storage
--- LOAD  heat_hp = 27:heat_hp
--- LOAD  heat_elec = 28:heat_elec
--- LOAD  heat_fossil = 29:heat_fossil
--- LOAD  headers_heat = 30:headers_heat
--- LOAD  heat_data_upload = 40:heat_data_upload
 571  ;
 572   
 573  *$ontext
 574  parameter inc ;
 575  inc(l,n) = 1 ;
 578   
 579   
 580  ***************  UPLOAD TIME-SERIES SETS AND PARAMETERS  *****************
      ******
 581   
 607   
 608  *$call "gdxxrw time_series.xlsx @temp2.tmp o=time_series";
 609   
GDXIN   C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Dieter_
        Module\Modified_MCP\time_series.gdx
--- LOAD  h = 1:h
--- LOAD  headers_time = 2:headers_time
--- LOAD  year = 3:year
--- LOAD  time_data_upload = 4:time_data_upload
--- LOAD  headers_time_ev = 5:headers_time_ev
--- LOAD  ev_time_data_upload = 6:ev_time_data_upload
--- LOAD  reserves_time_data_activation = 7:reserves_time_data_activation
--- LOAD  reserves_time_data_provision = 8:reserves_time_data_provision
--- LOAD  headers_time_heat = 9:headers_time_heat
--- LOAD  dh_upload = 10:dh_upload
--- LOAD  theta_night = 11:theta_night
--- LOAD  temp_source_upload = 15:temp_source_upload
--- LOAD  headers_time_dhw = 12:headers_time_dhw
--- LOAD  d_dhw_upload = 13:d_dhw_upload
--- LOAD  nets_profile = 14:nets_profile
 619  ;
 620   
 621   
 622   
 623   
 624  ***************  ASSIGNMENTS  ********************************************
      ******
 625   
 626   
 627   
 628  ***** Aliases *****
 629  alias (h,hh) ;
 630  alias (res,resres) ;
 631  alias (reserves,reservesreserves) ;
 632  alias (nondis,nondisnondis) ;
 633   
 634   
 635   
 636  ***** Derived sets *****
 637  dis(tech)$sum( (n,tech_res_con,headers_tech), technology_data_upload(n,tec
      h,tech_res_con,'dis',headers_tech)) = yes;
 638  nondis(tech)$sum( (n,tech_res_con,headers_tech), technology_data_upload(n,
      tech,tech_res_con,'nondis',headers_tech)) = yes;
 639   
 640  con(tech)$sum( (n,tech_dispatch,headers_tech), technology_data_upload(n,te
      ch,'con',tech_dispatch,headers_tech)) = yes;
 641  res(tech)$sum( (n,tech_dispatch,headers_tech), technology_data_upload(n,te
      ch,'res',tech_dispatch,headers_tech)) = yes;
 642   
 643  reserves_up(reserves)$sum( (n,reserves_spin_nonspin,reserves_prim_nonprim,
      headers_reserves), reserves_data_upload(n,reserves,'up',reserves_spin_nons
      pin,reserves_prim_nonprim,headers_reserves)) = yes;
 644  reserves_do(reserves)$sum( (n,reserves_spin_nonspin,reserves_prim_nonprim,
      headers_reserves), reserves_data_upload(n,reserves,'do',reserves_spin_nons
      pin,reserves_prim_nonprim,headers_reserves)) = yes;
 645   
 646  reserves_spin(reserves)$sum( (n,reserves_up_down,reserves_prim_nonprim,hea
      ders_reserves), reserves_data_upload(n,reserves,reserves_up_down,'spin',re
      serves_prim_nonprim,headers_reserves)) = yes;
 647  reserves_nonspin(reserves)$sum( (n,reserves_up_down,reserves_prim_nonprim,
      headers_reserves), reserves_data_upload(n,reserves,reserves_up_down,'nonsp
      in',reserves_prim_nonprim,headers_reserves)) = yes;
 648   
 649  reserves_prim(reserves)$sum( (n,reserves_up_down,reserves_spin_nonspin,hea
      ders_reserves), reserves_data_upload(n,reserves,reserves_up_down,reserves_
      spin_nonspin,'prim',headers_reserves)) = yes;
 650  reserves_nonprim(reserves)$sum( (n,reserves_up_down,reserves_spin_nonspin,
      headers_reserves), reserves_data_upload(n,reserves,reserves_up_down,reserv
      es_spin_nonspin,'nonprim',headers_reserves)) = yes;
 651   
 652  reserves_prim_up(reserves)$sum( (n,reserves_spin_nonspin,headers_reserves)
      , reserves_data_upload(n,reserves,'up',reserves_spin_nonspin,'prim',header
      s_reserves)) = yes;
 653  reserves_prim_do(reserves)$sum( (n,reserves_spin_nonspin,headers_reserves)
      , reserves_data_upload(n,reserves,'do',reserves_spin_nonspin,'prim',header
      s_reserves)) = yes;
 654  reserves_nonprim_up(reserves)$sum( (n,reserves_spin_nonspin,headers_reserv
      es), reserves_data_upload(n,reserves,'up',reserves_spin_nonspin,'nonprim',
      headers_reserves)) = yes;
 655  reserves_nonprim_do(reserves)$sum( (n,reserves_spin_nonspin,headers_reserv
      es), reserves_data_upload(n,reserves,'do',reserves_spin_nonspin,'nonprim',
      headers_reserves)) = yes;
 656   
 657  hst(ch)$sum( (n,bu,heat_hp,heat_elec,heat_fossil,headers_heat), heat_data_
      upload(n,bu,ch,'yes',heat_hp,heat_elec,heat_fossil,headers_heat)) = yes;
 658  hp(ch)$sum( (n,bu,heat_storage,heat_elec,heat_fossil,headers_heat), heat_d
      ata_upload(n,bu,ch,heat_storage,'yes',heat_elec,heat_fossil,headers_heat))
       = yes;
 659   
 660  hel(ch)$sum( (n,bu,heat_storage,heat_hp,heat_fossil,headers_heat), heat_da
      ta_upload(n,bu,ch,heat_storage,heat_hp,'yes',heat_fossil,headers_heat)) = 
      yes;
 661  hfo(ch)$sum( (n,bu,heat_storage,heat_hp,heat_elec,headers_heat), heat_data
      _upload(n,bu,ch,heat_storage,heat_hp,heat_elec,'yes',headers_heat)) = yes;
 662   
 663   
 664   
 665   
 666  ***** Parameters *****
 667   
 668  *--- Generation technologies ---*
 669  technology_data(n,tech,headers_tech) = sum((tech_res_con,tech_dispatch), t
      echnology_data_upload(n,tech,tech_res_con,tech_dispatch,headers_tech)) ;
 670  eta(n,tech) = technology_data(n,tech,'eta_con') ;
 671  carbon_content(n,tech) = technology_data(n,tech,'carbon_content') ;
 672  c_up(n,dis) =technology_data(n,dis,'load change costs up') ;
 673  c_do(n,dis) = technology_data(n,dis,'load change costs down') ;
 674  c_fix(n,tech) = technology_data(n,tech,'fixed_costs') ;
 675  c_vom(n,tech) = technology_data(n,tech,'variable_om') ;
 676  CO2price(n,tech) = technology_data(n,tech,'CO2_price') ;
 677   
 678  c_inv_overnight(n,tech) = technology_data(n,tech,'oc') ;
 679  lifetime(n,tech) = technology_data(n,tech,'lifetime') ;
 680  recovery(n,tech) = technology_data(n,tech,'recovery_period') ;
 681  interest_rate(n,tech) = technology_data(n,tech,'interest_rate') ;
 682  m_p(n,tech) = technology_data(n,tech,'max_installable') ;
 683  m_e(n,tech) = technology_data(n,tech,'max_energy') ;
 684  grad_per_min(n,dis) = technology_data(n,dis,'load change flexibility') ;
 685  fuelprice(n,tech) = technology_data(n,tech,'fuel costs') ;
 686   
 687  c_cu(n,res) = technology_data(n,res,'curtailment_costs') ;
 688   
 689   
 690  *--- Storage technologies ---*
 691  c_m_sto(n,sto) = storage_data(n,sto,'mc');
 692  eta_sto(n,sto) = storage_data(n,sto,'efficiency');
 693  c_fix_sto(n,sto) = storage_data(n,sto,'fixed_costs');
 694  phi_sto_ini(n,sto) = storage_data(n,sto,'level_start');
 695  etop_max(n,sto) = storage_data(n,sto,'etop_max') ;
 696   
 697  c_inv_overnight_sto_e(n,sto) = storage_data(n,sto,'oc_energy');
 698  c_inv_overnight_sto_p(n,sto) = storage_data(n,sto,'oc_capacity');
 699  lifetime(n,sto) = storage_data(n,sto,'lifetime');
 700  interest_rate(n,sto) = storage_data(n,sto,'interest_rate');
 701  m_sto_e(n,sto) = storage_data(n,sto,'max_energy');
 702  m_sto_p(n,sto) = storage_data(n,sto,'max_power');
 703   
 704   
 705  *--- Reservoir technologies ---*
 706  c_m_rsvr(n,rsvr) = reservoir_data(n,rsvr,'mc');
 707  eta_rsvr(n,rsvr) = reservoir_data(n,rsvr,'efficiency');
 708  c_fix_rsvr(n,rsvr) = reservoir_data(n,rsvr,'fixed_costs');
 709  phi_rsvr_ini(n,rsvr) = reservoir_data(n,rsvr,'level_start');
 710  phi_rsvr_lev_min(n,rsvr) = reservoir_data(n,rsvr,'level_min');
 711   
 712  c_inv_overnight_rsvr_e(n,rsvr) = reservoir_data(n,rsvr,'oc_energy');
 713  c_inv_overnight_rsvr_p(n,rsvr) = reservoir_data(n,rsvr,'oc_capacity');
 714  inv_lifetime_rsvr(n,rsvr) = reservoir_data(n,rsvr,'lifetime');
 715  inv_interest_rsvr(n,rsvr) = reservoir_data(n,rsvr,'interest_rate');
 716  m_rsvr_e(n,rsvr) = reservoir_data(n,rsvr,'max_energy');
 717  m_rsvr_p(n,rsvr) = reservoir_data(n,rsvr,'max_power');
 718   
 719   
 720  *--- DSM technologies ---*
 721  dsm_curt(dsm)$sum( (n,dsm_type,headers_dsm), dsm_data_upload(n,dsm,'curt',
      headers_dsm)) = yes;
 722  dsm_shift(dsm)$sum( (n,dsm_type,headers_dsm), dsm_data_upload(n,dsm,'shift
      ',headers_dsm)) = yes;
 723  dsm_data(n,dsm,headers_dsm) = sum(dsm_type, dsm_data_upload(n,dsm,dsm_type
      ,headers_dsm) ) ;
 724   
 725  c_m_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'mc')     ;
 726  c_m_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'mc')  ;
 727  c_fix_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'fc')  ;
 728  c_fix_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'fc') ;
 729   
 730  t_dur_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'max_duration')   ;
 731  t_off_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'recovery_time')   ;
 732  t_dur_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'max_duration')   ;
 733  t_off_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'recovery_time')   ;
 734  eta_dsm_shift(n,dsm_shift)  = dsm_data(n,dsm_shift,'efficiency')   ;
 735   
 736  c_inv_overnight_dsm_cu(n,dsm_curt) =  dsm_data(n,dsm_curt,'oc')   ;
 737  c_inv_overnight_dsm_shift(n,dsm_shift)  =  dsm_data(n,dsm_shift,'oc')   ;
 738  inv_recovery_dsm_cu(n,dsm_curt)  =  dsm_data(n,dsm_curt,'lifetime')   ;
 739  inv_recovery_dsm_shift(n,dsm_shift)   =  dsm_data(n,dsm_shift,'lifetime') 
        ;
 740  inv_interest_dsm_cu(n,dsm_curt)   =  dsm_data(n,dsm_curt,'interest_rate') 
        ;
 741  inv_interest_dsm_shift(n,dsm_shift)  =  dsm_data(n,dsm_shift,'interest_rat
      e')   ;
 742  m_dsm_cu(n,dsm_curt) =  dsm_data(n,dsm_curt,'max_installable')   ;
 743  m_dsm_shift(n,dsm_shift) =  dsm_data(n,dsm_shift,'max_installable')   ;
 744   
 745   
 746  *--- Temporal data ---*
 747  d_y(n,year,h) = time_data_upload(h,n,year,'demand')  ;
 748  phi_res_y(n,year,res,h) = sum(headers_time$(sameas(res,headers_time)), tim
      e_data_upload(h,n,year,headers_time));
 749  rsvr_in_y(n,year,rsvr,h) = sum(headers_time$(sameas(rsvr,headers_time)), t
      ime_data_upload(h,n,year,headers_time));
 750  phi_reserves_call_y(n,year,reserves,h) = reserves_time_data_activation(h,y
      ear,reserves) ;
 751  reserves_exogenous_y(n,year,reserves,h) = reserves_time_data_provision(h,y
      ear,reserves) ;
 752   
 753   
 754  *--- Spatial data ---*
 755  inv_lifetime_ntc(l) = topology_data(l,'lifetime') ;
 756  inv_recovery_ntc(l) = topology_data(l,'recovery_period') ;
 757  inv_interest_ntc(l) = topology_data(l,'interest_rate') ;
 758  c_inv_overnight_ntc(l) = topology_data(l,'overnight_costs') ;
 759  c_fix_ntc(l) = topology_data(l,'fixed_costs') ;
 760  m_ntc(l) = topology_data(l,'max_installable') ;
 761  dist(l) = topology_data(l,'distance') ;
 762   
 763   
 764  *--- Electric vehicles ---*
 765  c_m_ev(n,ev) = ev_data(n,ev,'mc') ;
 766  pen_phevfuel(n,ev) = ev_data(n,ev,'penalty_fuel') ;
 767  eta_ev_in(n,ev) = ev_data(n,ev,'efficiency_charge') ;
 768  eta_ev_out(n,ev) = ev_data(n,ev,'efficiency_discharge') ;
 769  phi_ev_ini(n,ev) = ev_data(n,ev,'ev_start') ;
 770   
 771  n_ev_e(n,ev) = ev_data(n,ev,'ev_capacity') ;
 772  phi_ev(n,ev) = ev_data(n,ev,'share_ev') ;
 773  ev_phev(n,ev) = ev_data(n,ev,'ev_type') ;
 774   
 775  n_ev_p(n,ev,h) = ev_time_data_upload(h,'n_ev_p',ev) ;
 776  ev_ed(n,ev,h) = ev_time_data_upload(h,'ev_ed',ev) ;
 777  ev_ged_exog(n,ev,h) = ev_time_data_upload(h,'ev_ged_exog',ev) ;
 778   
 779   
 780  *--- Prosumage ---*
 781  m_res_pro(n,res) = prosumage_data_generation(n,res,'max_power') ;
 782  m_sto_pro_e(n,sto) = prosumage_data_storage(n,sto,'max_energy') ;
 783  m_sto_pro_p(n,sto) = prosumage_data_storage(n,sto,'max_power') ;
 784  phi_sto_pro_ini(n,sto) = prosumage_data_storage(n,sto,'level_start') ;
 785   
 786   
 787  *--- Reserves ---*
 788  reserves_data(n,reserves,headers_reserves) = sum((reserves_up_down,reserve
      s_spin_nonspin,reserves_prim_nonprim), reserves_data_upload(n,reserves,res
      erves_up_down,reserves_spin_nonspin,reserves_prim_nonprim,headers_reserves
      )) ;
 789  phi_reserves_share(n,reserves) = reserves_data(n,reserves,'share_sr_mr') ;
 790  reserves_intercept(n,reserves) = reserves_data(n,reserves,'intercept') ;
 791  reserves_slope(n,reserves,'wind_on') = reserves_data(n,reserves,'slope_win
      d_on') ;
 792  reserves_slope(n,reserves,'wind_off') = reserves_data(n,reserves,'slope_wi
      nd_off') ;
 793  reserves_slope(n,reserves,'pv') = reserves_data(n,reserves,'slope_pv') ;
 794  reserves_reaction(n,reserves) = reserves_data(n,reserves,'reaction_time') 
      ;
 795  phi_reserves_pr_up(n) = reserves_data(n,'PR_up','fraction_pr') ;
 796  phi_reserves_pr_do(n) = reserves_data(n,'PR_do','fraction_pr') ;
 797   
 798   
 799  *--- Heat ---*
 800  heat_data(n,bu,ch,headers_heat) = sum((heat_storage,heat_hp,heat_elec,heat
      _fossil), heat_data_upload(n,bu,ch,heat_storage,heat_hp,heat_elec,heat_fos
      sil,headers_heat)) ;
 801  phi_heat_type(n,bu,ch) = heat_data(n,bu,ch,'share') ;
 802  dh_y(n,year,bu,ch,h) = phi_heat_type(n,bu,ch) * dh_upload(h,n,year,'demand
      ',bu) ;
 803  d_dhw_y(n,year,bu,ch,h) = phi_heat_type(n,bu,ch) * d_dhw_upload(h,n,year,'
      demand',bu) ;
 804   
 805  eta_heat_stat(n,bu,ch) = heat_data(n,bu,ch,'static_efficiency') ;
 806  eta_heat_dyn(n,bu,ch) = heat_data(n,bu,ch,'dynamic_efficiency') ;
 807  eta_dhw_aux_stat(n,bu,ch) = heat_data(n,bu,ch,'static_efficiency_sets_aux_
      dhw') ;
 808  * currently not used
 809  n_heat_p_in(n,bu,ch) = heat_data(n,bu,ch,'max_power') ;
 810  n_heat_p_out(n,bu,ch) = heat_data(n,bu,ch,'max_outflow') ;
 811  n_heat_e(n,bu,ch) = heat_data(n,bu,ch,'max_level') ;
 812  n_sets_p_in(n,bu,ch) = heat_data(n,bu,ch,'max_power') ;
 813  n_sets_p_out(n,bu,ch) = heat_data(n,bu,ch,'max_outflow') ;
 814  n_sets_e(n,bu,ch) = heat_data(n,bu,ch,'max_level') ;
 815  n_sets_dhw_p_in(n,bu,ch) = heat_data(n,bu,ch,'max_power_in_sets_aux_dhw') 
      ;
 816  n_sets_dhw_p_out(n,bu,ch) = heat_data(n,bu,ch,'max_power_out_sets_aux_dhw'
      ) ;
 817  n_sets_dhw_e(n,bu,ch) = heat_data(n,bu,ch,'max_energy_sets_aux_dhw') ;
 818  phi_heat_ini(n,bu,ch) = heat_data(n,bu,ch,'level_ini') ;
 819  temp_sink(n,bu,ch) = heat_data(n,bu,ch,'temperature_sink') ;
 820   
 821  temp_source(n,bu,'hp_as',h) = temp_source_upload(h,n,'hp_as') ;
 822  temp_source(n,bu,'hp_gs',h) = heat_data(n,bu,'hp_gs','temperature_source')
       ;
 823   
 824  temp_source(n,bu,'gas_hp_gs',h) = heat_data(n,bu,'gas_hp_gs','temperature_
      source') ;
 825  temp_source(n,bu,'hp_gs_elec',h) = heat_data(n,bu,'hp_gs_elec','temperatur
      e_source') ;
 826   
 827  pen_heat_fuel(n,bu,ch) = heat_data(n,bu,ch,'penalty_non-electric_heat_supp
      ly') ;
 828   
 829  area_floor(n,bu,ch) = heat_data(n,bu,ch,'area_floor') ;
 830   
 831   
 832   
 833  ***************  CALCULATE DERIVED PARAMETERS  ***************************
      ******
 834   
 835  c_m(n,tech) = fuelprice(n,tech)/eta(n,tech) + carbon_content(n,tech)/eta(n
      ,tech)*CO2price(n,tech) + c_vom(n,tech)   ;
 836   
 837  c_i(n,tech) = c_inv_overnight(n,tech)*( interest_rate(n,tech) * (1+interes
      t_rate(n,tech))**(lifetime(n,tech)) )
 838                    / ( (1+interest_rate(n,tech))**(lifetime(n,tech))-1 )   
          ;
 839   
 840  c_i_res(n,res) = c_i(n,res) ;
 841  c_fix_res(n,res) = c_fix(n,res) ;
 842   
 843  c_i_sto_e(n,sto) = c_inv_overnight_sto_e(n,sto)*( interest_rate(n,sto) * (
      1+interest_rate(n,sto))**(lifetime(n,sto)) )
 844                   / ( (1+interest_rate(n,sto))**(lifetime(n,sto))-1 )      
       ;
 845   
 846  c_i_sto_p(n,sto) = c_inv_overnight_sto_p(n,sto)*( interest_rate(n,sto) * (
      1+interest_rate(n,sto))**(lifetime(n,sto)) )
 847                   / ( (1+interest_rate(n,sto))**(lifetime(n,sto))-1 )      
       ;
 848   
 849  c_i_rsvr_e(n,rsvr) = c_inv_overnight_rsvr_e(n,rsvr)*( inv_interest_rsvr(n,
      rsvr) * (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,rsvr)) )
 850                   / ( (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,r
      svr))-1 )       ;
 851   
 852  c_i_rsvr_p(n,rsvr) = c_inv_overnight_rsvr_p(n,rsvr)*( inv_interest_rsvr(n,
      rsvr) * (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,rsvr)) )
 853                   / ( (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,r
      svr))-1 )       ;
 854   
 855  c_i_dsm_cu(n,dsm_curt) =c_inv_overnight_dsm_cu(n,dsm_curt)*( inv_interest_
      dsm_cu(n,dsm_curt) * (1+inv_interest_dsm_cu(n,dsm_curt))**(inv_recovery_ds
      m_cu(n,dsm_curt)) )
 856                   / ( (1+inv_interest_dsm_cu(n,dsm_curt))**(inv_recovery_ds
      m_cu(n,dsm_curt))-1 )       ;
 857   
 858  c_i_dsm_shift(n,dsm_shift) = c_inv_overnight_dsm_shift(n,dsm_shift)*( inv_
      interest_dsm_shift(n,dsm_shift) * (1+inv_interest_dsm_shift(n,dsm_shift))*
      *(inv_recovery_dsm_shift(n,dsm_shift)) )
 859                   / ( (1+inv_interest_dsm_shift(n,dsm_shift))**(inv_recover
      y_dsm_shift(n,dsm_shift))-1 )       ;
 860   
 861  c_i_ntc(l) = c_inv_overnight_ntc(l) * (inv_interest_ntc(l) * (1 + inv_inte
      rest_ntc(l))**(inv_lifetime_ntc(l)) )
 862                   / ((1 + inv_interest_ntc(l)) ** (inv_lifetime_ntc(l))-1 )
       ;
 863   
 864  phi_mean_reserves_call_y(n,year,reserves) = sum(h, phi_reserves_call_y(n,y
      ear,reserves,h) ) / card(h) + eps ;
 865   
 866   
 867  theta_sets(n,bu,'setsh')$(smax( (heat_storage,heat_hp,heat_elec,heat_fossi
      l,headers_heat) , heat_data_upload(n,bu,'setsh',heat_storage,heat_hp,heat_
      elec,heat_fossil,headers_heat)) > 0 AND phi_heat_type(n,bu,'setsh')) = 1;
 868  theta_dir(n,bu,'dir')$(smax((heat_storage,heat_hp,heat_elec,heat_fossil,he
      aders_heat) , heat_data_upload(n,bu,'dir',heat_storage,heat_hp,heat_elec,h
      eat_fossil,headers_heat)) > 0 AND phi_heat_type(n,bu,'dir')) = 1;
 869   
 870  theta_storage(n,bu,ch)$(sum((heat_hp,heat_elec,heat_fossil,headers_heat), 
      heat_data_upload(n,bu,ch,'yes',heat_hp,heat_elec,heat_fossil,headers_heat)
      ) AND phi_heat_type(n,bu,ch)) = 1;
 871  theta_hp(n,bu,ch)$sum( (heat_storage,heat_elec,heat_fossil,headers_heat), 
      heat_data_upload(n,bu,ch,heat_storage,'yes',heat_elec,heat_fossil,headers_
      heat) AND phi_heat_type(n,bu,ch)) = 1;
 872   
 873  theta_elec(n,bu,ch)$sum( (heat_storage,heat_hp,heat_fossil,headers_heat), 
      heat_data_upload(n,bu,ch,heat_storage,heat_hp,'yes',heat_fossil,headers_he
      at) AND phi_heat_type(n,bu,ch)) = 1;
 874  theta_fossil(n,bu,ch)$sum( (heat_storage,heat_hp,heat_elec,headers_heat), 
      heat_data_upload(n,bu,ch,heat_storage,heat_hp,heat_elec,'yes',headers_heat
      ) AND phi_heat_type(n,bu,ch)) = 1;
 875   
 876   
 877   
 878  ***************  Adjust costs to model's hourly basis ********************
      ******
 879   
 880  c_i(n,tech) = c_i(n,tech)*card(h)/8760 ;
 881  c_i_res(n,tech) = c_i_res(n,tech)*card(h)/8760 ;
 882  c_i_sto_p(n,sto) = c_i_sto_p(n,sto)*card(h)/8760 ;
 883  c_i_sto_e(n,sto) = c_i_sto_e(n,sto)*card(h)/8760 ;
 884  c_i_rsvr_e(n,rsvr) = c_i_rsvr_e(n,rsvr)*card(h)/8760 ;
 885  c_i_rsvr_p(n,rsvr) = c_i_rsvr_p(n,rsvr)*card(h)/8760 ;
 886  c_i_dsm_cu(n,dsm_curt) = c_i_dsm_cu(n,dsm_curt)*card(h)/8760 ;
 887  c_i_dsm_shift(n,dsm_shift) = c_i_dsm_shift(n,dsm_shift)*card(h)/8760 ;
 888   
 889  c_fix(n,tech) = c_fix(n,tech)*card(h)/8760 ;
 890  c_fix_sto(n,sto) = c_fix_sto(n,sto)*card(h)/8760 ;
 891  c_fix_dsm_cu(n,dsm_curt) = c_fix_dsm_cu(n,dsm_curt)*card(h)/8760 ;
 892  c_fix_dsm_shift(n,dsm_shift) = c_fix_dsm_shift(n,dsm_shift)*card(h)/8760 ;
 893  c_fix_rsvr(n,rsvr) = c_fix_rsvr(n,rsvr)*card(h)/8760 ;
 894   
 895  m_e(n,'bio') = m_e(n,'bio')*card(h)/8760 ;
 896   
 897  c_i_ntc(l) = c_i_ntc(l) * card(h)/8760 ;
 898   
 899  *t_dur_dsm_cu(n,dsm_curt) = t_dur_dsm_cu(n,dsm_curt) ;
 900  *t_off_dsm_cu(n,dsm_curt) = t_off_dsm_cu(n,dsm_curt) ;
 901  *t_dur_dsm_shift(n,dsm_shift)$(ord(dsm_shift)=2 or ord(dsm_shift)=4 or ord
      (dsm_shift)=5) = t_dur_dsm_shift(n,dsm_shift) / 2 ;
 902  *t_dur_dsm_shift(n,dsm_shift)$(ord(dsm_shift)=1 or ord(dsm_shift)=3) = 2 ;
 903   
 904   
 905   
 906  ***************  Check for parameter sanity ******************************
      ******
 907   
 908  Parameter
 909  check_heat
 910  check_heat_agg ;
 911  check_heat(n,bu) = sum( ch , phi_heat_type(n,bu,ch)) ;
 912  check_heat_agg = smax( (n,bu) , check_heat(n,bu) ) ;
 913  *abort$(check_heat_agg > 1) "DATA: heating technologies for a building typ
      e do not add up to 100 percent" ;
 914   
 915   
 916   
 917   
 918  ***************  Infeasibility *******************************************
      ******
 919   
 920  Positive variable
 921  G_INFES(n,h)
 922  ;
 923   
 924  Parameter
 925  c_infes  /100000/
 926  ;
 927   
 928   
 929   
 930   
 931   
 932   
 933   
 934   
 935   
 936   
 937   
 938   
 939   
 940   
 941   
 942   
 943   
 944   
 945  **************************************************************************
      ******
 946   
 947  *************************************
 948  ***** Features for single nodes *****
 949  *************************************
 950   
 951  Set
 952  features /dsm, ev, reserves, prosumage, rsvr_outflow, heat/
 953  ;
 954   
 955   
 956  Table
 957  feat_node(features,n)
 958                   DE
      dsm              1
      $ontext
      reserves         1
      $ontext
      ev               1
      $ontext
      prosumage        1
      $ontext
 975  rsvr_outflow     0
      heat             1
      $ontext
 980  ;
 981   
 982   
      m_dsm_cu(n,dsm_curt)$(feat_node('dsm',n) = 0) = 0 ;
      m_dsm_shift(n,dsm_shift)$(feat_node('dsm',n) = 0) = 0 ;
      $ontext
 988   
      m_res_pro(n,res)$(feat_node('prosumage',n) = 0) = 0 ;
      m_sto_pro_e(n,sto)$(feat_node('prosumage',n) = 0) = 0 ;
      m_sto_pro_p(n,sto)$(feat_node('prosumage',n) = 0) = 0 ;
      $ontext
 995   
 996  phi_rsvr_min(n) = 0
 997  *feat_node('rsvr_outflow',n)
 998  ;
 999   
      dh(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      d_dhw(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      $ontext
1005   
1006   
1007  Set
1008  map_n_tech(n,tech)
1009  map_n_sto(n,sto)
1010  map_n_rsvr(n,rsvr)
1011  map_n_dsm(n,dsm)
1012  map_n_ev(n,ev)
1013  map_l(l)
1014  map_n_sto_pro(n,sto)
1015  map_n_res_pro(n,tech)
1016  ;
1017   
1018  map_n_tech(n,tech) = yes$m_p(n,tech) ;
1019  map_n_sto(n,sto) = yes$m_sto_p(n,sto) ;
1020  map_n_rsvr(n,rsvr) = yes$m_rsvr_p(n,rsvr) ;
1021  map_n_dsm(n,dsm_curt) = yes$m_dsm_cu(n,dsm_curt) ;
1022  map_n_dsm(n,dsm_shift) = yes$m_dsm_shift(n,dsm_shift) ;
1023  map_n_ev(n,ev) = yes$ev_data(n,ev,'share_ev') ;
1024  map_l(l) = yes$m_ntc(l) ;
1025  map_n_sto_pro(n,sto) = yes$(yes$m_sto_pro_p(n,sto)) ;
1026  map_n_res_pro(n,res) = yes$(yes$m_res_pro(n,res)) ;
1027  ;
1028   
1029   
1030   
1031   
1032  **************************************************************************
      ******
1033   
1034  ***************************
1035  ***** Initialize data *****
1036  ***************************
1037   
1038  * Parameters for default base year
1039  d(n,h) = d_y(n,'2030',h) ;
1040  phi_res(n,res,h) = phi_res_y(n,'2030',res,h) ;
1041  rsvr_in(n,rsvr,h) = rsvr_in_y(n,'2030',rsvr,h) ;
1042  phi_reserves_call(n,reserves,h) = phi_reserves_call_y(n,'2030',reserves,h)
       ;
1043  phi_mean_reserves_call(n,reserves) = phi_mean_reserves_call_y(n,'2030',res
      erves) ;
1044  reserves_exogenous(n,reserves,h) = reserves_exogenous_y(n,'2030',reserves,
      h) ;
1045  dh(n,bu,ch,h) = dh_y(n,'2030',bu,ch,h) ;
1046  d_dhw(n,bu,ch,h) = d_dhw_y(n,'2030',bu,ch,h) ;
1047   
1048  dh(n,bu,ch,h) = area_floor(n,bu,ch) * dh(n,bu,ch,h) ;
1049  d_dhw(n,bu,ch,h) = area_floor(n,bu,ch) * d_dhw(n,bu,ch,h) ;
1050   
1051   
1052  * No interconnections between non-adjacent or nonuploaded nodes
1053  m_ntc(l)$( smax(n,inc(l,n)) = 0 OR smin(n,inc(l,n)) = 0 ) = 0 ;
1054   
1055   
1056  * Set loop parameters to default zero
1057  phi_min_res = 0 ;
1058  ev_quant = 0 ;
1059  phi_pro_self = 0 ;
1060  phi_pro_load(n) = 0 ;
1061  phi_pro_load(n)$feat_node('prosumage',n) = 0.2 ;
1062   
1063   
1064  Parameter
1065  phi_min_res_exog(n)
1066  min_flh(n,rsvr)
1067  ;
1068   
1069  phi_min_res_exog(n) = 1 ;
1070  min_flh(n,rsvr) = 0 ;
1071   
1072  *min_flh('FR',rsvr) = 1000 * card(h)/8760 ;
1073  *min_flh('AT',rsvr) = 1000 * card(h)/8760 ;
1074  *min_flh('CH',rsvr) = 1000 * card(h)/8760 ;
1075   
1076   
1077   
1078   
1079  **************************************************************************
      ******
1080  ***** Model *****
1081  **************************************************************************
      ******
1082   
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\model.gms
1084   
1085  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
1095  **************************************************************************
      ******
1096   
1097   
1098  Variables
1099  Z                Value objective function [Euro]
1100  F(l,h)           Energy flow over link l in hour h [MWh]
1101  ;
1102   
1103  Positive Variables
1104  G_L(n,tech,h)            Generation level in hour h [MWh]
1105  G_UP(n,tech,h)           Generation upshift in hour h [MWh]
1106  G_DO(n,tech,h)           Generation downshift in hour h [MWh]
1107   
1108  G_RES(n,tech,h)          Generation renewables type res in hour h [MWh]
1109  CU(n,tech,h)             Renewables curtailment technology res in hour h [
      MWh]
1110   
1111  STO_IN(n,sto,h)          Storage inflow technology sto hour h [MWh]
1112  STO_OUT(n,sto,h)         Storage outflow technology sto hour h [MWh]
1113  STO_L(n,sto,h)           Storage level technology sto hour h [MWh]
1114   
1115  EV_CHARGE(n,ev,h)        Electric vehicle charging vehicle profile ev hour
       h [MWh]
1116  EV_DISCHARGE(n,ev,h)     Electric vehicle discharging vehicle profile ev h
      our h [MWh]
1117  EV_L(n,ev,h)             Electric vehicle charging level vehicle profile e
      v hour h [MWh]
1118  EV_PHEVFUEL(n,ev,h)      Plug in hybrid electric vehicle conventional fuel
       use vehicle profile ev hour h [MWh]
1119  EV_GED(n,ev,h)           Grid electricity demand for mobility vehicle prof
      ile ev hour h [MWh]
1120   
1121  N_TECH(n,tech)           Technology tech built [MW]
1122  N_STO_E(n,sto)           Storage technology built - Energy [MWh]
1123  N_STO_P(n,sto)           Storage loading and discharging capacity built - 
      Capacity [MW]
1124   
1125  DSM_CU(n,dsm,h)          DSM: Load curtailment hour h [MWh]
1126  DSM_UP(n,dsm,h)          DSM: Load shifting up hour h technology dsm [MWh]
1127  DSM_DO(n,dsm,h,hh)       DSM: Load shifting down in hour hh to account for
       upshifts in hour h technology dsm [MWh]
1128   
1129  DSM_UP_DEMAND(n,dsm,h)   DSM: Load shifting up active for wholesale demand
       in hour h of technology dsm [MWh]
1130  DSM_DO_DEMAND(n,dsm,h)   DSM: Load shifting down active for wholesale dema
      nd in hour h of technology dsm [MWh]
1131   
1132  N_DSM_CU(n,dsm)          DSM: Load curtailment capacity [MW]
1133  N_DSM_SHIFT(n,dsm)       DSM: Load shifting capacity [MWh]
1134   
1135  RP_DIS(n,reserves,tech,h)        Reserve provision by conventionals in hou
      r h [MW]
1136  RP_NONDIS(n,reserves,tech,h)     Reserve provision by renewables in hour h
       [MW]
1137  RP_STO_IN(n,reserves,sto,h)      Reserve provision by storage in in hour h
       [MW]
1138  RP_STO_OUT(n,reserves,sto,h)     Reserve provision by storage out in hour 
      h [MW]
1139  RP_EV_V2G(n,reserves,ev,h)       Reserve provision by electric vehicles V2
      G hour h [MW]
1140  RP_EV_G2V(n,reserves,ev,h)       Reserve provision by electric vehicles G2
      V hour h [MW]
1141  RP_DSM_CU(n,reserves,dsm,h)      Reserve provision by DSM load curtailment
       in hour h [MW]
1142  RP_DSM_SHIFT(n,reserves,dsm,h)   Reserve provision by DSM load shifting in
       hour h [MW]
1143  RP_RSVR(n,reserves,rsvr,h)       Reserve provision by reservoirs h [MW]
1144  RP_SETS(n,reserves,bu,ch,h)      Reserve provision by SETS [MW]
1145  RP_SETS_AUX(n,reserves,bu,ch,h)  Reserve provision by SETS auxiliary DHW m
      odules [MW]
1146  RP_HP(n,reserves,bu,ch,h)        Reserve provision by heat pumps [MW]
1147  RP_H_ELEC(n,reserves,bu,ch,h)    Reserve provision by hybrid electric heat
      ers [MW]
1148   
1149  CU_PRO(n,tech,h)                 Prosumage: curtailment of renewable gener
      ation in hour h [MWh]
1150  G_MARKET_PRO2M(n,tech,h)         Prosumage. energy sent to market in hour 
      h [MWh]
1151  G_MARKET_M2PRO(n,h)              Prosumage: withdrawal of energy from mark
      et in hour h [MWh]
1152  G_RES_PRO(n,tech,h)              Prosumage: hourly renewables generation i
      n hour h [MWh]
1153  STO_IN_PRO2PRO(n,tech,sto,h)     Prosumage: storage loading from generatio
      n for discharging to consumption in hour h [MWh]
1154  STO_IN_PRO2M(n,tech,sto,h)       Prosumage: storage loading from generatio
      n for discharging to market in hour h [MWh]
1155  STO_IN_M2PRO(n,sto,h)            Prosumage: storage loading from market fo
      r discharging to consumption in hour h [MWh]
1156  STO_IN_M2M(n,sto,h)              Prosumage: storage loading from market fo
      r discharging to market in hour h [MWh]
1157  STO_OUT_PRO2PRO(n,sto,h)         Prosumage: storage discharging to consump
      tion from generation in hour h [MWh]
1158  STO_OUT_PRO2M(n,sto,h)           Prosumage: storage discharging to market 
      from generation in hour h [MWh]
1159  STO_OUT_M2PRO(n,sto,h)           Prosumage: storage discharging to consump
      tion from market in hour h [MWh]
1160  STO_OUT_M2M(n,sto,h)             Prosumage: storage discharging to market 
      from market in hour h [MWh]
1161  STO_L_PRO2PRO(n,sto,h)           Prosumage: storage level generation to co
      nsumption in hour h [MWh]
1162  STO_L_PRO2M(n,sto,h)             Prosumage: storage level generation to ma
      rket in hour h [MWh]
1163  STO_L_M2PRO(n,sto,h)             Prosumage: storage level market to consum
      otion in hour h [MWh]
1164  STO_L_M2M(n,sto,h)               Prosumage: storage level market to market
       in hour h [MWh]
1165  N_STO_E_PRO(n,sto)               Prosumage: installed storage energy [MWh]
1166  N_STO_P_PRO(n,sto)               Prosumage: installed storage power [MW]
1167  STO_L_PRO(n,sto,h)               Prosumage: overall storage level in hour 
      h [MWh]
1168  N_RES_PRO(n,tech)                Prosumage: installed renewables capacitie
      s [MW]
1169   
1170  NTC(l)                           Trade: installed NTC on line l [MW]
1171   
1172  RSVR_OUT(n,rsvr,h)               Reservoirs: outflow in hour h [MWh]
1173  RSVR_L(n,rsvr,h)                 Reservoirs: level in hour h [MWh]
1174  N_RSVR_E(n,rsvr)                 Reservoirs: installed energy capacity [MW
      h]
1175  N_RSVR_P(n,rsvr)                 Reservoirs: installed power capacity [MW]
1176   
1177  H_DIR(n,bu,ch,h)                 Heating: direct heating in hour h for bui
      lding type bu with haeting technology ch [MWh]
1178  H_SETS_LEV(n,bu,ch,h)            Heating: storage level SETS technologies 
      [MWh]
1179  H_SETS_IN(n,bu,ch,h)             Heating: storage inflow SETS technologies
       [MWh]
1180  H_SETS_OUT(n,bu,ch,h)            Heating: storage outflow SETS technologie
      s [MWh]
1181  H_HP_IN(n,bu,ch,hh)              Heating: electricity demand heat pump tec
      hnologies [MWh]
1182  H_STO_LEV(n,bu,ch,h)             Heating: storage level storage technologi
      es [MWh]
1183  H_STO_IN_HP(n,bu,ch,h)           Heating: storage inflow from heat pumps t
      o storage technologies [MWh]
1184  H_STO_IN_ELECTRIC(n,bu,ch,h)     Heating: storage inflow from electric hea
      ting to storage technologies [MWh]
1185  H_ELECTRIC_IN(n,bu,ch,h)         Heating: hybrid electric heaters electric
      ity demand [MWh]
1186  H_STO_IN_FOSSIL(n,bu,ch,h)       Heating: storage inflow from nonelectric 
      heating to storage technologies [MWh]
1187  H_STO_OUT(n,bu,ch,h)             Heating: storage outflow from storage tec
      hnologies [MWh]
1188   
1189  H_DHW_DIR(n,bu,ch,h)             Heating - domestic hot water: provision i
      n case of direct electric heating [MWh]
1190  H_DHW_STO_OUT(n,bu,ch,h)         Heating - domestic hot water: DHW storage
       outflow [MWh]
1191   
1192  H_DHW_AUX_ELEC_IN(n,bu,ch,h)     Heating - domestic hot water: electrical 
      energy input of auxiliary hot water tank for SETS [MWh]
1193  H_DHW_AUX_LEV(n,bu,ch,h)         Heating - domestic hot water: level of au
      xiliary hot water tank for SETS [MWh]
1194  H_DHW_AUX_OUT(n,bu,ch,h)         Heating - domestic hot water: auxiliary D
      HW provision for SETS [MWh]
1195  ;
1196   
1197   
1198   
1199   
1200  **************************************************************************
      ******
1201   
1202  Equations
1203  * Objective
1204  obj                      Objective cost minimization
1205   
1206  * Energy balance
1207  con1a_bal                Energy Balance
1208   
1209  * Load change costs
1210  con2a_loadlevel          Load change costs: Level
1211  con2b_loadlevelstart     Load change costs: Level for first period
1212   
1213  * Capacity contraints and flexibility constraints
1214  con3a_maxprod_dispatchable       Capacity Constraint conventionals
1215  con3e_maxprod_res                Capacity constraints renewables
1216   
1217  * Storage constraints
1218  con4a_stolev_start        Storage Level Dynamics Initial Condition
1219  con4b_stolev              Storage Level Dynamics
1220  con4c_stolev_max          Storage Power Capacity
1221  con4d_maxin_sto           Storage maximum inflow
1222  con4e_maxout_sto          Storage maximum outflow
1223  con4j_ending              End level equal to initial level
1224  con4k_PHS_EtoP            Maximum E to P ratio for PHS
1225   
1226  * Minimum restrictions for renewables and biomass
1227  con5a_minRES             Minimum yearly renewables requirement
1228  con5b_max_energy         Maximum yearly biomass energy
1229   
1230   
1231  * Maximum installation conditions
1232  con8a_max_I_power                Maximum installable capacity: Conventiona
      ls
1233  con8b_max_I_sto_e                Maximum installable energy: Storage in MW
      h
1234  con8c_max_I_sto_p                Maximum installable capacity: Storage inf
      low-outflow in MW
1235  con8f_max_pro_res                Maximum installable capacity: prosumage r
      enewables
1236  con8g_max_pro_sto_e              Maximum installable capacity: prosumage s
      torage energy
1237  con8h_max_sto_pro_p              Maximum installable capacity: prosumage s
      torage power
1238   
1239  * Prosumage
1240  con11a_pro_distrib                       Prosumage: distribution of genera
      ted energy
1241  con11b_pro_balance                       Prosumage: energy balance
1242  con11c_pro_selfcon                       Prosumage: minimum self-generatio
      n requirement
1243  con11d_pro_stolev_PRO2PRO                Prosumage: storage level prosumag
      er-to-prosumagers
1244  con11e_pro_stolev_PRO2M                  Prosumage: storage level prosumag
      ers-to-market
1245  con11f_pro_stolev_M2PRO                  Prosumage: storage level market-t
      o-prosumagers
1246  con11g_pro_stolev_M2M                    Prosumage: storage level market-t
      o-market
1247  con11h_1_pro_stolev_start_PRO2PRO        Prosumage: storage level initial 
      conditions
1248  con11h_2_pro_stolev_start_PRO2M          Prosumage: storage level initial 
      conditions
1249  con11h_3_pro_stolev_start_M2PRO          Prosumage: storage level initial 
      conditions
1250  con11h_4_pro_stolev_start_M2M            Prosumage: storage level initial 
      conditions
1251  con11i_pro_stolev                        Prosumage: storage level total
1252  con11j_pro_stolev_max                    Prosumage: maximum overall storag
      e level
1253  con11k_pro_maxin_sto                     Prosumage: maximum storage inflow
1254  con11l_pro_maxout_sto                    Prosumage: maximum storage outflo
      w
1255  con11m_pro_maxout_lev                    Prosumage: maximum storage outflo
      w linked to level
1256  con11n_pro_maxin_lev                     Prosumage: maximum storage inflow
       linked to level
1257  con11o_pro_ending                        Prosumage: storage ending conditi
      on
1258  ;
1259   
1260   
1261   
1262  **************************************************************************
      ******
1263   
1264  * ------------------------------------------------------------------------
      ---- *
1265  ***** Objective function *****
1266  * ------------------------------------------------------------------------
      ---- *
1267   
1268  obj..
1269           Z =E=
1270                     sum( (h,map_n_tech(n,dis)) , c_m(n,dis)*G_L(n,dis,h) )
1271                   + sum( (h,map_n_tech(n,dis))$(ord(h)>1) , c_up(n,dis)*G_U
      P(n,dis,h) )
1272                   + sum( (h,map_n_tech(n,dis)) , c_do(n,dis)*G_DO(n,dis,h) 
      )
1273                   + sum( (h,map_n_tech(n,nondis)) , c_cu(n,nondis)*CU(n,non
      dis,h) )
1274                   + sum( (h,map_n_sto(n,sto)) , c_m_sto(n,sto) * ( STO_OUT(
      n,sto,h) + STO_IN(n,sto,h) ) )
                       + sum( (h,map_n_dsm(n,dsm_curt)) , c_m_dsm_cu(n,dsm_curt)
      *DSM_CU(n,dsm_curt,h) )
                       + sum( (h,map_n_dsm(n,dsm_shift)) , c_m_dsm_shift(n,dsm_s
      hift) * DSM_UP_DEMAND(n,dsm_shift,h) )
                       + sum( (h,map_n_dsm(n,dsm_shift)) , c_m_dsm_shift(n,dsm_s
      hift) * DSM_DO_DEMAND(n,dsm_shift,h) )
      $ontext
                       + sum( (h,map_n_ev(n,ev)) , c_m_ev(n,ev) * EV_DISCHARGE(n
      ,ev,h) )
                       + sum( (h,map_n_ev(n,ev)) , pen_phevfuel(n,ev) * EV_PHEVF
      UEL(n,ev,h) )
      $ontext
1286                   + sum( map_n_tech(n,tech) , c_i(n,tech)*N_TECH(n,tech) )
1287                   + sum( map_n_tech(n,tech) , c_fix(n,tech)*N_TECH(n,tech) 
      )
1288                   + sum( map_n_sto(n,sto) , c_i_sto_e(n,sto)*N_STO_E(n,sto)
       )
1289                   + sum( map_n_sto(n,sto) , c_fix_sto(n,sto)/2*(N_STO_P(n,s
      to)+N_STO_E(n,sto)) )
1290                   + sum( map_n_sto(n,sto) , c_i_sto_p(n,sto)*N_STO_P(n,sto)
       )
                       + sum( map_n_dsm(n,dsm_curt) , c_i_dsm_cu(n,dsm_curt)*N_D
      SM_CU(n,dsm_curt) )
                       + sum( map_n_dsm(n,dsm_curt) , c_fix_dsm_cu(n,dsm_curt)*N
      _DSM_CU(n,dsm_curt) )
                       + sum( map_n_dsm(n,dsm_shift) , c_i_dsm_shift(n,dsm_shift
      )*N_DSM_SHIFT(n,dsm_shift) )
                       + sum( map_n_dsm(n,dsm_shift) , c_fix_dsm_shift(n,dsm_shi
      ft)*N_DSM_SHIFT(n,dsm_shift) )
      $ontext
                       + sum( (h,map_n_sto(n,sto),reserves_up) , phi_reserves_ca
      ll(n,reserves_up,h) * c_m_sto(n,sto) * (RP_STO_OUT(n,reserves_up,sto,h) - 
      RP_STO_IN(n,reserves_up,sto,h)) )
                       - sum( (h,map_n_sto(n,sto),reserves_do) , phi_reserves_ca
      ll(n,reserves_do,h) * c_m_sto(n,sto) * (RP_STO_OUT(n,reserves_do,sto,h) - 
      RP_STO_IN(n,reserves_do,sto,h)) )
                       + sum( (h,map_n_rsvr(n,rsvr),reserves_up) , RP_RSVR(n,res
      erves_up,rsvr,h) * phi_reserves_call(n,reserves_up,h) * c_m_rsvr(n,rsvr) )
                       - sum( (h,map_n_rsvr(n,rsvr),reserves_do) , RP_RSVR(n,res
      erves_do,rsvr,h) * phi_reserves_call(n,reserves_do,h) * c_m_rsvr(n,rsvr) )
      $ontext
      %EV%$ontext
      %EV_EXOG%        + sum( (h,map_n_ev(n,ev),reserves_up) , RP_EV_V2G(n,reser
      ves_up,ev,h) * phi_reserves_call(n,reserves_up,h) * c_m_ev(n,ev) )
      %EV_EXOG%        - sum( (h,map_n_ev(n,ev),reserves_do) , RP_EV_V2G(n,reser
      ves_do,ev,h) * phi_reserves_call(n,reserves_do,h) * c_m_ev(n,ev) )
      $ontext
      %reserves%$ontext
                       + sum( (h,map_n_dsm(n,dsm_curt),reserves_up) , RP_DSM_CU(
      n,reserves_up,dsm_curt,h) * phi_reserves_call(n,reserves_up,h) * c_m_dsm_c
      u(n,dsm_curt) )
                       + sum( (h,map_n_dsm(n,dsm_shift),reserves) , RP_DSM_SHIFT
      (n,reserves,dsm_shift,h) * phi_reserves_call(n,reserves,h) * c_m_dsm_shift
      (n,dsm_shift) )
      $ontext
                       + sum( map_n_res_pro(n,res) , c_i(n,res)*N_RES_PRO(n,res)
       )
                       + sum( map_n_res_pro(n,res) , c_fix(n,res)*N_RES_PRO(n,re
      s) )
       
                       + sum( map_n_sto_pro(n,sto) , c_i_sto_e(n,sto)*N_STO_E_PR
      O(n,sto) )
                       + sum( map_n_sto_pro(n,sto) , c_fix_sto(n,sto)/2*(N_STO_P
      _PRO(n,sto) + N_STO_E_PRO(n,sto)) )
                       + sum( map_n_sto_pro(n,sto) , c_i_sto_p(n,sto)*N_STO_P_PR
      O(n,sto) )
       
                       + sum( (h,map_n_sto_pro(n,sto)) , c_m_sto(n,sto) * ( STO_
      OUT_PRO2PRO(n,sto,h) + STO_OUT_M2PRO(n,sto,h) + STO_OUT_PRO2M(n,sto,h) + S
      TO_OUT_M2M(n,sto,h) + sum( res , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN_PRO2
      M(n,res,sto,h)) + STO_OUT_PRO2M(n,sto,h) + STO_OUT_M2M(n,sto,h) ) )
      $ontext
1328                   + sum( map_l(l) , c_i_ntc(l) * NTC(l)*dist(l) )
1329   
1330                   + sum( (h,map_n_rsvr(n,rsvr)), c_m_rsvr(n,rsvr) * RSVR_OU
      T(n,rsvr,h) )
1331                   + sum( map_n_rsvr(n,rsvr) , c_i_rsvr_e(n,rsvr) * N_RSVR_E
      (n,rsvr) )
1332                   + sum( map_n_rsvr(n,rsvr) , c_i_rsvr_p(n,rsvr) * N_RSVR_P
      (n,rsvr) )
1333                   + sum( map_n_rsvr(n,rsvr) , c_fix_rsvr(n,rsvr) * N_RSVR_P
      (n,rsvr) )
                       + sum( (h,n,bu,hfo) , pen_heat_fuel(n,bu,hfo) * H_STO_IN_
      FOSSIL(n,bu,hfo,h))
      $ontext
1338                   + sum( (h,n) , c_infes * G_INFES(n,h) )
1339  ;
1340   
1341  * ------------------------------------------------------------------------
      ---- *
1342  ***** Energy balance and load levels *****
1343  * ------------------------------------------------------------------------
      ---- *
1344   
1345  * Energy balance
1346  con1a_bal(n,hh)..
1347           ( 1 - phi_pro_load(n) ) * d(n,hh) + sum( map_n_sto(n,sto) , STO_I
      N(n,sto,hh) )
               + sum( map_n_dsm(n,dsm_shift) , DSM_UP_DEMAND(n,dsm_shift,hh) )
      $ontext
               + sum( map_n_ev(n,ev) , EV_CHARGE(n,ev,hh) )
      $ontext
               + G_MARKET_M2PRO(n,hh)
               + sum( map_n_sto_pro(n,sto) , STO_IN_M2PRO(n,sto,hh))
               + sum( map_n_sto_pro(n,sto) , STO_IN_M2M(n,sto,hh))
      $ontext
              + sum( (bu,ch) , theta_dir(n,bu,ch) * (H_DIR(n,bu,ch,hh) + H_DHW_D
      IR(n,bu,ch,hh)) )
              + sum( (bu,ch) , theta_sets(n,bu,ch) * (H_SETS_IN(n,bu,ch,hh) + H_
      DHW_AUX_ELEC_IN(n,bu,ch,hh)) )
              + sum( (bu,hp) , theta_hp(n,bu,hp) * H_HP_IN(n,bu,hp,hh) )
              + sum( (bu,hel) , theta_elec(n,bu,hel) * H_ELECTRIC_IN(n,bu,hel,hh
      ) )
      $ontext
1369           =E=
1370           sum( map_n_tech(n,dis) , G_L(n,dis,hh)) + sum( map_n_tech(n,nondi
      s) , G_RES(n,nondis,hh)) + sum( sto , STO_OUT(n,sto,hh) ) + sum( map_n_rsv
      r(n,rsvr) , RSVR_OUT(n,rsvr,hh))
1371  *       + sum( map_l(l) , inc(l,n) * F(l,hh))
      *Balancing Correction Factor
              + sum( map_n_tech(n,dis) ,
                sum( reserves_do ,  RP_DIS(n,reserves_do,dis,hh) * phi_reserves_
      call(n,reserves_do,hh))
              - sum( reserves_up ,  RP_DIS(n,reserves_up,dis,hh) * phi_reserves_
      call(n,reserves_up,hh))
               )
      $ontext
               + sum( map_n_dsm(n,dsm_curt) , DSM_CU(n,dsm_curt,hh))
               + sum( map_n_dsm(n,dsm_shift) , DSM_DO_DEMAND(n,dsm_shift,hh))
      $ontext
              + sum( map_n_ev(n,ev) , EV_DISCHARGE(n,ev,hh) )
      $ontext
               + sum( map_n_res_pro(n,res) , G_MARKET_PRO2M(n,res,hh) )
               + sum( map_n_sto_pro(n,sto) , STO_OUT_PRO2M(n,sto,hh))
               + sum( map_n_sto_pro(n,sto) , STO_OUT_M2M(n,sto,hh))
      $ontext
1395           + G_INFES(n,hh)
1396  ;
1397   
1398  con2a_loadlevel(n,dis,h)$(ord(h) > 1 AND map_n_tech(n,dis))..
1399          G_L(n,dis,h) =E= G_L(n,dis,h-1) + G_UP(n,dis,h) - G_DO(n,dis,h)
1400  ;
1401   
1402  con2b_loadlevelstart(n,dis,h)$(ord(h) = 1 AND map_n_tech(n,dis))..
1403           G_L(n,dis,h) =E= G_UP(n,dis,h)
1404  ;
1405   
1406  * ------------------------------------------------------------------------
      ---- *
1407  ***** Hourly maximum generation caps and constraints related to reserves  
       *****
1408  * ------------------------------------------------------------------------
      ---- *
1409   
1410  con3a_maxprod_dispatchable(n,dis,h)$(map_n_tech(n,dis))..
1411          G_L(n,dis,h)
              + sum( reserves_up , RP_DIS(n,reserves_up,dis,h))
      *Balancing Correction Factor
              + sum( reserves_do ,  RP_DIS(n,reserves_do,dis,h) * phi_reserves_c
      all(n,reserves_do,h))
              - sum( reserves_up ,  RP_DIS(n,reserves_up,dis,h) * phi_reserves_c
      all(n,reserves_up,h))
      $ontext
1419          =L= N_TECH(n,dis)
1420  ;
1421   
1422   
1423  con3e_maxprod_res(n,nondis,h)$(map_n_tech(n,nondis))..
1424          G_RES(n,nondis,h) + CU(n,nondis,h)
              + sum( reserves_up , RP_NONDIS(n,reserves_up,nondis,h))
      $ontext
1429          =E= phi_res(n,nondis,h) * N_TECH(n,nondis)
1430  ;
1431   
1432  * ------------------------------------------------------------------------
      ---- *
1433  ***** Storage constraints *****
1434  * ------------------------------------------------------------------------
      ---- *
1435   
1436  con4a_stolev_start(n,sto,h)$(map_n_sto(n,sto) AND ord(h) = 1)..
1437          STO_L(n,sto,h) =E= phi_sto_ini(n,sto) * N_STO_E(n,sto) + STO_IN(n,
      sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT(n,sto,h)/(1+eta_sto(n,sto))*2
1438  ;
1439   
1440  con4b_stolev(n,sto,h)$((ord(h)>1) AND map_n_sto(n,sto))..
1441           STO_L(n,sto,h) =E= STO_L(n,sto,h-1) + STO_IN(n,sto,h)*(1+eta_sto(
      n,sto))/2 - STO_OUT(n,sto,h)/(1+eta_sto(n,sto))*2
               + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( RP_ST
      O_IN(n,reserves_do,sto,h)*(1+eta_sto(n,sto))/2 + RP_STO_OUT(n,reserves_do,
      sto,h)/(1+eta_sto(n,sto))*2 ))
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( RP_ST
      O_IN(n,reserves_up,sto,h)*(1+eta_sto(n,sto))/2 + RP_STO_OUT(n,reserves_up,
      sto,h)/(1+eta_sto(n,sto))*2 ))
      $ontext
1447  ;
1448   
1449  con4c_stolev_max(n,sto,h)$(map_n_sto(n,sto))..
1450          STO_L(n,sto,h) =L= N_STO_E(n,sto)
1451  ;
1452   
1453  con4d_maxin_sto(n,sto,h)$(map_n_sto(n,sto))..
1454          STO_IN(n,sto,h)
              + sum( reserves_do , RP_STO_IN(n,reserves_do,sto,h))
      $ontext
1459          =L= N_STO_P(n,sto)
1460  ;
1461   
1462  con4e_maxout_sto(n,sto,h)$(map_n_sto(n,sto))..
1463          STO_OUT(n,sto,h)
              + sum( reserves_up , RP_STO_OUT(n,reserves_up,sto,h))
      $ontext
1468          =L= N_STO_P(n,sto)
1469  ;
1470   
1471  con4j_ending(n,sto,h)$(ord(h) = card(h) AND map_n_sto(n,sto))..
1472           STO_L(n,sto,h) =E= phi_sto_ini(n,sto) * N_STO_E(n,sto)
1473  ;
1474   
1475  con4k_PHS_EtoP(n,sto)$(map_n_sto(n,sto))..
1476          N_STO_E(n,sto) =L= etop_max(n,sto) * N_STO_P(n,sto)
1477  ;
1478   
1479  * ------------------------------------------------------------------------
      ---- *
1480  ***** Quotas for renewables and biomass *****
1481  * ------------------------------------------------------------------------
      ---- *
1482   
1483  con5a_minRES(n)..
1484  sum( h , G_L(n,'bio',h) + sum( map_n_tech(n,nondis) , G_RES(n,nondis,h)) +
       sum( map_n_rsvr(n,rsvr) , RSVR_OUT(n,rsvr,h))
               - sum( reserves_do , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_do,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_do,rsvr
      ,h))) * phi_reserves_call(n,reserves_do,h))
               + sum( reserves_up , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_up,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_up,rsvr
      ,h))) * phi_reserves_call(n,reserves_up,h))
      $ontext
               + sum( map_n_sto_pro(n,sto) , STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_
      PRO2M(n,sto,h)) + sum( map_n_res_pro(n,res) , G_MARKET_PRO2M(n,res,h) + G_
      RES_PRO(n,res,h))
      $ontext
1494  )
1495          =G= phi_min_res * phi_min_res_exog(n) * sum( h ,
1496           sum( map_n_tech(n,dis) , G_L(n,dis,h)) + sum( map_n_tech(n,nondis
      ) , G_RES(n,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RSVR_OUT(n,rsvr,h))
               - sum( reserves_do , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_do,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_do,rsvr
      ,h))) * phi_reserves_call(n,reserves_do,h))
               + sum( reserves_up , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_up,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_up,rsvr
      ,h))) * phi_reserves_call(n,reserves_up,h))
      $ontext
               + sum( map_n_res_pro(n,res) , phi_res(n,res,h) * N_RES_PRO(n,res)
       - CU_PRO(n,res,h))
      $ontext
1506           )
1507  ;
1508   
1509  con5b_max_energy(n,dis)$(map_n_tech(n,dis) AND m_e(n,dis))..
1510           sum( h , G_L(n,dis,h) ) =L= m_e(n,dis)
1511  ;
1512   
1513  * ------------------------------------------------------------------------
      ---- *
1514  ***** Maximum installation constraints *****
1515  * ------------------------------------------------------------------------
      ---- *
1516   
1517  con8a_max_I_power(n,tech)$(map_n_tech(n,tech))..
1518           N_TECH(n,tech) =L= m_p(n,tech)
1519  ;
1520   
1521  con8b_max_I_sto_e(n,sto)$(map_n_sto(n,sto))..
1522           N_STO_E(n,sto) =L= m_sto_e(n,sto)
1523  ;
1524   
1525  con8c_max_I_sto_p(n,sto)$(map_n_sto(n,sto))..
1526           N_STO_P(n,sto) =L= m_sto_p(n,sto)
1527  ;
1528   
1529   
1530  con8f_max_pro_res(n,res)$(map_n_res_pro(n,res))..
1531           N_RES_PRO(n,res) =L= m_res_pro(n,res)
1532  ;
1533   
1534  con8g_max_pro_sto_e(n,sto)$(map_n_sto_pro(n,sto))..
1535           N_STO_E_PRO(n,sto) =L= m_sto_pro_e(n,sto)
1536  ;
1537   
1538  con8h_max_sto_pro_p(n,sto)$(map_n_sto_pro(n,sto))..
1539           N_STO_P_PRO(n,sto) =L= m_sto_pro_p(n,sto)
1540  ;
1541   
1542  * ------------------------------------------------------------------------
      ---- *
1543  ***** Prosumage constraints *****
1544  * ------------------------------------------------------------------------
      ---- *
1545   
1546  con11a_pro_distrib(n,res,h)$(map_n_res_pro(n,res))..
1547           phi_res(n,res,h) * N_RES_PRO(n,res)
1548           =E=
1549           CU_PRO(n,res,h) + G_MARKET_PRO2M(n,res,h) + G_RES_PRO(n,res,h) + 
      sum( map_n_sto_pro(n,sto) , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN_PRO2M(n,r
      es,sto,h) )
1550  ;
1551   
1552  con11b_pro_balance(n,h)..
1553           phi_pro_load(n) * d(n,h)
1554           =E=
1555           sum( map_n_res_pro(n,res) , G_RES_PRO(n,res,h)) + sum( map_n_sto_
      pro(n,sto) , STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_M2PRO(n,sto,h) ) + G_MARKE
      T_M2PRO(n,h)
1556  ;
1557   
1558  con11c_pro_selfcon(n)..
1559           sum( (h,map_n_res_pro(n,res)) , G_RES_PRO(n,res,h) ) + sum( (h,st
      o) , STO_OUT_PRO2PRO(n,sto,h) )
1560           =G=
1561           phi_pro_self * sum( h , phi_pro_load(n) * d(n,h))
1562  ;
1563   
1564  con11d_pro_stolev_PRO2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) > 1 ).
      .
1565           STO_L_PRO2PRO(n,sto,h) =E= STO_L_PRO2PRO(n,sto,h-1) + sum( map_n_
      res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h))*(1+eta_sto(n,sto))/2 - STO_O
      UT_PRO2PRO(n,sto,h)/(1+eta_sto(n,sto))*2
1566  ;
1567   
1568  con11e_pro_stolev_PRO2M(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) > 1)..
1569           STO_L_PRO2M(n,sto,h) =E= STO_L_PRO2M(n,sto,h-1) + sum( map_n_res_
      pro(n,res) , STO_IN_PRO2M(n,res,sto,h))*(1+eta_sto(n,sto))/2 - STO_OUT_PRO
      2M(n,sto,h)/(1+eta_sto(n,sto))*2
1570  ;
1571   
1572  con11f_pro_stolev_M2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) > 1)..
1573           STO_L_M2PRO(n,sto,h) =E= STO_L_M2PRO(n,sto,h-1) + STO_IN_M2PRO(n,
      sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT_M2PRO(n,sto,h)/(1+eta_sto(n,sto))*2
1574  ;
1575   
1576  con11g_pro_stolev_M2M(n,sto,h)$(ord(h) > 1)..
1577           STO_L_M2M(n,sto,h) =E= STO_L_M2M(n,sto,h-1) + STO_IN_M2M(n,sto,h)
      *(1+eta_sto(n,sto))/2 - STO_OUT_M2M(n,sto,h)/(1+eta_sto(n,sto))*2
1578  ;
1579   
1580  con11h_1_pro_stolev_start_PRO2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h
      ) = 1)..
1581          STO_L_PRO2PRO(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E
      _PRO(n,sto) + sum( map_n_res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h))*(1+
      eta_sto(n,sto))/2 - STO_OUT_PRO2PRO(n,sto,h)/(1+eta_sto(n,sto))*2
1582  ;
1583   
1584  con11h_2_pro_stolev_start_PRO2M(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) 
      = 1)..
1585          STO_L_PRO2M(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_P
      RO(n,sto) + sum( map_n_res_pro(n,res) , STO_IN_PRO2M(n,res,sto,h))*(1+eta_
      sto(n,sto))/2 - STO_OUT_PRO2M(n,sto,h)/(1+eta_sto(n,sto))*2
1586  ;
1587   
1588  con11h_3_pro_stolev_start_M2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) 
      = 1)..
1589          STO_L_M2PRO(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_P
      RO(n,sto) + STO_IN_M2PRO(n,sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT_M2PRO(n,s
      to,h)/(1+eta_sto(n,sto))*2
1590  ;
1591   
1592  con11h_4_pro_stolev_start_M2M(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) = 
      1)..
1593          STO_L_M2M(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_PRO
      (n,sto) + STO_IN_M2M(n,sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT_M2M(n,sto,h)/
      (1+eta_sto(n,sto))*2
1594  ;
1595   
1596  con11i_pro_stolev(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h)>1)..
1597           STO_L_PRO(n,sto,h) =E=   STO_L_PRO2PRO(n,sto,h) +  STO_L_PRO2M(n,
      sto,h) + STO_L_M2PRO(n,sto,h) + STO_L_M2M(n,sto,h)
1598  ;
1599   
1600  con11j_pro_stolev_max(n,sto,h)..
1601          STO_L_PRO(n,sto,h) =L= N_STO_E_PRO(n,sto)
1602  ;
1603   
1604  con11k_pro_maxin_sto(n,sto,h)$(map_n_sto_pro(n,sto))..
1605          sum( map_n_res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN_P
      RO2M(n,res,sto,h) ) + STO_IN_M2PRO(n,sto,h) + STO_IN_M2M(n,sto,h)
1606          =L= N_STO_P_PRO(n,sto)
1607  ;
1608   
1609  con11l_pro_maxout_sto(n,sto,h)$(map_n_sto_pro(n,sto))..
1610          STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_PRO2M(n,sto,h) + STO_OUT_M2PRO(
      n,sto,h) + STO_OUT_M2M(n,sto,h)
1611          =L= N_STO_P_PRO(n,sto)
1612  ;
1613   
1614  con11m_pro_maxout_lev(n,sto,h)$(map_n_sto_pro(n,sto))..
1615          ( STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_M2PRO(n,sto,h) + STO_OUT_PRO2
      M(n,sto,h) + STO_OUT_M2M(n,sto,h) ) / (1+eta_sto(n,sto))*2
1616          =L= STO_L_PRO(n,sto,h-1)
1617  ;
1618   
1619  con11n_pro_maxin_lev(n,sto,h)$(map_n_sto_pro(n,sto))..
1620          ( sum( map_n_res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN
      _PRO2M(n,res,sto,h) ) + STO_IN_M2PRO(n,sto,h) + STO_IN_M2M(n,sto,h) ) * (1
      +eta_sto(n,sto))/2
1621          =L= N_STO_E_PRO(n,sto) - STO_L_PRO(n,sto,h-1)
1622  ;
1623   
1624  con11o_pro_ending(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) = card(h))..
1625           STO_L_PRO(n,sto,h) =E= phi_sto_pro_ini(n,sto) * N_STO_E_PRO(n,sto
      )
1626  ;
1627   
1628  **************************************************************************
      ******
1629  ***** MODEL *****
1630  **************************************************************************
      ******
1631   
1632  model DIETER /
1633  obj
1634   
1635  con1a_bal
1636   
1637  con2a_loadlevel
1638  con2b_loadlevelstart
1639   
1640  con3a_maxprod_dispatchable
1641   
1642  con3e_maxprod_res
1643   
1644   
1645   
1646  con4a_stolev_start
1647  con4b_stolev
1648  con4c_stolev_max
1649  con4d_maxin_sto
1650  con4e_maxout_sto
1651   
1652  con4j_ending
1653  con4k_PHS_EtoP
1654   
1655  con5a_minRES
1656  con5b_max_energy
1657   
1658   
1659  con8a_max_I_power
1660  con8b_max_I_sto_e
1661  con8c_max_I_sto_p
1662   
      con8f_max_pro_res
      con8g_max_pro_sto_e
      con8h_max_sto_pro_p
      con11a_pro_distrib
      con11b_pro_balance
      con11c_pro_selfcon
      con11d_pro_stolev_PRO2PRO
      con11e_pro_stolev_PRO2M
      con11f_pro_stolev_M2PRO
      con11g_pro_stolev_M2M
      con11h_1_pro_stolev_start_PRO2PRO
      con11h_2_pro_stolev_start_PRO2M
      con11h_3_pro_stolev_start_M2PRO
      con11h_4_pro_stolev_start_M2M
      con11i_pro_stolev
      con11j_pro_stolev_max
      con11k_pro_maxin_sto
      con11l_pro_maxout_sto
      con11m_pro_maxout_lev
      con11n_pro_maxin_lev
      con11o_pro_ending
      $ontext
1687   
1688   
1689  /;
1690   
1691   
1692   
1693   
1694  **************************************************************************
      ******
1695  ***** Options, fixings, report preparation *****
1696  **************************************************************************
      ******
1697   
1698  * Solver options
1704   
      $onecho > cplex.opt
      lpmethod 4
      threads 4
      epgap 1e-3
      barcrossalg -1
      barepcomp 1e-8
      $offecho
      $ontext
1715   
1716  dieter.OptFile = 1;
1717  dieter.holdFixed = 1 ;
1718   
1719   
1720   
1721   
1722  **************************************************************************
      ******
1723  ***** Solve *****
1724  **************************************************************************
      ******
1725   
1726  * Preparation of GUSS tool for scenario analysis
1727  phi_min_res = eps ;
1728  ev_quant = eps ;
1729  phi_pro_self = eps ;
1730   
1732   
1733  Set
1734  modelstats       model stats collection                  /modelstat, solve
      stat, resusd/
1735  superscen        Scenarios                               /scen1*scen1000/
1736  map(superscen,loop_res_share,loop_ev,loop_prosumage)    /#superscen:(#loop
      _res_share.#loop_ev.#loop_prosumage)/
1737  ;
1738   
1739  set
1740  scen(superscen);
1741  scen(superscen) = yes$( sum((loop_res_share,loop_ev,loop_prosumage) , map(
      superscen,loop_res_share,loop_ev,loop_prosumage)) )    ;
1742   
1743  Parameters
1744  gussoptions                              /Logoption 2, Optfile 1, Skipbase
      case 1/
1745  modstats(superscen, modelstats)
1746  min_res
1747  number_ev
1748  pro_selfcon
1749  ;
1750   
1751  min_res(scen) = sum( (loop_res_share,loop_ev,loop_prosumage)$map(scen,loop
      _res_share,loop_ev,loop_prosumage) , loop_res_share.val/100 ) ;
1752  number_ev(scen) = sum( (loop_res_share,loop_ev,loop_prosumage)$map(scen,lo
      op_res_share,loop_ev,loop_prosumage) , loop_ev.val ) ;
1753  pro_selfcon(scen) = sum( (loop_res_share,loop_ev,loop_prosumage)$map(scen,
      loop_res_share,loop_ev,loop_prosumage) , loop_prosumage.val/100 ) ;
1754   
1755  Parameters
1756  * Equations
1757  marginal_con5a(superscen,*)
1758  marginal_con1a(superscen,*,*)
1759  marginal_con9a(superscen,*,*,*)
1760  marginal_con9b(superscen,*,*,*)
1761   
1762  * Basic
1763  lev_Z(superscen)
1764  lev_G_L(superscen,n,tech,h)
1765  lev_G_UP(superscen,n,tech,h)
1766  lev_G_DO(superscen,n,tech,h)
1767  lev_G_RES(superscen,n,tech,h)
1768  lev_CU(superscen,n,tech,h)
1769  lev_STO_IN(superscen,n,sto,h)
1770  lev_STO_OUT(superscen,n,sto,h)
1771  lev_STO_L(superscen,n,sto,h)
1772  lev_N_TECH(superscen,n,tech)
1773  lev_N_STO_E(superscen,n,sto)
1774  lev_N_STO_P(superscen,n,sto)
1775  lev_NTC(superscen,l)
1776  lev_F(superscen,l,h)
1777  lev_RSVR_OUT(superscen,n,rsvr,h)
1778  lev_RSVR_L(superscen,n,rsvr,h)
1779  lev_N_RSVR_E(superscen,n,rsvr)
1780  lev_N_RSVR_P(superscen,n,rsvr)
1781   
1782  * EV
1783  lev_EV_CHARGE(superscen,n,ev,h)
1784  lev_EV_DISCHARGE(superscen,n,ev,h)
1785  lev_EV_L(superscen,n,ev,h)
1786  lev_EV_PHEVFUEL(superscen,n,ev,h)
1787  lev_EV_GED(superscen,n,ev,h)
1788   
1789  * DSM
1790  lev_DSM_CU(superscen,n,dsm,h)
1791  lev_DSM_UP(superscen,n,dsm,h)
1792  lev_DSM_DO(superscen,n,dsm,h,hh)
1793  lev_DSM_UP_DEMAND(superscen,n,dsm,h)
1794  lev_DSM_DO_DEMAND(superscen,n,dsm,h)
1795  lev_N_DSM_CU(superscen,n,dsm)
1796  lev_N_DSM_SHIFT(superscen,n,dsm)
1797   
1798  * Reserves
1799  lev_RP_DIS(superscen,n,reserves,tech,h)
1800  lev_RP_NONDIS(superscen,n,reserves,tech,h)
1801  lev_RP_STO_IN(superscen,n,reserves,sto,h)
1802  lev_RP_STO_OUT(superscen,n,reserves,sto,h)
1803  lev_RP_RSVR(superscen,n,reserves,rsvr,h)
1804   
1805  * EV & reserves
1806  lev_RP_EV_V2G(superscen,n,reserves,ev,h)
1807  lev_RP_EV_G2V(superscen,n,reserves,ev,h)
1808   
1809  * DSM $ reserves
1810  lev_RP_DSM_CU(superscen,n,reserves,dsm,h)
1811  lev_RP_DSM_SHIFT(superscen,n,reserves,dsm,h)
1812   
1813  * Prosumage
1814  lev_CU_PRO(superscen,n,tech,h)
1815  lev_G_MARKET_PRO2M(superscen,n,tech,h)
1816  lev_G_MARKET_M2PRO(superscen,n,h)
1817  lev_G_RES_PRO(superscen,n,tech,h)
1818  lev_STO_IN_PRO2PRO(superscen,n,tech,sto,h)
1819  lev_STO_IN_PRO2M(superscen,n,tech,sto,h)
1820  lev_STO_IN_M2PRO(superscen,n,sto,h)
1821  lev_STO_IN_M2M(superscen,n,sto,h)
1822  lev_STO_OUT_PRO2PRO(superscen,n,sto,h)
1823  lev_STO_OUT_PRO2M(superscen,n,sto,h)
1824  lev_STO_OUT_M2PRO(superscen,n,sto,h)
1825  lev_STO_OUT_M2M(superscen,n,sto,h)
1826  lev_STO_L_PRO2PRO(superscen,n,sto,h)
1827  lev_STO_L_PRO2M(superscen,n,sto,h)
1828  lev_STO_L_M2PRO(superscen,n,sto,h)
1829  lev_STO_L_M2M(superscen,n,sto,h)
1830  lev_N_STO_E_PRO(superscen,n,sto)
1831  lev_N_STO_P_PRO(superscen,n,sto)
1832  lev_STO_L_PRO(superscen,n,sto,h)
1833  lev_N_RES_PRO(superscen,n,tech)
1834   
1835  * Heat
1836  lev_H_DIR(superscen,n,bu,ch,h)
1837  lev_H_SETS_LEV(superscen,n,bu,ch,h)
1838  lev_H_SETS_IN(superscen,n,bu,ch,h)
1839  lev_H_SETS_OUT(superscen,n,bu,ch,h)
1840  lev_H_HP_IN(superscen,n,bu,ch,h)
1841  lev_H_STO_LEV(superscen,n,bu,ch,h)
1842  lev_H_STO_IN_HP(superscen,n,bu,ch,h)
1843  lev_H_STO_IN_ELECTRIC(superscen,n,bu,ch,h)
1844  lev_H_ELECTRIC_IN(superscen,n,bu,ch,h)
1845  lev_H_STO_IN_FOSSIL(superscen,n,bu,ch,h)
1846  lev_H_STO_OUT(superscen,n,bu,ch,h)
1847   
1848  lev_H_DHW_STO(superscen,n,bu,ch,h)
1849  lev_H_DHW_STO_OUT(superscen,n,bu,ch,h)
1850  lev_H_DHW_DIR(superscen,n,bu,ch,h)
1851   
1852  lev_H_DHW_AUX_ELEC_IN(superscen,n,bu,ch,h)
1853  lev_H_DHW_AUX_LEV(superscen,n,bu,ch,h)
1854  lev_H_DHW_AUX_OUT(superscen,n,bu,ch,h)
1855   
1856   
1857  lev_RP_SETS(superscen,n,reserves,bu,ch,h)
1858  lev_RP_HP(superscen,n,reserves,bu,ch,h)
1859  lev_RP_H_ELEC(superscen,n,reserves,bu,ch,h)
1860  lev_RP_SETS_AUX(superscen,n,reserves,bu,ch,h)
1861   
1862  * Infeasibility
1863  lev_G_INFES(superscen,n,h)
1864  ;
1865   
1866   
1867  * Inclusion of scenario and fixing
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\fix.gms
1869   
1870  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
1880  **************************************************************************
      ******
1881   
1882   
1883   
1884  **************************************************************************
      ******
1885  **** Run of river  *******************************************************
      ******
1886  **************************************************************************
      ******
1887   
1888  * If $setglobal ror_parameter "*": choose appropriate value for N_CON.fx('
      ror') (but no reserve provision):
1889   
      N_TECH.fx(n,'ror') = 5857.47 ;
      G_RES.fx(n,'ror',h) = N_TECH.l(n,'ror') * phi_res(n,'ror',h) ;
      %reserves%$ontext
      RP_NONDIS.fx(n,reserves,'ror',h) = 0 ;
      $ontext
1897   
1898  * Fix everything to zero in case no ROR option is selected:
1899  *N_TECH.fx(n,'ror') = 0 ;
1900  *G_RES.fx(n,'ror',h) = 0 ;
1901  *RP_NONDIS.fx(n,reserves,'ror',h) = 0 ;
1902   
1903   
1904   
1905  **************************************************************************
      ******
1906  **** Exogenous EV  *******************************************************
      ******
1907  **************************************************************************
      ******
1908   
      %EV_EXOG%$ontext
      EV_DISCHARGE.fx(n,ev,h) = 0 ;
      RP_EV_G2V.fx(n,reserves,ev,h) = 0 ;
      RP_EV_V2G.fx(n,reserves,ev,h) = 0 ;
      $ontext
1916   
1917   
1918   
1919  **************************************************************************
      ******
1920  **** No storage and DSM in first period  *********************************
      ******
1921  **************************************************************************
      ******
1922   
1923  ** No storage inflow in first period **
1924  STO_IN.fx(n,sto,h)$(ord(h) = 1) = 0;
1925   
      ** No DSM load shifting in the first period **
      DSM_UP.fx(n,dsm_shift,h)$(ord(h) = 1) = 0;
      DSM_DO.fx(n,dsm_shift,h,hh)$(ord(h) = 1) = 0 ;
      DSM_DO.fx(n,dsm_shift,h,h)$(ord(h) = 1) = 0 ;
      DSM_UP_DEMAND.fx(n,dsm_shift,h)$(ord(h) = 1) = 0 ;
      DSM_DO_DEMAND.fx(n,dsm_shift,h)$(ord(h) = 1) = 0 ;
       
      ** No reserves provision by DSM in first period **
      RP_DSM_SHIFT.fx(n,reserves,dsm_shift,h)$(ord(h) = 1) = 0;
      RP_DSM_CU.fx(n,reserves,dsm_curt,h)$(ord(h) = 1) = 0 ;
      RP_DSM_CU.fx(n,reserves,dsm_curt,h)$(ord(h) = 1) = 0 ;
       
      ** No provision of PR and negative reserves by DSM load curtailment **
      RP_DSM_CU.fx(n,reserves_prim,dsm_curt,h) = 0 ;
      RP_DSM_CU.fx(n,reserves_do,dsm_curt,h) = 0 ;
       
      ** No provision of PR by DSM load shifting **
      RP_DSM_SHIFT.fx(n,reserves_prim,dsm_shift,h) = 0 ;
      $ontext
1947   
1948   
1949   
1950  **************************************************************************
      ******
1951  **** No primary reserves by heating devices  *****************************
      ******
1952  **************************************************************************
      ******
1953   
      %reserves%$ontext
      RP_HP.fx(n,reserves_prim,bu,hp,h) = 0 ;
      RP_SETS.fx(n,reserves_prim,bu,ch,h) = 0 ;
      RP_SETS_AUX.fx(n,reserves_prim,bu,ch,h) = 0 ;
      RP_H_ELEC.fx(n,reserves_prim,bu,ch,h) = 0 ;
      $ontext
1962   
1963   
1964   
1965  **************************************************************************
      ******
1966  **** Fixing to reduce model size  ****************************************
      ******
1967  **************************************************************************
      ******
1968   
1969  F.fx(l,h)$(m_ntc(l) = 0) = 0 ;
1970  NTC.fx(l)$(m_ntc(l) = 0) = 0 ;
1971   
1972  G_L.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
1973  G_UP.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
1974  G_DO.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
1975  N_TECH.fx(n,tech)$(m_p(n,tech) = 0) = 0 ;
1976  G_RES.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
1977  CU.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
1978   
1979  N_STO_P.fx(n,sto)$(m_sto_p(n,sto) = 0) = 0 ;
1980  N_STO_E.fx(n,sto)$(m_sto_e(n,sto) = 0) = 0 ;
1981  STO_IN.fx(n,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
1982  STO_OUT.fx(n,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
1983  STO_L.fx(n,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
1984  RP_STO_IN.fx(n,reserves,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
1985  RP_STO_OUT.fx(n,reserves,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
1986   
1987  RSVR_OUT.fx(n,rsvr,h)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
1988  RSVR_L.fx(n,rsvr,h)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
1989  N_RSVR_E.fx(n,rsvr)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
1990  N_RSVR_P.fx(n,rsvr)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
1991   
      RP_DIS.fx(n,reserves,tech,h)$(feat_node('reserves',n) = 0 OR m_p(n,tech) =
       0) = 0 ;
      RP_NONDIS.fx(n,reserves,tech,h)$(feat_node('reserves',n) = 0 OR m_p(n,tech
      ) = 0) = 0 ;
      RP_STO_IN.fx(n,reserves,sto,h)$(feat_node('reserves',n) = 0 OR m_sto_p(n,s
      to) = 0) = 0 ;
      RP_STO_OUT.fx(n,reserves,sto,h)$(feat_node('reserves',n) = 0 OR m_sto_p(n,
      sto) = 0) = 0 ;
      RP_EV_V2G.fx(n,reserves,ev,h)$(feat_node('reserves',n) = 0) = 0 ;
      RP_EV_G2V.fx(n,reserves,ev,h)$(feat_node('reserves',n) = 0) = 0 ;
      RP_DSM_CU.fx(n,reserves,dsm_curt,h)$(feat_node('reserves',n) = 0 OR m_dsm_
      cu(n,dsm_curt) = 0) = 0 ;
      RP_DSM_SHIFT.fx(n,reserves,dsm_shift,h)$(feat_node('reserves',n) = 0 OR m_
      dsm_shift(n,dsm_shift) = 0) = 0 ;
      RP_RSVR.fx(n,reserves,rsvr,h)$(feat_node('reserves',n) = 0  OR m_rsvr_p(n,
      rsvr) = 0) = 0 ;
      $ontext
2004   
      CU_PRO.fx(n,res,h)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,res) = 0) 
      = 0 ;
      G_MARKET_PRO2M.fx(n,res,h)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,re
      s) = 0) = 0 ;
      G_MARKET_M2PRO.fx(n,h)$(feat_node('prosumage',n) = 0) = 0 ;
      G_RES_PRO.fx(n,res,h)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,res) = 
      0) = 0 ;
      STO_IN_PRO2PRO.fx(n,res,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_
      p(n,sto) = 0) = 0 ;
      STO_IN_PRO2M.fx(n,res,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(
      n,sto) = 0) = 0 ;
      STO_IN_M2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,st
      o) = 0) = 0 ;
      STO_IN_M2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto)
       = 0) = 0 ;
      STO_OUT_PRO2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n
      ,sto) = 0) = 0 ;
      STO_OUT_PRO2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,s
      to) = 0) = 0 ;
      STO_OUT_M2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,s
      to) = 0) = 0 ;
      STO_OUT_M2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto
      ) = 0) = 0 ;
      STO_L_PRO2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,s
      to) = 0) = 0 ;
      STO_L_PRO2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto
      ) = 0) = 0 ;
      STO_L_M2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto
      ) = 0) = 0 ;
      STO_L_M2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
      N_STO_E_PRO.fx(n,sto)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
      N_STO_P_PRO.fx(n,sto)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
      STO_L_PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
      N_RES_PRO.fx(n,res)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,res) = 0)
       = 0 ;
      $ontext
2028   
      EV_CHARGE.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_DISCHARGE.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_L.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_PHEVFUEL.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_GED.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      RP_EV_V2G.fx(n,reserves,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      RP_EV_G2V.fx(n,reserves,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      $ontext
2039   
2040  *%heat%
      H_DIR.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_SETS_LEV.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_SETS_IN.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_SETS_OUT.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_HP_IN.up(n,bu,ch,hh)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_LEV.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_IN_HP.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_IN_ELECTRIC.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_IN_NONELECTRIC.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_OUT.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      $ontext
2054   
2055   
2056   
2057  **************************************************************************
      ******
2058  **** DEFAULT LEVELS FOR REPORT PARAMETERS  *******************************
      ******
2059  **************************************************************************
      ******
2060   
2061  * Default level zero for report parameters
2062  lev_Z(scen) = 0 ;
2063  lev_G_L(scen,n,tech,h) = 0 ;
2064  lev_G_UP(scen,n,tech,h) = 0 ;
2065  lev_G_DO(scen,n,tech,h) = 0 ;
2066  lev_G_RES(scen,n,tech,h) = 0 ;
2067  lev_CU(scen,n,tech,h) = 0 ;
2068  lev_STO_IN(scen,n,sto,h) = 0 ;
2069  lev_STO_OUT(scen,n,sto,h) = 0 ;
2070  lev_STO_L(scen,n,sto,h) = 0 ;
2071  lev_N_TECH(scen,n,tech) = 0 ;
2072  lev_N_STO_E(scen,n,sto) = 0 ;
2073  lev_N_STO_P(scen,n,sto) = 0 ;
2074  marginal_con1a(scen,h,n) = 0 ;
2075  marginal_con5a(superscen,n) = 0 ;
2076  lev_NTC(superscen,l) = 0 ;
2077  lev_F(superscen,l,h) = 0 ;
2078  lev_RSVR_OUT(superscen,n,rsvr,h) = 0 ;
2079  lev_RSVR_L(superscen,n,rsvr,h) = 0 ;
2080  lev_N_RSVR_E(superscen,n,rsvr) = 0 ;
2081  lev_N_RSVR_P(superscen,n,rsvr) = 0 ;
2082  lev_G_INFES(superscen,n,h) = 0 ;
2083   
2084  * EV
2085  lev_EV_CHARGE(scen,n,ev,h) = 0 ;
2086  lev_EV_DISCHARGE(scen,n,ev,h) = 0 ;
2087  lev_EV_L(scen,n,ev,h) = 0 ;
2088  lev_EV_PHEVFUEL(scen,n,ev,h) = 0 ;
2089  lev_EV_GED(scen,n,ev,h) = 0 ;
2090   
2091  * DSM
2092  lev_DSM_CU(scen,n,dsm,h) = 0 ;
2093  lev_DSM_UP(scen,n,dsm,h) = 0 ;
2094  lev_DSM_DO(scen,n,dsm,h,hh) = 0 ;
2095  lev_DSM_UP_DEMAND(scen,n,dsm,h) = 0 ;
2096  lev_DSM_DO_DEMAND(scen,n,dsm,h) = 0 ;
2097  lev_N_DSM_CU(scen,n,dsm) = 0 ;
2098  lev_N_DSM_SHIFT(scen,n,dsm) = 0 ;
2099   
2100  * Reserves
2101  lev_RP_DIS(scen,n,reserves,dis,h) = 0 ;
2102  lev_RP_NONDIS(scen,n,reserves,nondis,h) = 0 ;
2103  lev_RP_STO_IN(scen,n,reserves,sto,h) = 0 ;
2104  lev_RP_STO_OUT(scen,n,reserves,sto,h) = 0 ;
2105  lev_RP_RSVR(superscen,n,reserves,rsvr,h) = 0 ;
2106   
2107  * EV & reserves
2108  lev_RP_EV_V2G(scen,n,reserves,ev,h) = 0 ;
2109  lev_RP_EV_G2V(scen,n,reserves,ev,h) = 0 ;
2110   
2111  * DSM & reserves
2112  lev_RP_DSM_CU(scen,n,reserves,dsm_curt,h) = 0 ;
2113  lev_RP_DSM_SHIFT(scen,n,reserves,dsm_shift,h) = 0 ;
2114   
2115  * Prosumage
2116  lev_CU_PRO(scen,n,tech,h) = 0 ;
2117  lev_G_MARKET_PRO2M(scen,n,tech,h) = 0  ;
2118  lev_G_MARKET_M2PRO(scen,n,h) = 0  ;
2119  lev_G_RES_PRO(scen,n,tech,h) = 0  ;
2120  lev_STO_IN_PRO2PRO(scen,n,tech,sto,h) = 0  ;
2121  lev_STO_IN_PRO2M(scen,n,tech,sto,h) = 0  ;
2122  lev_STO_IN_M2PRO(scen,n,sto,h) = 0   ;
2123  lev_STO_IN_M2M(scen,n,sto,h) = 0  ;
2124  lev_STO_OUT_PRO2PRO(scen,n,sto,h) = 0  ;
2125  lev_STO_OUT_PRO2M(scen,n,sto,h) = 0  ;
2126  lev_STO_OUT_M2PRO(scen,n,sto,h) = 0  ;
2127  lev_STO_OUT_M2M(scen,n,sto,h) = 0  ;
2128  lev_STO_L_PRO2PRO(scen,n,sto,h) = 0  ;
2129  lev_STO_L_PRO2M(scen,n,sto,h) = 0  ;
2130  lev_STO_L_M2PRO(scen,n,sto,h) = 0  ;
2131  lev_STO_L_M2M(scen,n,sto,h) = 0  ;
2132  lev_N_STO_E_PRO(scen,n,sto) = 0  ;
2133  lev_N_STO_P_PRO(scen,n,sto) = 0  ;
2134  lev_STO_L_PRO(scen,n,sto,h) = 0  ;
2135  lev_N_RES_PRO(scen,n,tech) = 0  ;
2136   
2137  * Heat
2138  lev_H_DIR(superscen,n,bu,ch,h) = 0 ;
2139  lev_H_SETS_LEV(superscen,n,bu,ch,h) = 0 ;
2140  lev_H_SETS_IN(superscen,n,bu,ch,h) = 0 ;
2141  lev_H_SETS_OUT(superscen,n,bu,ch,h) = 0 ;
2142  lev_H_HP_IN(superscen,n,bu,ch,h) = 0 ;
2143  lev_H_STO_LEV(superscen,n,bu,ch,h) = 0 ;
2144  lev_H_STO_IN_HP(superscen,n,bu,ch,h) = 0 ;
2145  lev_H_STO_IN_ELECTRIC(superscen,n,bu,ch,h) = 0 ;
2146  lev_H_STO_IN_FOSSIL(superscen,n,bu,ch,h) = 0 ;
2147  lev_H_STO_OUT(superscen,n,bu,ch,h) = 0 ;
2148   
2149  * Heat - DHW
2150  lev_H_DHW_DIR(superscen,n,bu,ch,h) = 0  ;
2151  lev_H_DHW_STO_OUT(superscen,n,bu,ch,h) = 0  ;
2152  lev_H_DHW_AUX_ELEC_IN(superscen,n,bu,ch,h) = 0  ;
2153  lev_H_DHW_AUX_LEV(superscen,n,bu,ch,h) = 0  ;
2154  lev_H_DHW_AUX_OUT(superscen,n,bu,ch,h) = 0  ;
2155   
2156  * Heat & reserves
2157  lev_RP_SETS_AUX(superscen,n,reserves,bu,ch,h) = 0 ;
2158  lev_RP_SETS(superscen,n,reserves,bu,ch,h) = 0 ;
2159  lev_RP_HP(superscen,n,reserves,bu,ch,h) = 0 ;
2160  lev_RP_H_ELEC(superscen,n,reserves,bu,ch,h) = 0 ;
2161   
2162   
2163  * Fixing of report parameters for run-of-river
      lev_N_TECH(scen,n,'ror') = 5857.47 ;
      lev_G_RES(scen,n,'ror',h) = lev_N_TECH(scen,n,'ror') * phi_res(n,'ror',h) 
      ;
      %reserves%$ontext
      lev_RP_NONDIS(scen,n,reserves,'ror',h) = 0 ;
      $ontext
2171   
2172  *lev_N_TECH(scen,n,'ror') = 0 ;
2173  *lev_G_RES(scen,n,'ror',h) = 0 ;
      %ror_parameter%%ror_variable%lev_RP_CON(scen,n,reserves,'ror',h) = 0 ;
      $ontext
2178   
2179   
2180   
2181   
2182   
2183   
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\scenario.gms
2185   
2186  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
2196  **************************************************************************
      ******
2197   
2198   
2199   
2200   
2201  *****************************************
2202  **** Scenario file                   ****
2203  ****                                 ****
2204  *****************************************
2205   
2206  Parameter
2207  m_exog_p(n,tech)
2208  m_exog_sto_e(n,sto)
2209  m_exog_sto_p(n,sto)
2210  m_exog_rsvr_p(n,rsvr)
2211  m_exog_ntc(l)
2212  ;
2213   
2214  m_exog_p(n,tech) = technology_data(n,tech,'fixed_capacities') ;
2215  m_exog_sto_e(n,sto) = storage_data(n,sto,'fixed_capacities_energy');
2216  m_exog_sto_p(n,sto) = storage_data(n,sto,'fixed_capacities_power');
2217  m_exog_rsvr_p(n,rsvr) = reservoir_data(n,rsvr,'fixed_capacities_power');
2218  m_exog_ntc(l) = topology_data(l,'fixed_capacities_ntc') ;
2219   
2220   
2221  *** Dispatch model
      N_TECH.lo(n,tech) = m_exog_p(n,tech) ;
      N_STO_P.lo(n,sto) = m_exog_sto_p(n,sto) ;
      N_STO_E.lo(n,sto) = m_exog_sto_e(n,sto) ;
      N_RSVR_P.lo(n,rsvr) =  m_exog_rsvr_p(n,rsvr) ;
      NTC.lo(l) = m_exog_ntc(l) ;
       
      N_TECH.up(n,tech) = m_exog_p(n,tech) + 0.1 ;
      N_STO_P.up(n,sto) = m_exog_sto_p(n,sto) + 0.1 ;
      N_STO_E.up(n,sto) = m_exog_sto_e(n,sto) + 0.1 ;
      N_RSVR_P.up(n,rsvr) =  m_exog_rsvr_p(n,rsvr) + 0.1 ;
      NTC.up(l) = m_exog_ntc(l) + 0.1 ;
       
      *N_TECH.lo(n,'OCGT') = m_exog_p(n,'OCGT') ;
      *N_TECH.up(n,'OCGT') = inf ;
2238   
2239  *** Investment model
2240  *$ontext
2241  N_TECH.lo(n,tech) = 0 ;
2242  N_TECH.lo(n,'wind_on') = m_exog_p(n,'wind_on') ;
2243  N_TECH.lo(n,'wind_off') = m_exog_p(n,'wind_off') ;
2244  N_TECH.lo(n,'pv') = m_exog_p(n,'pv') ;
2245  N_STO_P.lo(n,sto) = m_exog_sto_p(n,sto) ;
2246  N_STO_E.lo(n,sto) = m_exog_sto_e(n,sto) ;
2247  N_RSVR_P.lo(n,rsvr) =  m_exog_rsvr_p(n,rsvr) ;
2248  NTC.lo(l) = m_exog_ntc(l) ;
2249   
2250  N_TECH.up(n,tech) = m_exog_p(n,tech) + 0.1 ;
2251  N_TECH.up(n,'wind_on') = inf ;
2252  N_TECH.up(n,'wind_off') = inf ;
2253  N_TECH.up(n,'pv') = inf ;
2254  N_STO_P.up(n,sto) = m_exog_sto_p(n,sto) + 0.1 ;
2255  N_STO_E.up(n,sto) = m_exog_sto_e(n,sto) + 0.1 ;
2256  N_STO_P.up(n,'sto1') = inf ;
2257  N_STO_P.up(n,'sto5') = inf ;
2258  N_STO_P.up(n,'sto7') = inf ;
2259  N_STO_E.up(n,'sto1') = inf ;
2260  N_STO_E.up(n,'sto5') = inf ;
2261  N_STO_E.up(n,'sto7') = inf ;
2262  N_RSVR_P.up(n,rsvr) =  m_exog_rsvr_p(n,rsvr) + 0.1 ;
2263  NTC.up(l) = m_exog_ntc(l) + 0.1 ;
2264  *$offtext
2265   
2266   
2267  *** Reservoir assumption - not used here
2268  *phi_rsvr_lev_min(n,rsvr) = 0.0 ;
2269  *%GER_only%N_RSVR_E.lo('FR',rsvr) = 600 * m_exog_rsvr_p('FR',rsvr) ;
2270  *%GER_only%N_RSVR_E.lo('AT',rsvr) = 1700 * m_exog_rsvr_p('AT',rsvr) ;
2271  *%GER_only%N_RSVR_E.lo('CH',rsvr) = 3000 * m_exog_rsvr_p('CH',rsvr) ;
2272   
2273   
2274  *** Germany only, no infeasibility
2275  NTC.fx(l) = 0 ;
2276  F.fx(l,h) = 0 ;
2277  G_INFES.fx(n,h) = 0 ;
2278   
2279   
2280  *** Heating
2281  Parameter
2282  security_margin_n_heat_out /1.0/
2283  ;
2284   
2285  * Parameterization of water-based heat storage
2286  n_heat_p_out(n,bu,ch) = security_margin_n_heat_out * smax( h , dh(n,bu,ch,
      h) + d_dhw(n,bu,ch,h) ) ;
2287  n_heat_e(n,bu,ch) = 3 * n_heat_p_out(n,bu,ch) ;
2288  n_heat_p_in(n,bu,ch) = n_heat_p_out(n,bu,ch) ;
2289  n_heat_p_in(n,bu,'hp_gs') = n_heat_p_out(n,bu,'hp_gs') / ( eta_heat_dyn(n,
      bu,'hp_gs') * (temp_sink(n,bu,'hp_gs')+273.15) / (temp_sink(n,bu,'hp_gs') 
      - 10) ) ;
2290  * at least -5°C; applied to 98% of hoursn; minimum: -13.4
2291  n_heat_p_in(n,bu,'hp_as') = n_heat_p_out(n,bu,'hp_as') / ( eta_heat_dyn(n,
      bu,'hp_as') * (temp_sink(n,bu,'hp_as')+273.15) / (temp_sink(n,bu,'hp_as') 
      + 5) ) ;
2292   
2293  * Parameterization of SETS
2294  n_sets_p_out(n,bu,ch) = security_margin_n_heat_out * smax( h , dh(n,bu,ch,
      h) ) ;
2295  n_sets_p_in(n,bu,ch) = 2 * n_sets_p_out(n,bu,ch) ;
2296  n_sets_e(n,bu,ch) = 16 * n_sets_p_out(n,bu,ch) ;
2297   
2298  * Parameterization of DHW SETS
2299  n_sets_dhw_p_out(n,bu,ch) = security_margin_n_heat_out * smax( h , d_dhw(n
      ,bu,ch,h) ) ;
2300  n_sets_dhw_p_in(n,bu,ch) = n_sets_dhw_p_out(n,bu,ch) ;
2301  n_sets_dhw_e(n,bu,ch) = 2.2 * n_sets_dhw_p_out(n,bu,ch) ;
2302   
2303  *RP_SETS_AUX.fx(n,reserves,bu,ch,h) = 0 ;
2304  *RP_SETS.fx(n,reserves,bu,ch,h) = 0 ;
2305  *RP_HP.fx(n,reserves,bu,ch,h) = 0 ;
2306  *RP_H_ELEC.fx(n,reserves,bu,ch,h) = 0 ;
2307   
2308   
2309  * Definition of dictionary set for GUSS tool
2310  Set dict(*,*,*) /
2311  scen             .scenario       .''
2312  gussoptions      .opt            .modstats
2313   
2314  phi_min_res      .param          .min_res
      ev_quant         .param          .number_ev
      $ontext
      phi_pro_self     .param          .pro_selfcon
      $ontext
2323   
2324  con5a_minRES     .marginal       .marginal_con5a
2325  con1a_bal        .marginal       .marginal_con1a
2326   
2327  Z                .level          .lev_Z
2328  G_L              .level          .lev_G_L
2329  G_UP             .level          .lev_G_UP
2330  G_DO             .level          .lev_G_DO
2331  G_RES            .level          .lev_G_RES
2332  CU               .level          .lev_CU
2333  STO_IN           .level          .lev_STO_IN
2334  STO_OUT          .level          .lev_STO_OUT
2335  STO_L            .level          .lev_STO_L
2336  N_TECH           .level          .lev_N_TECH
2337  N_STO_E          .level          .lev_N_STO_E
2338  N_STO_P          .level          .lev_N_STO_P
2339  *NTC              .level          .lev_NTC
2340  *F                .level          .lev_F
2341  *RSVR_OUT         .level          .lev_RSVR_OUT
2342  *RSVR_L           .level          .lev_RSVR_L
2343  *N_RSVR_E         .level          .lev_N_RSVR_E
2344  *N_RSVR_P         .level          .lev_N_RSVR_P
2345   
      CU_PRO           .level          .lev_CU_PRO
      G_MARKET_PRO2M   .level          .lev_G_MARKET_PRO2M
      G_MARKET_M2PRO   .level          .lev_G_MARKET_M2PRO
      G_RES_PRO        .level          .lev_G_RES_PRO
      STO_IN_PRO2PRO   .level          .lev_STO_IN_PRO2PRO
      STO_IN_PRO2M     .level          .lev_STO_IN_PRO2M
      STO_IN_M2PRO     .level          .lev_STO_IN_M2PRO
      STO_IN_M2M       .level          .lev_STO_IN_M2M
      STO_OUT_PRO2PRO  .level          .lev_STO_OUT_PRO2PRO
      STO_OUT_PRO2M    .level          .lev_STO_OUT_PRO2M
      STO_OUT_M2PRO    .level          .lev_STO_OUT_M2PRO
      STO_OUT_M2M      .level          .lev_STO_OUT_M2M
      STO_L_PRO        .level          .lev_STO_L_PRO
      STO_L_PRO2PRO    .level          .lev_STO_L_PRO2PRO
      STO_L_PRO2M      .level          .lev_STO_L_PRO2M
      STO_L_M2PRO      .level          .lev_STO_L_M2PRO
      STO_L_M2M        .level          .lev_STO_L_M2M
      N_STO_E_PRO      .level          .lev_N_STO_E_PRO
      N_STO_P_PRO      .level          .lev_N_STO_P_PRO
      N_RES_PRO        .level          .lev_N_RES_PRO
      $ontext
2369   
2370  /
2371  ;
2372   
2373   
2374  solve DIETER using lp min Z scenario dict;
2375   
2376   
2377  * Reporting
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\report.gms
2379   
2380  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
2390  **************************************************************************
      ******
2391   
2393   
2394   
2395   
2396   
2397  **************************************************************************
      ******
2398  **** Parameters for report file  *****************************************
      ******
2399  **************************************************************************
      ******
2400   
2401  Parameter
2402  corr_fac_dis             Balancing correction factor - dispatchable techno
      logies
2403  corr_fac_nondis          Balancing correction factor - nondispatchable tec
      hnologies
2404  corr_fac_sto             Balancing correction factor - storage technologie
      s
2405  corr_fac_dsm_cu          Balancing correction factor - DSM curtailment tec
      hnologies
2406  corr_fac_dsm_shift       Balancing correction factor - DSM shifting techno
      logies
2407  corr_fac_ev              Balancing correction factor - electric vehicles
2408  corr_fac_rsvr            Balancing correction factor - reservoir
2409  corr_fac_sets            Balancing correction factor - SETS
2410  corr_fac_sets_aux        Balancing correction factor - SETS auxiliary DHW
2411  corr_fac_hp              Balancing correction factor - heat pumps
2412  corr_fac_h_elec          Balancing correction factor - hybrid electric sto
      rage heating
2413   
2414  corr_fac_ev_sep
2415   
2416  gross_energy_demand                      Gross energy demand
2417  gross_energy_demand_market               Gross energy demand - market (non
      -prosumage segment)
2418  gross_energy_demand_prosumers            Gross energy demand - prosumagers
2419  gross_energy_demand_prosumers_selfgen    Gross energy demand - prosumagers
       self-generated
2420  gross_energy_demand_prosumers_market     Gross energy demand - prosumagers
       from market
2421   
2422  reserves_activated
2423   
2424  calc_maxprice
2425  calc_minprice
2426   
2427  report
2428  report_tech
2429  report_tech_hours
2430  report_hours
2431  report_node
2432  report_line
2433  report_cost
2434   
2435  report_reserves
2436  report_reserves_hours
2437  report_reserves_tech
2438  report_reserves_tech_hours
2439   
2440  report_prosumage
2441  report_prosumage_tech
2442  report_prosumage_tech_hours
2443  report_market
2444  report_market_tech
2445  report_market_tech_hours
2446   
2447  report_heat_tech_hours
2448  report_heat_tech
2449  ;
2450   
2451   
2452   
2453   
2454  **************************************************************************
      ******
2455  **** Initialize reporting paremetrs  *************************************
      ******
2456  **************************************************************************
      ******
2457   
2458  * Set reporting sensitivity. All results below will be reported as zero
2459  Scalar eps_rep_rel Sensitivity for shares defined between 0 and 1        /
       1e-4 / ;
2460  Scalar eps_rep_abs Sensitivity for absolute values - e.g. hourly         /
       1e-2 / ;
2461  Scalar eps_rep_ins Sensitivity for absolute values - e.g. installed MW   /
       1 /    ;
2462   
2463   
2464  * ------------------------------------------------------------------------
      ----
2465   
2466  * Min and max for prices
2467  calc_maxprice = 0 ;
2468  calc_minprice = 1000 ;
2469   
2470   
2471  * ------------------------------------------------------------------------
      ----
2472   
2473  * Default values for correction factors
2474  corr_fac_dis(scen,n,dis,h) = 0 ;
2475  corr_fac_nondis(scen,n,nondis,h) = 0 ;
2476  corr_fac_sto(scen,n,sto,h) = 0 ;
2477  corr_fac_dsm_cu(scen,n,dsm_curt,h) = 0 ;
2478  corr_fac_dsm_shift(scen,n,dsm_shift,h) = 0 ;
2479  corr_fac_ev(scen,n,h) = 0 ;
2480  corr_fac_rsvr(scen,n,rsvr,h) = 0 ;
2481  corr_fac_sets(scen,n,bu,ch,h) = 0 ;
2482  corr_fac_sets_aux(scen,n,bu,ch,h) = 0 ;
2483  corr_fac_hp(scen,n,bu,ch,h) = 0 ;
2484  corr_fac_h_elec(scen,n,bu,ch,h) = 0 ;
2485   
2486  corr_fac_ev_sep(scen,n,ev,h) = 0 ;
2487   
2488   
2489  * ------------------------------------------------------------------------
      ----
2490   
2491  * Parameter for hourly nodal reserves activated
2492  reserves_activated(scen,n,h) = 0 ;
      reserves_activated(scen,n,h)$(ord(h) > 1) =
      feat_node('reserves',n) * (
      sum( reserves_nonprim_up , phi_reserves_call(n,reserves_nonprim_up,h) * 10
      00 * phi_reserves_share(n,reserves_nonprim_up) * ( reserves_intercept(n,re
      serves_nonprim_up) + sum( nondis , reserves_slope(n,reserves_nonprim_up,no
      ndis) * (lev_N_TECH(scen,n,nondis) + lev_N_RES_PRO(scen,n,nondis)))/1000))
      - sum( reserves_nonprim_do , phi_reserves_call(n,reserves_nonprim_do,h) * 
      1000 * phi_reserves_share(n,reserves_nonprim_do) * ( reserves_intercept(n,
      reserves_nonprim_do) + sum( nondis , reserves_slope(n,reserves_nonprim_do,
      nondis) * (lev_N_TECH(scen,n,nondis) + lev_N_RES_PRO(scen,n,nondis)))/1000
      ))
      ) ;
      $ontext
2501   
      reserves_activated(scen,n,h)$(ord(h) > 1) =
      feat_node('reserves',n) * (
      sum( reserves_nonprim_up , phi_reserves_call(n,reserves_nonprim_up,h) * re
      serves_exogenous(n,reserves_nonprim_up,h))
      - sum( reserves_nonprim_do , phi_reserves_call(n,reserves_nonprim_do,h) * 
      reserves_exogenous(n,reserves_nonprim_do,h))
      ) ;
      $ontext
2510   
2511   
2512  * ------------------------------------------------------------------------
      ----
2513   
2514  * Prepare prosumage reporting parameters
      gross_energy_demand_prosumers(scen,n) = sum( h , phi_pro_load(n) * d(n,h))
      ;
      gross_energy_demand_prosumers_selfgen(scen,n) = sum( (h,res) , lev_G_RES_P
      RO(scen,n,res,h)) + sum( (sto,h) , lev_STO_OUT_PRO2PRO(scen,n,sto,h) ) ;
      gross_energy_demand_prosumers_market(scen,n) = sum( h , lev_G_MARKET_M2PRO
      (scen,n,h)) + sum( (sto,h) , lev_STO_OUT_M2PRO(scen,n,sto,h) ) ;
      $ontext
2521   
2522   
2523  * ------------------------------------------------------------------------
      ----
2524   
2525  *Determine balancing correction factors
              corr_fac_dis(scen,n,tech,h) =
                sum( reserves_do ,  lev_RP_DIS(scen,n,reserves_do,tech,h) * phi_
      reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_DIS(scen,n,reserves_up,tech,h) * phi_
      reserves_call(n,reserves_up,h))
      ;
              corr_fac_nondis(scen,n,tech,h) =
                sum( reserves_do ,  lev_RP_NONDIS(scen,n,reserves_do,tech,h) * p
      hi_reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_NONDIS(scen,n,reserves_up,tech,h) * p
      hi_reserves_call(n,reserves_up,h))
      ;
              corr_fac_sto(scen,n,sto,h) =
                 sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( lev_R
      P_STO_IN(scen,n,reserves_do,sto,h) + lev_RP_STO_OUT(scen,n,reserves_do,sto
      ,h)) )
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( lev_R
      P_STO_IN(scen,n,reserves_up,sto,h) + lev_RP_STO_OUT(scen,n,reserves_up,sto
      ,h)) )
      ;
              corr_fac_rsvr(scen,n,rsvr,h) =
                sum( reserves_do ,  lev_RP_RSVR(scen,n,reserves_do,rsvr,h) * phi
      _reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_RSVR(scen,n,reserves_up,rsvr,h) * phi
      _reserves_call(n,reserves_up,h))
      ;
       
      %DSM%$ontext
              corr_fac_dsm_cu(scen,n,dsm_curt,h) =
             - sum( reserves_up , lev_RP_DSM_CU(scen,n,reserves_up,dsm_curt,h) *
       phi_reserves_call(n,reserves_up,h) )
      ;
              corr_fac_dsm_shift(scen,n,dsm_shift,h) =
                sum( reserves_do ,  lev_RP_DSM_SHIFT(scen,n,reserves_do,dsm_shif
      t,h) * phi_reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_DSM_SHIFT(scen,n,reserves_up,dsm_shif
      t,h) * phi_reserves_call(n,reserves_up,h))
      ;
      $ontext
      %reserves%$ontext
               corr_fac_ev(scen,n,h) = sum( ev ,
               + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * (lev_RP
      _EV_G2V(scen,n,reserves_do,ev,h) + lev_RP_EV_V2G(scen,n,reserves_do,ev,h))
      )
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * (lev_RP
      _EV_G2V(scen,n,reserves_up,ev,h) + lev_RP_EV_V2G(scen,n,reserves_up,ev,h))
      ) )
      ;
       
               corr_fac_ev_sep(scen,n,ev,h) =
               + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * (lev_RP
      _EV_G2V(scen,n,reserves_do,ev,h) + lev_RP_EV_V2G(scen,n,reserves_do,ev,h))
      )
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * (lev_RP
      _EV_G2V(scen,n,reserves_up,ev,h) + lev_RP_EV_V2G(scen,n,reserves_up,ev,h))
      )
      ;
       
       
       
      $ontext
2570   
      %reserves%$ontext
               corr_fac_sets(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS(scen,n,reserves_up,bu,ch,h) ))
      ;
               corr_fac_sets_aux(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS_AUX(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS_AUX(scen,n,reserves_up,bu,ch,h) ))
      ;
               corr_fac_hp(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      hp(n,bu,ch) * lev_RP_HP(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      hp(n,bu,ch) * lev_RP_HP(scen,n,reserves_up,bu,ch,h) ))
      ;
               corr_fac_h_elec(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      storage(n,bu,ch) * lev_RP_H_ELEC(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      storage(n,bu,ch) * lev_RP_H_ELEC(scen,n,reserves_up,bu,ch,h) ))
      ;
      $ontext
2591   
2592   
2593  * ------------------------------------------------------------------------
      ----
2594   
2595  * Define gross energy demand for reporting
2596  gross_energy_demand(scen,n) = sum( h , d(n,h) + sum( sto , lev_STO_IN(scen
      ,n,sto,h) - lev_STO_OUT(scen,n,sto,h) )
               + sum( sto , sum( res , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + le
      v_STO_IN_PRO2M(scen,n,res,sto,h) ) + lev_STO_IN_M2PRO(scen,n,sto,h) + lev_
      STO_IN_M2M(scen,n,sto,h) - lev_STO_OUT_PRO2PRO(scen,n,sto,h) - lev_STO_OUT
      _PRO2M(scen,n,sto,h) - lev_STO_OUT_M2PRO(scen,n,sto,h) - lev_STO_OUT_M2M(s
      cen,n,sto,h) )
      $ontext
               - sum( dsm_curt , lev_DSM_CU(scen,n,dsm_curt,h) )
               + sum( dsm_shift , lev_DSM_UP(scen,n,dsm_shift,h) - sum( hh$( ord
      (hh) >= ord(h) - t_dur_dsm_shift(n,dsm_shift) AND ord(hh) <= ord(h) + t_du
      r_dsm_shift(n,dsm_shift) ) , lev_DSM_DO(scen,n,dsm_shift,h,hh)) )
      $ontext
               + sum( ev , lev_EV_CHARGE(scen,n,ev,h) - lev_EV_DISCHARGE(scen,n,
      ev,h) )
      $ontext
               + reserves_activated(scen,n,h)
               + sum( sto , corr_fac_sto(scen,n,sto,h) )
      $ontext
      %reserves%$ontext
             - sum( (dsm,reserves_up) , lev_RP_DSM_CU(scen,n,reserves_up,dsm,h) 
      * phi_reserves_call(n,reserves_up,h) )
      $ontext
      %EV%$ontext
             + corr_fac_ev(scen,n,h)
      $ontext
              + sum( (bu,ch) , theta_dir(n,bu,ch) * lev_H_DIR(scen,n,bu,ch,h) + 
      theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n,bu,ch,h) + theta_hp(n,bu,ch) * 
      lev_H_HP_IN(scen,n,bu,ch,h) + theta_elec(n,bu,ch) * lev_H_ELECTRIC_IN(scen
      ,n,bu,ch,h) )
              + sum( (bu,ch) , theta_dir(n,bu,ch) * lev_H_DHW_DIR(scen,n,bu,ch,h
      ) + theta_sets(n,bu,ch) * lev_H_DHW_AUX_ELEC_IN(scen,n,bu,ch,h) )
      $ontext
      %reserves%$ontext
              + sum( (bu,ch) , corr_fac_sets(scen,n,bu,ch,h) + corr_fac_sets_aux
      (scen,n,bu,ch,h) + corr_fac_hp(scen,n,bu,ch,h) + corr_fac_h_elec(scen,n,bu
      ,ch,h) )
      $ontext
2635  )
2636  ;
2637   
2638   
2639  **************************************************************************
      ******
2640  **** Report  *************************************************************
      ******
2641  **************************************************************************
      ******
2642   
2643  * RPEORT model statistics
2644          report('model status',loop_res_share,loop_ev,loop_prosumage) = sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , modstats(scen,'m
      odelstat')) ;
2645          report('solve time',loop_res_share,loop_ev,loop_prosumage) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , modstats(scen,'res
      usd')) ;
2646          report('obj value',loop_res_share,loop_ev,loop_prosumage) = sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_Z(scen) * 1) ;
2647   
2648   
2649  * ------------------------------------------------------------------------
      ----
2650   
2651  * REPORT HOURS
2652          report_hours('demand consumers',loop_res_share,loop_ev,loop_prosum
      age,h,n) = d(n,h) ;
2653          report_hours('energy generated',loop_res_share,loop_ev,loop_prosum
      age,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , su
      m( dis , lev_G_L(scen,n,dis,h) ) + sum( nondis , lev_G_RES(scen,n,nondis,h
      ) - corr_fac_nondis(scen,n,nondis,h)) + sum( sto , lev_STO_OUT(scen,n,sto,
      h) - corr_fac_sto(scen,n,sto,h)) + sum( dsm_shift, lev_DSM_DO_DEMAND(scen,
      n,dsm_shift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) + sum( ev , lev_E
      V_DISCHARGE(scen,n,ev,h)) - corr_fac_ev(scen,n,h) + sum( rsvr , lev_RSVR_O
      UT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h)) + sum( res , lev_G_RES_P
      RO(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,res,h) + sum( sto , lev_STO_I
      N_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h))) + sum( 
      sto , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) 
      + lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_M2M(scen,n,sto,h)) ) ;
2654          report_hours('infeasibility',loop_res_share,loop_ev,loop_prosumage
      ,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      G_INFES(scen,n,h) ) ;
2655          report_hours('gross exports',loop_res_share,loop_ev,loop_prosumage
      ,h,n) = sum( l , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , -min(inc(l,n) * lev_F(scen,l,h),0) )) ;
2656          report_hours('gross imports',loop_res_share,loop_ev,loop_prosumage
      ,h,n) = sum( l , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , max(inc(l,n) * lev_F(scen,l,h),0) ) ) ;
2657          report_hours('price',loop_res_share,loop_ev,loop_prosumage,h,n) = 
      - sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , marginal_co
      n1a(scen,n,h)) ;
2658   
2659                   report_hours('energy generated',loop_res_share,loop_ev,lo
      op_prosumage,h,n)$(report_hours('energy generated',loop_res_share,loop_ev,
      loop_prosumage,h,n) < eps_rep_abs ) = 0 ;
2660                   report_hours('energy demanded',loop_res_share,loop_ev,loo
      p_prosumage,h,n)$(report_hours('energy demanded',loop_res_share,loop_ev,lo
      op_prosumage,h,n) < eps_rep_abs ) = 0 ;
2661                   report_hours('gross exports',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('gross exports',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs ) = 0 ;
2662                   report_hours('gross imports',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('gross imports',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs ) = 0 ;
2663                   report_hours('demand consumers',loop_res_share,loop_ev,lo
      op_prosumage,h,n)$(report_hours('demand consumers',loop_res_share,loop_ev,
      loop_prosumage,h,n) < eps_rep_abs) = 0 ;
2664                   report_hours('price',loop_res_share,loop_ev,loop_prosumag
      e,h,n)$(report_hours('price',loop_res_share,loop_ev,loop_prosumage,h,n) < 
      eps_rep_abs AND report_hours('price',loop_res_share,loop_ev,loop_prosumage
      ,h,n) > -eps_rep_abs) = eps ;
2665                   report_hours('infeasibility',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('infeasibility',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs) = 0 ;
2666   
2667   
2668  * ------------------------------------------------------------------------
      ----
2669   
2670  * REPORT TECH HOURS
2671          report_tech_hours('generation conventional',loop_res_share,loop_ev
      ,loop_prosumage,con,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_G_L(scen,n,con,h) + corr_fac_dis(scen,n,con,h)) ;
2672          report_tech_hours('infeasibility',loop_res_share,loop_ev,loop_pros
      umage,'',h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_G_INFES(scen,n,h) ) ;
2673          report_tech_hours('generation renewable',loop_res_share,loop_ev,lo
      op_prosumage,res,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_G_L(scen,n,res,h) + corr_fac_dis(scen,n,res,h) + lev_G_RES(
      scen,n,res,h) + lev_G_RES_PRO(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,re
      s,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(
      scen,n,res,sto,h)) ) ;
2674          report_tech_hours('generation renewable',loop_res_share,loop_ev,lo
      op_prosumage,rsvr,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_RSVR_OUT(scen,n,rsvr,h) ) ;
2675          report_tech_hours('reservoir inflow',loop_res_share,loop_ev,loop_p
      rosumage,rsvr,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , rsvr_in(n,rsvr,h)/1000 * lev_N_RSVR_E(scen,n,rsvr) ) ;
2676          report_tech_hours('reservoir level',loop_res_share,loop_ev,loop_pr
      osumage,rsvr,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_RSVR_L(scen,n,rsvr,h) ) ;
2677          report_tech_hours('curtailment of fluct res',loop_res_share,loop_e
      v,loop_prosumage,res,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loo
      p_prosumage)) , lev_CU(scen,n,res,h) + lev_CU_PRO(scen,n,res,h) ) ;
2678          report_tech_hours('generation storage',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_STO_OUT(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) + le
      v_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_ST
      O_OUT_M2M(scen,n,sto,h) ) ;
2679          report_tech_hours('storage loading',loop_res_share,loop_ev,loop_pr
      osumage,sto,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_STO_IN(scen,n,sto,h) + sum( res , lev_STO_IN_PRO2PRO(scen,n,res
      ,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h)) + lev_STO_IN_M2PRO(scen,n,st
      o,h) + lev_STO_IN_M2M(scen,n,sto,h) ) ;
2680          report_tech_hours('storage level',loop_res_share,loop_ev,loop_pros
      umage,sto,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_STO_L(scen,n,sto,h) + lev_STO_L_PRO(scen,n,sto,h) ) ;
2681          report_tech_hours('netto exports',loop_res_share,loop_ev,loop_pros
      umage,'',h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , - sum( l , inc(l,n) * lev_F(scen,l,h)) ) ;
2682   
2683                   report_tech_hours('generation conventional',loop_res_shar
      e,loop_ev,loop_prosumage,con,h,n)$(report_tech_hours('generation conventio
      nal',loop_res_share,loop_ev,loop_prosumage,con,h,n) < eps_rep_abs) = 0 ;
2684                   report_tech_hours('generation renewable',loop_res_share,l
      oop_ev,loop_prosumage,res,h,n)$(report_tech_hours('generation renewable',l
      oop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
2685                   report_tech_hours('generation renewable',loop_res_share,l
      oop_ev,loop_prosumage,rsvr,h,n)$(report_tech_hours('generation renewable',
      loop_res_share,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0 ;
2686                   report_tech_hours('curtailment of fluct res',loop_res_sha
      re,loop_ev,loop_prosumage,res,h,n)$(report_tech_hours('curtailment of fluc
      t res',loop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
2687                   report_tech_hours('generation storage',loop_res_share,loo
      p_ev,loop_prosumage,sto,h,n)$(report_tech_hours('generation storage',loop_
      res_share,loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
2688                   report_tech_hours('storage loading',loop_res_share,loop_e
      v,loop_prosumage,sto,h,n)$(report_tech_hours('storage loading',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
2689                   report_tech_hours('storage level',loop_res_share,loop_ev,
      loop_prosumage,sto,h,n)$(report_tech_hours('storage level',loop_res_share,
      loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
2690                   report_tech_hours('netto exports',loop_res_share,loop_ev,
      loop_prosumage,'',h,n)$(abs(report_tech_hours('netto exports',loop_res_sha
      re,loop_ev,loop_prosumage,'',h,n)) < eps_rep_abs ) = 0 ;
2691                   report_tech_hours('infeasibility',loop_res_share,loop_ev,
      loop_prosumage,'',h,n)$(report_tech_hours('infeasibility',loop_res_share,l
      oop_ev,loop_prosumage,'',h,n) < eps_rep_abs ) = 0 ;
2692                   report_tech_hours('reservoir inflow',loop_res_share,loop_
      ev,loop_prosumage,rsvr,h,n)$(report_tech_hours('reservoir inflow',loop_res
      _share,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0 ;
2693                   report_tech_hours('reservoir level',loop_res_share,loop_e
      v,loop_prosumage,rsvr,h,n)$(report_tech_hours('reservoir level',loop_res_s
      hare,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0 ;
2694   
2695   
2696  * ------------------------------------------------------------------------
      ----
2697   
2698  * RPEORT LINE
2699           report_line('NTC',loop_res_share,loop_ev,loop_prosumage,l) = sum(
       scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_NTC(scen,l) 
      ) ;
2700                           report_line('NTC',loop_res_share,loop_ev,loop_pro
      sumage,l)$(report_line('NTC',loop_res_share,loop_ev,loop_prosumage,l) < ep
      s_rep_ins ) = 0 ;
2701   
2702           report_line('average line use',loop_res_share,loop_ev,loop_prosum
      age,l)$report_line('NTC',loop_res_share,loop_ev,loop_prosumage,l) = sum( s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h, abs(lev_F(
      scen,l,h)))) / sum( h , report_line('NTC',loop_res_share,loop_ev,loop_pros
      umage,l)) ;
2703                   report_line('avergae line use',loop_res_share,loop_ev,loo
      p_prosumage,l)$(report_line('average line use',loop_res_share,loop_ev,loop
      _prosumage,l) < eps_rep_rel) = 0 ;
2704   
2705   
2706  * ------------------------------------------------------------------------
      ----
2707   
2708  * REPORT NODE
2709          report_node('energy demand total',loop_res_share,loop_ev,loop_pros
      umage,n) = (sum( h , d(n,h) ) + sum( (sto,h) , sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h) + sum( res , le
      v_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h)) +
       lev_STO_IN_M2PRO(scen,n,sto,h) + lev_STO_IN_M2M(scen,n,sto,h)) )) * 1
              + sum( (dsm_shift,h) , sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage)) , lev_DSM_UP_DEMAND(scen,n,dsm_shift,h)) ) * %sec_hour%
      $ontext
               + sum( (ev,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_EV_CHARGE(scen,n,ev,h)) ) * %sec_hour%
      $ontext
               + sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , reserves_activated(scen,n,h)))
      $ontext
      *        + sum( (bu,ch,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , theta_dir(n,bu,ch) * ( lev_H_DIR(scen,n,bu,ch,h) + lev_H_DH
      W_DIR(scen,n,bu,ch,h) ) + theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n,bu,ch
      ,h) + theta_hp(n,bu,ch) * lev_H_HP_IN(scen,n,bu,ch,h) + theta_elec(n,bu,ch
      ) * lev_H_STO_IN_ELECTRIC(scen,n,bu,ch,h)) )
      $ontext
2726  ;
2727          report_node('energy demand gross',loop_res_share,loop_ev,loop_pros
      umage,n) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , g
      ross_energy_demand(scen,n)) ;
2728          report_node('energy generated net',loop_res_share,loop_ev,loop_pro
      sumage,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( dis , lev_G_L(scen,n,dis,h)) + sum( nondis , lev_G_RES(scen,n
      ,nondis,h) - corr_fac_nondis(scen,n,nondis,h)) + sum( rsvr , lev_RSVR_OUT(
      scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h)) + sum( res , phi_res(n,res,
      h) * lev_N_RES_PRO(scen,n,res) - lev_CU_PRO(scen,n,res,h)) )) ;
2729          report_node('energy generated gross',loop_res_share,loop_ev,loop_p
      rosumage,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , sum( dis , lev_G_L(scen,n,dis,h)) + sum( nondis , lev_G_RES(scen
      ,n,nondis,h) - corr_fac_nondis(scen,n,nondis,h)) + sum( rsvr , lev_RSVR_OU
      T(scen,n,rsvr,h)- corr_fac_rsvr(scen,n,rsvr,h)) + sum( sto , lev_STO_OUT(s
      cen,n,sto,h) - corr_fac_sto(scen,n,sto,h)) + sum( dsm_shift , lev_DSM_DO_D
      EMAND(scen,n,dsm_shift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) + sum(
       dsm_curt , lev_DSM_CU(scen,n,dsm_curt,h)) + sum( ev , lev_EV_DISCHARGE(sc
      en,n,ev,h)) - corr_fac_ev(scen,n,h) +  sum( res , phi_res(n,res,h) * lev_N
      _RES_PRO(scen,n,res) - lev_CU_PRO(scen,n,res,h)) + sum( sto , lev_STO_OUT_
      PRO2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) + lev_STO_OUT_M2PR
      O(scen,n,sto,h) + lev_STO_OUT_M2M(scen,n,sto,h)) )) ;
2730          report_node('net exports',loop_res_share,loop_ev,loop_prosumage,n)
       = sum( (l,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , - inc(l,n) * lev_F(scen,l,h)) ) ;
2731          report_node('gross exports',loop_res_share,loop_ev,loop_prosumage,
      n) = sum( (l,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , -min(inc(l,n) * lev_F(scen,l,h),0) ) ) ;
2732          report_node('gross imports',loop_res_share,loop_ev,loop_prosumage,
      n) = sum( (l,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , max(inc(l,n) * lev_F(scen,l,h),0) ) ) ;
2733          report_node('net import share in gross demand',loop_res_share,loop
      _ev,loop_prosumage,n) = -min(report_node('net exports',loop_res_share,loop
      _ev,loop_prosumage,n),0)/report_node('energy demand gross',loop_res_share,
      loop_ev,loop_prosumage,n) ;
2734          report_node('net export share in net generation',loop_res_share,lo
      op_ev,loop_prosumage,n) = max(report_node('net exports',loop_res_share,loo
      p_ev,loop_prosumage,n),0)/report_node('energy generated net',loop_res_shar
      e,loop_ev,loop_prosumage,n) ;
2735          report_node('trade capacity',loop_res_share,loop_ev,loop_prosumage
      ,n) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( l
       , abs(inc(l,n) * lev_NTC(scen,l))) ) ;
2736  *        report_node('gross import share',loop_res_share,loop_ev,loop_pros
      umage,n) = sum( h , report_hours('gross imports',loop_res_share,loop_ev,lo
      op_prosumage,h,n))/ sum( h , report_hours('energy demanded',loop_res_share
      ,loop_ev,loop_prosumage,h,n) ) ;
2737          report_node('gross export share in net generation',loop_res_share,
      loop_ev,loop_prosumage,n) = sum( h , report_hours('gross exports',loop_res
      _share,loop_ev,loop_prosumage,h,n))/sum( h , report_hours('energy generate
      d',loop_res_share,loop_ev,loop_prosumage,h,n) ) ;
2738          report_node('Capacity total',loop_res_share,loop_ev,loop_prosumage
      ,n) = sum( tech , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_N_TECH(scen,n,tech))) + sum( res , sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res))) + sum( sto , su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(sce
      n,n,sto) + lev_N_STO_P_PRO(scen,n,sto) )) + sum( rsvr , sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr)))
              + sum( dsm_curt , sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) ) + sum( dsm_shift , sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_SHIFT(scen,n
      ,dsm_shift)) )
      $ontext
2743  ;
2744          report_node('curtailment of fluct res absolute',loop_res_share,loo
      p_ev,loop_prosumage,n) = sum((nondis,h), sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , lev_CU_PRO(scen,n,nondis,h) + lev_CU(scen,n,no
      ndis,h))) * 1 ;
2745          report_node('curtailment of fluct res relative',loop_res_share,loo
      p_ev,loop_prosumage,n)$(sum((nondis,h), sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , phi_res(n,nondis,h) * (lev_N_TECH(scen,n,nondis
      )))) + sum((res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res))) > eps_rep_abs*card(r
      es)*card(h)) = (sum((res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loo
      p_prosumage)) , lev_CU_PRO(scen,n,res,h))) + sum((nondis,h), sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,nondis,h))))
       * 1 / (sum((res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res))) + sum((nondis,h), s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , phi_res(n,nond
      is,h) * (lev_N_TECH(scen,n,nondis))))) ;
2746          report_node('bio not utilized absolute',loop_res_share,loop_ev,loo
      p_prosumage,n)$(m_e(n,'bio')) = (m_e(n,'bio') - sum(h, sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,'bio',h)))) * 1 ;
2747          report_node('bio not utilized relative',loop_res_share,loop_ev,loo
      p_prosumage,n)$(m_e(n,'bio')) = (m_e(n,'bio') - sum(h, sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,'bio',h)))) / m_e
      (n,'bio') ;
2748          report_node('max price',loop_res_share,loop_ev,loop_prosumage,n)$s
      um(h,d(n,h)) = max( calc_maxprice , smax( h, sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , - marginal_con1a(scen,n,h))) ) ;
2749          report_node('min price',loop_res_share,loop_ev,loop_prosumage,n)$s
      um(h,d(n,h)) = min( calc_minprice , smin( h, sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , - marginal_con1a(scen,n,h))) ) ;
2750          report_node('mean price',loop_res_share,loop_ev,loop_prosumage,n)$
      sum(h,d(n,h)) = -sum(h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , marginal_con1a(scen,n,h)))/card(h) ;
2751   
2752                   report_node('energy demand total',loop_res_share,loop_ev,
      loop_prosumage,n)$(report_node('energy demand total',loop_res_share,loop_e
      v,loop_prosumage,n) < eps_rep_abs) = 0 ;
2753                   report_node('curtailment of fluct res absolute',loop_res_
      share,loop_ev,loop_prosumage,n)$(report_node('curtailment of fluct res abs
      olute',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs*card(h)*1) =
       0 ;
2754                   report_node('curtailment of fluct res relative',loop_res_
      share,loop_ev,loop_prosumage,n)$(report_node('curtailment of fluct res rel
      ative',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
2755                   report_node('bio not utilized absolute',loop_res_share,lo
      op_ev,loop_prosumage,n)$(report_node('bio not utilized absolute',loop_res_
      share,loop_ev,loop_prosumage,n) < eps_rep_abs*card(h)*1) = 0 ;
2756                   report_node('bio not utilized relative',loop_res_share,lo
      op_ev,loop_prosumage,n)$(report_node('bio not utilized relative',loop_res_
      share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
2757                   report_node('min price',loop_res_share,loop_ev,loop_prosu
      mage,n)$(report_node('min price',loop_res_share,loop_ev,loop_prosumage,n) 
      < eps_rep_abs AND report_node('min price',loop_res_share,loop_ev,loop_pros
      umage,n) > -eps_rep_abs) = eps ;
2758                   report_node('gross exports',loop_res_share,loop_ev,loop_p
      rosumage,n)$(report_node('gross exports',loop_res_share,loop_ev,loop_prosu
      mage,n) < eps_rep_abs*card(h)) = 0 ;
2759                   report_node('gross imports',loop_res_share,loop_ev,loop_p
      rosumage,n)$(report_node('gross imports',loop_res_share,loop_ev,loop_prosu
      mage,n) < eps_rep_abs*card(h)) = 0 ;
2760                   report_node('net exports',loop_res_share,loop_ev,loop_pro
      sumage,n)$(abs(report_node('net exports',loop_res_share,loop_ev,loop_prosu
      mage,n)) < eps_rep_abs*card(h)) = 0 ;
2761                   report_node('energy generated net',loop_res_share,loop_ev
      ,loop_prosumage,n)$(report_node('energy generated net',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_abs*card(h)) = 0 ;
2762                   report_node('energy generated gross',loop_res_share,loop_
      ev,loop_prosumage,n)$(report_node('energy generated gross',loop_res_share,
      loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
2763                   report_node('energy demand gross',loop_res_share,loop_ev,
      loop_prosumage,n)$(report_node('energy demand gross',loop_res_share,loop_e
      v,loop_prosumage,n) < eps_rep_abs*card(h)) = 0 ;
2764                   report_node('net import share in gross demand',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(report_node('net import share in gross dem
      and',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
2765                   report_node('net export share in net generation',loop_res
      _share,loop_ev,loop_prosumage,n)$(report_node('net export share in net gen
      eration',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
2766                   report_node('Capacity total',loop_res_share,loop_ev,loop_
      prosumage,n)$(report_node('Capacity total',loop_res_share,loop_ev,loop_pro
      sumage,n) < eps_rep_ins) = 0 ;
2767                   report_node('gross import share',loop_res_share,loop_ev,l
      oop_prosumage,n)$(report_node('gross import share',loop_res_share,loop_ev,
      loop_prosumage,n) < eps_rep_rel ) = 0 ;
2768                   report_node('gross export share in net generation',loop_r
      es_share,loop_ev,loop_prosumage,n)$(report_node('gross export share in net
       generation',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 
      ;
2769   
2770   
2771  * ------------------------------------------------------------------------
      ----
2772   
2773  * REPORT COST
2774          report_cost('Nodal cost: dispatch',loop_res_share,loop_ev,loop_pro
      sumage,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( dis , c_m(n,dis)*lev_G_L(scen,n,dis,h) + c_up(n,dis)*lev_G_UP
      (scen,n,dis,h)$(ord(h)>1) + c_do(n,dis)*lev_G_DO(scen,n,dis,h)) + sum( non
      dis , c_cu(n,nondis)*lev_CU(scen,n,nondis,h)) + sum( sto , c_m_sto(n,sto) 
      * ( lev_STO_OUT(scen,n,sto,h) + lev_STO_IN(scen,n,sto,h) ) )
                       + sum( dsm_curt , c_m_dsm_cu(n,dsm_curt)*lev_DSM_CU(scen,
      n,dsm_curt,h) ) + sum( dsm_shift , c_m_dsm_shift(n,dsm_shift)*(lev_DSM_UP_
      DEMAND(scen,n,dsm_shift,h) + lev_DSM_DO_DEMAND(scen,n,dsm_shift,h)))
      $ontext
                       + sum( ev , c_m_ev(n,ev) * lev_EV_DISCHARGE(scen,n,ev,h))
      $ontext
                       + sum( (reserves_up,sto) , phi_reserves_call(n,reserves_u
      p,h) * c_m_sto(n,sto) * (lev_RP_STO_OUT(scen,n,reserves_up,sto,h) - lev_RP
      _STO_IN(scen,n,reserves_up,sto,h)) ) - sum( (reserves_do,sto) , phi_reserv
      es_call(n,reserves_do,h) * c_m_sto(n,sto) * (lev_RP_STO_OUT(scen,n,reserve
      s_do,sto,h) - lev_RP_STO_IN(scen,n,reserves_do,sto,h)) ) + sum( (reserves_
      up,rsvr) , lev_RP_RSVR(scen,n,reserves_up,rsvr,h) * phi_reserves_call(n,re
      serves_up,h) * c_m_rsvr(n,rsvr) ) - sum( (reserves_do,rsvr) , lev_RP_RSVR(
      scen,n,reserves_do,rsvr,h) * phi_reserves_call(n,reserves_do,h) * c_m_rsvr
      (n,rsvr))
      $ontext
      %EV%$ontext
      %EV_EXOG%        + sum( (reserves_up,ev) , lev_RP_EV_V2G(scen,n,reserves_u
      p,ev,h) * phi_reserves_call(n,reserves_up,h) * c_m_ev(n,ev) ) - sum( (rese
      rves_do,ev) , lev_RP_EV_V2G(scen,n,reserves_do,ev,h) * phi_reserves_call(n
      ,reserves_do,h) * c_m_ev(n,ev) )
      %EV_EXOG%
      $ontext
      %reserves%$ontext
                       + sum( (reserves_up,dsm_curt) , lev_RP_DSM_CU(scen,n,rese
      rves_up,dsm_curt,h) * phi_reserves_call(n,reserves_up,h) * c_m_dsm_cu(n,ds
      m_curt) ) + sum( (reserves,dsm_shift) , lev_RP_DSM_SHIFT(scen,n,reserves,d
      sm_shift,h) * phi_reserves_call(n,reserves,h) * c_m_dsm_shift(n,dsm_shift)
       )
      $ontext
2798  ));
2799           report_cost('Nodal cost: investment & fix',loop_res_share,loop_ev
      ,loop_prosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( tech , c_i(n,tech)*lev_N_TECH(scen,n,tech) + c_fix(n,tech)*le
      v_N_TECH(scen,n,tech) ) + sum( sto , c_i_sto_e(n,sto)*lev_N_STO_E(scen,n,s
      to) + c_fix_sto(n,sto)/2*(lev_N_STO_P(scen,n,sto)+lev_N_STO_E(scen,n,sto))
       + c_i_sto_p(n,sto)*lev_N_STO_P(scen,n,sto) ) + sum( rsvr , c_i_rsvr_e(n,r
      svr)*lev_N_RSVR_E(scen,n,rsvr) + c_i_rsvr_p(n,rsvr)*lev_N_RSVR_P(scen,n,rs
      vr) + c_fix_rsvr(n,rsvr) * lev_N_RSVR_P(scen,n,rsvr))
                       + sum( dsm_curt , c_i_dsm_cu(n,dsm_curt)*lev_N_DSM_CU(sce
      n,n,dsm_curt) + c_fix_dsm_cu(n,dsm_curt)*lev_N_DSM_CU(scen,n,dsm_curt) ) +
       sum( dsm_shift , c_i_dsm_shift(n,dsm_shift)*lev_N_DSM_SHIFT(scen,n,dsm_sh
      ift) + c_fix_dsm_shift(n,dsm_shift)*lev_N_DSM_SHIFT(scen,n,dsm_shift) )
      $ontext
                       + sum( res , c_i(n,res)*lev_N_RES_PRO(scen,n,res) + c_fix
      (n,res)*lev_N_RES_PRO(scen,n,res) ) + sum( sto , c_i_sto_e(n,sto)*lev_N_ST
      O_E_PRO(scen,n,sto) + c_fix_sto(n,sto)/2*(lev_N_STO_P_PRO(scen,n,sto) + le
      v_N_STO_E_PRO(scen,n,sto)) + c_i_sto_p(n,sto)*lev_N_STO_P_PRO(scen,n,sto))
       + sum( (sto,h) , c_m_sto(n,sto) * ( lev_STO_OUT_PRO2PRO(scen,n,sto,h) + l
      ev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) + lev_STO
      _OUT_M2M(scen,n,sto,h) + sum( res , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) +
       lev_STO_IN_PRO2M(scen,n,res,sto,h)) + lev_STO_OUT_PRO2M(scen,n,sto,h) + l
      ev_STO_OUT_M2M(scen,n,sto,h) ) )
      $ontext
2808  );
2809   
2810           report_cost('Nodal cost: infeasibility',loop_res_share,loop_ev,lo
      op_prosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( h , c_infes * lev_G_INFES(scen,n,h)) ) ;
2811           report_cost('Nodal cost: PHEV fuel',loop_res_share,loop_ev,loop_p
      rosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) ,
       sum( (h,ev) , pen_phevfuel(n,ev) * lev_EV_PHEVFUEL(scen,n,ev,h)) ) ;
2812           report_cost('Nodal cost: fossil heating',loop_res_share,loop_ev,l
      oop_prosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , sum( (bu,hst,h) , pen_heat_fuel(n,bu,hst) * lev_H_STO_IN_FOSSIL(scen
      ,n,bu,hst,h)) ) ;
2813           report_cost('Nodal cost: total',loop_res_share,loop_ev,loop_prosu
      mage,n) = report_cost('Nodal cost: dispatch',loop_res_share,loop_ev,loop_p
      rosumage,n) + report_cost('Nodal cost: investment & fix',loop_res_share,lo
      op_ev,loop_prosumage,n) + report_cost('Nodal cost: infeasibility',loop_res
      _share,loop_ev,loop_prosumage,n) + report_cost('Nodal cost: PHEV fuel',loo
      p_res_share,loop_ev,loop_prosumage,n) + report_cost('Nodal cost: fossil he
      ating',loop_res_share,loop_ev,loop_prosumage,n) ;
2814           report_cost('Costs lines',loop_res_share,loop_ev,loop_prosumage,l
      ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , c_i_ntc(l
      ) * lev_NTC(scen,l)*dist(l) ) ;
2815   
2816                   report_cost('Nodal cost: dispatch',loop_res_share,loop_ev
      ,loop_prosumage,n)$(report_cost('Nodal cost: dispatch',loop_res_share,loop
      _ev,loop_prosumage,n) < card(h) * eps_rep_abs) = 0 ;
2817                   report_cost('Nodal cost: investment & fix',loop_res_share
      ,loop_ev,loop_prosumage,n)$(report_cost('Nodal cost: investment & fix',loo
      p_res_share,loop_ev,loop_prosumage,n) < eps_rep_ins) = 0 ;
2818                   report_cost('Nodal cost: infeasibility',loop_res_share,lo
      op_ev,loop_prosumage,n)$(report_cost('Nodal cost: infeasibility',loop_res_
      share,loop_ev,loop_prosumage,n) < card(h) * eps_rep_abs) = 0 ;
2819                   report_cost('Nodal cost: PHEV fuel',loop_res_share,loop_e
      v,loop_prosumage,n)$(report_cost('Nodal cost: PHEV fuel',loop_res_share,lo
      op_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
2820                   report_cost('Nodal cost: fossil heating',loop_res_share,l
      oop_ev,loop_prosumage,n)$(report_cost('Nodal cost: fossil heating',loop_re
      s_share,loop_ev,loop_prosumage,n) < card(h) * eps_rep_abs) = 0 ;
2821                   report_cost('Nodal cost: total',loop_res_share,loop_ev,lo
      op_prosumage,n)$(report_cost('Nodal cost: total',loop_res_share,loop_ev,lo
      op_prosumage,n) < eps_rep_abs) = 0 ;
2822                   report_cost('Costs lines',loop_res_share,loop_ev,loop_pro
      sumage,l)$(report_cost('Costs lines',loop_res_share,loop_ev,loop_prosumage
      ,l) < eps_rep_ins) = 0 ;
2823   
2824   
2825  * ------------------------------------------------------------------------
      ----
2826   
2827  * REPORT TECH
2828          report_tech('capacities conventional',loop_res_share,loop_ev,loop_
      prosumage,con,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_N_TECH(scen,n,con)) ;
2829          report_tech('capacities renewable',loop_res_share,loop_ev,loop_pro
      sumage,res,n) = 0 + sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_N_TECH(scen,n,res) + lev_N_RES_PRO(scen,n,res)) ;
2830          report_tech('capacities reservoir MW',loop_res_share,loop_ev,loop_
      prosumage,rsvr,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_N_RSVR_P(scen,n,rsvr));
2831          report_tech('capacities reservoir MWh',loop_res_share,loop_ev,loop
      _prosumage,rsvr,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_N_RSVR_E(scen,n,rsvr));
2832          report_tech('capacities storage MW',loop_res_share,loop_ev,loop_pr
      osumage,sto,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , lev_N_STO_P(scen,n,sto)+ lev_N_STO_P_PRO(scen,n,sto)) ;
2833          report_tech('capacities storage MWh',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_N_STO_E(scen,n,sto)+ lev_N_STO_E_PRO(scen,n,sto)) * 1 ;
2834   
2835          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,con,n) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_TECH(scen,n,con) ) / report_node('Capacity total',loop_res_share,loop_
      ev,loop_prosumage,n) + 1e-9 ;
2836          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,res,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _N_TECH(scen,n,res)) / report_node('Capacity total',loop_res_share,loop_ev
      ,loop_prosumage,n) + 1e-9 ;
2837          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,rsvr,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_RSVR_P(scen,n,rsvr)) / report_node('Capacity total',loop_res_share,loo
      p_ev,loop_prosumage,n) + 1e-9 ;
2838          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,res,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _N_TECH(scen,n,res) + lev_N_RES_PRO(scen,n,res) ) / report_node('Capacity 
      total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
2839          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,sto,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _N_STO_P(scen,n,sto) + lev_N_STO_P_PRO(scen,n,sto) ) / report_node('Capaci
      ty total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
2840   
2841          report_tech('renshares in nodal gross demand',loop_res_share,loop_
      ev,loop_prosumage,res,n) = sum( h, sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,re
      s,h) + lev_G_RES_PRO(scen,n,res,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,
      res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h)) + lev_G_RES(scen,n,res,h)
       - corr_fac_nondis(scen,n,res,h))) / sum( scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , gross_energy_demand(scen,n) ) ;
2842          report_tech('renshares in nodal gross demand',loop_res_share,loop_
      ev,loop_prosumage,rsvr,n) = sum( h, sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,
      rsvr,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) ,
       gross_energy_demand(scen,n) ) ;
2843          report_tech('conshares in nodal gross demand',loop_res_share,loop_
      ev,loop_prosumage,con,n) = sum( h, sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,con,h)) ) / sum( scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , gross_energy_demand(scen,n) ) ;
2844          report_tech('renshares in nodal net generation',loop_res_share,loo
      p_ev,loop_prosumage,res,n)$report_node('energy generated net',loop_res_sha
      re,loop_ev,loop_prosumage,n) = sum( h, sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,
      n,res,h) + lev_G_RES_PRO(scen,n,res,h) + sum( sto , lev_STO_IN_PRO2PRO(sce
      n,n,res,sto,h)) + lev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h))
      ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , report_n
      ode('energy generated net',loop_res_share,loop_ev,loop_prosumage,n) ) ;
2845          report_tech('renshares in nodal net generation',loop_res_share,loo
      p_ev,loop_prosumage,rsvr,n)$report_node('energy generated net',loop_res_sh
      are,loop_ev,loop_prosumage,n) = sum( h, sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(sce
      n,n,rsvr,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , report_node('energy generated net',loop_res_share,loop_ev,loop_prosum
      age,n) ) ;
2846          report_tech('conshares in nodal net generation',loop_res_share,loo
      p_ev,loop_prosumage,con,n)$report_node('energy generated net',loop_res_sha
      re,loop_ev,loop_prosumage,n) = sum( h, sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_G_L(scen,n,con,h)) ) / sum( scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , report_node('energy generated net
      ',loop_res_share,loop_ev,loop_prosumage,n) ) ;
2847   
2848          report_tech('curtailment of fluct res absolute',loop_res_share,loo
      p_ev,loop_prosumage,res,n) =  sum(h, sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_CU(scen,n,res,h) + lev_CU_PRO(scen,n,res,h) ))
       * 1 ;
2849          report_tech('curtailment of fluct res relative',loop_res_share,loo
      p_ev,loop_prosumage,res,n)$(report_tech('curtailment of fluct res absolute
      ',loop_res_share,loop_ev,loop_prosumage,res,n) AND sum(h, sum(scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES_PRO(scen,n,res,h) +
       lev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) ) + sum(h, sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PRO(scen,n,
      res,h) + lev_CU(scen,n,res,h))) > card(h)*eps_rep_abs ) =  sum(h, sum(scen
      $(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,res,h) 
      + lev_CU_PRO(scen,n,res,h) ))/( sum( h , sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , phi_res(n,res,h) * (lev_N_TECH(scen,n,res) + l
      ev_N_RES_PRO(scen,n,res) ))) ) ;
2850   
2851          report_tech('Storage out total non-reserves',loop_res_share,loop_e
      v,loop_prosumage,sto,n) = sum(h, report_tech_hours('generation storage',lo
      op_res_share,loop_ev,loop_prosumage,sto,h,n) ) * 1 ;
2852          report_tech('Storage in total non-reserves',loop_res_share,loop_ev
      ,loop_prosumage,sto,n) = sum(h, report_tech_hours('storage loading',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n) ) * 1 ;
2853   
2854          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,con,n)$(su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen
      ,n,con)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,con,h)) ) / sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,con)) ;
2855          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,res,n)$(su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen
      ,n,res)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,re
      s,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,res,sto,h)) + lev_G_RES_PRO(sc
      en,n,res,h) + lev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h))) / 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(sc
      en,n,res)) ;
2856          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,rsvr,n)$(s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(s
      cen,n,rsvr)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen
      ,n,rsvr,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_N_RSVR_P(scen,n,rsvr)) ;
2857          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(sce
      n,n,sto)) > eps_rep_ins) = ( report_tech('Storage out total non-reserves',
      loop_res_share,loop_ev,loop_prosumage,sto,n)) / sum(scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) ;
2858   
2859   
2860                   report_tech('capacities conventional',loop_res_share,loop
      _ev,loop_prosumage,con,n)$(report_tech('capacities conventional',loop_res_
      share,loop_ev,loop_prosumage,con,n) < eps_rep_ins) = 0 ;
2861                   report_tech('capacities renewable',loop_res_share,loop_ev
      ,loop_prosumage,res,n)$(report_tech('capacities renewable',loop_res_share,
      loop_ev,loop_prosumage,res,n) < eps_rep_ins) = 0 ;
2862                   report_tech('capacities storage MW',loop_res_share,loop_e
      v,loop_prosumage,sto,n)$(report_tech('capacities storage MW',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) < eps_rep_ins) = 0 ;
2863                   report_tech('capacities storage MWh',loop_res_share,loop_
      ev,loop_prosumage,sto,n)$(report_tech('capacities storage MWh',loop_res_sh
      are,loop_ev,loop_prosumage,sto,n) < eps_rep_ins) = 0 ;
2864                   report_tech('capacities reservoir MW',loop_res_share,loop
      _ev,loop_prosumage,rsvr,n)$(report_tech('capacities reservoir MW',loop_res
      _share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_ins) = 0 ;
2865                   report_tech('capacities reservoir MWh',loop_res_share,loo
      p_ev,loop_prosumage,rsvr,n)$(report_tech('capacities reservoir MWh',loop_r
      es_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_ins) = 0 ;
2866                   report_tech('renshares in nodal gross demand',loop_res_sh
      are,loop_ev,loop_prosumage,res,n)$(report_tech('renshares in nodal gross d
      emand',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) = 0 ;
2867                   report_tech('renshares in nodal gross demand',loop_res_sh
      are,loop_ev,loop_prosumage,rsvr,n)$(report_tech('renshares in nodal gross 
      demand',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
2868                   report_tech('conshares in nodal gross demand',loop_res_sh
      are,loop_ev,loop_prosumage,con,n)$(report_tech('conshares in nodal gross d
      emand',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_rel) = 0 ;
2869                   report_tech('renshares in nodal net generation',loop_res_
      share,loop_ev,loop_prosumage,res,n)$(report_tech('renshares in nodal net g
      eneration',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) = 0
       ;
2870                   report_tech('renshares in nodal net generation',loop_res_
      share,loop_ev,loop_prosumage,rsvr,n)$(report_tech('renshares in nodal net 
      generation',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_rel) =
       0 ;
2871                   report_tech('conshares in nodal net generation',loop_res_
      share,loop_ev,loop_prosumage,con,n)$(report_tech('conshares in nodal net g
      eneration',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_rel) = 0
       ;
2872                   report_tech('curtailment of fluct res absolute',loop_res_
      share,loop_ev,loop_prosumage,res,n)$(report_tech('curtailment of fluct res
       absolute',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_abs*card
      (h)*1) = 0 ;
2873                   report_tech('curtailment of fluct res relative',loop_res_
      share,loop_ev,loop_prosumage,res,n)$(report_tech('curtailment of fluct res
       relative',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) = 0
       ;
2874                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,con,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loop
      _prosumage,con,n) < eps_rep_rel) = 0 ;
2875                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,res,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loop
      _prosumage,res,n) < eps_rep_rel) = 0 ;
2876                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,rsvr,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loo
      p_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
2877                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,sto,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_rel) = 0 ;
2878                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,c
      on,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,con,n) < ep
      s_rep_abs) = 0 ;
2879                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,r
      es,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,res,n) < ep
      s_rep_abs) = 0 ;
2880                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,r
      svr,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < 
      eps_rep_abs) = 0 ;
2881                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,s
      to,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n) < ep
      s_rep_abs) = 0 ;
2882                   report_tech('Storage out total non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage out total non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs*card(h)*1)
       = 0 ;
2883                   report_tech('Storage in total non-reserves',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage in total non-reserve
      s',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs*card(h)*1) =
       0 ;
2884   
2885   
2886  * ------------------------------------------------------------------------
      ----
2887   
2888  * REPORT NODE
2889          report_node('renshare in nodal gross demand',loop_res_share,loop_e
      v,loop_prosumage,n) = sum(res, report_tech('renshares in nodal gross deman
      d',loop_res_share,loop_ev,loop_prosumage,res,n)) + sum( rsvr , report_tech
      ('renshares in nodal gross demand',loop_res_share,loop_ev,loop_prosumage,r
      svr,n)) ;
2890          report_node('conshare in nodal gross demand',loop_res_share,loop_e
      v,loop_prosumage,n) = sum(con, report_tech('conshares in nodal gross deman
      d',loop_res_share,loop_ev,loop_prosumage,con,n) ) ;
2891          report_node('net import share in nodal gross demand',loop_res_shar
      e,loop_ev,loop_prosumage,n) = - report_node('net exports',loop_res_share,l
      oop_ev,loop_prosumage,n) / sum( scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , gross_energy_demand(scen,n) ) ;
2892          report_node('renshare in nodal net generation',loop_res_share,loop
      _ev,loop_prosumage,n) = sum(res, report_tech('renshares in nodal net gener
      ation',loop_res_share,loop_ev,loop_prosumage,res,n)) + sum( rsvr , report_
      tech('renshares in nodal net generation',loop_res_share,loop_ev,loop_prosu
      mage,rsvr,n)) ;
2893          report_node('conshare in nodal net generation',loop_res_share,loop
      _ev,loop_prosumage,n) = sum(con, report_tech('conshares in nodal net gener
      ation',loop_res_share,loop_ev,loop_prosumage,con,n) ) ;
2894   
2895                   report_node('renshare in nodal gross demand',loop_res_sha
      re,loop_ev,loop_prosumage,n) $(report_node('renshare in nodal gross demand
      ',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
2896                   report_node('conshare in nodal gross demand',loop_res_sha
      re,loop_ev,loop_prosumage,n)$(report_node('conshare in nodal gross demand'
      ,loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
2897                   report_node('renshare in nodal net generation',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(report_node('renshare in nodal net generat
      ion',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
2898                   report_node('conshare in nodal net generation',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(report_node('conshare in nodal net generat
      ion',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
2899   
2900   
2901   
2902  * ------------------------------------------------------------------------
      ----
2903   
2904  * REPORT TECH
2905          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      con,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_G_L(scen,n,con,h) ) ) ;
2906          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      res,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,res,h) + sum(sto , 
      lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h))
       + lev_G_RES_PRO(scen,n,res,h) + lev_G_RES(scen,n,res,h) - corr_fac_nondis
      (scen,n,res,h))) ;
2907          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      rsvr,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h) ) ) ;
2908          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      sto,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) +
       lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_M2M(scen,n,sto,h) + lev_STO
      _OUT(scen,n,sto,h) - corr_fac_sto(scen,n,sto,h)) ) ;
2909   
2910          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,con,n) = sum( h , sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_G_L(scen,n,con,h) ) ) / report_node('ene
      rgy generated gross',loop_res_share,loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
2911          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,res,n) = sum( h , sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(s
      cen,n,res,h) + sum(sto , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN
      _PRO2M(scen,n,res,sto,h)) + lev_G_RES_PRO(scen,n,res,h) + lev_G_RES(scen,n
      ,res,h) - corr_fac_nondis(scen,n,res,h))) / report_node('energy generated 
      gross',loop_res_share,loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
2912          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,rsvr,n) = sum( h , sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr
      (scen,n,rsvr,h) ) ) / report_node('energy generated gross',loop_res_share,
      loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
2913          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) = sum( h , sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_
      OUT_PRO2M(scen,n,sto,h) + lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_M2
      M(scen,n,sto,h) + lev_STO_OUT(scen,n,sto,h) - corr_fac_sto(scen,n,sto,h)) 
      ) / report_node('energy generated gross',loop_res_share,loop_ev,loop_prosu
      mage,n) * 1 + 1e-9 ;
2914   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto
      ) + lev_N_STO_P_PRO(scen,n,sto) ) > eps_rep_ins) = report_tech('Storage ou
      t total non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n) / sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n
      ,sto) + lev_N_STO_P_PRO(scen,n,sto) ) ;
2915   report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumage,sto,n)
      $(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E
      (scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) > eps_rep_ins) = report_tech(
      'Storage out total non-reserves',loop_res_share,loop_ev,loop_prosumage,sto
      ,n) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_S
      TO_E(scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) * 1 ;
2916   
2917                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,con,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,con,n) < eps_rep_ins ) = 0 ;
2918                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,res,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,res,n) < eps_rep_ins ) = 0 ;
2919                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,rsvr,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_
      prosumage,rsvr,n) < eps_rep_ins ) = 0 ;
2920                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,sto,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_ins ) = 0 ;
2921   
2922                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,con,n)$(report_tech('Energy share in nod
      al gross generation',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_re
      p_rel) = 0 ;
2923                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,res,n)$(report_tech('Energy share in nod
      al gross generation',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_re
      p_rel) = 0 ;
2924                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,rsvr,n)$(report_tech('Energy share in no
      dal gross generation',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_
      rep_rel) = 0 ;
2925                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Energy share in nod
      al gross generation',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_re
      p_rel) = 0 ;
2926         report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(rep
      ort_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs)
       = 0 ;
2927         report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumage,
      sto,n)$(report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumage
      ,sto,n) < eps_rep_abs) = 0 ;
2928   
2929   
2930  * ------------------------------------------------------------------------
      ----
2931   
2932  * RPEORT
2933          report('curtailment of fluct res absolute',loop_res_share,loop_ev,
      loop_prosumage) = sum( n , report_node('curtailment of fluct res absolute'
      ,loop_res_share,loop_ev,loop_prosumage,n) ) ;
2934          report('curtailment of fluct res relative',loop_res_share,loop_ev,
      loop_prosumage) = sum( n , report_node('curtailment of fluct res absolute'
      ,loop_res_share,loop_ev,loop_prosumage,n) ) / sum((res,h,n), sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , phi_res(n,res,h) * (lev_N_
      TECH(scen,n,res) + lev_N_RES_PRO(scen,n,res)) )) ;
2935          report('bio not utilized absolute',loop_res_share,loop_ev,loop_pro
      sumage)$(sum( n , m_e(n,'bio'))) = sum( n , report_node('bio not utilized 
      absolute',loop_res_share,loop_ev,loop_prosumage,n) ) ;
2936          report('bio not utilized relative',loop_res_share,loop_ev,loop_pro
      sumage)$(sum( n , m_e(n,'bio'))) = report('bio not utilized absolute',loop
      _res_share,loop_ev,loop_prosumage) / sum( n , m_e(n,'bio')) ;
2937          report('Capacity total',loop_res_share,loop_ev,loop_prosumage) = s
      um( n , report_node('Capacity total',loop_res_share,loop_ev,loop_prosumage
      ,n)) ;
2938          report('energy demand gross',loop_res_share,loop_ev,loop_prosumage
      ) = sum( n , report_node('energy demand gross',loop_res_share,loop_ev,loop
      _prosumage,n) ) ;
2939          report('energy demand total',loop_res_share,loop_ev,loop_prosumage
      ) = sum ( n , report_node('energy demand total',loop_res_share,loop_ev,loo
      p_prosumage,n) ) ;
2940          report('energy generated net',loop_res_share,loop_ev,loop_prosumag
      e) =  sum( n , report_node('energy generated net',loop_res_share,loop_ev,l
      oop_prosumage,n)) ;
2941          report('energy generated gross',loop_res_share,loop_ev,loop_prosum
      age) =  sum( n , report_node('energy generated gross',loop_res_share,loop_
      ev,loop_prosumage,n)) ;
2942  *        report('gross trade share',loop_res_share,loop_ev,loop_prosumage)
       = sum( (h,n) , report_hours('gross imports',loop_res_share,loop_ev,loop_p
      rosumage,h,n))/ sum( (h,n) , report_hours('energy demanded',loop_res_share
      ,loop_ev,loop_prosumage,h,n) ) ;
2943          report('renshare total',loop_res_share,loop_ev,loop_prosumage) = s
      um( (h,n) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , s
      um( res , lev_G_L(scen,n,res,h) + lev_G_RES(scen,n,res,h) - corr_fac_nondi
      s(scen,n,res,h) + phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res) - lev_CU_PR
      O(scen,n,res,h)) + sum( rsvr , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr
      (scen,n,rsvr,h)))) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , sum( n , gross_energy_demand(scen,n)) ) ;
2944          report('conshare total',loop_res_share,loop_ev,loop_prosumage) = s
      um( (h,n) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , s
      um( con , lev_G_L(scen,n,con,h)) )) / sum( scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , sum( n, gross_energy_demand(scen,n)) ) ;
2945          report('Energy total',loop_res_share,loop_ev,loop_prosumage) = sum
      ( n , report_node('Energy total',loop_res_share,loop_ev,loop_prosumage,n) 
      ) ;
2946   
2947                   report('curtailment of fluct res absolute',loop_res_share
      ,loop_ev,loop_prosumage)$(report('curtailment of fluct res absolute',loop_
      res_share,loop_ev,loop_prosumage) < eps_rep_abs*card(h)) = 0 ;
2948                   report('curtailment of fluct res relative',loop_res_share
      ,loop_ev,loop_prosumage)$(report('curtailment of fluct res relative',loop_
      res_share,loop_ev,loop_prosumage) < eps_rep_rel) = 0 ;
2949                   report('bio not utilized absolute',loop_res_share,loop_ev
      ,loop_prosumage)$(report('bio not utilized absolute',loop_res_share,loop_e
      v,loop_prosumage) < eps_rep_abs*card(h)) = 0 ;
2950                   report('bio not utilized relative',loop_res_share,loop_ev
      ,loop_prosumage)$(report('bio not utilized relative',loop_res_share,loop_e
      v,loop_prosumage) < eps_rep_rel) = 0 ;
2951                   report('Capacity total',loop_res_share,loop_ev,loop_prosu
      mage)$(report('Capacity total',loop_res_share,loop_ev,loop_prosumage) < ep
      s_rep_ins) = 0 ;
2952                   report('gross trade share',loop_res_share,loop_ev,loop_pr
      osumage)$(report('gross trade share',loop_res_share,loop_ev,loop_prosumage
      ) < eps_rep_rel ) = 0 ;
2953                   report('renshare total',loop_res_share,loop_ev,loop_prosu
      mage)$(report('renshare total',loop_res_share,loop_ev,loop_prosumage) < ep
      s_rep_rel ) = 0 ;
2954                   report('conshare total',loop_res_share,loop_ev,loop_prosu
      mage)$(report('conshare total',loop_res_share,loop_ev,loop_prosumage) < ep
      s_rep_rel ) = 0 ;
2955                   report('Energy total',loop_res_share,loop_ev,loop_prosuma
      ge)$(report('Energy total',loop_res_share,loop_ev,loop_prosumage) < eps_re
      p_abs) = 0 ;
2956   
2957   
2958  * ------------------------------------------------------------------------
      ----
2959   
2960  * DSM
              report_tech_hours('load curtailment (non-reserves)',loop_res_share
      ,loop_ev,loop_prosumage,dsm_curt,h,n)$(feat_node('dsm',n)) = sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,dsm_curt
      ,h)) ;
              report_tech_hours('load shift pos (non-reserves)',loop_res_share,l
      oop_ev,loop_prosumage,dsm_shift,h,n)$(feat_node('dsm',n)) = sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP_DEMAND(scen,n,ds
      m_shift,h)) ;
              report_tech_hours('load shift neg (non-reserves)',loop_res_share,l
      oop_ev,loop_prosumage,dsm_shift,h,n)$(feat_node('dsm',n)) = sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND(scen,n,ds
      m_shift,h)) ;
       
              report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,dsm_shift,
      n)$(feat_node('dsm',n) AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) > eps_rep_ins) = sum( (h,
      hh) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM
      _DO(scen,n,dsm_shift,h,hh)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) ;
              report_tech('capacities load curtailment',loop_res_share,loop_ev,l
      oop_prosumage,dsm_curt,n)$(feat_node('dsm',n)) =  sum(scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) ;
              report_tech('capacities load shift',loop_res_share,loop_ev,loop_pr
      osumage,dsm_shift,n)$(feat_node('dsm',n)) =  sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) ;
              report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,dsm_curt,n)$(feat_node('dsm',n)) = sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) / report_node('Capac
      ity total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,dsm_shift,n)$(feat_node('dsm',n)) = sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) / report_node('
      Capacity total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,dsm_curt,n)$(feat_node('dsm',n)) = sum( h , sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,
      dsm_curt,h) - corr_fac_dsm_cu(scen,n,dsm_curt,h)) )  / report_node('energy
       generated gross',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 
      1e-9 ;
              report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n)) = sum( h , sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND
      (scen,n,dsm_shift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) ) / report_
      node('energy generated gross',loop_res_share,loop_ev,loop_prosumage,n) * %
      sec_hour% + 1e-9 ;
              report_tech('Load shift pos absolute (total)',loop_res_share,loop_
      ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n)) = sum( h , sum(scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP(scen,n,dsm_sh
      ift,h)) ) ;
              report_tech('Load shift neg absolute (total)',loop_res_share,loop_
      ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n)) = sum( (h,hh) , sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO(scen,n,d
      sm_shift,h,hh)) ) ;
       
              report_node('load curtailment absolute (non-reserves)',loop_res_sh
      are,loop_ev,loop_prosumage,n)$(feat_node('dsm',n)) =  sum((dsm_curt,h), su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen
      ,n,dsm_curt,h))) * %sec_hour% ;
              report_node('load shift pos absolute (non-reserves)',loop_res_shar
      e,loop_ev,loop_prosumage,n)$(feat_node('dsm',n)) =  sum((dsm_shift,h), sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP_DEMAN
      D(scen,n,dsm_shift,h))) * %sec_hour% ;
              report_node('load shift neg absolute (non-reserves)',loop_res_shar
      e,loop_ev,loop_prosumage,n)$(feat_node('dsm',n)) =  sum((dsm_shift,h), sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAN
      D(scen,n,dsm_shift,h))) * %sec_hour% ;
       
                       report_tech_hours('load curtailment (non-reserves)',loop_
      res_share,loop_ev,loop_prosumage,dsm_curt,h,n)$(report_tech_hours('load cu
      rtailment (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_curt,h
      ,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('load shift pos (non-reserves)',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,h,n)$(report_tech_hours('load shi
      ft pos (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,h,n
      ) < eps_rep_abs) = 0 ;
                       report_tech_hours('load shift neg (non-reserves)',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,h,n)$(report_tech_hours('load shi
      ft neg (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,h,n
      ) < eps_rep_abs) = 0 ;
       
                       report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,d
      sm_shift,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,dsm_s
      hift,n) < eps_rep_abs) = 0 ;
                       report_tech('capacities load curtailment',loop_res_share,
      loop_ev,loop_prosumage,dsm_curt,n)$(report_tech('capacities load curtailme
      nt',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n) < eps_rep_ins) = 0 ;
                       report_tech('capacities load shift',loop_res_share,loop_e
      v,loop_prosumage,dsm_shift,n)$(report_tech('capacities load shift',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_ins) = 0 ;
                       report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,dsm_curt,n)$(report_tech('Capacity share',loop_res_share,loop_ev
      ,loop_prosumage,dsm_curt,n) < eps_rep_rel) = 0 ;
                       report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,dsm_shift,n)$(report_tech('Capacity share',loop_res_share,loop_e
      v,loop_prosumage,dsm_shift,n) < eps_rep_rel) = 0 ;
                       report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,dsm_curt,n)$(report_tech('Energy share i
      n nodal gross generation',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n
      ) < eps_rep_rel) = 0 ;
                       report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Energy share 
      in nodal gross generation',loop_res_share,loop_ev,loop_prosumage,dsm_shift
      ,n) < eps_rep_rel) = 0 ;
                       report_tech('Load shift pos absolute (total)',loop_res_sh
      are,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos absol
      ute (total)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < card(h)*
      eps_rep_abs) = 0 ;
                       report_tech('Load shift neg absolute (total)',loop_res_sh
      are,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift neg absol
      ute (total)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < card(h)*
      eps_rep_abs) = 0 ;
      *                 report_tech('Load shift pos absolute (wholesale)',loop_r
      es_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos 
      absolute (wholesale)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) <
       card(h)*eps_rep_abs) = 0 ;
      *                 report_tech('Load shift neg absolute (wholesale)',loop_r
      es_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift neg 
      absolute (wholesale)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) <
       card(h)*eps_rep_abs) = 0 ;
      *                 report_tech('Load shift pos absolute (reserves)',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos a
      bsolute (reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < c
      ard(h)*eps_rep_abs) = 0 ;
       
                       report_node('load curtailment absolute (non-reserves)',lo
      op_res_share,loop_ev,loop_prosumage,n)$(report_node('load curtailment abso
      lute (non-reserves)',loop_res_share,loop_ev,loop_prosumage,n) < card(h)*ep
      s_rep_abs*%sec_hour%) = 0 ;
                       report_node('load shift pos absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,n)$(report_node('load shift pos absolute
       (non-reserves)',loop_res_share,loop_ev,loop_prosumage,n) < card(h)*eps_re
      p_abs*%sec_hour%) = 0 ;
                       report_node('load shift neg absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,n)$(report_node('load shift neg absolute
       (non-reserves)',loop_res_share,loop_ev,loop_prosumage,n) < card(h)*eps_re
      p_abs*%sec_hour%) = 0 ;
      $ontext
3002   
3003   
3004  * ------------------------------------------------------------------------
      ----
3005   
3006  * EV
              report_tech_hours('EV charge',loop_res_share,loop_ev,loop_prosumag
      e,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_EV_CHARGE(scen,n,ev,h)) ;
              report_tech_hours('EV discharge',loop_res_share,loop_ev,loop_prosu
      mage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_EV_DISCHARGE(scen,n,ev,h)) ;
              report_tech_hours('EV phevfuel consumption',loop_res_share,loop_ev
      ,loop_prosumage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_EV_PHEVFUEL(scen,n,ev,h));
              report_tech_hours('EV electrical consumption',loop_res_share,loop_
      ev,loop_prosumage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_EV_GED(scen,n,ev,h));
              report_tech_hours('EV battery level',loop_res_share,loop_ev,loop_p
      rosumage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_EV_L(scen,n,ev,h)) ;
       
              report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = (sum( (h,ev) , 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_EV_DISCHA
      RGE(scen,n,ev,h))) - sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( h , corr_fac_ev(scen,n,h))))/ report_node('energy generated g
      ross',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
              report_tech('EV charge total wholesale',loop_res_share,loop_ev,loo
      p_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tech_hour
      s('EV charge',loop_res_share,loop_ev,loop_prosumage,ev,h,n) ) * %sec_hour%
       ;
              report_tech('EV discharge total wholesale',loop_res_share,loop_ev,
      loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tech_h
      ours('EV discharge',loop_res_share,loop_ev,loop_prosumage,ev,h,n) ) * %sec
      _hour% ;
              report_tech('EV phevfuel total consumption',loop_res_share,loop_ev
      ,loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tech_
      hours('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,ev,h
      ,n) ) * %sec_hour% ;
              report_tech('EV electrical total consumption',loop_res_share,loop_
      ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tec
      h_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosumage,
      ev,h,n) ) * %sec_hour% ;
              report_tech('EV share of electrical consumption',loop_res_share,lo
      op_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND sum((h,ev), report
      _tech_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosum
      age,ev,h,n) + report_tech_hours('EV phevfuel consumption',loop_res_share,l
      oop_ev,loop_prosumage,ev,h,n)) > card(h)*eps_rep_abs) = sum((h,ev), report
      _tech_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosum
      age,ev,h,n) ) * %sec_hour% / (sum((h,ev), report_tech_hours('EV electrical
       consumption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) + report_tech_
      hours('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,ev,h
      ,n) ) ) ;
              report_tech('EV share of phevfuel consumption',loop_res_share,loop
      _ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND sum((h,ev), report_t
      ech_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosumag
      e,ev,h,n) + report_tech_hours('EV phevfuel consumption',loop_res_share,loo
      p_ev,loop_prosumage,ev,h,n)) > card(h)*eps_rep_abs) = sum((h,ev), report_t
      ech_hours('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,
      ev,h,n) ) * %sec_hour% / (sum((h,ev), report_tech_hours('EV electrical con
      sumption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) + report_tech_hour
      s('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) 
      ) ) ;
       
              report_node('gross_energy_demand w/o EV',loop_res_share,loop_ev,lo
      op_prosumage,n)$feat_node('ev',n) = sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , gross_energy_demand(scen,n)) - sum( (ev,h) , sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_EV_GED(scen,n,e
      v,h)) ) ;
              report_node('EV electricity demand',loop_res_share,loop_ev,loop_pr
      osumage,n)$(feat_node('ev',n)) = sum( (ev,h) , sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_EV_GED(scen,n,ev,h)) ) ;
              report_node('renshare EV',loop_res_share,loop_ev,loop_prosumage,n)
      $feat_node('ev',n) = (report_node('renshare in nodal gross demand',loop_re
      s_share,loop_ev,loop_prosumage,n) - report_node('gross_energy_demand w/o E
      V',loop_res_share,loop_ev,loop_prosumage,n) * report_node('EV electricity 
      demand',loop_res_share,loop_ev,loop_prosumage,n) ) / report_node('energy d
      emand gross',loop_res_share,loop_ev,loop_prosumage,n) ;
              report_node('conshare EV',loop_res_share,loop_ev,loop_prosumage,n)
      $feat_node('ev',n) = 1 - report_node('renshare EV',loop_res_share,loop_ev,
      loop_prosumage,n) ;
      %EV_FREE%%EV_DEFAULT%        report_node('renshare EV',loop_res_share,loop
      _ev,loop_prosumage,n)$(feat_node('ev',n)) = 1 ;
      %EV_FREE%%EV_DEFAULT%        report_node('conshare EV',loop_res_share,loop
      _ev,loop_prosumage,n)$(feat_node('ev',n)) = 0 ;
       
                       report_tech_hours('EV charge',loop_res_share,loop_ev,loop
      _prosumage,ev,h,n)$(report_tech_hours('EV charge',loop_res_share,loop_ev,l
      oop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV discharge',loop_res_share,loop_ev,l
      oop_prosumage,ev,h,n)$(report_tech_hours('EV discharge',loop_res_share,loo
      p_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV phevfuel consumption',loop_res_shar
      e,loop_ev,loop_prosumage,ev,h,n)$(report_tech_hours('EV phevfuel consumpti
      on',loop_res_share,loop_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV electrical consumption',loop_res_sh
      are,loop_ev,loop_prosumage,ev,h,n)$(report_tech_hours('EV electrical consu
      mption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV battery level',loop_res_share,loop_
      ev,loop_prosumage,ev,h,n)$(report_tech_hours('EV battery level',loop_res_s
      hare,loop_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('Energy share i
      n nodal gross generation',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n
      ) < eps_rep_rel) = 0 ;
                       report_tech('EV charge total wholesale',loop_res_share,lo
      op_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV charge total wholesale',
      loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_abs*card(h)*%s
      ec_hour%) = 0 ;
                       report_tech('EV discharge total wholesale',loop_res_share
      ,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV discharge total whole
      sale',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_abs*card
      (h)*%sec_hour%) = 0 ;
                       report_tech('EV phevfuel total consumption',loop_res_shar
      e,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV phevfuel total consu
      mption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_abs*ca
      rd(h)*%sec_hour%) = 0 ;
                       report_tech('EV electrical total consumption',loop_res_sh
      are,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV electrical total c
      onsumption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_ab
      s*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV share of electrical consumption',loop_res
      _share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV share of electr
      ical consumption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_
      rep_rel) = 0 ;
                       report_tech('EV share of phevfuel consumption',loop_res_s
      hare,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV share of phevfuel
       consumption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_
      rel) = 0 ;
                       report_node('EV_electricity_demand',loop_res_share,loop_e
      v,loop_prosumage,n)$(report_node('EV_electricity_demand',loop_res_share,lo
      op_ev,loop_prosumage,n) < card(h)*eps_rep_abs) = 0 ;
                       report_node('renshare EV',loop_res_share,loop_ev,loop_pro
      sumage,n)$(report_node('renshare EV',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_rel) = eps ;
                       report_node('conshare EV',loop_res_share,loop_ev,loop_pro
      sumage,n)$(report_node('conshare EV',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_rel) = eps ;
                       report_node('gross_energy_demand w/o EV',loop_res_share,l
      oop_ev,loop_prosumage,n)$(report_node('gross_energy_demand w/o EV',loop_re
      s_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
      $ontext
3047   
3048   
3049  * ------------------------------------------------------------------------
      ----
3050   
3051  * Reserves
               report_reserves('reserve provision requirements',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,n) = feat_node('reserves',n) * phi_res
      erves_pr_up(n) * sum( reserves_nonprim ,  (1000 * phi_reserves_share(n,res
      erves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum( nondis , r
      eserves_slope(n,reserves_nonprim,nondis) * sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondis) + lev_N_RES_PRO(
      scen,n,nondis)))/1000) )) ) ;
               report_reserves('reserve provision requirements',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,n) = feat_node('reserves',n) * 1000
       * phi_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves
      _nonprim) + sum( nondis , reserves_slope(n,reserves_nonprim,nondis) * sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen
      ,n,nondis) + lev_N_RES_PRO(scen,n,nondis)))/1000) ) ;
      * ## marginals missing
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('re
      serves',n) * (report_reserves('reserve provision requirements',loop_res_sh
      are,loop_ev,loop_prosumage,reserves,n)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('r
      eserves',n) * (phi_reserves_call(n,reserves,h) * report_reserves('reserve 
      provision requirements',loop_res_share,loop_ev,loop_prosumage,reserves,n))
       ;
      $ontext
               report_reserves_hours('reserve provision requirements',loop_res_s
      hare,loop_ev,loop_prosumage,reserves_prim,h,n) = feat_node('reserves',n) *
       reserves_exogenous(n,reserves_prim,h) ;
               report_reserves_hours('reserve provision requirements',loop_res_s
      hare,loop_ev,loop_prosumage,reserves_nonprim,h,n) = feat_node('reserves',n
      ) * reserves_exogenous(n,reserves_nonprim,h) ;
               report_reserves_hours('reserve prices',loop_res_share,loop_ev,loo
      p_prosumage,reserves_nonprim,h,n) = feat_node('reserves',n) * sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , marginal_con9a(scen,reser
      ves_nonprim,h,n) );
               report_reserves_hours('reserve prices',loop_res_share,loop_ev,loo
      p_prosumage,reserves_prim,h,n) = feat_node('reserves',n) * sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , marginal_con9b(scen,reserves
      _prim,h,n) );
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('re
      serves',n) * (report_reserves_hours('reserve provision requirements',loop_
      res_share,loop_ev,loop_prosumage,reserves,h,n)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('r
      eserves',n) * (phi_reserves_call(n,reserves,h) * report_reserves_hours('re
      serve provision requirements',loop_res_share,loop_ev,loop_prosumage,reserv
      es,h,n)) ;
      $ontext
3069   
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dis,h,n)$(feat_node('reserves',n)) = sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(scen,n,re
      serves,dis,h)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,dis,h,n)$(feat_node('reserves',n)) = sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(scen,n,r
      eserves,dis,h))*phi_reserves_call(n,reserves,h) ;
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,nondis,h,n)$(feat_node('reserves',n)) = sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(sce
      n,n,reserves,nondis,h)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,nondis,h,n)$(feat_node('reserves',n)) = sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(sc
      en,n,reserves,nondis,h))*phi_reserves_call(n,reserves,h) ;
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,rsvr,h,n)$(feat_node('reserves',n)) = sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n,
      reserves,rsvr,h)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,rsvr,h,n)$(feat_node('reserves',n)) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n
      ,reserves,rsvr,h))*phi_reserves_call(n,reserves,h) ;
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,sto,h,n)$(feat_node('reserves',n)) = (sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_STO_IN(scen,
      n,reserves,sto,h)) + sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_RP_STO_OUT(scen,n,reserves,sto,h))) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,sto,h,n)$(feat_node('reserves',n)) = ((sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_STO_IN(sce
      n,n,reserves,sto,h)) + sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_RP_STO_OUT(scen,n,reserves,sto,h)))*phi_reserves_call(n,rese
      rves,h)) ;
       
               report_reserves_tech('Reserves provision ratio',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dis,n)$(feat_node('reserves',n) AND sum( h ,
       sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen
      ,n,dis,h) + corr_fac_dis(scen,n,dis,h))) > card(h)*eps_rep_abs)= sum( h , 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(sc
      en,n,reserves,dis,h)) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,dis,h) + corr_fac_dis(scen,n,dis,h)) 
      ) ;
               report_reserves_tech('Reserves activation ratio',loop_res_share,l
      oop_ev,loop_prosumage,reserves,dis,n)$(feat_node('reserves',n) AND sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(sce
      n,n,dis,h) + corr_fac_dis(scen,n,dis,h))) > card(h)*eps_rep_abs) = sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(
      scen,n,reserves,dis,h)) * phi_reserves_call(n,reserves,h)) / sum( h , sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,di
      s,h) + corr_fac_dis(scen,n,dis,h)) ) ;
               report_reserves_tech('Reserves provision ratio',loop_res_share,lo
      op_ev,loop_prosumage,reserves,nondis,n)$(feat_node('reserves',n) AND sum( 
      h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES
      (scen,n,nondis,h))) >  card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(scen,n,reserves,no
      ndis,h)) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_G_RES(scen,n,nondis,h)) ) ;
               report_reserves_tech('Reserves activation ratio',loop_res_share,l
      oop_ev,loop_prosumage,reserves,nondis,n)$(feat_node('reserves',n) AND sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RE
      S(scen,n,nondis,h))) > card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(scen,n,reserves,no
      ndis,h)) * phi_reserves_call(n,reserves,h) ) / sum( h , sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES(scen,n,nondis,h)) ) ;
               report_reserves_tech('Reserves provision ratio',loop_res_share,lo
      op_ev,loop_prosumage,reserves,rsvr,n)$(feat_node('reserves',n) AND sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RSVR_OU
      T(scen,n,rsvr,h))) >  card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n,reserves,rsvr,
      h)) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_RSVR_OUT(scen,n,rsvr,h)) ) ;
               report_reserves_tech('Reserves activation ratio',loop_res_share,l
      oop_ev,loop_prosumage,reserves,rsvr,n)$(feat_node('reserves',n) AND sum( h
       , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RSVR_O
      UT(scen,n,rsvr,h))) >  card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n,reserves,rsvr
      ,h)) * phi_reserves_call(n,reserves,h) ) / sum( h , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage out posit
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) =
       sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _RP_STO_OUT(scen,n,reserves_up,sto,h)) ) / sum( h , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage out negat
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) =
       sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _RP_STO_OUT(scen,n,reserves_do,sto,h)) ) / sum( h , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage in positi
      ve reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(fe
      at_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_up,sto,h)) ) / sum( h , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage in negati
      ve reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(fe
      at_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_do,sto,h)) ) / sum( h , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage out posi
      tive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(
      feat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_STO_OUT(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,reserves_up,
      h) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage out nega
      tive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(
      feat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_STO_OUT(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,reserves_do,
      h) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage in posit
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_STO_IN(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,reserves_up,h) 
      ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_STO_IN(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage in negat
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_STO_IN(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,reserves_do,h) 
      ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_STO_IN(scen,n,sto,h)) ) ;
      $ontext
3096   
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_DIS(scen,n,reserves_nonprim,dis,h))) / ((card(h)-1) * 1000 * phi_reserve
      s_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + su
      m( nondis ,reserves_slope(n,reserves_nonprim,nondis) * sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondis) + le
      v_N_RES_PRO(scen,n,nondis)))/1000) ) ) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n)) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_NONDIS(scen,n,reserves_nonprim,nondis,h))) / ((card(h)-1) * 1000 * ph
      i_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonp
      rim) + sum( nondisnondis ,reserves_slope(n,reserves_nonprim,nondisnondis) 
      * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TEC
      H(scen,n,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_RSVR(scen,n,reserves_nonprim,rsvr,h))) / ((card(h)-1) * 1000 * phi_rese
      rves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) +
       sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n
      ,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h
      ))) / ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (rese
      rves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,res
      erves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,lo
      op_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,no
      ndisnondis)))/1000) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_D
      IS(scen,n,reserves_prim,dis,h))) / (phi_reserves_pr_up(n)* sum( reserves_n
      onprim ,  ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (
      reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n
      ,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,
      n,nondisnondis)))/1000) )) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_NONDIS(scen,n,reserves_prim,nondis,h))) / (phi_reserves_pr_up(n) * sum( 
      reserves_nonprim ,  ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_no
      nprim) * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserv
      es_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES
      _PRO(scen,n,nondisnondis)))/1000) )) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = sum
      ( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      RSVR(scen,n,reserves_prim,rsvr,h))) / (phi_reserves_pr_up(n) * sum( reserv
      es_nonprim ,  ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim)
       * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slo
      pe(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(s
      cen,n,nondisnondis)))/1000) )) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_S
      TO_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h))) / (ph
      i_reserves_pr_up(n) * sum( reserves_nonprim ,  ((card(h)-1) * 1000 * phi_r
      eserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim
      ) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(sce
      n,n,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ));
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum
      (h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS
      (scen,n,reserves_prim,dis,h))*phi_reserves_call(n,reserves_prim,h)) / sum(
       h , phi_reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n) * sum( 
      reserves_nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( reser
      ves_intercept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,re
      serves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,n
      ondisnondis)))/1000 ) ) )   ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      NONDIS(scen,n,reserves_prim,nondis,h))*phi_reserves_call(n,reserves_prim,h
      )) / sum( h , phi_reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n
      )* sum( reserves_nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) *
       ( reserves_intercept(n,reserves_nonprim) + sum(nondisnondis , reserves_sl
      ope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis) + lev_N_RES_PR
      O(scen,n,nondisnondis)))/1000 ) ) )   ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = su
      m(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RS
      VR(scen,n,reserves_prim,rsvr,h))*phi_reserves_call(n,reserves_prim,h)) / s
      um( h , phi_reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n)* sum
      ( reserves_nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( res
      erves_intercept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,
      reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis) + lev_N_RES_PRO(scen
      ,n,nondisnondis)))/1000 ) ) )   ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum
      (h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_ST
      O_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h)))*phi_re
      serves_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_pr
      im,h) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserv
      es_share(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + 
      sum( nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen
      ,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   );
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      DIS(scen,n,reserves_nonprim,dis,h))*phi_reserves_call(n,reserves_nonprim,h
      )) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_reserve
      s_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + su
      m(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,no
      ndisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n))
       = sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_NONDIS(scen,n,reserves_nonprim,nondis,h))*phi_reserves_call(n,reserves_
      nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * ph
      i_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonp
      rim) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(
      scen,n,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) =
       sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _RSVR(scen,n,reserves_nonprim,rsvr,h))*phi_reserves_call(n,reserves_nonpri
      m,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_rese
      rves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) +
       sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n
      ,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = 
      sum(h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_shar
      e,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h)
      ))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n
      ,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (re
      serves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,r
      eserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,
      nondisnondis)))/1000) )) ;
      $ontext
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_DIS(scen,n,reserves_nonprim,dis,h))) / sum( h$(ord(h) > 1), reserves_exo
      genous(n,reserves_nonprim,h))  ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n)) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_NONDIS(scen,n,reserves_nonprim,nondis,h))) / sum( h$(ord(h) > 1), res
      erves_exogenous(n,reserves_nonprim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_RSVR(scen,n,reserves_nonprim,rsvr,h))) / sum( h$(ord(h) > 1), reserves_
      exogenous(n,reserves_nonprim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h
      ))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_D
      IS(scen,n,reserves_prim,dis,h))) / sum( h$(ord(h) > 1), reserves_exogenous
      (n,reserves_prim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_NONDIS(scen,n,reserves_prim,nondis,h))) / sum( h$(ord(h) > 1), reserves_
      exogenous(n,reserves_prim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = sum
      ( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      RSVR(scen,n,reserves_prim,rsvr,h))) / sum( h$(ord(h) > 1), reserves_exogen
      ous(n,reserves_prim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_S
      TO_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h))) / sum
      ( h$(ord(h) > 1), reserves_exogenous(n,reserves_prim,h)) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum
      (h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS
      (scen,n,reserves_prim,dis,h))*phi_reserves_call(n,reserves_prim,h)) / sum(
       h , phi_reserves_call(n,reserves_prim,h) * reserves_exogenous(n,reserves_
      prim,h) )     ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      NONDIS(scen,n,reserves_prim,nondis,h))*phi_reserves_call(n,reserves_prim,h
      )) / sum( h , phi_reserves_call(n,reserves_prim,h) * reserves_exogenous(n,
      reserves_prim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = su
      m(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RS
      VR(scen,n,reserves_prim,rsvr,h))*phi_reserves_call(n,reserves_prim,h)) / s
      um( h , phi_reserves_call(n,reserves_prim,h) * reserves_exogenous(n,reserv
      es_prim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum
      (h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_ST
      O_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h)))*phi_re
      serves_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_pr
      im,h) * reserves_exogenous(n,reserves_prim,h) );
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      DIS(scen,n,reserves_nonprim,dis,h))*phi_reserves_call(n,reserves_nonprim,h
      )) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_exogenous
      (n,reserves_nonprim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n))
       = sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_NONDIS(scen,n,reserves_nonprim,nondis,h))*phi_reserves_call(n,reserves_
      nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_
      exogenous(n,reserves_nonprim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) =
       sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _RSVR(scen,n,reserves_nonprim,rsvr,h))*phi_reserves_call(n,reserves_nonpri
      m,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_exogen
      ous(n,reserves_nonprim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = 
      sum(h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_shar
      e,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h)
      ))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n
      ,reserves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h) ) ;
      $ontext
3135   
               report_tech('Storage positive reserves activation by storage in',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = s
      um( (h,reserves_up) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_RP_STO_IN(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,re
      serves_up,h)) * %sec_hour% ;
               report_tech('Storage negative reserves activation by storage in',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = s
      um( (h,reserves_do) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_RP_STO_IN(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,re
      serves_do,h)) * %sec_hour% ;
               report_tech('Storage positive reserves activation by storage out'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = 
      sum( (h,reserves_up) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_RP_STO_OUT(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,
      reserves_up,h)) * %sec_hour% ;
               report_tech('Storage negative reserves activation by storage out'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = 
      sum( (h,reserves_do) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_RP_STO_OUT(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,
      reserves_do,h)) * %sec_hour% ;
               report_tech('Load shift pos absolute (non-reserves)',loop_res_sha
      re,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('reserves',n)) = sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP_
      DEMAND(scen,n,dsm_shift,h)) ) ;
               report_tech('Load shift neg absolute (non-reserves)',loop_res_sha
      re,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('reserves',n)) = sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_
      DEMAND(scen,n,dsm_shift,h)) ) ;
       
               report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(f
      eat_node('reserves',n) AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_P(scen,n,sto)) > eps_rep_ins) = ( report_tech('Sto
      rage out total non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n)
                              + sum( (h,reserves_up) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_up,sto,
      h)) * phi_reserves_call(n,reserves_up,h)) * %sec_hour%
                              - sum( (h,reserves_do) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_do,sto,
      h)) * phi_reserves_call(n,reserves_do,h)) * %sec_hour%
                              ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_N_STO_P(scen,n,sto)) ;
               report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumag
      e,sto,n)$(feat_node('reserves',n) AND sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) > eps_rep_ins) = ( repor
      t_tech('Storage out total non-reserves',loop_res_share,loop_ev,loop_prosum
      age,sto,n)
                              + sum( (h,reserves_up) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_up,sto,
      h)) * phi_reserves_call(n,reserves_up,h)) * %sec_hour%
                              - sum( (h,reserves_do) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_do,sto,
      h)) * phi_reserves_call(n,reserves_do,h)) * %sec_hour%
                              ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_N_STO_E(scen,n,sto)) * %sec_hour% ;
               report_tech('Storage EP-ratio',loop_res_share,loop_ev,loop_prosum
      age,sto,n)$(feat_node('reserves',n) AND sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto) + lev_N_STO_P_PRO(scen,
      n,sto) ) > eps_rep_ins AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_E(scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) * %s
      ec_hour% > eps_rep_ins ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_E(scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) * %s
      ec_hour% / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_STO_P(scen,n,sto) + lev_N_STO_P_PRO(scen,n,sto) ) ;
       
       
      %reserves_exogenous%                 report_reserves('reserve provision re
      quirements',loop_res_share,loop_ev,loop_prosumage,reserves_prim,n)$(feat_n
      ode('reserves',n) AND report_reserves('reserve provision requirements',loo
      p_res_share,loop_ev,loop_prosumage,reserves_prim,n) < eps_rep_abs) = 0 ;
      %reserves_exogenous%                 report_reserves('reserve provision re
      quirements',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,n)$(fea
      t_node('reserves',n) AND report_reserves('reserve provision requirements',
      loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,n) < eps_rep_abs) =
       0 ;
      %reserves_endogenous%                report_reserves_hours('reserve provis
      ion requirements',loop_res_share,loop_ev,loop_prosumage,reserves_prim,h,n)
      $(feat_node('reserves',n) AND report_reserves_hours('reserve provision req
      uirements',loop_res_share,loop_ev,loop_prosumage,reserves_prim,h,n) < eps_
      rep_abs) = 0 ;
      %reserves_endogenous%                report_reserves_hours('reserve provis
      ion requirements',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,h
      ,n)$(feat_node('reserves',n) AND report_reserves_hours('reserve provision 
      requirements',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,h,n) 
      < eps_rep_abs) = 0 ;
       
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,'required',h,n)$(report_reserves_tec
      h_hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserve
      s,'required',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,'required',h,n)$(report_reserves_te
      ch_hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reser
      ves,'required',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,dis,h,n)$(report_reserves_tech_hours
      ('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,dis,h
      ,n) < eps_rep_abs ) = 0;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,dis,h,n)$(report_reserves_tech_hour
      s('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,dis
      ,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,nondis,h,n)$(report_reserves_tech_ho
      urs('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,no
      ndis,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,nondis,h,n)$(report_reserves_tech_h
      ours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,
      nondis,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,sto,h,n)$(report_reserves_tech_hours
      ('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,sto,h
      ,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,sto,h,n)$(report_reserves_tech_hour
      s('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,sto
      ,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,rsvr,h,n)$(report_reserves_tech_hour
      s('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,rsvr
      ,h,n) < eps_rep_abs) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,rsvr,h,n)$(report_reserves_tech_hou
      rs('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,rs
      vr,h,n) < eps_rep_abs) = 0 ;
       
                       report_reserves_tech('Reserves provision ratio',loop_res_
      share,loop_ev,loop_prosumage,reserves,dis,n)$(report_reserves_tech('Reserv
      es provision ratio',loop_res_share,loop_ev,loop_prosumage,reserves,dis,n) 
      < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio',loop_res
      _share,loop_ev,loop_prosumage,reserves,dis,n)$(report_reserves_tech('Reser
      ves activation ratio',loop_res_share,loop_ev,loop_prosumage,reserves,dis,n
      ) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio',loop_res_
      share,loop_ev,loop_prosumage,reserves,nondis,n)$(report_reserves_tech('Res
      erves provision ratio',loop_res_share,loop_ev,loop_prosumage,reserves,nond
      is,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio',loop_res
      _share,loop_ev,loop_prosumage,reserves,nondis,n)$(report_reserves_tech('Re
      serves activation ratio',loop_res_share,loop_ev,loop_prosumage,reserves,no
      ndis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio',loop_res_
      share,loop_ev,loop_prosumage,reserves,rsvr,n)$(report_reserves_tech('Reser
      ves provision ratio',loop_res_share,loop_ev,loop_prosumage,reserves,rsvr,n
      ) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio',loop_res
      _share,loop_ev,loop_prosumage,reserves,rsvr,n)$(report_reserves_tech('Rese
      rves activation ratio',loop_res_share,loop_ev,loop_prosumage,reserves,rsvr
      ,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage o
      ut positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves provision ratio (storage out positive r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage o
      ut negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves provision ratio (storage out negative r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage i
      n positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n
      )$(report_reserves_tech('Reserves provision ratio (storage in positive res
      erves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_re
      l) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage i
      n negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n
      )$(report_reserves_tech('Reserves provision ratio (storage in negative res
      erves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_re
      l) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      out positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto
      ,n)$(report_reserves_tech('Reserves activation ratio (storage out positive
       reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_re
      p_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      out negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto
      ,n)$(report_reserves_tech('Reserves activation ratio (storage out negative
       reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_re
      p_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      in positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves activation ratio (storage in positive r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      in negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves activation ratio (storage in negative r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,dis,n)$(report_reserves_tech
      ('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _nonprim,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_nonprim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(report_reserves_tec
      h('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserve
      s_nonprim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,sto,n)$(report_reserves_tech
      ('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _nonprim,sto,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,dis,n)$(report_reserves_tech('r
      eserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_pr
      im,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,nondis,n)$(report_reserves_tech
      ('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _prim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,rsvr,n)$(report_reserves_tech('
      reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_p
      rim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,sto,n)$(report_reserves_tech('r
      eserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_pr
      im,sto,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,dis,n)$(report_reserves_tech('
      reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_
      prim,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,nondis,n)$(report_reserves_tec
      h('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_prim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,rsvr,n)$(report_reserves_tech(
      'reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _prim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,sto,n)$(report_reserves_tech('
      reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_
      prim,sto,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,dis,n)$(report_reserves_tec
      h('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_nonprim,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(report_reserves_te
      ch('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_nonprim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,sto,n)$(report_reserves_tec
      h('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_nonprim,sto,n) < eps_rep_rel) = 0 ;
       
                       report_tech('Storage positive reserves activation by stor
      age in',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage
       positive reserves activation by storage in',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('Storage negative reserves activation by stor
      age in',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage
       negative reserves activation by storage in',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('Storage positive reserves activation by stor
      age out',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storag
      e positive reserves activation by storage out',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('Storage negative reserves activation by stor
      age out',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storag
      e negative reserves activation by storage out',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,s
      to,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n) < ep
      s_rep_abs) = 0 ;
                       report_tech('Storage cycles',loop_res_share,loop_ev,loop_
      prosumage,sto,n)$(report_tech('Storage cycles',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_abs) = 0 ;
                       report_tech('Storage EP-ratio',loop_res_share,loop_ev,loo
      p_prosumage,sto,n)$(report_tech('Storage EP-ratio',loop_res_share,loop_ev,
      loop_prosumage,sto,n) < eps_rep_rel) = 0 ;
                       report_tech('Load shift pos absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift po
      s absolute (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift
      ,n) < card(h) * eps_rep_abs) = 0 ;
                       report_tech('Load shift neg absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift ne
      g absolute (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift
      ,n) < card(h) * eps_rep_abs) = 0 ;
      $ontext
3213   
3214   
3215  * ------------------------------------------------------------------------
      ----
3216   
3217  * Reserves and DSM
      %reserves_endogenous%$ontext
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND f
      eat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h)))
       / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserv
      es_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reser
      ves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nond
      isnondis)))/1000) )))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shift
      ,h))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (r
      eserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,
      reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n
      ,nondisnondis)))/1000) )))   ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h))
      *phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,r
      eserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (rese
      rves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,res
      erves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,lo
      op_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,no
      ndisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND
       feat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shif
      t,h)) * phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_c
      all(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) 
      * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slop
      e(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sc
      en,n,nondisnondis)))/1000) )))   ;
      $ontext
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND f
      eat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h))) 
      / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shift,
      h))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h))   ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h))*
      phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,re
      serves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND
       feat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shift
      ,h)) * phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_ca
      ll(n,reserves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h))   ;
      $ontext
      %reserves%$ontext
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,dsm_shift,h,n)$(feat_node('dsm',n) AND feat_n
      ode('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_RP_DSM_SHIFT(scen,n,reserves,dsm_shift,h))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dsm_shift,h,n)$(feat_node('dsm',n) AND feat_
      node('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_RP_DSM_SHIFT(scen,n,reserves,dsm_shift,h))*phi_reserves_call(
      n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,dsm_curt,h,n)$(feat_node('dsm',n) AND feat_no
      de('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_RP_DSM_CU(scen,n,reserves,dsm_curt,h))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dsm_curt,h,n)$(feat_node('dsm',n) AND feat_n
      ode('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_RP_DSM_CU(scen,n,reserves,dsm_curt,h))*phi_reserves_call(n,res
      erves,h)  ;
       
              report_tech('Load shift pos absolute (reserves)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n) AND feat_node('reser
      ves',n)) = report_tech('Load shift pos absolute (total)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n) - report_tech('Load shift pos absolute (
      non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) ;
              report_tech('Load shift neg absolute (reserves)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n) AND feat_node('reser
      ves',n)) = report_tech('Load shift neg absolute (total)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n) - report_tech('Load shift neg absolute (
      non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) ;
       
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(report_reserves
      _tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,dsm_curt,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(report_reserve
      s_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,re
      serves_nonprim,dsm_shift,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(report_reserve
      s_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,r
      eserves_nonprim,dsm_curt,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(report_reserv
      es_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,
      reserves_nonprim,dsm_shift,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,dsm_shift,h,n)$(report_reserves_tech
      _hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves
      ,dsm_shift,h,n) < eps_rep_abs) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,dsm_shift,h,n)$(report_reserves_tec
      h_hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserv
      es,dsm_shift,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,dsm_curt,h,n)$(report_reserves_tech_
      hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,
      dsm_curt,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,dsm_curt,h,n)$(report_reserves_tech
      _hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserve
      s,dsm_curt,h,n) < eps_rep_abs ) = 0 ;
                       report_tech('Load shift neg absolute (reserves)',loop_res
      _share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift neg ab
      solute (reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < ca
      rd(h)*eps_rep_abs) = 0 ;
                       report_tech('Load shift pos absolute (reserves)',loop_res
      _share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos ab
      solute (reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < ca
      rd(h)*eps_rep_abs) = 0 ;
      $ontext
3255   
3256   
3257  * ------------------------------------------------------------------------
      ----
3258   
3259  * Reserves and EV
      %reserves%$ontext
             report_reserves_tech_hours('Reserves provision',loop_res_share,loop
      _ev,loop_prosumage,reserves,'ev_cum',h,n)$(feat_node('ev',n) AND feat_node
      ('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( ev , lev_RP_EV_V2G(scen,n,reserves,ev,h)))+ sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , sum( ev , lev_RP_EV_G2V(scen,n,re
      serves,ev,h)))  ;
             report_reserves_tech_hours('Reserves activation',loop_res_share,loo
      p_ev,loop_prosumage,reserves,'ev_cum',h,n)$(feat_node('ev',n) AND feat_nod
      e('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , sum( ev , phi_reserves_call(n,reserves,h) * lev_RP_EV_V2G(scen,n,res
      erves,ev,h)))+ sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) 
      , sum( ev , phi_reserves_call(n,reserves,h) * lev_RP_EV_G2V(scen,n,reserve
      s,ev,h)))  ;
      $ontext
      %reserves_endogenous%$ontext
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat_n
      ode('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,re
      serves_prim,ev,h))) / (phi_reserves_pr_up(n) * sum( reserves_nonprim ,  ((
      card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_int
      ercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves_no
      nprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnond
      is)))/1000) )) ));
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))) / (phi_re
      serves_pr_up(n) * sum( reserves_nonprim ,  ((card(h)-1) * 1000 * phi_reser
      ves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + 
      sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,
      nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ));
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))) / (phi_re
      serves_pr_up(n) * sum( reserves_nonprim ,  ((card(h)-1) * 1000 * phi_reser
      ves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + 
      sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,
      nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ));
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(sc
      en,n,reserves_nonprim,ev,h))) / ((card(h)-1) * 1000 * phi_reserves_share(n
      ,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum(nondisn
      ondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondi
      s)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))) / 
      ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_i
      ntercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves_
      nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisno
      ndis)))/1000) )) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))) / 
      ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_i
      ntercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves_
      nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisno
      ndis)))/1000) )) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum((h,ev),(sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,re
      serves_prim,ev,h)))*phi_reserves_call(n,reserves_prim,h)) / sum( h , phi_r
      eserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n) * sum( reserves_n
      onprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( reserves_interc
      ept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,reserves_non
      prim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondi
      s)))/1000 ) ) )   ) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND feat
      _node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))*phi_reserve
      s_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_prim,h)
       *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_sh
      are(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum(n
      ondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,non
      disnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND feat
      _node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))*phi_reserve
      s_call(n,reserves_prim,h)) /  sum( h , phi_reserves_call(n,reserves_prim,h
      ) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_s
      hare(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum(
      nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,no
      ndisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = (sum((h,ev),(sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(sc
      en,n,reserves_nonprim,ev,h)))*phi_reserves_call(n,reserves_nonprim,h)) / s
      um( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_reserves_shar
      e(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum(nond
      isnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisno
      ndis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) ))) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND f
      eat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))*phi_
      reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reserv
      es_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_
      intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves
      _nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisn
      ondis)))/1000) ))) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND f
      eat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))*phi_
      reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reserv
      es_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_
      intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves
      _nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisn
      ondis)))/1000) ))) ;
      $ontext
      %reserves_exogenous%$ontext
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat_n
      ode('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,re
      serves_prim,ev,h))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_p
      rim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))) / sum( h$
      (ord(h) > 1), reserves_exogenous(n,reserves_prim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))) / sum( h$
      (ord(h) > 1), reserves_exogenous(n,reserves_prim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(sc
      en,n,reserves_nonprim,ev,h))) / sum( h$(ord(h) > 1), reserves_exogenous(n,
      reserves_nonprim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))) / 
      sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))) / 
      sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
      *** ### not completed
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat
      _node('reserves',n)) = sum((h,ev),(sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,r
      eserves_prim,ev,h)))*phi_reserves_call(n,reserves_prim,h)) / sum( h , phi_
      reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n) * sum( reserves_
      nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( reserves_inter
      cept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,reserves_no
      nprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnond
      is)))/1000 ) ) )   ) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))*phi_reserv
      es_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_prim,h
      ) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_s
      hare(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum(
      nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,no
      ndisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))*phi_reserv
      es_call(n,reserves_prim,h)) /  sum( h , phi_reserves_call(n,reserves_prim,
      h) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_
      share(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum
      (nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen
      $(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,n
      ondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND f
      eat_node('reserves',n)) = (sum((h,ev),(sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(s
      cen,n,reserves_nonprim,ev,h)))*phi_reserves_call(n,reserves_nonprim,h)) / 
      sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_reserves_sha
      re(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum(non
      disnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisn
      ondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) ))) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND 
      feat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))*phi
      _reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reser
      ves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves
      _intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserve
      s_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondis
      nondis)))/1000) ))) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND 
      feat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))*phi
      _reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reser
      ves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves
      _intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserve
      s_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondis
      nondis)))/1000) ))) ;
      $ontext
      %reserves%$ontext
             report_tech('EV positive reserves activation by charging',loop_res_
      share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_node(
      'reserves',n)) = sum( (ev,h,reserves_up) ,  sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_up,ev,h)) * p
      hi_reserves_call(n,reserves_up,h)) * %sec_hour% ;
             report_tech('EV negative reserves activation by charging',loop_res_
      share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_node(
      'reserves',n)) = sum( (ev,h,reserves_do) ,  sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_do,ev,h)) * p
      hi_reserves_call(n,reserves_do,h)) * %sec_hour% ;
             report_tech('EV positive reserves activation by discharging',loop_r
      es_share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_no
      de('reserves',n)) = sum( (ev,h,reserves_up) , sum(scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_up,ev,h)) *
       phi_reserves_call(n,reserves_up,h)) * %sec_hour% ;
             report_tech('EV negative reserves activation by discharging',loop_r
      es_share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_no
      de('reserves',n)) = sum( (ev,h,reserves_do) , sum(scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_do,ev,h)) *
       phi_reserves_call(n,reserves_do,h)) * %sec_hour% ;
       
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,'ev_cum',h,n)$(report_reserves_tech_
      hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,
      'ev_cum',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,'ev_cum',h,n)$(report_reserves_tech
      _hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserve
      s,'ev_cum',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(report_reserves_te
      ch('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_prim,'ev_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_prim,'G2V_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_prim,'V2G_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(report_reserves
      _tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,'ev_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(report_reserve
      s_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,re
      serves_nonprim,'G2V_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(report_reserve
      s_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,re
      serves_nonprim,'V2G_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(report_reserves_t
      ech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,rese
      rves_prim,'ev_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_prim,'G2V_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_prim,'V2G_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(report_reserve
      s_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,r
      eserves_nonprim,'ev_cum',n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(report_reserv
      es_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,
      reserves_nonprim,'G2V_cum',n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(report_reserv
      es_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,
      reserves_nonprim,'V2G_cum',n) < eps_rep_rel ) = 0 ;
                       report_tech('EV positive reserves activation by charging'
      ,loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV positi
      ve reserves activation by charging',loop_res_share,loop_ev,loop_prosumage,
      'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV negative reserves activation by charging'
      ,loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV negati
      ve reserves activation by charging',loop_res_share,loop_ev,loop_prosumage,
      'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV positive reserves activation by dischargi
      ng',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV pos
      itive reserves activation by discharging',loop_res_share,loop_ev,loop_pros
      umage,'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV negative reserves activation by dischargi
      ng',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV neg
      ative reserves activation by discharging',loop_res_share,loop_ev,loop_pros
      umage,'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
      $ontext
3326   
3327   
3328  * ------------------------------------------------------------------------
      ----
3329   
3330  * PROSUMAGE
              report_hours('demand prosumers',loop_res_share,loop_ev,loop_prosum
      age,h,n)$feat_node('prosumage',n) = phi_pro_load(n) * d(n,h) ;
              report_hours('demand market',loop_res_share,loop_ev,loop_prosumage
      ,h,n)$feat_node('prosumage',n) = (1 - phi_pro_load(n)) * d(n,h) ;
              gross_energy_demand_market(scen,n) = gross_energy_demand(scen,n) -
       gross_energy_demand_prosumers_selfgen(scen,n) ;
       
              report_prosumage_tech_hours('generation prosumers',loop_res_share,
      loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) = sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , phi_res(n,res,h) * lev_N_RES
      _PRO(scen,n,res) ) ;
              report_prosumage_tech_hours('curtailment of fluct res prosumers',l
      oop_res_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) =  
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PRO(sc
      en,n,res,h)) ;
              report_prosumage_tech_hours('generation prosumers self-consumption
      ',loop_res_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) 
      = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES_P
      RO(scen,n,res,h) ) ;
              report_prosumage_tech_hours('generation prosumers to market',loop_
      res_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_MARKET_PRO2M
      (scen,n,res,h) ) ;
              report_prosumage_tech_hours('withdrawal prosumers from market',loo
      p_res_share,loop_ev,loop_prosumage,'',h,n)$feat_node('prosumage',n) = sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_MARKET_M2PR
      O(scen,n,h) ) ;
              report_prosumage_tech_hours('storage loading prosumers PRO2PRO',lo
      op_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( res , lev
      _STO_IN_PRO2PRO(scen,n,res,sto,h))) ;
              report_prosumage_tech_hours('storage loading prosumers PRO2M',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( res , lev_S
      TO_IN_PRO2M(scen,n,res,sto,h))) ;
              report_prosumage_tech_hours('storage loading prosumers M2PRO',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN_M2PRO
      (scen,n,sto,h)) ;
              report_prosumage_tech_hours('storage loading prosumers M2M',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN_M2M(sce
      n,n,sto,h)) ;
              report_prosumage_tech_hours('storage generation prosumers PRO2PRO'
      ,loop_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =
        sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT
      _PRO2PRO(scen,n,sto,h)) ;
              report_prosumage_tech_hours('storage generation prosumers PRO2M',l
      oop_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT_P
      RO2M(scen,n,sto,h)) ;
              report_prosumage_tech_hours('storage generation prosumers M2PRO',l
      oop_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT_M
      2PRO(scen,n,sto,h)) ;
              report_prosumage_tech_hours('storage generation prosumers M2M',loo
      p_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT_M2M
      (scen,n,sto,h)) ;
              report_prosumage_tech_hours('storage level prosumers',loop_res_sha
      re,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_PRO(scen,n,sto
      ,h)) ;
              report_prosumage_tech_hours('storage level prosumers PRO2PRO',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_PRO2PR
      O(scen,n,sto,h)) ;
              report_prosumage_tech_hours('storage level prosumers PRO2M',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_PRO2M(sc
      en,n,sto,h)) ;
              report_prosumage_tech_hours('storage level prosumers M2PRO',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_M2PRO(sc
      en,n,sto,h)) ;
              report_prosumage_tech_hours('storage level prosumers M2M',loop_res
      _share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_M2M(scen,n
      ,sto,h)) ;
       
              report_market_tech_hours('generation market',loop_res_share,loop_e
      v,loop_prosumage,con,h,n)$feat_node('prosumage',n) = sum(scen$(map(scen,lo
      op_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,con,h) + corr_fac_d
      is(scen,n,con,h)) ;
              report_market_tech_hours('generation market',loop_res_share,loop_e
      v,loop_prosumage,res,h,n)$feat_node('prosumage',n) = sum(scen$(map(scen,lo
      op_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + corr_fac_d
      is(scen,n,res,h) + lev_G_RES(scen,n,res,h)) ;
              report_market_tech_hours('generation market',loop_res_share,loop_e
      v,loop_prosumage,rsvr,h,n)$feat_node('prosumage',n) = sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) + cor
      r_fac_rsvr(scen,n,rsvr,h)) ;
              report_market_tech_hours('curtailment of fluct res market',loop_re
      s_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) =  sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,res,h
      )) ;
              report_market_tech_hours('generation storage market',loop_res_shar
      e,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h)
      ) ;
              report_market_tech_hours('storage loading market',loop_res_share,l
      oop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h)) ;
              report_market_tech_hours('storage level market',loop_res_share,loo
      p_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L(scen,n,sto,h)) ;
              report_market_tech_hours('market to prosumer storage M2PRO',loop_r
      es_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_nod
      e('prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( sto , lev_STO_IN_M2PRO(scen,n,sto,h)) ) ;
              report_market_tech_hours('market to prosumer storage M2M',loop_res
      _share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node(
      'prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( sto , lev_STO_IN_M2M(scen,n,sto,h)) ) ;
              report_market_tech_hours('prosumer storage to market PRO2M',loop_r
      es_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_nod
      e('prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( sto , lev_STO_OUT_PRO2M(scen,n,sto,h)) ) ;
              report_market_tech_hours('prosumer storage to market M2M',loop_res
      _share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node(
      'prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( sto , lev_STO_OUT_M2M(scen,n,sto,h)) ) ;
              report_market_tech_hours('energy market to prosumer',loop_res_shar
      e,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node('pros
      umage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_G_MARKET_M2PRO(scen,n,h) )   ;
              report_market_tech_hours('energy prosumer to market',loop_res_shar
      e,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node('pros
      umage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      sum( res , lev_G_MARKET_PRO2M(scen,n,res,h)) )  ;
       
              report_node('gross energy demand market',loop_res_share,loop_ev,lo
      op_prosumage,n)$feat_node('prosumage',n) = sum( scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n)) ;
              report_node('gross energy demand prosumers self generation',loop_r
      es_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_pros
      umers_selfgen(scen,n)) ;
       
              report_prosumage_tech('capacities renewable prosumers',loop_res_sh
      are,loop_ev,loop_prosumage,res,n)$feat_node('prosumage',n) =  sum( scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res
      ) ) ;
              report_prosumage_tech('capacities storage MW prosumers',loop_res_s
      hare,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,
      sto)) ;
              report_prosumage_tech('capacities storage MWh prosumers',loop_res_
      share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n
      ,sto)) * %sec_hour% ;
              report_prosumage_tech('Storage in total prosumers PRO2PRO',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, r
      eport_prosumage_tech_hours('storage loading prosumers PRO2PRO',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n)) ;
              report_prosumage_tech('Storage in total prosumers PRO2PRO',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, r
      eport_prosumage_tech_hours('storage loading prosumers PRO2PRO',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n));
              report_prosumage_tech('Storage in total prosumers PRO2M',loop_res_
      share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, rep
      ort_prosumage_tech_hours('storage loading prosumers PRO2M',loop_res_share,
      loop_ev,loop_prosumage,sto,h,n));
              report_prosumage_tech('Storage in total prosumers M2PRO',loop_res_
      share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, rep
      ort_prosumage_tech_hours('storage loading prosumers M2PRO',loop_res_share,
      loop_ev,loop_prosumage,sto,h,n));
              report_prosumage_tech('Storage in total prosumers M2M',loop_res_sh
      are,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, repor
      t_prosumage_tech_hours('storage loading prosumers M2M',loop_res_share,loop
      _ev,loop_prosumage,sto,h,n));
              report_prosumage_tech('Storage out total prosumers PRO2PRO',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, 
      report_prosumage_tech_hours('storage generation prosumers PRO2PRO',loop_re
      s_share,loop_ev,loop_prosumage,sto,h,n)) ;
              report_prosumage_tech('Storage out total prosumers PRO2M',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, re
      port_prosumage_tech_hours('storage generation prosumers PRO2M',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n)) ;
              report_prosumage_tech('Storage out total prosumers M2PRO',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, re
      port_prosumage_tech_hours('storage generation prosumers M2PRO',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n)) ;
              report_prosumage_tech('Storage out total prosumers M2M',loop_res_s
      hare,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( h, rep
      ort_prosumage_tech_hours('storage generation prosumers M2M',loop_res_share
      ,loop_ev,loop_prosumage,sto,h,n)) ;
              report_prosumage_tech('Storage out total prosumers',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = report_prosumage
      _tech('Storage out total prosumers PRO2PRO',loop_res_share,loop_ev,loop_pr
      osumage,sto,n) + report_prosumage_tech('Storage out total prosumers PRO2M'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n) + report_prosumage_tech('Sto
      rage out total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,
      n) + report_prosumage_tech('Storage out total prosumers M2M',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) ;
              report_prosumage_tech('Generation total prosumers PRO2M',loop_res_
      share,loop_ev,loop_prosumage,'',n)$feat_node('prosumage',n) =  sum( (h,res
      ) , report_prosumage_tech_hours('generation prosumers to market',loop_res_
      share,loop_ev,loop_prosumage,res,h,n)) ;
              report_prosumage_tech('Withdrawal total prosumers M2PRO',loop_res_
      share,loop_ev,loop_prosumage,'',n)$feat_node('prosumage',n) =  sum( h , re
      port_prosumage_tech_hours('withdrawal prosumers from market',loop_res_shar
      e,loop_ev,loop_prosumage,'',h,n)) ;
              report_prosumage_tech('generation prosumers self-consumption',loop
      _res_share,loop_ev,loop_prosumage,'',n)$feat_node('prosumage',n) =  sum( (
      res,h) , report_prosumage_tech_hours('generation prosumers self-consumptio
      n',loop_res_share,loop_ev,loop_prosumage,res,h,n)) ;
              report_prosumage_tech('consumption share prosumers',loop_res_share
      ,loop_ev,loop_prosumage,res,n)$(feat_node('prosumage',n) AND sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , phi_pro_load(n) 
      * d(n,h) )) ) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( h , lev_G_RES_PRO(scen,n,res,h)) ) / sum( scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , sum( h , phi_pro_load(n) * d(n,h) ) );
              report_prosumage_tech('consumption share prosumers',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , phi_pro_load(n) 
      * d(n,h) )) ) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( h , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_M2PRO(scen,n,
      sto,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      sum( h , phi_pro_load(n) * d(n,h) ) );
              report_prosumage_tech('consumption share prosumers',loop_res_share
      ,loop_ev,loop_prosumage,'market',n)$sum( scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , sum( h , phi_pro_load(n) * d(n,h) ) ) = sum( scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , lev_G_MARKET_
      M2PRO(scen,n,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , sum( h , phi_pro_load(n) * d(n,h) ) );
              report_prosumage_tech('curtailment of fluct res absolute prosumers
      ',loop_res_share,loop_ev,loop_prosumage,res,n)$feat_node('prosumage',n) = 
       sum(h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_C
      U_PRO(scen,n,res,h) )) * %sec_hour% ;
              report_prosumage_tech('curtailment of fluct res relative prosumers
      ',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('cur
      tailment of fluct res absolute prosumers',loop_res_share,loop_ev,loop_pros
      umage,res,n) AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_N_RES_PRO(scen,n,res)) > eps_rep_abs ) =  sum(h, sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PRO(scen,n,res,h) ))/ s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , phi_r
      es(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage_tech('average market value storage in PRO2PRO',lo
      op_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage
       in total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) 
      > eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop
      _ev,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage)) , sum( res , lev_STO_IN_PRO2PRO(scen,n,res,sto,h)))) / report_p
      rosumage_tech('Storage in total prosumers PRO2PRO',loop_res_share,loop_ev,
      loop_prosumage,sto,n) ;
              report_prosumage_tech('average market value storage in PRO2M',loop
      _res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage i
      n total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > ep
      s_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,
      loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , sum( res , lev_STO_IN_PRO2M(scen,n,res,sto,h)))) / report_prosuma
      ge_tech('Storage in total prosumers PRO2M',loop_res_share,loop_ev,loop_pro
      sumage,sto,n) ;
              report_prosumage_tech('average market value storage in M2PRO',loop
      _res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage i
      n total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) > ep
      s_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,
      loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_STO_IN_M2PRO(scen,n,sto,h))) / report_prosumage_tech('Storage
       in total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) ;
              report_prosumage_tech('average market value storage in M2M',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage in 
      total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > eps_re
      p_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,loop
      _prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_STO_IN_M2M(scen,n,sto,h))) / report_prosumage_tech('Storage in to
      tal prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) ;
              report_prosumage_tech('average market value storage out PRO2PRO',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storag
      e out total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n
      ) > eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,lo
      op_ev,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_STO_OUT_PRO2PRO(scen,n,sto,h))) / report_prosumage_tech
      ('Storage in total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumag
      e,sto,n) ;
              report_prosumage_tech('average market value storage out PRO2M',loo
      p_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage 
      out total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > 
      eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_e
      v,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_STO_OUT_PRO2M(scen,n,sto,h))) / report_prosumage_tech('Stor
      age in total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n)
       ;
              report_prosumage_tech('average market value storage out M2PRO',loo
      p_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage 
      out total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) > 
      eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_e
      v,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_STO_OUT_M2PRO(scen,n,sto,h))) / report_prosumage_tech('Stor
      age in total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)
       ;
              report_prosumage_tech('average market value storage out M2M',loop_
      res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage ou
      t total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > eps_
      rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,lo
      op_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_STO_OUT_M2M(scen,n,sto,h))) / report_prosumage_tech('Storage in
       total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) ;
              report_prosumage_tech('average market value generation PRO2M',loop
      _res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Generation
       total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,'',n) > eps_
      rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,lo
      op_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( res , lev_G_MARKET_PRO2M(scen,n,res,h)))) / report_prosumage_t
      ech('Generation total prosumers PRO2M',loop_res_share,loop_ev,loop_prosuma
      ge,'',n) ;
              report_prosumage_tech('average market value withdrawal M2PRO',loop
      _res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Withdrawal
       total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,'',n) > eps_
      rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,lo
      op_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_G_MARKET_M2PRO(scen,n,h))) / report_prosumage_tech('Withdrawal 
      total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,'',n) ;
              report_prosumage_tech('average market value generation PRO2PRO',lo
      op_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('generati
      on prosumers self-consumption',loop_res_share,loop_ev,loop_prosumage,'',n)
       > eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loo
      p_ev,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , sum( res , lev_G_RES_PRO(scen,n,res,h)))) / report_prosumage
      _tech('generation prosumers self-consumption',loop_res_share,loop_ev,loop_
      prosumage,'',n) ;
              report_prosumage_tech('FLH prosumers',loop_res_share,loop_ev,loop_
      prosumage,res,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res) > eps_rep_ins)
      ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_G_MARKET_PRO2M(scen,n,res,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,re
      s,sto,h)) + lev_G_RES_PRO(scen,n,res,h) )) / sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res) ) ;
      %reserves% report_prosumage_tech('FLH prosumers',loop_res_share,loop_ev,lo
      op_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto)) > eps_re
      p_ins) = report_prosumage_tech('Storage out total prosumers',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto)) ;
      %reserves% report_prosumage_tech('Storage cycles prosumers',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n,sto
      )) > eps_rep_ins) = report_prosumage_tech('Storage out total prosumers',lo
      op_res_share,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n,sto)) * %sec_hour% 
      ;
              report_prosumage_tech('Storage EP-ratio prosumers',loop_res_share,
      loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto)
       ) > eps_rep_ins AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_N_STO_E_PRO(scen,n,sto) ) * %sec_hour% > eps_rep_ins ) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(sc
      en,n,sto) ) * %sec_hour% / sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_P_PRO(scen,n,sto) ) ;
       
              report_market_tech('capacities renewable market',loop_res_share,lo
      op_ev,loop_prosumage,res,n)$feat_node('prosumage',n) =  sum( scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,res) ) ;
              report_market_tech('capacities reservoir MW market',loop_res_share
      ,loop_ev,loop_prosumage,rsvr,n)$feat_node('prosumage',n) =  sum( scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr) 
      );
              report_market_tech('capacities reservoir MWh market',loop_res_shar
      e,loop_ev,loop_prosumage,rsvr,n)$feat_node('prosumage',n) =  sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_E(scen,n,rsvr)
       );
              report_market_tech('capacities storage MW market',loop_res_share,l
      oop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) ;
              report_market_tech('capacities storage MWh market',loop_res_share,
      loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) * %
      sec_hour% ;
              report_market_tech('curtailment of fluct res absolute market',loop
      _res_share,loop_ev,loop_prosumage,res,n)$feat_node('prosumage',n) =  sum(h
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen
      ,n,res,h) )) * %sec_hour% ;
              report_market_tech('curtailment of fluct res relative market',loop
      _res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech('curtailment 
      of fluct res absolute market',loop_res_share,loop_ev,loop_prosumage,res,n)
       AND sum(h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , l
      ev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) ) + sum(h, sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,res,h)
      )) > card(h)*eps_rep_abs ) =  sum(h, sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_CU(scen,n,res,h) ))/( sum(h,  sum(scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES(scen,n,res,h) - cor
      r_fac_nondis(scen,n,res,h)) ) + sum(h,sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_CU(scen,n,res,h)  )) ) ;
              report_market_tech('capacities conventional market',loop_res_share
      ,loop_ev,loop_prosumage,con,n)$feat_node('prosumage',n) =  sum( scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,con)) ;
              report_market_tech('Storage out total market non-reserves',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum(h, re
      port_market_tech_hours('generation storage market',loop_res_share,loop_ev,
      loop_prosumage,sto,h,n) ) * %sec_hour% ;
              report_market_tech('Storage in total market non-reserves',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum(h, rep
      ort_market_tech_hours('storage loading market',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) ) * %sec_hour% ;
              report_market_tech('FLH market non-reserves',loop_res_share,loop_e
      v,loop_prosumage,res,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,res)) > eps_rep
      _ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_G_RES(scen,n,res,h) + lev_G_L(scen,n,res,h)- corr_fac_dis(scen,n,r
      es,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_TECH(scen,n,res)) ;
              report_market_tech('FLH market non-reserves',loop_res_share,loop_e
      v,loop_prosumage,con,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,con)) > eps_rep
      _ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_G_L(scen,n,con,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage)) , lev_N_TECH(scen,n,con)) ;
      %reserves% report_market_tech('FLH market non-reserves',loop_res_share,loo
      p_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) > eps
      _rep_ins) = report_market_tech('Storage out total market non-reserves',loo
      p_res_share,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) ;
      %reserves% report_market_tech('Storage cycles market non-reserves',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,
      sto)) > eps_rep_ins) = report_market_tech('Storage out total market non-re
      serves',loop_res_share,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) * %sec_
      hour% ;
              report_market_tech('Storage EP-ratio market',loop_res_share,loop_e
      v,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto) ) > eps_r
      ep_ins AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_STO_E(scen,n,sto) ) * %sec_hour% > eps_rep_ins ) = sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto) ) * %sec
      _hour% / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      N_STO_P(scen,n,sto) ) ;
       
              report_prosumage('gross energy demand prosumers',loop_res_share,lo
      op_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(scen,
      n)) ;
              report_prosumage('gross energy demand prosumers from market',loop_
      res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_pro
      sumers_market(scen,n)) ;
              report_prosumage('gross energy demand prosumers self generation',l
      oop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand
      _prosumers_selfgen(scen,n)) ;
              report_prosumage('self-generation share prosumers total',loop_res_
      share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosu
      mers(scen,n) )) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , gross_energy_demand_prosumers_selfgen(scen,n)) / sum( scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(sc
      en,n) ) ;
              report_prosumage('market share prosumers',loop_res_share,loop_ev,l
      oop_prosumage,n)$(feat_node('prosumage',n) AND  sum(scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(scen,n) )
      ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_ene
      rgy_demand_prosumers_market(scen,n)) / sum( scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(scen,n) ) ;
              report_prosumage('curtailment of fluct res absolute prosumers',loo
      p_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum((res,
      h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PR
      O(scen,n,res,h))) * %sec_hour% ;
              report_prosumage('curtailment of fluct res relative prosumers',loo
      p_res_share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_
      res(n,res,h) * lev_N_RES_PRO(scen,n,res))))  = sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , sum( (h,res) , lev_CU_PRO(scen,n,res,h) 
      )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (re
      s,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage('share self-generation curtailed',loop_res_share,
      loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,res,h)
       * lev_N_RES_PRO(scen,n,res)) )) = sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( (h,res) , lev_CU_PRO(scen,n,res,h) )) / sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_r
      es(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage('share self-generation direct consumption',loop_r
      es_share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res
      (n,res,h) * lev_N_RES_PRO(scen,n,res)) )) = sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , sum( (h,res) , lev_G_RES_PRO(scen,n,res,h) 
      )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (re
      s,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage('share self-generation to market',loop_res_share,
      loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,res,h)
       * lev_N_RES_PRO(scen,n,res))) ) = sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( (h,res) , lev_G_MARKET_PRO2M(scen,n,res,h) )) /
       sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h)
       , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage('share self-generation stored PRO2PRO',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,r
      es,h) * lev_N_RES_PRO(scen,n,res))) ) = sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , sum( (h,sto,res) , lev_STO_IN_PRO2PRO(scen,n,re
      s,sto,h) )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) ,
       sum( (res,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage('share self-generation stored PRO2M',loop_res_sha
      re,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,res
      ,h) * lev_N_RES_PRO(scen,n,res))) ) = sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , sum( (h,sto,res) , lev_STO_IN_PRO2M(scen,n,res,st
      o,h) )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum
      ( (res,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
              report_prosumage('Capacity total prosumers',loop_res_share,loop_ev
      ,loop_prosumage,n)$feat_node('prosumage',n) = sum( res , sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res)) ) +
       sum( sto , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , l
      ev_N_STO_P_PRO(scen,n,sto)) ) ;
       
              report_prosumage_tech('Capacity share prosumers',loop_res_share,lo
      op_ev,loop_prosumage,res,n)$report_prosumage('Capacity total prosumers',lo
      op_res_share,loop_ev,loop_prosumage,n) = sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res) ) / report_prosumage
      ('Capacity total prosumers',loop_res_share,loop_ev,loop_prosumage,n) + 1e-
      9 ;
              report_prosumage_tech('Capacity share prosumers',loop_res_share,lo
      op_ev,loop_prosumage,sto,n)$report_prosumage('Capacity total prosumers',lo
      op_res_share,loop_ev,loop_prosumage,n) = sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto) ) / report_prosuma
      ge('Capacity total prosumers',loop_res_share,loop_ev,loop_prosumage,n) + 1
      e-9 ;
       
              report_market('gross energy demand market',loop_res_share,loop_ev,
      loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n)) ;
              report_market('curtailment of fluct res absolute market',loop_res_
      share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum((res,h), su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,r
      es,h))) * %sec_hour% ;
              report_market('curtailment of fluct res relative market',loop_res_
      share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (h,res) , phi_res(n,
      res,h)*lev_N_TECH(scen,n,res)) ) > eps_rep_abs*card(res)*card(h) ) = sum( 
      (res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      CU(scen,n,res,h)))/ sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( (res,h) , phi_res(n,res,h) * lev_N_TECH(scen,n,res)) ) ;
              report_market('Share market energy transferred to prosumer consump
      tion',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = 
      sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G
      _MARKET_M2PRO(scen,n,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,lo
      op_prosumage)) , gross_energy_demand_market(scen,n) ) ;
              report_market('Share market energy transferred to prosumer storage
       M2PRO',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) 
      = sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum
      ( sto , lev_STO_IN_M2PRO(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
              report_market('Share market energy transferred to prosumer storage
       M2M',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = 
      sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( 
      sto , lev_STO_IN_M2M(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_res_shar
      e,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
              report_market('Share market energy tranferred from prosumer genera
      tion',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = 
      sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( 
      res , lev_G_MARKET_PRO2M(scen,n,res,h))) ) / sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
              report_market('Share market energy transferred from prosumer stora
      ge PRO2M',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n
      ) = sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , s
      um( sto , lev_STO_OUT_PRO2M(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
              report_market('Share market energy transferred from prosumer stora
      ge M2M',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) 
      = sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum
      ( sto , lev_STO_OUT_M2M(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
              report_market('Capacity total market',loop_res_share,loop_ev,loop_
      prosumage,n)$feat_node('prosumage',n) = sum( tech , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,tech))) + sum( st
      o , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO
      _P(scen,n,sto) )) + sum( rsvr ,  sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr))) + sum( dsm_curt ,  sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_CU(scen,n,
      dsm_curt))) + sum( dsm_shift ,  sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift))) ;
              report_market('Energy demand total market',loop_res_share,loop_ev,
      loop_prosumage,n)$feat_node('prosumage',n) = (sum( h , (1 - phi_pro_load(n
      )) * d(n,h) ) + sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_G_MARKET_M2PRO(scen,n,h))) + sum( (sto,h) , sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h) + 
      lev_STO_IN_M2M(scen,n,sto,h) + lev_STO_IN_M2PRO(scen,n,sto,h) ) )) * %sec_
      hour%
      %prosumage%$ontext
      %DSM%$ontext
              + sum( (dsm_shift,h) , sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage)) , lev_DSM_UP_DEMAND(scen,n,dsm_shift,h)) ) * %sec_hour%
      $ontext
      %EV%$ontext
               + sum( (ev,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_EV_CHARGE(scen,n,ev,h)) ) * %sec_hour%
      $ontext
      %reserves%$ontext
               + sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , reserves_activated(scen,n,h)))
      $ontext
      ;
              report_market('energy generated gross market',loop_res_share,loop_
      ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( h , sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , sum( dis ,lev_G_L(scen,n,dis,h
      )) + sum( nondis ,lev_G_RES(scen,n,nondis,h)) + sum( res , lev_G_MARKET_PR
      O2M(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) + sum( rsvr , lev_RSVR_
      OUT(scen,n,rsvr,h)- corr_fac_rsvr(scen,n,rsvr,h)) + sum( sto , lev_STO_OUT
      _M2M(scen,n,sto,h) + lev_STO_OUT(scen,n,sto,h) - corr_fac_sto(scen,n,sto,h
      )) + sum( dsm_shift , lev_DSM_DO_DEMAND(scen,n,dsm_shift,h) - corr_fac_dsm
      _shift(scen,n,dsm_shift,h)) + sum( dsm_curt , lev_DSM_CU(scen,n,dsm_curt,h
      )) + sum( ev , lev_EV_DISCHARGE(scen,n,ev,h)) - corr_fac_ev(scen,n,h) )) ;
       
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,tech,n)$(feat_node('prosumage',n) AND report_market('Capaci
      ty total market',loop_res_share,loop_ev,loop_prosumage,n)) = sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,tech) )
       / report_market('Capacity total market',loop_res_share,loop_ev,loop_prosu
      mage,n) + 1e-9 ;
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,rsvr,n)$feat_node('prosumage',n) = sum(scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr) ) / report_
      market('Capacity total market',loop_res_share,loop_ev,loop_prosumage,n) + 
      1e-9 ;
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,sto,n)$feat_node('prosumage',n) = sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto) ) / report_mar
      ket('Capacity total market',loop_res_share,loop_ev,loop_prosumage,n) + 1e-
      9 ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,con,n)$(feat_node('prosumage',n) AN
      D report_market('energy generated gross market',loop_res_share,loop_ev,loo
      p_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_G_L(scen,n,con,h)) ) / report_market('energy generated g
      ross market',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 
      ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,res,n)$(feat_node('prosumage',n) AN
      D report_market('energy generated gross market',loop_res_share,loop_ev,loo
      p_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,res,h) + l
      ev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) ) / report_market(
      'energy generated gross market',loop_res_share,loop_ev,loop_prosumage,n) *
       %sec_hour% + 1e-9 ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,rsvr,n)$(feat_node('prosumage',n) A
      ND report_market('energy generated gross market',loop_res_share,loop_ev,lo
      op_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h))
       ) / report_market('energy generated gross market',loop_res_share,loop_ev,
      loop_prosumage,n) * %sec_hour% + 1e-9 ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AN
      D report_market('energy generated gross market',loop_res_share,loop_ev,loo
      p_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_STO_OUT_M2M(scen,n,sto,h) + lev_STO_OUT(scen,n,sto,h) - 
      corr_fac_sto(scen,n,sto,h)) ) / report_market('energy generated gross mark
      et',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
       
                       report_hours('demand prosumers',loop_res_share,loop_ev,lo
      op_prosumage,h,n)$(report_hours('demand prosumers',loop_res_share,loop_ev,
      loop_prosumage,h,n) < eps_rep_abs) = 0 ;
                       report_hours('demand market',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('demand market',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs) = 0 ;
       
                       report_prosumage_tech_hours('generation prosumers',loop_r
      es_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumage_tech_hours('gen
      eration prosumers',loop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_re
      p_abs) = 0 ;
                       report_prosumage_tech_hours('curtailment of fluct res pro
      sumers',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumage_t
      ech_hours('curtailment of fluct res prosumers',loop_res_share,loop_ev,loop
      _prosumage,res,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('generation prosumers self-co
      nsumption',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumag
      e_tech_hours('generation prosumers self-consumption',loop_res_share,loop_e
      v,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('generation prosumers to mark
      et',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumage_tech_
      hours('generation prosumers to market',loop_res_share,loop_ev,loop_prosuma
      ge,res,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('withdrawal prosumers from ma
      rket',loop_res_share,loop_ev,loop_prosumage,'',h,n)$(report_prosumage_tech
      _hours('withdrawal prosumers from market',loop_res_share,loop_ev,loop_pros
      umage,'',h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage loading prosumers PR
      O2PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_te
      ch_hours('storage loading prosumers PRO2PRO',loop_res_share,loop_ev,loop_p
      rosumage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage loading prosumers PR
      O2M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech
      _hours('storage loading prosumers PRO2M',loop_res_share,loop_ev,loop_prosu
      mage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage loading prosumers M2
      PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech
      _hours('storage loading prosumers M2PRO',loop_res_share,loop_ev,loop_prosu
      mage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage loading prosumers M2
      M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_h
      ours('storage loading prosumers M2M',loop_res_share,loop_ev,loop_prosumage
      ,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage generation prosumers
       PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage
      _tech_hours('storage generation prosumers PRO2PRO',loop_res_share,loop_ev,
      loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage generation prosumers
       PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_t
      ech_hours('storage generation prosumers PRO2M',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage generation prosumers
       M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_t
      ech_hours('storage generation prosumers M2PRO',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage generation prosumers
       M2M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tec
      h_hours('storage generation prosumers M2M',loop_res_share,loop_ev,loop_pro
      sumage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage level prosumers',loo
      p_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_hours('
      storage level prosumers',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < 
      eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage level prosumers PRO2
      PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech
      _hours('storage level prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosu
      mage,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage level prosumers PRO2
      M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_h
      ours('storage level prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage
      ,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage level prosumers M2PR
      O',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_h
      ours('storage level prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage
      ,sto,h,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech_hours('storage level prosumers M2M'
      ,loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_hou
      rs('storage level prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto
      ,h,n) < eps_rep_abs) = 0 ;
       
                       report_market_tech_hours('generation market',loop_res_sha
      re,loop_ev,loop_prosumage,con,h,n)$(report_market_tech_hours('generation m
      arket',loop_res_share,loop_ev,loop_prosumage,con,h,n) < eps_rep_abs) = 0 ;
                       report_market_tech_hours('generation market',loop_res_sha
      re,loop_ev,loop_prosumage,res,h,n)$(report_market_tech_hours('generation m
      arket',loop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
                       report_market_tech_hours('generation market',loop_res_sha
      re,loop_ev,loop_prosumage,rsvr,h,n)$(report_market_tech_hours('generation 
      market',loop_res_share,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0
       ;
                       report_market_tech_hours('curtailment of fluct res market
      ',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_market_tech_hours
      ('curtailment of fluct res market',loop_res_share,loop_ev,loop_prosumage,r
      es,h,n) < eps_rep_abs) =  0 ;
                       report_market_tech_hours('generation storage market',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$(report_market_tech_hours('gene
      ration storage market',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < ep
      s_rep_abs) =  0 ;
                       report_market_tech_hours('storage loading market',loop_re
      s_share,loop_ev,loop_prosumage,sto,h,n)$(report_market_tech_hours('storage
       loading market',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < eps_rep_
      abs) = 0 ;
                       report_market_tech_hours('storage level market',loop_res_
      share,loop_ev,loop_prosumage,sto,h,n)$(report_market_tech_hours('storage l
      evel market',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs)
       = 0 ;
                       report_market_tech_hours('market to prosumer storage M2PR
      O',loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)
      $(report_market_tech_hours('market to prosumer storage M2PRO',loop_res_sha
      re,loop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs)
       = 0 ;
                       report_market_tech_hours('market to prosumer storage M2M'
      ,loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(
      report_market_tech_hours('market to prosumer storage M2M',loop_res_share,l
      oop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0
       ;
                       report_market_tech_hours('prosumer storage to market PRO2
      M',loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)
      $(report_market_tech_hours('prosumer storage to market PRO2M',loop_res_sha
      re,loop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs)
       = 0 ;
                       report_market_tech_hours('prosumer storage to market M2M'
      ,loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(
      report_market_tech_hours('prosumer storage to market M2M',loop_res_share,l
      oop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0
       ;
                       report_market_tech_hours('energy market to prosumer',loop
      _res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(repor
      t_market_tech_hours('energy market to prosumer',loop_res_share,loop_ev,loo
      p_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0 ;
                       report_market_tech_hours('energy prosumer to market',loop
      _res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(repor
      t_market_tech_hours('energy prosumer to market',loop_res_share,loop_ev,loo
      p_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0 ;
       
                       report_prosumage_tech('capacities renewable prosumers',lo
      op_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('capacit
      ies renewable prosumers',loop_res_share,loop_ev,loop_prosumage,res,n) < ep
      s_rep_ins) =  0 ;
                       report_prosumage_tech('capacities storage MW prosumers',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('capaci
      ties storage MW prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < 
      eps_rep_ins) =  0 ;
                       report_prosumage_tech('capacities storage MWh prosumers',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('capac
      ities storage MWh prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) 
      < eps_rep_ins) =  0 ;
                       report_prosumage_tech('consumption share prosumers',loop_
      res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('consumptio
      n share prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_
      rel) = 0 ;
                       report_prosumage_tech('consumption share prosumers',loop_
      res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('consumptio
      n share prosumers',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_
      rel) = 0 ;
                       report_prosumage_tech('consumption share prosumers',loop_
      res_share,loop_ev,loop_prosumage,'market',n)$(report_prosumage_tech('consu
      mption share prosumers',loop_res_share,loop_ev,loop_prosumage,'market',n) 
      < eps_rep_rel) = 0 ;
                       report_prosumage_tech('curtailment of fluct res absolute 
      prosumers',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_
      tech('curtailment of fluct res absolute prosumers',loop_res_share,loop_ev,
      loop_prosumage,res,n) < eps_rep_ins) = 0 ;
                       report_prosumage_tech('curtailment of fluct res relative 
      prosumers',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_
      tech('curtailment of fluct res relative prosumers',loop_res_share,loop_ev,
      loop_prosumage,res,n) < eps_rep_rel) = 0 ;
                       report_prosumage_tech('Storage in total prosumers PRO2PRO
      ',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Sto
      rage in total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto
      ,n)< eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage in total prosumers PRO2M',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stora
      ge in total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n)<
       eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage in total prosumers M2PRO',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stora
      ge in total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)<
       eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage in total prosumers M2M',lo
      op_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage
       in total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n)< eps
      _rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage out total prosumers PRO2PR
      O',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('St
      orage out total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,s
      to,n)< eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage out total prosumers PRO2M'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stor
      age out total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n
      )< eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage out total prosumers M2PRO'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stor
      age out total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n
      )< eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage out total prosumers M2M',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storag
      e out total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n)< e
      ps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Storage out total prosumers',loop_
      res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage ou
      t total prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n)< eps_rep_a
      bs*card(h)) = 0 ;
                       report_prosumage_tech('Generation total prosumers PRO2M',
      loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Genera
      tion total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,'',n) < 
      eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('Withdrawal total prosumers M2PRO',
      loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Withdr
      awal total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,'',n) < 
      eps_rep_abs*card(h)) = 0 ;
                       report_prosumage_tech('generation prosumers self-consumpt
      ion',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('g
      eneration prosumers self-consumption',loop_res_share,loop_ev,loop_prosumag
      e,'',n) < eps_rep_abs * card(h)) = 0 ;
                       report_prosumage_tech('average market value storage in PR
      O2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech
      ('average market value storage in PRO2PRO',loop_res_share,loop_ev,loop_pro
      sumage,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage in PR
      O2M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('
      average market value storage in PRO2M',loop_res_share,loop_ev,loop_prosuma
      ge,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage in M2
      PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('
      average market value storage in M2PRO',loop_res_share,loop_ev,loop_prosuma
      ge,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage in M2
      M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('av
      erage market value storage in M2M',loop_res_share,loop_ev,loop_prosumage,s
      to,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage out P
      RO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tec
      h('average market value storage out PRO2PRO',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage out P
      RO2M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech(
      'average market value storage out PRO2M',loop_res_share,loop_ev,loop_prosu
      mage,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage out M
      2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech(
      'average market value storage out M2PRO',loop_res_share,loop_ev,loop_prosu
      mage,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value storage out M
      2M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('a
      verage market value storage out M2M',loop_res_share,loop_ev,loop_prosumage
      ,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value generation PR
      O2M',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('a
      verage market value generation PRO2M',loop_res_share,loop_ev,loop_prosumag
      e,'',n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value withdrawal M2
      PRO',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('a
      verage market value withdrawal M2PRO',loop_res_share,loop_ev,loop_prosumag
      e,'',n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('average market value generation PR
      O2PRO',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech(
      'average market value generation PRO2PRO',loop_res_share,loop_ev,loop_pros
      umage,'',n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('Capacity share prosumers',loop_res
      _share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('Capacity shar
      e prosumers',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) =
       0 ;
                       report_prosumage_tech('Capacity share prosumers',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Capacity shar
      e prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_rel) =
       0 ;
                       report_prosumage_tech('FLH prosumers',loop_res_share,loop
      _ev,loop_prosumage,res,n)$(report_prosumage_tech('FLH prosumers',loop_res_
      share,loop_ev,loop_prosumage,res,n) < eps_rep_abs) = 0 ;
      %reserves%       report_prosumage_tech('Storage cycles prosumers',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage cycle
      s prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs) =
       0 ;
      %reserves%       report_prosumage_tech('FLH',loop_res_share,loop_ev,loop_p
      rosumage,sto,n)$(report_prosumage_tech('FLH',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs) = 0 ;
                       report_prosumage_tech('Storage EP-ratio prosumers',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage EP-
      ratio prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_re
      l) = 0 ;
       
                       report_market_tech('capacities renewable market',loop_res
      _share,loop_ev,loop_prosumage,res,n)$(report_market_tech('capacities renew
      able market',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_abs) =
        0 ;
                       report_market_tech('capacities reservoir MW market',loop_
      res_share,loop_ev,loop_prosumage,rsvr,n)$(report_market_tech('capacities r
      eservoir MW market',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_re
      p_ins) = 0 ;
                       report_market_tech('capacities reservoir MWh market',loop
      _res_share,loop_ev,loop_prosumage,rsvr,n)$(report_market_tech('capacities 
      reservoir MWh market',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_
      rep_ins) = 0 ;
                       report_market_tech('capacities storage MW market',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities stor
      age MW market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs)
       =  0 ;
                       report_market_tech('capacities storage MWh market',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities sto
      rage MWh market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_ab
      s) =  0 ;
                       report_market_tech('curtailment of fluct res absolute mar
      ket',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech('cur
      tailment of fluct res absolute market',loop_res_share,loop_ev,loop_prosuma
      ge,res,n) < eps_rep_abs*card(h)) = 0 ;
                       report_market_tech('curtailment of fluct res relative mar
      ket',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech('cur
      tailment of fluct res relative market',loop_res_share,loop_ev,loop_prosuma
      ge,res,n) < eps_rep_rel) = 0 ;
                       report_market_tech('capacities conventional market',loop_
      res_share,loop_ev,loop_prosumage,con,n)$(report_market_tech('capacities co
      nventional market',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_
      ins) = 0 ;
                       report_market_tech('capacities renewable market',loop_res
      _share,loop_ev,loop_prosumage,res,n)$(report_market_tech('capacities renew
      able market',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_ins) =
       0 ;
                       report_market_tech('capacities storage MW market',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities stor
      age MW market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_ins)
       =  0 ;
                       report_market_tech('capacities storage MWh market',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities sto
      rage MWh market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_in
      s) = 0 ;
                       report_market_tech('Storage out total market non-reserves
      ',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storag
      e out total market non-reserves',loop_res_share,loop_ev,loop_prosumage,sto
      ,n) < eps_rep_abs*card(h)) = 0 ;
                       report_market_tech('Storage in total market non-reserves'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storage
       in total market non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n
      ) < eps_rep_abs*card(h)) = 0 ;
                       report_market_tech('FLH market non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,res,n)$(report_market_tech('FLH market non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_abs) = 0 ;
                       report_market_tech('FLH market non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,con,n)$(report_market_tech('FLH market non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_abs) = 0 ;
      %reserves%       report_market_tech('FLH market non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,sto,n)$(report_market_tech('FLH market non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs) = 0 ;
      %reserves%       report_market_tech('Storage cycles market non-reserves',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storage c
      ycles market non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n) < 
      eps_rep_abs) = 0 ;
                       report_market_tech('Storage EP-ratio market',loop_res_sha
      re,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storage EP-ratio mar
      ket',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_rel) = 0 ;
       
                       report_prosumage('gross energy demand prosumers',loop_res
      _share,loop_ev,loop_prosumage,n)$(report_prosumage('gross energy demand pr
      osumers',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_ins) = 0 ;
                       report_prosumage('gross energy demand prosumers from mark
      et',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('gross ener
      gy demand prosumers from market',loop_res_share,loop_ev,loop_prosumage,n) 
      < eps_rep_ins) = 0 ;
                       report_prosumage('gross energy demand prosumers self gene
      ration',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('gross 
      energy demand prosumers self generation',loop_res_share,loop_ev,loop_prosu
      mage,n) < eps_rep_ins) = 0 ;
                       report_prosumage('self-generation share prosumage total',
      loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('self-generatio
      n share prosumage total',loop_res_share,loop_ev,loop_prosumage,n) < eps_re
      p_rel) = 0 ;
                       report_prosumage('market share prosumage',loop_res_share,
      loop_ev,loop_prosumage,n)$(report_prosumage('market share prosumage',loop_
      res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_prosumage('curtailment of fluct res absolute prosu
      mers',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('curtailm
      ent of fluct res absolute prosumers',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_ins) = 0 ;
                       report_prosumage('curtailment of fluct res relative prosu
      mers',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('curtailm
      ent of fluct res relative prosumers',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_rel) = 0 ;
                       report_prosumage('share self-generation curtailed',loop_r
      es_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-generatio
      n curtailed',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_prosumage('share self-generation direct consumptio
      n',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-
      generation direct consumption',loop_res_share,loop_ev,loop_prosumage,n) < 
      eps_rep_rel) = 0 ;
                       report_prosumage('share self-generation to market',loop_r
      es_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-generatio
      n to market',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_prosumage('share self-generation stored PRO2PRO',l
      oop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-gene
      ration stored PRO2PRO',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_
      rel) = 0 ;
                       report_prosumage('share self-generation stored PRO2M',loo
      p_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-genera
      tion stored PRO2M',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel)
       = 0 ;
                       report_prosumage('Capacity total prosumers',loop_res_shar
      e,loop_ev,loop_prosumage,n)$(report_prosumage('Capacity total prosumers',l
      oop_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
       
                       report_market('gross energy demand market',loop_res_share
      ,loop_ev,loop_prosumage,n)$(report_market('gross energy demand market',loo
      p_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
                       report_market('curtailment of fluct res absolute market',
      loop_res_share,loop_ev,loop_prosumage,n)$(report_market('curtailment of fl
      uct res absolute market',loop_res_share,loop_ev,loop_prosumage,n) < eps_re
      p_abs) = 0 ;
                       report_market('curtailment of fluct res relative market',
      loop_res_share,loop_ev,loop_prosumage,n)$(report_market('curtailment of fl
      uct res relative market',loop_res_share,loop_ev,loop_prosumage,n) < eps_re
      p_rel) = 0 ;
                       report_market('Share market energy transferred to prosume
      r consumption',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('Sh
      are market energy transferred to prosumer consumption',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_market('Share market energy transferred to prosume
      r storage M2PRO',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('
      Share market energy transferred to prosumer storage M2PRO',loop_res_share,
      loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_market('Share market energy transferred to prosume
      r storage M2M',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('Sh
      are market energy transferred to prosumer storage M2M',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_market('Share market energy tranferred from prosum
      er generation',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('Sh
      are market energy tranferred from prosumer generation',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_market('Share market energy transferred from prosu
      mer storage PRO2M',loop_res_share,loop_ev,loop_prosumage,n)$(report_market
      ('Share market energy transferred from prosumer storage PRO2M',loop_res_sh
      are,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_market('Share market energy transferred from prosu
      mer storage M2M',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('
      Share market energy transferred from prosumer storage M2M',loop_res_share,
      loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
                       report_market('Capacity total market',loop_res_share,loop
      _ev,loop_prosumage,n)$(report_market('Capacity total market',loop_res_shar
      e,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
                       report_market('Energy demand total market',loop_res_share
      ,loop_ev,loop_prosumage,n)$(report_market('Energy demand total market',loo
      p_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
                       report_market('energy generated gross market',loop_res_sh
      are,loop_ev,loop_prosumage,n)$(report_market('energy generated gross marke
      t',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
       
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,tech,n)$(report_market_tech('Capacity share market
      ',loop_res_share,loop_ev,loop_prosumage,tech,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Capacity share market'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,rsvr,n)$(report_market_tech('Capacity share market
      ',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,con,n)$(report_market_tech
      ('Energy share in gross nodal market generation',loop_res_share,loop_ev,lo
      op_prosumage,con,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech
      ('Energy share in gross nodal market generation',loop_res_share,loop_ev,lo
      op_prosumage,res,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech
      ('Energy share in gross nodal market generation',loop_res_share,loop_ev,lo
      op_prosumage,sto,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,rsvr,n)$(report_market_tec
      h('Energy share in gross nodal market generation',loop_res_share,loop_ev,l
      oop_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
      $ontext
3609   
3610   
3611  * ------------------------------------------------------------------------
      ----
3612   
3613  * PROSUMAGE & DSM
      %DSM%$ontext
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,dsm_curt,n)$(feat_node('prosumage',n) AND feat_node('dsm',n
      ) AND report_market('Capacity total market',loop_res_share,loop_ev,loop_pr
      osumage,n)) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) 
      , lev_N_DSM_CU(scen,n,dsm_curt) ) / report_market('Capacity total market',
      loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,dsm_shift,n)$(feat_node('prosumage',n) AND feat_node('dsm',
      n) AND report_market('Capacity total market',loop_res_share,loop_ev,loop_p
      rosumage,n)) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_N_DSM_SHIFT(scen,n,dsm_shift) ) / report_market('Capacity total mar
      ket',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_market_tech('capacities load curtailment',loop_res_share,lo
      op_ev,loop_prosumage,dsm_curt,n)$(feat_node('prosumage',n) AND feat_node('
      dsm',n)) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_N_DSM_CU(scen,n,dsm_curt) );
              report_market_tech('capacities load shift',loop_res_share,loop_ev,
      loop_prosumage,dsm_shift,n)$(feat_node('prosumage',n) AND feat_node('dsm',
      n)) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N
      _DSM_SHIFT(scen,n,dsm_shift) );
              report_market_tech('FLH market',loop_res_share,loop_ev,loop_prosum
      age,dsm_curt,n)$(feat_node('prosumage',n) AND feat_node('dsm',n) AND sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_CU(scen,
      n,dsm_curt)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,dsm_curt,h) - corr_fac_dsm_cu(
      scen,n,dsm_curt,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) ;
              report_market_tech('FLH market',loop_res_share,loop_ev,loop_prosum
      age,dsm_shift,n)$(feat_node('prosumage',n) AND feat_node('dsm',n) AND sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_SHIFT(s
      cen,n,dsm_shift)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND(scen,n,dsm_shift,h)) ) / 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_SHI
      FT(scen,n,dsm_shift)) ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,dsm_curt,n)$(feat_node('prosumage',
      n) AND feat_node('dsm',n) AND report_market('energy generated gross market
      ',loop_res_share,loop_ev,loop_prosumage,n)) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,dsm_curt,h) - 
      corr_fac_dsm_cu(scen,n,dsm_curt,h)) ) / report_market('energy generated gr
      oss market',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('prosumage'
      ,n) AND feat_node('dsm',n) AND report_market('energy generated gross marke
      t',loop_res_share,loop_ev,loop_prosumage,n)) = sum( h , sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND(scen,n,dsm_sh
      ift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) ) / report_market('energy
       generated gross market',loop_res_share,loop_ev,loop_prosumage,n) * %sec_h
      our% + 1e-9 ;
       
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,dsm_curt,n)$(report_market_tech('Capacity share ma
      rket',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n) < eps_rep_rel) = 0
       ;
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,dsm_shift,n)$(report_market_tech('Capacity share m
      arket',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_rel) =
       0 ;
                       report_market_tech('capacities load curtailment',loop_res
      _share,loop_ev,loop_prosumage,dsm_curt,n)$(report_market_tech('capacities 
      load curtailment',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n) < eps_
      rep_ins) = 0 ;
                       report_market_tech('capacities load shift',loop_res_share
      ,loop_ev,loop_prosumage,dsm_shift,n)$(report_market_tech('capacities load 
      shift',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_ins) =
       0 ;
                       report_market_tech('FLH market',loop_res_share,loop_ev,lo
      op_prosumage,dsm_curt,n)$(report_market_tech('FLH market',loop_res_share,l
      oop_ev,loop_prosumage,dsm_curt,n) < eps_rep_abs) = 0 ;
                       report_market_tech('FLH market',loop_res_share,loop_ev,lo
      op_prosumage,dsm_shift,n)$(report_market_tech('FLH market',loop_res_share,
      loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_abs) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n)$(report_market
      _tech('Energy share in gross nodal market generation',loop_res_share,loop_
      ev,loop_prosumage,dsm_curt,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_marke
      t_tech('Energy share in gross nodal market generation',loop_res_share,loop
      _ev,loop_prosumage,dsm_shift,n) < eps_rep_rel) = 0 ;
      $ontext
3635   
3636   
3637  * ------------------------------------------------------------------------
      ----
3638   
3639  * PROSUMAGE & EV
      %EV%$ontext
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('prosumage',
      n) AND feat_node('ev',n) AND report_market('energy generated gross market'
      ,loop_res_share,loop_ev,loop_prosumage,n)) = (sum( (h,ev) , sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_EV_DISCHARGE(scen,n,ev,
      h))) - sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h
       , corr_fac_ev(scen,n,h))))/ report_market('energy generated gross market'
      ,loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
      $ontext
3645   
3646   
3647  * ------------------------------------------------------------------------
      ----
3648   
3649  * HEAT
               report_heat_tech_hours('heat demand - heating',loop_res_share,loo
      p_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = dh(n,bu,ch,h) ;
               report_heat_tech_hours('heat supply direct electric heating',loop
      _res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch) 
      * lev_H_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('heat supply SETS',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * (lev_H_SETS_OUT(
      scen,n,bu,ch,h) + (1-eta_heat_stat(n,bu,ch)) * lev_H_SETS_LEV(scen,n,bu,ch
      ,h-1)) ) ;
               report_heat_tech_hours('heat supply storage heating',loop_res_sha
      re,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * le
      v_H_STO_OUT(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand direct electric',loop_
      res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch) *
       lev_H_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand SETS',loop_res_share,l
      oop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * (lev_H_SE
      TS_IN(scen,n,bu,ch,h) + corr_fac_sets(scen,n,bu,ch,h)) ) ;
               report_heat_tech_hours('electricity demand HP',loop_res_share,loo
      p_ev,loop_prosumage,n,bu,hp,h)$feat_node('heat',n) = sum( scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , theta_hp(n,bu,hp) * ( lev_H_HP_IN
      (scen,n,bu,hp,h) + corr_fac_hp(scen,n,bu,hp,h)) ) ;
               report_heat_tech_hours('electricity demand hybrid heating',loop_r
      es_share,loop_ev,loop_prosumage,n,bu,hel,h)$feat_node('heat',n) = sum( sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_elec(n,bu,hel)
       * (lev_H_ELECTRIC_IN(scen,n,bu,hel,h) + corr_fac_h_elec(scen,n,bu,hel,h))
       ) ;
               report_heat_tech_hours('fossil fuel demand hybrid heating',loop_r
      es_share,loop_ev,loop_prosumage,n,bu,hfo,h)$feat_node('heat',n) = sum( sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_fossil(n,bu,hf
      o) * lev_H_STO_IN_FOSSIL(scen,n,bu,hfo,h) ) ;
               report_heat_tech_hours('SETS inflow',loop_res_share,loop_ev,loop_
      prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n,
      bu,ch,h) ) ;
               report_heat_tech_hours('SETS level',loop_res_share,loop_ev,loop_p
      rosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * lev_H_SETS_LEV(scen,n,
      bu,ch,h) ) ;
               report_heat_tech_hours('SETS outflow',loop_res_share,loop_ev,loop
      _prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * (lev_H_SETS_OUT(scen
      ,n,bu,ch,h) + (1-eta_heat_stat(n,bu,ch)) * lev_H_SETS_LEV(scen,n,bu,ch,h-1
      ) ) ) ;
               report_heat_tech_hours('Storage inflow',loop_res_share,loop_ev,lo
      op_prosumage,n,bu,hst,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , theta_hp(n,bu,hst) * lev_H_STO_IN_HP(sc
      en,n,bu,hst,h) + theta_elec(n,bu,hst) * lev_H_STO_IN_ELECTRIC(scen,n,bu,hs
      t,h) + theta_elec(n,bu,hst) * lev_H_STO_IN_FOSSIL(scen,n,bu,hst,h) ) ;
               report_heat_tech_hours('Storage level',loop_res_share,loop_ev,loo
      p_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * lev_H_STO_LEV(sc
      en,n,bu,ch,h) ) ;
               report_heat_tech_hours('Storage outflow',loop_res_share,loop_ev,l
      oop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * lev_H_STO_OUT(
      scen,n,bu,ch,h) ) ;
       
               report_heat_tech_hours('heat demand - DHW',loop_res_share,loop_ev
      ,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = d_dhw(n,bu,ch,h) ;
               report_heat_tech_hours('DHW supply - direct electric',loop_res_sh
      are,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch) * lev_H
      _DHW_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('DHW supply - SETS aux electric',loop_res_
      share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * le
      v_H_DHW_AUX_OUT(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('DHW supply - storage heating',loop_res_sh
      are,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * l
      ev_H_DHW_STO_OUT(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand DHW - direct electric'
      ,loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = su
      m( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu
      ,ch) * lev_H_DHW_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand DHW - SETS aux electri
      c',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = 
      sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n
      ,bu,ch) * (lev_H_DHW_AUX_ELEC_IN(scen,n,bu,ch,h) + corr_fac_sets_aux(scen,
      n,bu,ch,h)) ) ;
               report_heat_tech_hours('DHW - SETS aux hot water storage level',l
      oop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum(
       scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,
      ch) * lev_H_DHW_AUX_LEV(scen,n,bu,ch,h) ) ;
       
               report_heat_tech_hours('price heat electricity consumption',loop_
      res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(feat_node('heat',n) AND sum( 
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch
      ) * lev_H_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n
      ,bu,ch,h) + theta_storage(n,bu,ch) * lev_H_HP_IN(scen,n,bu,ch,h) + theta_s
      torage(n,bu,ch) * lev_H_ELECTRIC_IN(scen,n,bu,ch,h)) > 0.25 ) = sum( scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , - marginal_con1a(scen,
      n,h)) ;
               report_heat_tech_hours('price DHW electricity consumption',loop_r
      es_share,loop_ev,loop_prosumage,n,bu,ch,h)$(feat_node('heat',n) AND sum( s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch)
       * lev_H_DHW_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * lev_H_DHW_AUX_ELE
      C_IN(scen,n,bu,ch,h)) > 0.25 ) = sum( scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , - marginal_con1a(scen,n,h)) ;
       
                       report_heat_tech_hours('heat demand - heating',loop_res_s
      hare,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat deman
      d - heating',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_ab
      s) = 0 ;
                       report_heat_tech_hours('heat supply direct electric heati
      ng',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hou
      rs('heat supply direct electric heating',loop_res_share,loop_ev,loop_prosu
      mage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('heat supply SETS',loop_res_share,
      loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat supply SET
      S',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('heat supply storage heating',loop
      _res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat
       supply storage heating',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) 
      < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand direct electri
      c',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hour
      s('electricity demand direct electric',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand SETS',loop_res
      _share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('electric
      ity demand SETS',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_re
      p_abs) = 0 ;
                       report_heat_tech_hours('electricity demand HP',loop_res_s
      hare,loop_ev,loop_prosumage,n,bu,hp,h)$(report_heat_tech_hours('electricit
      y demand HP',loop_res_share,loop_ev,loop_prosumage,n,bu,hp,h) < eps_rep_ab
      s) = 0 ;
                       report_heat_tech_hours('electricity demand hybrid heating
      ',loop_res_share,loop_ev,loop_prosumage,n,bu,hel,h)$(report_heat_tech_hour
      s('electricity demand hybrid heating',loop_res_share,loop_ev,loop_prosumag
      e,n,bu,hel,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('fossil fuel demand hybrid heating
      ',loop_res_share,loop_ev,loop_prosumage,n,bu,hfo,h)$(report_heat_tech_hour
      s('fossil fuel demand hybrid heating',loop_res_share,loop_ev,loop_prosumag
      e,n,bu,hfo,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('SETS inflow',loop_res_share,loop_
      ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('SETS inflow',loop_re
      s_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('SETS level',loop_res_share,loop_e
      v,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('SETS level',loop_res_
      share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('SETS outflow',loop_res_share,loop
      _ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('SETS outflow',loop_
      res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('Storage inflow',loop_res_share,lo
      op_ev,loop_prosumage,n,bu,hst,h)$(report_heat_tech_hours('Storage inflow',
      loop_res_share,loop_ev,loop_prosumage,n,bu,hst,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('Storage level',loop_res_share,loo
      p_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('Storage level',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('Storage outflow',loop_res_share,l
      oop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('Storage outflow'
      ,loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
       
                       report_heat_tech_hours('heat demand - DHW',loop_res_share
      ,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat demand - 
      DHW',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW supply - direct electric',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('DHW
       supply - direct electric',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h
      ) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW supply - SETS aux electric',l
      oop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('D
      HW supply - SETS aux electric',loop_res_share,loop_ev,loop_prosumage,n,bu,
      ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW supply - storage heating',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('DHW
       supply - storage heating',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h
      ) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand DHW - direct e
      lectric',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tec
      h_hours('electricity demand DHW - direct electric',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand DHW - SETS aux
       electric',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_t
      ech_hours('electricity demand DHW - SETS aux electric',loop_res_share,loop
      _ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW - SETS aux hot water storage 
      level',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_
      hours('DHW - SETS aux hot water storage level',loop_res_share,loop_ev,loop
      _prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
       
                       report_heat_tech_hours('price heat electricity consumptio
      n',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hour
      s('price heat electricity consumption',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('price DHW electricity consumption
      ',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$( report_heat_tech_hour
      s('price DHW electricity consumption',loop_res_share,loop_ev,loop_prosumag
      e,n,bu,ch,h)< eps_rep_abs) = 0 ;
       
       
               report_heat_tech('heat supply',loop_res_share,loop_ev,loop_prosum
      age,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( h , theta_dir(n,bu,ch) * lev_H_DIR(scen,n,bu,c
      h,h) + theta_sets(n,bu,ch) * (lev_H_SETS_OUT(scen,n,bu,ch,h) + (1-eta_heat
      _stat(n,bu,ch)) * lev_H_SETS_LEV(scen,n,bu,ch,h-1)) + theta_storage(n,bu,c
      h) * lev_H_STO_OUT(scen,n,bu,ch,h) )) ;
               report_heat_tech('DHW supply',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( h , theta_dir(n,bu,ch) * lev_H_DHW_DIR(scen,n,b
      u,ch,h) + theta_sets(n,bu,ch) * lev_H_DHW_AUX_OUT(scen,n,bu,ch,h) + theta_
      storage(n,bu,ch) * lev_H_DHW_STO_OUT(scen,n,bu,ch,h) )) ;
               report_heat_tech('total costs',loop_res_share,loop_ev,loop_prosum
      age,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( h , report_heat_tech_hours('price heat electri
      city consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) * ( the
      ta_dir(n,bu,ch) * lev_H_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H
      _SETS_IN(scen,n,bu,ch,h) + corr_fac_sets(scen,n,bu,ch,h)) + theta_hp(n,bu,
      ch) * ( lev_H_HP_IN(scen,n,bu,ch,h) + corr_fac_hp(scen,n,bu,ch,h)) + theta
      _elec(n,bu,ch) * lev_H_ELECTRIC_IN(scen,n,bu,ch,h) + corr_fac_h_elec(scen,
      n,bu,ch,h)) + report_heat_tech_hours('price DHW electricity consumption',l
      oop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) * (theta_dir(n,bu,ch) * le
      v_H_DHW_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H_DHW_AUX_ELEC_IN
      (scen,n,bu,ch,h) + corr_fac_sets_aux(scen,n,bu,ch,h))) )) ;
               report_heat_tech('total electricity consumption',loop_res_share,l
      oop_ev,loop_prosumage,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , sum( h , theta_dir(n,bu,ch) * lev
      _H_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H_SETS_IN(scen,n,bu,ch
      ,h) + corr_fac_sets(scen,n,bu,ch,h)) + theta_hp(n,bu,ch) * ( lev_H_HP_IN(s
      cen,n,bu,ch,h) + corr_fac_hp(scen,n,bu,ch,h)) + theta_elec(n,bu,ch) * lev_
      H_ELECTRIC_IN(scen,n,bu,ch,h) + corr_fac_h_elec(scen,n,bu,ch,h) + theta_di
      r(n,bu,ch) * lev_H_DHW_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H_
      DHW_AUX_ELEC_IN(scen,n,bu,ch,h) + corr_fac_sets_aux(scen,n,bu,ch,h)) )) ;
               report_heat_tech('average price heat electricity consumption',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch)$(feat_node('heat',n) AND repor
      t_heat_tech('total electricity consumption',loop_res_share,loop_ev,loop_pr
      osumage,n,bu,ch)) = report_heat_tech('total costs',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch) / report_heat_tech('total electricity consumption'
      ,loop_res_share,loop_ev,loop_prosumage,n,bu,ch) ;
               report_heat_tech('average price heat electricity consumption over
       all bu',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch)$(feat_n
      ode('heat',n) AND report_heat_tech('total electricity consumption',loop_re
      s_share,loop_ev,loop_prosumage,n,'bu1',ch)) = sum( bu, report_heat_tech('a
      verage price heat electricity consumption',loop_res_share,loop_ev,loop_pro
      sumage,n,bu,ch) * report_heat_tech('total electricity consumption',loop_re
      s_share,loop_ev,loop_prosumage,n,bu,ch) ) / sum( bu, report_heat_tech('tot
      al electricity consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,ch)
       ) ;
               report_heat_tech('Storage cycles (inflow)',loop_res_share,loop_ev
      ,loop_prosumage,n,bu,ch)$(feat_node('heat',n) AND n_heat_e(n,bu,ch)) = sum
      ( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_s
      ets(n,bu,ch) * (lev_H_SETS_IN(scen,n,bu,ch,h) + corr_fac_sets(scen,n,bu,ch
      ,h)) + theta_hp(n,bu,ch) * ( lev_H_HP_IN(scen,n,bu,ch,h) + corr_fac_hp(sce
      n,n,bu,ch,h))) )/n_heat_e(n,bu,ch);
       
                       report_heat_tech('heat supply',loop_res_share,loop_ev,loo
      p_prosumage,n,bu,ch)$(report_heat_tech('heat supply',loop_res_share,loop_e
      v,loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('DHW supply',loop_res_share,loop_ev,loop
      _prosumage,n,bu,ch)$(report_heat_tech('DHW supply',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('total costs',loop_res_share,loop_ev,loo
      p_prosumage,n,bu,ch)$(report_heat_tech('total costs',loop_res_share,loop_e
      v,loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('total electricity consumption',loop_res
      _share,loop_ev,loop_prosumage,n,bu,ch)$(report_heat_tech('total electricit
      y consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,ch) < eps_rep_ab
      s) = 0 ;
                       report_heat_tech('average price heat electricity consumpt
      ion',loop_res_share,loop_ev,loop_prosumage,n,bu,ch)$(report_heat_tech('ave
      rage price heat electricity consumption',loop_res_share,loop_ev,loop_prosu
      mage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('average price heat electricity consumpt
      ion over all bu',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch)
      $(report_heat_tech('average price heat electricity consumption over all bu
      ',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch) < eps_rep_abs)
       = 0 ;
                       report_heat_tech('Storage cycles (inflow)',loop_res_share
      ,loop_ev,loop_prosumage,n,bu,ch)$(report_heat_tech('Storage cycles (inflow
      )',loop_res_share,loop_ev,loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
      $ontext
3723   
3724   
3725  * ------------------------------------------------------------------------
      ----
3726   
3727   
3728  * Reserves and heat
      %reserves_endogenous%$ontext
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND fe
      at_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(sc
      en,n,reserves_nonprim,bu,'setsh',h)))) / ( (card(h)-1) * 1000 * phi_reserv
      es_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + s
      um(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen
      $(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,n
      ondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND f
      eat_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(s
      cen,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserves_nonpri
      m,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_rese
      rves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) +
       sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n
      ,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
      *        report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,n
      ,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hst
      ,h) )))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) *
       (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope
      (n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sce
      n,n,nondisnondis)))/1000) ))  ;
      *        report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND fea
      t_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,
      n,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hs
      t,h)  ))*phi_reserves_call(n,reserves_nonprim,h))) / sum( h , phi_reserves
      _call(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim
      ) * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_sl
      ope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(
      scen,n,nondisnondis)))/1000) ))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat_
      node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(sce
      n,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst,
      h))))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (
      reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n
      ,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,
      n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(sc
      en,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst
      ,h))))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_ca
      ll(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) *
       (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope
      (n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sce
      n,n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) AN
      D feat_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SET
      S_AUX(scen,n,reserves_nonprim,bu,'setsh',h)))) / ( (card(h)-1) * 1000 * ph
      i_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonp
      rim) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(
      scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) A
      ND feat_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SE
      TS_AUX(scen,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserve
      s_nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * 
      phi_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_no
      nprim) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) 
      * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TEC
      H(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
      $ontext
      %reserves_exogenous%$ontext
      *** ### Noch nicht vollständig
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND fe
      at_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(sce
      n,n,reserves_nonprim,bu,'setsh',h)))) / sum( h$(ord(h) > 1), reserves_exog
      enous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND f
      eat_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(sc
      en,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserves_nonprim
      ,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_exogeno
      us(n,reserves_nonprim,h) )  ;
      *        report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,n
      ,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hst
      ,h) )))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) *
       (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope
      (n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sce
      n,n,nondisnondis)))/1000) ))  ;
      *        report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND fea
      t_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,
      n,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hs
      t,h)  ))*phi_reserves_call(n,reserves_nonprim,h))) / sum( h , phi_reserves
      _call(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim
      ) * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_sl
      ope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(
      scen,n,nondisnondis)))/1000) ))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat_
      node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(scen
      ,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst,h
      ))))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(sce
      n,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst,
      h))))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_cal
      l(n,reserves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h) )  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) AN
      D feat_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS
      _AUX(scen,n,reserves_nonprim,bu,'setsh',h)))) / sum( h$(ord(h) > 1), reser
      ves_exogenous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) A
      ND feat_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SET
      S_AUX(scen,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserves
      _nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves
      _exogenous(n,reserves_nonprim,h) )  ;
      $ontext
3754   
      %reserves%$ontext
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,'sets aux',h,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS_AUX(scen,n,res
      erves,bu,'setsh',h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'sets aux',h,n)$(feat_node('heat',n) AND fea
      t_node('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS_AUX(scen,n,re
      serves,bu,'setsh',h)))*phi_reserves_call(n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,'sets',h,n)$(feat_node('heat',n) AND feat_nod
      e('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(scen,n,reserves,bu
      ,'setsh',h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'sets',h,n)$(feat_node('heat',n) AND feat_no
      de('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(scen,n,reserves,b
      u,'setsh',h)))*phi_reserves_call(n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,hp,h,n)$(feat_node('heat',n) AND feat_node('r
      eserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , sum( bu , theta_hp(n,bu,hp) * lev_RP_HP(scen,n,reserves,bu,hp,h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,hp,h,n)$(feat_node('heat',n) AND feat_node('
      reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( bu , theta_hp(n,bu,hp) * lev_RP_HP(scen,n,reserves,bu,hp,h)))*phi
      _reserves_call(n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,hel,h,n)$(feat_node('heat',n) AND feat_node('
      reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( bu , theta_storage(n,bu,hel) * lev_RP_H_ELEC(scen,n,reserves,bu,h
      el,h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,hel,h,n)$(feat_node('heat',n) AND feat_node(
      'reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( bu , theta_storage(n,bu,hel) * lev_RP_H_ELEC(scen,n,reserves,bu,
      hel,h)))*phi_reserves_call(n,reserves,h)  ;
       
                        report_reserves_tech('reserve provision shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'sets',n)$( report_reserves
      _tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,'sets',n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve activation shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,'sets',n)$( report_reserve
      s_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,r
      eserves_nonprim,'sets',n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve provision shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,hst,n)$( report_reserves_te
      ch('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_nonprim,hst,n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve activation shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,hst,n)$( report_reserves_t
      ech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,rese
      rves_nonprim,hst,n) < eps_rep_rel) = 0 ;
      *                  report_reserves_tech('reserve provision shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,hel,n)$( report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_nonprim,hel,n) < eps_rep_rel) = 0 ;
      *                  report_reserves_tech('reserve activation shares',loop_r
      es_share,loop_ev,loop_prosumage,reserves_nonprim,hel,n)$( report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,hel,n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve provision shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$( report_rese
      rves_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage
      ,reserves_nonprim,'sets aux',n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve activation shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$( report_res
      erves_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosuma
      ge,reserves_nonprim,'sets aux',n) < eps_rep_rel) = 0 ;
       
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,'sets aux',h,n)$(report_reserves_te
      ch_hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserv
      es,'sets aux',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,'sets aux',h,n)$(report_reserves_t
      ech_hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,rese
      rves,'sets aux',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,'sets',h,n)$(report_reserves_tech_h
      ours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,'
      sets',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,'sets',h,n)$( report_reserves_tech
      _hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserve
      s,'sets',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,hp,h,n)$( report_reserves_tech_hour
      s('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,hp,h
      ,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,hp,h,n)$( report_reserves_tech_hou
      rs('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,hp
      ,h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,hel,h,n)$( report_reserves_tech_hou
      rs('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,hel
      ,h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,hel,h,n)$( report_reserves_tech_ho
      urs('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,h
      el,h,n) < eps_rep_abs) = 0 ;
      $ontext
3785   
3786   
3787  * ------------------------------------------------------------------------
      ---- *
3788  * ------------------------------------------------------------------------
      ---- *
3789  * ------------------------------------------------------------------------
      ---- *
3790   
3791   
3792  execute_unload "results", report, report_tech, report_node, report_line, r
      eport_tech_hours, report_hours, report_cost
      , report_prosumage, report_prosumage_tech, report_prosumage_tech_hours, re
      port_market, report_market_tech, report_market_tech_hours
      $ontext
3797   
3798  ;
3799   
3800  *$ontext
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\report_to_excel.gms
3802   
3803  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2018.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
3813  **************************************************************************
      ******
3814   
3815   
3816   
3817   
3818  *****************************************
3819  **** Reporting to Excel              ****
3820  *****************************************
3821   
3822   
3823  Parameter
3824  excel_cost
3825  excel_cost_building_heat
3826  excel_cost_building
3827  excel_cost_building_heat_other
3828  excel_heat
3829  excel_capacities
3830  excel_capacities_storage
3831  excel_res_curt
3832  excel_prices
3833  excel_dispatch
3834  excel_reserves
3835  ;
3836   
3837  Parameter
3838  building_size(bu) /
3839  bu1      176
3840  bu2      584
3841  bu3      192
3842  bu4      2739
3843  bu5      160
3844  bu6      1815
3845  bu7      137
3846  bu8      1182
3847  bu9      153
3848  bu10     715
3849  bu11     150
3850  bu12     700
3851  /
3852  ;
3853   
3854   
3855  excel_cost('Nodal cost: dispatch & investment') = sum( (n,loop_res_share,l
      oop_ev,loop_prosumage) , report_cost('Nodal cost: dispatch',loop_res_share
      ,loop_ev,loop_prosumage,n) + report_cost('Nodal cost: investment & fix',lo
      op_res_share,loop_ev,loop_prosumage,n) + report_cost('Nodal cost: infeasib
      ility',loop_res_share,loop_ev,loop_prosumage,n)) ;
3856  excel_cost('Nodal cost: dispatch') = sum( (n,loop_res_share,loop_ev,loop_p
      rosumage) , report_cost('Nodal cost: dispatch',loop_res_share,loop_ev,loop
      _prosumage,n) + report_cost('Nodal cost: infeasibility',loop_res_share,loo
      p_ev,loop_prosumage,n)) ;
3857  excel_cost('Nodal cost: investment and fix') = sum( (n,loop_res_share,loop
      _ev,loop_prosumage) , report_cost('Nodal cost: investment & fix',loop_res_
      share,loop_ev,loop_prosumage,n)) ;
3858  excel_cost('Energy generated net') = sum( (n,loop_res_share,loop_ev,loop_p
      rosumage) , report('energy generated net',loop_res_share,loop_ev,loop_pros
      umage)) ;
3859  excel_cost('Average cost') = excel_cost('Nodal cost: dispatch & investment
      ')/excel_cost('Energy generated net') ;
3860   
      excel_cost_building_heat('Costs per square meter',bu,'setsh')$(sum( n, are
      a_floor(n,bu,'setsh')*phi_heat_type(n,bu,'setsh'))) = sum((n,loop_res_shar
      e,loop_ev,loop_prosumage) , report_heat_tech('total costs',loop_res_share,
      loop_ev,loop_prosumage,n,bu,'setsh')) / sum( n, area_floor(n,bu,'setsh')*p
      hi_heat_type(n,bu,'setsh')) ;
      excel_cost_building_heat('Costs per square meter heating',bu,'setsh')$(sum
      ( n, area_floor(n,bu,'setsh')*phi_heat_type(n,bu,'setsh'))) = sum( (n,h,lo
      op_res_share,loop_ev,loop_prosumage) , report_heat_tech_hours('price heat 
      electricity consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,'setsh
      ',h) * sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , ( the
      ta_sets(n,bu,'setsh') * (lev_H_SETS_IN(scen,n,bu,'setsh',h) + corr_fac_set
      s(scen,n,bu,'setsh',h))))) / sum( n, area_floor(n,bu,'setsh')*phi_heat_typ
      e(n,bu,'setsh')) ;
      excel_cost_building_heat('Costs per square meter DHW',bu,'setsh')$(sum( n,
       area_floor(n,bu,'setsh')*phi_heat_type(n,bu,'setsh'))) = sum( (n,h,loop_r
      es_share,loop_ev,loop_prosumage) , report_heat_tech_hours('price DHW elect
      ricity consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,'setsh',h) 
      * sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , (theta_set
      s(n,bu,'setsh') * (lev_H_DHW_AUX_ELEC_IN(scen,n,bu,'setsh',h) + corr_fac_s
      ets_aux(scen,n,bu,'setsh',h))))) / sum( n, area_floor(n,bu,'setsh')*phi_he
      at_type(n,bu,'setsh')) ;
      excel_cost_building_heat('Costs per building',bu,'setsh')$(excel_cost_buil
      ding_heat('Costs per square meter',bu,'setsh')) = excel_cost_building_heat
      ('Costs per square meter',bu,'setsh') * building_size(bu) ;
      excel_cost_building_heat('Costs per building heating',bu,'setsh')$(excel_c
      ost_building_heat('Costs per square meter heating',bu,'setsh')) = excel_co
      st_building_heat('Costs per square meter heating',bu,'setsh') * building_s
      ize(bu) ;
      excel_cost_building_heat('Costs per building DHW',bu,'setsh')$(excel_cost_
      building_heat('Costs per square meter DHW',bu,'setsh')) = excel_cost_build
      ing_heat('Costs per square meter DHW',bu,'setsh') * building_size(bu) ;
      excel_cost_building_heat('Reserve revenues heating per square meter',bu,'s
      etsh')$(sum( n, area_floor(n,bu,'setsh')*phi_heat_type(n,bu,'setsh'))) = (
      sum( (loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,h,n) , (sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,'s
      etsh') * lev_RP_SETS(scen,n,reserves_nonprim,bu,'setsh',h))) * report_rese
      rves_hours('reserve prices',loop_res_share,loop_ev,loop_prosumage,reserves
      _nonprim,h,n)) ) / sum( n, area_floor(n,bu,'setsh')*phi_heat_type(n,bu,'se
      tsh')) ;
      excel_cost_building_heat('Reserve revenues DHW per square meter',bu,'setsh
      ')$(sum( n, area_floor(n,bu,'setsh')*phi_heat_type(n,bu,'setsh'))) = sum( 
      (loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,h,n) , (sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,'setsh'
      ) * lev_RP_SETS_AUX(scen,n,reserves_nonprim,bu,'setsh',h))) * report_reser
      ves_hours('reserve prices',loop_res_share,loop_ev,loop_prosumage,reserves_
      nonprim,h,n) ) / sum( n, area_floor(n,bu,'setsh')*phi_heat_type(n,bu,'sets
      h')) ;
      excel_cost_building_heat('Reserve revenues heating per building',bu,'setsh
      ')$(excel_cost_building_heat('Reserve revenues heating per square meter',b
      u,'setsh')) = excel_cost_building_heat('Reserve revenues heating per squar
      e meter',bu,'setsh') * building_size(bu) ;
      excel_cost_building_heat('Reserve revenues DHW per building',bu,'setsh')$(
      excel_cost_building_heat('Reserve revenues DHW per square meter',bu,'setsh
      ')) = excel_cost_building_heat('Reserve revenues DHW per square meter',bu,
      'setsh') * building_size(bu) ;
      excel_cost_building_heat('Mean price heating',bu,'setsh')$(sum( (loop_res_
      share,loop_ev,loop_prosumage,n) , report_heat_tech('average price heat ele
      ctricity consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,'setsh'))
      ) = sum( (loop_res_share,loop_ev,loop_prosumage,n) , report_heat_tech('ave
      rage price heat electricity consumption',loop_res_share,loop_ev,loop_prosu
      mage,n,bu,'setsh') ) ;
       
      excel_cost_building_heat_other('Costs per square meter',bu,hst)$(sum( n, a
      rea_floor(n,bu,hst)*phi_heat_type(n,bu,hst))) = sum((n,loop_res_share,loop
      _ev,loop_prosumage) , report_heat_tech('total costs',loop_res_share,loop_e
      v,loop_prosumage,n,bu,hst)) / sum( n, area_floor(n,bu,hst)*phi_heat_type(n
      ,bu,hst)) ;
      excel_cost_building_heat_other('Costs per building',bu,hst)$(excel_cost_bu
      ilding_heat_other('Costs per square meter',bu,hst)) = excel_cost_building_
      heat_other('Costs per square meter',bu,hst) * building_size(bu) ;
      excel_cost_building_heat_other('Reserve revenues per square meter',bu,hst)
      $(sum( n, area_floor(n,bu,hst)*phi_heat_type(n,bu,hst))) = (sum( (loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,h,n) , (sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,hst)*(lev_RP_
      HP(scen,n,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonpr
      im,bu,hst,h)) )) * report_reserves_hours('reserve prices',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,h,n)) ) / sum( n, area_floor(n,bu,h
      st)*phi_heat_type(n,bu,hst)) ;
      excel_cost_building_heat_other('Reserve revenues per building',bu,hst)$(ex
      cel_cost_building_heat_other('Reserve revenues per square meter',bu,hst)) 
      = excel_cost_building_heat_other('Reserve revenues per square meter',bu,hs
      t) * building_size(bu) ;
      excel_cost_building_heat_other('Heating mean price',bu,hst)$(sum( (loop_re
      s_share,loop_ev,loop_prosumage,n) , report_heat_tech('average price heat e
      lectricity consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,hst))) 
      = sum( (loop_res_share,loop_ev,loop_prosumage,n) , report_heat_tech('avera
      ge price heat electricity consumption',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,hst) ) ;
       
      excel_cost_building('Costs per square meter over building types',ch)$(sum(
      (n,bu) , area_floor(n,bu,ch)*phi_heat_type(n,bu,ch))) = sum((n,bu,loop_res
      _share,loop_ev,loop_prosumage) , report_heat_tech('total costs',loop_res_s
      hare,loop_ev,loop_prosumage,n,bu,ch)) / sum((n,bu) , area_floor(n,bu,ch)*p
      hi_heat_type(n,bu,ch)) ;
      excel_cost_building('Costs per square meter over building types','NETS') =
       sum((n,loop_res_share,loop_ev,loop_prosumage) , sum( h, nets_profile(h) *
       report_hours('price',loop_res_share,loop_ev,loop_prosumage,h,n)) ) / 60.0
      3819066E+6 ;
      excel_cost_building('Costs over all buildings',ch)$(excel_cost_building('C
      osts per square meter over building types',ch)) = excel_cost_building('Cos
      ts per square meter over building types',ch)*sum( (n,bu) , area_floor(n,bu
      ,ch)*phi_heat_type(n,bu,ch));
      excel_cost_building('Average reserves revenue heating per m2 over all buil
      ding types','setsh')$(sum( (n,bu) , area_floor(n,bu,'setsh')*phi_heat_type
      (n,bu,'setsh'))) = sum( bu , (excel_cost_building_heat('Reserve revenues h
      eating per square meter',bu,'setsh')*sum( n, area_floor(n,bu,'setsh')*phi_
      heat_type(n,bu,'setsh')))) / sum( (n,bu) , area_floor(n,bu,'setsh')*phi_he
      at_type(n,bu,'setsh')) ;
      excel_cost_building('Average reserves revenue heating per m2 over all buil
      ding types',hp)$sum( (n,bu) , area_floor(n,bu,hp)*phi_heat_type(n,bu,hp)) 
      = sum( bu , (excel_cost_building_heat_other('Reserve revenues per square m
      eter',bu,hp)*sum( n, area_floor(n,bu,hp)*phi_heat_type(n,bu,hp)))) / sum( 
      (n,bu) , area_floor(n,bu,hp)*phi_heat_type(n,bu,hp)) ;
      excel_cost_building('Average reserves revenue DHW per m2 over all building
       types','setsh')$sum( (n,bu) , area_floor(n,bu,'setsh')*phi_heat_type(n,bu
      ,'setsh')) = sum( bu , (excel_cost_building_heat_other('Reserve revenues D
      HW per square meter',bu,'setsh')*sum( n, area_floor(n,bu,'setsh')*phi_heat
      _type(n,bu,'setsh')))) / sum( (n,bu) , area_floor(n,bu,'setsh')*phi_heat_t
      ype(n,bu,'setsh')) ;
       
      excel_heat('Heat supply',ch)$(sum((n,bu) , area_floor(n,bu,ch)*phi_heat_ty
      pe(n,bu,ch))) = sum( (n,bu,loop_res_share,loop_ev,loop_prosumage) , report
      _heat_tech('heat supply',loop_res_share,loop_ev,loop_prosumage,n,bu,ch));
      excel_heat('DHW supply',ch)$(sum((n,bu) , area_floor(n,bu,ch)*phi_heat_typ
      e(n,bu,ch))) = sum( (n,bu,loop_res_share,loop_ev,loop_prosumage) , report_
      heat_tech('DHW supply',loop_res_share,loop_ev,loop_prosumage,n,bu,ch)) ;
      excel_heat('Total heat supply',ch)$(sum((n,bu) , area_floor(n,bu,ch)*phi_h
      eat_type(n,bu,ch))) = excel_heat('Heat supply',ch) + excel_heat('DHW suppl
      y',ch) ;
      excel_heat('Savings natural gas replacement',ch)$(sum((n,bu) , area_floor(
      n,bu,ch)*phi_heat_type(n,bu,ch))) = sum( n , fuelprice(n,'CCGT')) * sum ( 
      (loop_res_share,loop_ev,loop_prosumage) , excel_heat('Total heat supply',c
      h) ) ;
      excel_heat('Savings natural gas replacement incl CO2 price',ch)$(sum((n,bu
      ) , area_floor(n,bu,ch)*phi_heat_type(n,bu,ch))) = ( sum( n , fuelprice(n,
      'CCGT')) + sum( n , carbon_content(n,'CCGT')*CO2price(n,'CCGT')) ) * excel
      _heat('Total heat supply',ch) ;
      excel_heat('Total energy in MWh',ch)$(sum((n,bu) , area_floor(n,bu,ch)*phi
      _heat_type(n,bu,ch))) = sum( (n,bu) , n_sets_e(n,bu,ch) ) ;
      excel_heat('Total power in',ch)$(sum((n,bu) , area_floor(n,bu,ch)*phi_heat
      _type(n,bu,ch))) = sum( (n,bu) , n_sets_p_in(n,bu,ch) ) ;
      excel_heat('Total power out',ch)$(sum((n,bu) , area_floor(n,bu,ch)*phi_hea
      t_type(n,bu,ch))) = sum( (n,bu) , n_sets_p_out(n,bu,ch) ) ;
      excel_heat('Mean price heating',ch)$(sum( (loop_res_share,loop_ev,loop_pro
      sumage,n) , report_heat_tech('average price heat electricity consumption o
      ver all bu',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch))) = 
      sum( (loop_res_share,loop_ev,loop_prosumage,n) , report_heat_tech('average
       price heat electricity consumption over all bu',loop_res_share,loop_ev,lo
      op_prosumage,n,'over all bu',ch) ) ;
      excel_heat('Mean price heating','NETS') = sum( (loop_res_share,loop_ev,loo
      p_prosumage,n) , sum( h, nets_profile(h) * report_hours('price',loop_res_s
      hare,loop_ev,loop_prosumage,h,n)) / sum( h, nets_profile(h)) ) ;
      $ontext
3899   
3900  excel_capacities('Capacities',tech) = sum( (n,loop_res_share,loop_ev,loop_
      prosumage) , report_tech('capacities conventional',loop_res_share,loop_ev,
      loop_prosumage,tech,n) + report_tech('capacities renewable',loop_res_share
      ,loop_ev,loop_prosumage,tech,n)) ;
3901  excel_capacities('Capacities',rsvr) = sum( (n,loop_res_share,loop_ev,loop_
      prosumage) , report_tech('capacities reservoir MW',loop_res_share,loop_ev,
      loop_prosumage,rsvr,n) ) ;
3902  excel_capacities('Capacities',sto) = sum( (n,loop_res_share,loop_ev,loop_p
      rosumage) , report_tech('capacities storage MW',loop_res_share,loop_ev,loo
      p_prosumage,sto,n) ) ;
3903   
3904  excel_res_curt('res share') = sum( (n,loop_res_share,loop_ev,loop_prosumag
      e) , report_node('renshare in nodal gross demand',loop_res_share,loop_ev,l
      oop_prosumage,n) ) ;
3905  excel_res_curt('curtailment absolute') = sum( (loop_res_share,loop_ev,loop
      _prosumage) , report('curtailment of fluct res absolute',loop_res_share,lo
      op_ev,loop_prosumage) ) ;
3906  excel_res_curt('curtailment relative') = sum( (loop_res_share,loop_ev,loop
      _prosumage) , report('curtailment of fluct res relative',loop_res_share,lo
      op_ev,loop_prosumage) ) ;
3907   
3908  excel_prices('max price') = sum( (loop_res_share,loop_ev,loop_prosumage,n)
       , report_node('max price',loop_res_share,loop_ev,loop_prosumage,n) ) ;
3909  excel_prices('mean price') = sum( (loop_res_share,loop_ev,loop_prosumage,n
      ) , report_node('mean price',loop_res_share,loop_ev,loop_prosumage,n) ) ;
3910  excel_prices('min price') = sum( (loop_res_share,loop_ev,loop_prosumage,n)
       , report_node('min price',loop_res_share,loop_ev,loop_prosumage,n) ) ;
3911   
3912  excel_dispatch('technology shares in nodal gross demand',res) = sum( (loop
      _res_share,loop_ev,loop_prosumage,n) , report_tech('renshares in nodal gro
      ss demand',loop_res_share,loop_ev,loop_prosumage,res,n) ) ;
3913  excel_dispatch('technology shares in nodal gross demand',rsvr) = sum( (loo
      p_res_share,loop_ev,loop_prosumage,n) , report_tech('renshares in nodal gr
      oss demand',loop_res_share,loop_ev,loop_prosumage,rsvr,n) ) ;
3914  excel_dispatch('technology shares in nodal gross demand',con) = sum( (loop
      _res_share,loop_ev,loop_prosumage,n) , report_tech('conshares in nodal gro
      ss demand',loop_res_share,loop_ev,loop_prosumage,con,n) ) ;
3915   
3916  excel_dispatch('yearly energy',tech) = sum( (loop_res_share,loop_ev,loop_p
      rosumage,n) , report_tech('Yearly energy',loop_res_share,loop_ev,loop_pros
      umage,tech,n) ) ;
3917  excel_dispatch('yearly energy',sto) = sum( (loop_res_share,loop_ev,loop_pr
      osumage,n) , report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosu
      mage,sto,n) ) ;
3918  excel_dispatch('yearly energy',dsm) = sum( (loop_res_share,loop_ev,loop_pr
      osumage,n) , report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosu
      mage,dsm,n) ) ;
3919   
3920  execute_unload "results_to_excel", excel_cost excel_capacities excel_res_c
      urt excel_prices excel_dispatch
      %reserves% excel_cost_building_heat excel_cost_building_heat_other excel_c
      ost_building excel_heat
      $ontext
3925  ;
3926   
      excel_reserves('provision shares prim',reserves_prim,dis) = sum( (loop_res
      _share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provision
       shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,dis,n) ) ;
      excel_reserves('provision shares prim',reserves_prim,nondis) = sum( (loop_
      res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provis
      ion shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,nondis,n) 
      ) ;
      excel_reserves('provision shares prim',reserves_prim,rsvr) = sum( (loop_re
      s_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provisio
      n shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,rsvr,n) ) ;
      excel_reserves('provision shares prim',reserves_prim,sto) = sum( (loop_res
      _share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provision
       shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,sto,n) ) ;
      excel_reserves('provision shares prim',reserves_prim,'sets') = sum( (loop_
      res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provis
      ion shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,'sets',n) 
      ) ;
      excel_reserves('provision shares prim',reserves_prim,'sets aux') = sum( (l
      oop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve pr
      ovision shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,'sets 
      aux',n) ) ;
      excel_reserves('provision shares prim',reserves_prim,hst) = sum( (loop_res
      _share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provision
       shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,hst,n) ) ;
      excel_reserves('provision shares prim',reserves_prim,hp) = sum( (loop_res_
      share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provision 
      shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,hp,n) ) ;
      excel_reserves('provision shares prim',reserves_prim,hel) = sum( (loop_res
      _share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve provision
       shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,hel,n) ) ;
       
      excel_reserves('activation shares prim',reserves_prim,dis) = sum( (loop_re
      s_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activati
      on shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,dis,n) ) ;
      excel_reserves('activation shares prim',reserves_prim,nondis) = sum( (loop
      _res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activ
      ation shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,nondis,n
      ) ) ;
      excel_reserves('activation shares prim',reserves_prim,rsvr) = sum( (loop_r
      es_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activat
      ion shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,rsvr,n) ) 
      ;
      excel_reserves('activation shares prim',reserves_prim,sto) = sum( (loop_re
      s_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activati
      on shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,sto,n) ) ;
      excel_reserves('activation shares prim',reserves_prim,'sets') = sum( (loop
      _res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activ
      ation shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,'sets',n
      ) ) ;
      excel_reserves('activation shares prim',reserves_prim,'sets aux') = sum( (
      loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve a
      ctivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,'set
      s aux',n) ) ;
      excel_reserves('activation shares prim',reserves_prim,hst) = sum( (loop_re
      s_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activati
      on shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,hst,n) ) ;
      excel_reserves('activation shares prim',reserves_prim,hp) = sum( (loop_res
      _share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activatio
      n shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,hp,n) ) ;
      excel_reserves('activation shares prim',reserves_prim,hel) = sum( (loop_re
      s_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve activati
      on shares',loop_res_share,loop_ev,loop_prosumage,reserves_prim,hel,n) ) ;
       
      excel_reserves('provision shares nonprim',reserves_nonprim,dis) = sum( (lo
      op_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve pro
      vision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,dis,
      n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,nondis) = sum( 
      (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve 
      provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,n
      ondis,n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,rsvr) = sum( (l
      oop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve pr
      ovision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,rsv
      r,n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,sto) = sum( (lo
      op_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve pro
      vision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,sto,
      n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,'sets') = sum( 
      (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve 
      provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,'
      sets',n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,'sets aux') = s
      um( (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('rese
      rve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonpr
      im,'sets aux',n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,hst) = sum( (lo
      op_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve pro
      vision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,hst,
      n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,hp) = sum( (loo
      p_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve prov
      ision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,hp,n)
       ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,hel) = sum( (lo
      op_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve pro
      vision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,hel,
      n) ) ;
       
      excel_reserves('activation shares nonprim',reserves_nonprim,dis) = sum( (l
      oop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve ac
      tivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,di
      s,n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,nondis) = sum(
       (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve
       activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim
      ,nondis,n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,rsvr) = sum( (
      loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve a
      ctivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,r
      svr,n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,sto) = sum( (l
      oop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve ac
      tivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,st
      o,n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,'sets') = sum(
       (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve
       activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim
      ,'sets',n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,'sets aux') = 
      sum( (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('res
      erve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_non
      prim,'sets aux',n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,hst) = sum( (l
      oop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve ac
      tivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,hs
      t,n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,hp) = sum( (lo
      op_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve act
      ivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,hp,
      n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,hel) = sum( (l
      oop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserve ac
      tivation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,he
      l,n) ) ;
       
      %DSM%$ontext
      excel_reserves('provision shares nonprim',reserves_nonprim,dsm_curt) = sum
      ( (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reserv
      e provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim
      ,dsm_curt,n) ) ;
      excel_reserves('provision shares nonprim',reserves_nonprim,dsm_shift) = su
      m( (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reser
      ve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonpri
      m,dsm_shift,n) ) ;
       
      excel_reserves('activation shares nonprim',reserves_nonprim,dsm_curt) = su
      m( (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('reser
      ve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonpr
      im,dsm_curt,n) ) ;
      excel_reserves('activation shares nonprim',reserves_nonprim,dsm_shift) = s
      um( (loop_res_share,loop_ev,loop_prosumage,n) , report_reserves_tech('rese
      rve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_nonp
      rim,dsm_shift,n) ) ;
      $ontext
3976   
      execute_unload "results_to_excel", excel_cost excel_capacities excel_res_c
      urt excel_prices excel_dispatch excel_reserves
      %heat%$ontext
      excel_cost_building_heat excel_cost_building_heat_other excel_cost_buildin
      g excel_heat
      $ontext
3983  ;
3984   
3985  execute 'gdxxrw.exe results_to_excel.gdx par=excel_cost rng=a2 rdim=1' ;
3986  execute 'gdxxrw.exe results_to_excel.gdx par=excel_cost_building_heat rng=
      a12 rdim=1' ;
3987  execute 'gdxxrw.exe results_to_excel.gdx par=excel_cost_building_heat_othe
      r rng=a26 rdim=1' ;
3988  execute 'gdxxrw.exe results_to_excel.gdx par=excel_cost_building rng=a34 r
      dim=1' ;
3989  execute 'gdxxrw.exe results_to_excel.gdx par=excel_heat rng=a40 rdim=1' ;
3990  execute 'gdxxrw.exe results_to_excel.gdx par=excel_capacities rng=a52' ;
3991  execute 'gdxxrw.exe results_to_excel.gdx par=excel_res_curt rng=a56 rdim=1
      ' ;
3992  execute 'gdxxrw.exe results_to_excel.gdx par=excel_prices rng=a60 cdim=1' 
      ;
      execute 'gdxxrw.exe results_to_excel.gdx par=excel_reserves rng=a64' ;
      $ontext
3997  execute 'gdxxrw.exe results_to_excel.gdx par=excel_dispatch rng=a82' ;
4000   
4001   
4002   
4003  * ------------------------------------------------------------------------
      ---- *
4004  * ------------------------------------------------------------------------
      ---- *
4005  * ------------------------------------------------------------------------
      ---- *
GAMS 24.2.1  r43572 Released Dec  9, 2013 WEX-WEI x86_64/MS Windows 10/22/18 14:44:43 Page 2
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Include File Summary


   SEQ   GLOBAL TYPE      PARENT   LOCAL  FILENAME

     1        1 INPUT          0       0  C:\Users\cguenther\Documents\GitHub\pr
                                          osumage\Code\Prosumage_Opt\Dieter_Modu
                                          le\Modified_MCP\DIETER.gms
     2      153 INCLUDE        1     153  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\dataload.gms
     3      558 GDXIN          2     405  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\Data_input.gdx
     4      610 GDXIN          2     457  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\time_series.gdx
     5     1083 INCLUDE        1     296  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\model.gms
     6     1868 INCLUDE        1     475  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\fix.gms
     7     2184 INCLUDE        1     476  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\scenario.gms
     8     2378 INCLUDE        1     548  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\report.gms
     9     3801 INCLUDE        1     560  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Modified_MCP\report_to_excel.gms


COMPILATION TIME     =        0.125 SECONDS     25 MB  24.2.1 r43572 WEX-WEI
GAMS 24.2.1  r43572 Released Dec  9, 2013 WEX-WEI x86_64/MS Windows 10/22/18 14:44:43 Page 3
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Model Statistics    SOLVE DIETER Using LP From line 2374


MODEL STATISTICS

BLOCKS OF EQUATIONS          18     SINGLE EQUATIONS      271,592
BLOCKS OF VARIABLES          13     SINGLE VARIABLES      332,896  5 projected
NON ZERO ELEMENTS     1,275,118     NON LINEAR N-Z         96,361
DERIVATIVE POOL              10     CONSTANT POOL              16
CODE LENGTH             140,165


GENERATION TIME      =       65.474 SECONDS    227 MB  24.2.1 r43572 WEX-WEI


EXECUTION TIME       =       66.550 SECONDS    227 MB  24.2.1 r43572 WEX-WEI
GAMS 24.2.1  r43572 Released Dec  9, 2013 WEX-WEI x86_64/MS Windows 10/22/18 14:44:43 Page 4
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Solution Report     SOLVE DIETER Using LP From line 2374


               S O L V E      S U M M A R Y

     MODEL   DIETER              OBJECTIVE  Z
     TYPE    LP                  DIRECTION  MINIMIZE
     SOLVER  CPLEX               FROM LINE  2374

**** SOLVER STATUS     1 Normal Completion         
**** MODEL STATUS      14 No Solution Returned     
**** OBJECTIVE VALUE                0.0000

 RESOURCE USAGE, LIMIT        631.913  10000000.000
 ITERATION COUNT, LIMIT         0    2000000000

GUSS             24.2.1 r43572 Released Dec  9, 2013 WEI x86_64/MS Windows    
Reading parameter(s) from scenario dictionary
>>  Logoption 2
>>  Optfile 1
>>  Skipbasecase 1
--- Scenario Variable with potential updates identified: phi_min_res

IBM ILOG CPLEX   24.2.1 r43572 Released Dec  9, 2013 WEI x86_64/MS Windows    
--- GAMS/Cplex licensed for continuous and discrete problems.
Cplex 12.6.0.0

Reading parameter(s) from "C:\Users\cguenther\Documents\GitHub\prosumage\Code\Pr
                               osumage_Opt\Dieter_Module\Modified_MCP\cplex.opt"
>>  lpmethod 4
>>  threads 4
>>  epgap 1e-3
Finished reading from "C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosum
                                   age_Opt\Dieter_Module\Modified_MCP\cplex.opt"
Warning: Cplex threads 4 > #cores 2
Space for names approximately 19.50 Mb
Use option 'names no' to turn use of names off
LP status(1): optimal
Cplex Time: 631.20sec (det. 18393.80 ticks)
Optimal solution found.
Objective : 33544534956.180664

--- Scenario scen1:     Records read:    1
--- Solution statistics for scenario scen1
---   Solver Status    1 Normal Completion         
---   Model Status     1 Optimal                   
---   Objective Value  33544534956.1807
---   Resource Usage   631960
---   Total Time (ms)  632116

No solution returned
GAMS 24.2.1  r43572 Released Dec  9, 2013 WEX-WEI x86_64/MS Windows 10/22/18 14:44:43 Page 5
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
E x e c u t i o n


EXECUTION TIME       =       12.230 SECONDS    146 MB  24.2.1 r43572 WEX-WEI


USER: Abteilung Energie, Verkehr, Umwelt, 5 User     S131220:0515AN-GEN
      Deutsches Institut fuer Wirtschaftsforschung DIW           DC3975
      License for teaching and research at degree granting institutions


**** FILE SUMMARY

Input      C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\DIETER.gms
Output     C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Modified_MCP\DIETER.lst
