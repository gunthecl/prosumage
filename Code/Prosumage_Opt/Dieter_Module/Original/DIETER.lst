GAMS 24.2.3  r46072 Released May 22, 2014 WEX-WEI x86_64/MS Windows 12/01/18 12:34:17 Page 1
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


   1   
   2  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2018.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
  12  **************************************************************************
      ******
  13   
  14   
  15   
  16   
  17  **************************
  18  ***** GLOBAL OPTIONS *****
  19  **************************
  20   
  21  * Set star to skip Excel upload and load data from gdx
  23   
  24  * Choose base year
  26   
  27  * Germany only - also adjust Excel inputs!
  29   
  30  * Set star to activate options
  32   
  35   
  37   
  38  **** Activate modifications to replicate MCP results**********************
      ****
  39  * Prosumage link restrictions prohibits prosumage storage interaction with
       market
  41  * Deacivated storage flow constraints 4h,4i,4j,4k
  43  * Set parameter phi_sto_ini to zero (instead of 0.5)
  45  * Deactivate load change costs
  47   
  48  **************************************************************************
      ****
  49   
  51   
  54  * Set star to indicate renewables constraint on electric vehicles - DEFAUL
      T is same quota as for the rest of the electricity system
  58   
  59  * Set star to select run-of-river options either as exogenous parameter or
       as endogenous variable including reserve provision:
  60  * if nothing is selected, ROR capacity will be set to zero
  61  * if parameter option is selected, set appropriate values in fix.gmx
  62  * if variable option is selected, set appropriate bound in data_input exce
      l
  65   
  66  * Set star to determine loops, otherwise default 100% renewables
  68   
  69  * Set star for no crossover to speed up calculation time by skipping cross
      over in LP solver
  71   
  72  * Set star for reporting to Excel
  74   
  75   
  76  **************************************************************************
      ******
  77   
  78  * Definition of strings for report parameters and sanity checks
  79  * (Do not change settings below)
  81   
  83   
  84  * Sanity checks
  86   
  88   
  90   
  94   
  98   
  99   
 100   
 101   
 102  **************************************************************************
      ******
 103   
 104  ****************************
 105  ***** INITIALIZE LOOPS *****
 106  ****************************
 107   
 108  sets
 109  *$ontext
 110  loop_res_share   Solution loop for different shares of renewables       /5
      0,80/
 113   
      loop_ev          Solution loop for different fleets of EVs              /4
      e+6/
      $ontext
 118   
 119  *$ontext
 120  loop_prosumage   Solution loop for different prosumer self-consumption lev
      els    /50/
 123   
 124  *      loop_res_share                          /50/
 125                               loop_ev                                 /0/
 126  *                      loop_prosumage                          /0/
 127  ;
 128   
 129   
 130   
 131   
 132  **************************************************************************
      ******
 133   
 134  **************************
 135  ***** SOLVER OPTIONS *****
 136  **************************
 137   
 138  options
 139  optcr = 0.00
 140  reslim = 10000000
 141  lp = cplex
 142  mip = cplex
 143  nlp = conopt
 144  limrow = 0
 145  limcol = 0
 146  ;
 147   
 148  options
 149  dispwidth = 15
 150  limrow = 0
 151  limcol = 0
 152  solprint = off
 153  sysout = off
 154  ;
 155   
 156   
 157   
 158   
 159  **************************************************************************
      ******
 160   
 161  **************************
 162  ***** Dataload *****
 163  **************************
 164   
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\dataload.gms
 166   
 167  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
 177  **************************************************************************
      ******
 178   
 179   
 180   
 181   
 182  ***************  SETS  ***************************************************
      ******
 183   
 184  ***** Sets used in the model *****
 185  Sets
 186  tech                     Generation technologies
 187   dis(tech)               Dispatchable generation technologies
 188   nondis(tech)            Nondispatchable generation technologies
 189   con(tech)               Conventional generation technologies
 190   res(tech)               Renewable generation technologies
 191  sto                      Storage technologies
 192  rsvr                     Reservoir technologies
 193  dsm                      DSM technologies
 194   dsm_shift(dsm)          DSM load shifting technologies
 195   dsm_curt(dsm)           DSM load curtailment technologies
 196  year                     Base year for temporal data
 197  h                        Hours
 198  n                        Nodes
 199  l                        Lines
 200  ev                       EV types
 201  reserves                         Reserve qualities
 202   reserves_up(reserves)           Positive reserves
 203   reserves_do(reserves)           Negative reserves
 204   reserves_spin(reserves)         Spinning reserves
 205   reserves_nonspin(reserves)      Nonspinning reserves
 206   reserves_prim(reserves)         Primary reserves
 207   reserves_nonprim(reserves)      Nonprimary reserves
 208   reserves_prim_up(reserves)      Primary positive reserves
 209   reserves_nonprim_up(reserves)   Nonprimary positive reserves
 210   reserves_prim_do(reserves)      Primary negative reserves
 211   reserves_nonprim_do(reserves)   Nonprimary negative reserves
 212  bu                       Building archtypes
 213  ch                       Heating combination type
 214   hst(ch)                 Heating technology that feeds to storage
 215   hp(ch)                  Heat pump technologies
 216   hel(ch)                 Hybrid electric heating technologies - electric p
      art
 217   hfo(ch)                 Hybrid electric heating technologies - fossil par
      t
 218   
 219   
 220  ***** Sets used for data upload *****
 221  headers_tech                     Generation technologies - upload headers
 222   tech_dispatch                   Generation technologies - dispatchable or
       nondispatchable
 223   tech_res_con                    Generation technologies - renewable or "c
      onventional"
 224  headers_sto                      Storage technologies - upload headers
 225  headers_reservoir                Reservoir technologies - upload headers
 226  headers_dsm                      DSM technologies - upload headers
 227   dsm_type                        DSM technologies - shifting or curtailmen
      t
 228  headers_time                     Temporal data - upload headers
 229  headers_topology                 Spatial data - upload headers
 230  headers_ev                       EV data - upload headers
 231  headers_time_ev                  EV temporal data - upload headers
 232  headers_prosumage_generation     Prosumage generation data - upload header
      s
 233  headers_prosumage_storage        Prosumage storage data - upload headers
 234  headers_reserves                 Reserve data - upload headers
 235   reserves_up_down                Reserve data - positive and neagtive rese
      rves
 236   reserves_spin_nonspin           Reserve data - spinning and nonspinning r
      eserves
 237   reserves_prim_nonprim           Reserve data - primary and nonprimary res
      erves
 238  headers_heat                     Heat data - upload headers
 239   heat_storage                    Heat data - storage technologies
 240   heat_hp                         Heat data - heat pump technologies
 241   heat_elec                       Heat data - hybrid heating technologies -
       electric part
 242   heat_fossil                     Heat data - hybrid heating technologies -
       fossil part
 243  headers_time_heat                Heat data - upload headers time data
 244  headers_time_dhw                 Heat data - upload headers time data on D
      HW
 245  ;
 246   
 247   
 248   
 249   
 250  ***************  PARAMETERS  *********************************************
      ******
 251   
 252  Parameters
 253   
 254  ***** Generation technologies *****
 255  *--- Variable and fixed costs ---*
 256  eta              Efficiency of conventional technologies [0 1]
 257  carbon_content   CO2 emissions per fuel unit used [tons per MWh thermal]
 258  c_up             Load change costs UP [EUR per MWh]
 259  c_do             Load change costs DOWN [EUR per MWh]
 260  c_fix            Annual fixed costs [EUR per MW per year]
 261  c_vom            Variable O&M costs [EUR per MWh]
 262  CO2price         CO2 price in [EUR per ton]
 263   
 264  *--- Investment ---*
 265  c_inv_overnight  Investment costs: Overnight [EUR per MW]
 266  lifetime         Investment costs: technical lifetime [a]
 267  recovery         Investment costs: Recovery period according to depreciati
      on tables [a]
 268  interest_rate    Investment costs: Interest rate [%]
 269  m_p              Investment: maximum installable capacity per technology [
      MW]
 270  m_e              Investment: maximum installable energy [TWh per a]
 271   
 272  *--- Flexibility ---*
 273  grad_per_min     Maximum load change relative to installed capacity [% of 
      installed capacity per minute]
 274   
 275   
 276  ***** Fuel and CO2 costs *****
 277  fuelprice        Fuel price conventionals [EUR per MWh thermal]
 278   
 279   
 280  ***** Renewables *****
 281  c_cu             Hourly Curtailment costs for renewables [Euro per MW]
 282  phi_min_res      Minimum renewables share [0 1]
 283   
 284   
 285  ***** Storage *****
 286  *--- Variable and fixed costs ---*
 287  c_m_sto          Marginal costs of storing in or out [EUR per MWh]
 288  eta_sto          Storage efficiency [0 1]
 289  phi_sto_ini      Initial storage level [0 1]
 290  etop_max         Maximum E to P ratio of storage types [#]
 291  c_fix_sto        Annual fixed costs [EUR per MW]
 292   
 293  *--- Investment ---*
 294  c_inv_overnight_sto_e       Investment costs for storage energy: Overnight
       [EUR per MWh]
 295  c_inv_overnight_sto_p       Investment costs for storage capacity: Overnig
      ht [EUR per MW]
 296  m_sto_e                     Investment into storage: maximum installable e
      nergy [MWh]
 297  m_sto_p                     Investment into storage: maximum installable p
      ower [MW]
 298   
 299   
 300  ***** Reservoir*****
 301  *--- Variable and fixed costs ---*
 302  c_m_rsvr                 Marginal costs of generating energy from reservoi
      r [EUR per MWh]
 303  eta_rsvr                 Generation efficiency [0 1]
 304  phi_rsvr_ini             Initial reservoir level [0 1]
 305  c_fix_rsvr               Annual fixed costs [EUR per MW per a]
 306  phi_rsvr_min             Minimum hourly reservoir outflow as fraction of a
      nnual energy [0 1]
 307  phi_rsvr_lev_min         Minimum filling level [0 1]
 308   
 309  *--- Investment ---*
 310  c_inv_overnight_rsvr_e   Investment costs for reservoir energy: Overnight 
      [EUR per MWh]
 311  c_inv_overnight_rsvr_p   Investment costs for reservoir capacity: Overnigh
      t [EUR per MW]
 312  inv_lifetime_rsvr        Investment costs for reservoir: technical lifetim
      e [a]
 313  inv_interest_rsvr        Investment costs for reservoir: Interest rate [%]
 314  m_rsvr_e                 Investment into reservoir: maximum installable en
      ergy [MWh]
 315  m_rsvr_p                 Investment into reservoir: maximum installable ca
      pacity [MW]
 316   
 317   
 318  ***** DSM *****
 319  *--- Variable and fixed costs ---*
 320  c_m_dsm_cu       DSM: hourly costs of load curtailment [EUR per MWh]
 321  c_m_dsm_shift    DSM: costs for load shifting [EUR per MWh]
 322  c_fix_dsm_cu     Annual fixed costs load curtailment capacity [EUR per MW 
      per a]
 323  c_fix_dsm_shift  Annual fixed costs load shifting capacity [EUR per MW per
       a]
 324   
 325  *--- Flexibility, efficiency, recovery ---*
 326  t_dur_dsm_cu     DSM: Maximum duration load curtailment [h]
 327  t_off_dsm_cu     DSM: Minimum recovery time between two load curtailment i
      nstances [h]
 328   
 329  t_dur_dsm_shift  DSM: Maximum duration load shifting [h]
 330  t_off_dsm_shift  DSM: Minimum recovery time between two granular load upsh
      ift instances [h]
 331  eta_dsm_shift    DSM: Efficiency of load shifting technologies [0 1]
 332   
 333  *--- Investment ---*
 334  c_inv_overnight_dsm_cu           Investment costs for DSM load curtailment
      : Overnight [EUR per MW]
 335  c_inv_overnight_dsm_shift        Investment costs for DSM load shifting: O
      vernight [EUR per MW]
 336  inv_recovery_dsm_cu              Investment costs for DSM load curtailment
      : Recovery period [a]
 337  inv_recovery_dsm_shift           Investment costs for DSM load shifting: R
      ecovery period [a]
 338  inv_interest_dsm_cu              Investment costs for DSM load curtailment
      : Interest rate [%]
 339  inv_interest_dsm_shift           Investment costs for DSM load shifting: I
      nterest rate [%]
 340  m_dsm_cu                         DSM: Maximum installable capacity load cu
      rtailment [MW]
 341  m_dsm_shift                      DSM: Maximum installable capacity load sh
      ifting [MW]
 342   
 343   
 344  ***** Time Data *****
 345  d_y                      Demand hour h for different years [MWh]
 346  d                        Demand hour h [MWh]
 347  phi_res_y                Renewables availability technology res in hour h 
      for different years [0 1]
 348  phi_res                  Renewables availability technology res in hour h 
      [0 1]
 349  phi_ror_y                Run-of-river availability technology ror in hour 
      h for different years [0 1]
 350  phi_ror                  Run-of-river availability technology ror in hour 
      h [0 1]
 351  rsvr_in_y                Reservoir inflow in hour h for different years [0
       1]
 352  rsvr_in                  Reservoir inflow in hour h [0 1]
 353  n_ev_p_upload            Power rating of the charging connection in hour h
       [MW - 0 when car is in use or parked without grid connection]
 354  ev_ed_upload             Electricity demand for mobility vehicle profile e
      v in hour h [MW]
 355  ev_ged_exog_upload       Electricity demand for mobility in case of uncont
      rolled charging vehicle profile ev in hour h [MW]
 356  phi_reserves_call_y      Hourly share of reserve provision that is actuall
      y activated for different years [0 1]
 357  phi_reserves_call        Hourly share of reserve provision that is actuall
      y activated [0 1]
 358  reserves_exogenous_y     Hourly reserve provision for different years [MW]
 359  reserves_exogenous       Hourly reserve provision [MW]
 360   
 361  ***** Transmission *****
 362  *--- Investment ---*
 363  c_inv_overnight_ntc       Investment costs in: overnight [EUR per MW]
 364  c_fix_ntc                 Fixed costs [EUR per MW per a]
 365  inv_lifetime_ntc          Investment costs: technical lifetime [a]
 366  inv_recovery_ntc          Investment costs: Recovery period in [a]
 367  inv_interest_ntc          Investment costs: Interest rate [%]
 368  m_ntc                     Investment into NTC: maximum installable capacit
      y [MW]
 369   
 370  *--- Topology and distance ---*
 371  inc              Incidence index of link l on node n
 372  dist             Distance covered by link l [km]
 373   
 374   
 375  ***** Electric vehicles *****
 376  *--- Costs and attributes ---*
 377  c_m_ev           Marginal costs of discharging V2G [EUR per MWh]
 378  pen_phevfuel     Penalty for non-electric PHEV operation mode [EUR per MWh
      ]
 379  eta_ev_in        Electric vehicle efficiency of charging (G2V) [0 1]
 380  eta_ev_out       Electric vehicle efficiency of discharging (V2G) [0 1]
 381  phi_ev_ini       Electric vehicle charging level in initial period [0 1]
 382   
 383  n_ev_e           Electric vehicle battery capacity [MWh]
 384  ev_quant         Overall number of electirc vehicles [#]
 385  phi_ev           Share of electric vehicles per load profile in actual sce
      nario [0 1]
 386  ev_phev          Defines whether an electric vehicle is a PHEV REEV [1 if 
      yes 0 otherwise]
 387   
 388  *--- Temporal data ---*
 389  n_ev_p           Electric vehicle power rating [MWh]
 390  ev_ed            Electric vehicle electricity demand [MWh]
 391  ev_ged_exog      Electric vehicle grid electricity demand for exogenous ch
      arging pattern [MWh]
 392   
 393   
 394  ***** Prosumage *****
 395  phi_pro_load             Share of prosumagers among total load [0 1]
 396  phi_pro_self             Minimum self-generation shares for prosumagers [0
       1]
 397  m_res_pro                Maximum installable: renewables capacity [MW]
 398  m_sto_pro_e              Maximum installable: storage energy [MWh]
 399  m_sto_pro_p              Maximum installable: storage capacity [MW]
 400  phi_sto_pro_ini          Prosumagers' initial storage loading [0 1]
 401   
 402   
 403  ***** Reserves *****
 404  phi_reserves_share       Shares of SRL and MRL up and down [0 1]
 405  reserves_intercept       Intercept of regression line determining reserves
       demand
 406  reserves_slope           Slope of regression line determining reserves dem
      and
 407  reserves_reaction        Activation reaction time for reserves qualities [
      min]
 408  phi_reserves_pr_up       Positive primary reserves fraction of total nonpr
      imary reserves demand [0 1]
 409  phi_reserves_pr_do       Negative primary reserves fraction of total nonpr
      imary reserves demand [0 1]
 410  *reserves_exog
 411   
 412   
 413  ***** Heat *****
 414  *--- Time data ---*
 415  dh_upload                Hourly heat demand per year for upload [MWh per m
      2]
 416  dh_y                     Hourly heat demand per year [MWh per m2]
 417  dh                       Hourly heat demand [MWh per m2]
 418  temp_source              Heat pumps - source temperature [°Celsius]
 419  d_dhw_upload             Hourly DHW demand per year for upload [MWh per m2
      ]
 420  d_dhw_y                  Hourly DHW demand per year [MWh per m2]
 421  d_dhw                    Hourly DHW demand [MWh per m2]
 422  nets_profile(h)          Hourly exogenous heat demand by nonsmart night-ti
      me storage heaters [MWh per m2]
 423   
 424  *--- Technololgy attributes ---*
 425  phi_heat_type            Share of heating type ch per building archetype b
      u [0 1]
 426  eta_heat_stat            Static efficiency for heating technologies [0 1]
 427  eta_heat_dyn             Static efficiency for heating technologies [0 1]
 428  eta_dhw_aux_stat         Static efficiency for auxiliary DHW technologies 
      [0 1]
 429  n_heat_p_in              Maximum power inflow into heating technologies [M
      W]
 430  n_heat_p_out             Maximum power outflow from heating technologies [
      MW]
 431  n_heat_e                 Maximum energy level of heating storage technolog
      ies [MWh]
 432  n_sets_p_in              SETS - Power rating - electricity intake [MW]
 433  n_sets_p_out             SETS - Power rating - heat output [MW]
 434  n_sets_e                 SETS - Energy storage capacity [MWh]
 435  n_sets_dhw_p_in          SETS auxiliary DHW module - power rating - electr
      icity intake [MW]
 436  n_sets_dhw_p_out         SETS auxiliary DHW module - power rating - DHW ou
      tput [MW]
 437  n_sets_dhw_e             SETS auxiliary DHW module - energy storage capaci
      ty [MWh]
 438  phi_heat_ini             Inititial storage level of heating technologies [
      0 1]
 439  temp_sink                Heat pumps - sink temperature [°Celsius]
 440  pen_heat_fuel            Penalty term for non-electric fuel usage for hybr
      id heating technologies [EUR per MWh]
 441  area_floor               Floor area subject to specific heating technology
       in specific building type [m2]
 442  theta_night              Indicator for night hours {0 1}
 443   
 444   
 445   
 446  ***************  DERIVED PARAMETERS  *************************************
      ******
 447   
 448  c_m              Marginal production costs for conventional plants includi
      ng variable O and M costs [EUR per MWh]
 449  c_i              Annualized investment costs by conventioanl plant [EUR pe
      r MW]
 450   
 451  c_i_res          Annualized investment costs by renewable plant [EUR per M
      W]
 452  c_fix_res        Annualized fixed costs by renewable plant [EUR per MW per
       a]
 453   
 454  c_i_sto_e        Annualized investment costs storage energy [EUR per MWh]
 455  c_i_sto_p        Annualized investment costs storage capacity [EUR per MW]
 456   
 457  c_i_rsvr_e       Annualized investment costs storage energy [EUR per MWh]
 458  c_i_rsvr_p       Annualized investment costs storage capacity [EUR per MW]
 459   
 460  c_i_dsm_cu       DSM: Annualized investment costs load curtailment [EUR pe
      r MW]
 461  c_i_dsm_shift    DSM: Annualized investment costs load shifting [EUR per M
      W]
 462   
 463  c_i_ntc          Investment for net transfer capacity [EUR per MW and km]
 464   
 465  phi_mean_reserves_call_y         Hourly mean of share reserves called per 
      year [0 1]
 466  phi_mean_reserves_call           Hourly mean of share reserves called [0 1
      ]
 467   
 468  theta_dir        Dummy equal to 1 if building type bu has direct heating t
      ype ch [0 1]
 469  theta_sets       Dummy equal to 1 if building type bu has SETS heating typ
      e ch [0 1]
 470  theta_hp         Dummy equal to 1 if building type bu has heat pump heatin
      g type ch [0 1]
 471  theta_elec       Dummy equal to 1 if building type bu has hybrif electric 
      heating - electric part [0 1]
 472  theta_fossil     Dummy equal to 1 if building type bu has hybrif electric 
      heating - fossil part [0 1]
 473  theta_storage    Dummy equal to 1 if building type ch has storage heating 
      type ch [0 1]
 474   
 475   
 476   
 477   
 478  ***************  PARAMETERS FOR DATA UPLOAD  *****************************
      ******
 479   
 480  technology_data_upload(n,tech,tech_res_con,tech_dispatch,headers_tech)
 481  technology_data(n,tech,headers_tech)
 482  storage_data(n,sto,headers_sto)
 483  reservoir_data(n,rsvr,headers_reservoir)
 484  time_data_upload(h,n,year,headers_time)
 485  dsm_data_upload(n,dsm,dsm_type,headers_dsm)
 486  dsm_data(n,dsm,headers_dsm)
 487  topology_data(l,headers_topology)
 488  ev_data(n,ev,headers_ev)
 489  ev_time_data_upload(h,headers_time_ev,ev)
 490  prosumage_data_generation(n,tech,headers_prosumage_generation)
 491  prosumage_data_storage(n,sto,headers_prosumage_storage)
 492  reserves_time_data_activation(h,year,reserves)
 493  reserves_time_data_provision(h,year,reserves)
 494  reserves_data_upload(n,reserves,reserves_up_down,reserves_spin_nonspin,res
      erves_prim_nonprim,headers_reserves)
 495  reserves_data(n,reserves,headers_reserves)
 496  heat_data_upload(n,bu,ch,heat_storage,heat_hp,heat_elec,heat_fossil,header
      s_heat)
 497  heat_data(n,bu,ch,headers_heat)
 498  dh_upload(h,n,year,headers_time_heat,bu)
 499  d_dhw_upload(h,n,year,headers_time_heat,bu)
 500  temp_source_upload
 501  ;
 502   
 503   
 504   
 505   
 506  ***************  UPLOAD TIME-CONSTANT SETS AND PARAMETERS  ***************
      ******
 507   
 567   
 568  *$call "gdxxrw data_input.xlsx @temp.tmp o=Data_input maxdupeerrors=100";
 569   
GDXIN   C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Dieter_
        Module\Original\Data_input.gdx
--- LOAD  n = 1:n
--- LOAD  tech = 2:tech
--- LOAD  headers_tech = 3:headers_tech
--- LOAD  tech_dispatch = 4:tech_dispatch
--- LOAD  tech_res_con = 5:tech_res_con
--- LOAD  sto = 6:sto
--- LOAD  headers_sto = 7:headers_sto
--- LOAD  rsvr = 8:rsvr
--- LOAD  headers_reservoir = 9:headers_reservoir
--- LOAD  reservoir_data = 33:reservoir_data
--- LOAD  dsm = 10:dsm
--- LOAD  headers_dsm = 11:headers_dsm
--- LOAD  dsm_type = 12:dsm_type
--- LOAD  technology_data_upload = 31:technology_data_upload
--- LOAD  storage_data = 32:storage_data
--- LOAD  dsm_data_upload = 34:dsm_data_upload
 574  *$load l headers_topology topology_data inc
 575  *$ontext
--- LOAD  l = 13:l
--- LOAD  headers_topology = 14:headers_topology
--- LOAD  topology_data = 35:topology_data
--- LOAD  ev = 15:ev
--- LOAD  headers_ev = 16:headers_ev
--- LOAD  ev_data = 36:ev_data
--- LOAD  headers_prosumage_generation = 17:headers_prosumage_generation
--- LOAD  headers_prosumage_storage = 18:headers_prosumage_storage
--- LOAD  prosumage_data_generation = 37:prosumage_data_generation
--- LOAD  prosumage_data_storage = 38:prosumage_data_storage
--- LOAD  reserves = 19:reserves
--- LOAD  reserves_up_down = 21:reserves_up_down
--- LOAD  reserves_spin_nonspin = 22:reserves_spin_nonspin
--- LOAD  reserves_prim_nonprim = 23:reserves_prim_nonprim
--- LOAD  headers_reserves = 20:headers_reserves
--- LOAD  reserves_data_upload = 39:reserves_data_upload
--- LOAD  bu = 24:bu
--- LOAD  ch = 25:ch
--- LOAD  heat_storage = 26:heat_storage
--- LOAD  heat_hp = 27:heat_hp
--- LOAD  heat_elec = 28:heat_elec
--- LOAD  heat_fossil = 29:heat_fossil
--- LOAD  headers_heat = 30:headers_heat
--- LOAD  heat_data_upload = 40:heat_data_upload
 583  ;
 584   
 585  *$ontext
 586  parameter inc ;
 587  inc(l,n) = 1 ;
 590   
 591   
 592  ***************  UPLOAD TIME-SERIES SETS AND PARAMETERS  *****************
      ******
 593   
 619   
 620  *$call "gdxxrw time_series.xlsx @temp2.tmp o=time_series";
 621   
GDXIN   C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Dieter_
        Module\Original\time_series.gdx
--- LOAD  h = 1:h
--- LOAD  headers_time = 2:headers_time
--- LOAD  year = 3:year
--- LOAD  time_data_upload = 4:time_data_upload
--- LOAD  headers_time_ev = 5:headers_time_ev
--- LOAD  ev_time_data_upload = 6:ev_time_data_upload
--- LOAD  reserves_time_data_activation = 7:reserves_time_data_activation
--- LOAD  reserves_time_data_provision = 8:reserves_time_data_provision
--- LOAD  headers_time_heat = 9:headers_time_heat
--- LOAD  dh_upload = 10:dh_upload
--- LOAD  theta_night = 11:theta_night
--- LOAD  temp_source_upload = 15:temp_source_upload
--- LOAD  headers_time_dhw = 12:headers_time_dhw
--- LOAD  d_dhw_upload = 13:d_dhw_upload
--- LOAD  nets_profile = 14:nets_profile
 631  ;
 632   
 633   
 634   
 635   
 636  ***************  ASSIGNMENTS  ********************************************
      ******
 637   
 638   
 639   
 640  ***** Aliases *****
 641  alias (h,hh) ;
 642  alias (res,resres) ;
 643  alias (reserves,reservesreserves) ;
 644  alias (nondis,nondisnondis) ;
 645   
 646   
 647   
 648  ***** Derived sets *****
 649  dis(tech)$sum( (n,tech_res_con,headers_tech), technology_data_upload(n,tec
      h,tech_res_con,'dis',headers_tech)) = yes;
 650  nondis(tech)$sum( (n,tech_res_con,headers_tech), technology_data_upload(n,
      tech,tech_res_con,'nondis',headers_tech)) = yes;
 651   
 652  con(tech)$sum( (n,tech_dispatch,headers_tech), technology_data_upload(n,te
      ch,'con',tech_dispatch,headers_tech)) = yes;
 653  res(tech)$sum( (n,tech_dispatch,headers_tech), technology_data_upload(n,te
      ch,'res',tech_dispatch,headers_tech)) = yes;
 654   
 655  reserves_up(reserves)$sum( (n,reserves_spin_nonspin,reserves_prim_nonprim,
      headers_reserves), reserves_data_upload(n,reserves,'up',reserves_spin_nons
      pin,reserves_prim_nonprim,headers_reserves)) = yes;
 656  reserves_do(reserves)$sum( (n,reserves_spin_nonspin,reserves_prim_nonprim,
      headers_reserves), reserves_data_upload(n,reserves,'do',reserves_spin_nons
      pin,reserves_prim_nonprim,headers_reserves)) = yes;
 657   
 658  reserves_spin(reserves)$sum( (n,reserves_up_down,reserves_prim_nonprim,hea
      ders_reserves), reserves_data_upload(n,reserves,reserves_up_down,'spin',re
      serves_prim_nonprim,headers_reserves)) = yes;
 659  reserves_nonspin(reserves)$sum( (n,reserves_up_down,reserves_prim_nonprim,
      headers_reserves), reserves_data_upload(n,reserves,reserves_up_down,'nonsp
      in',reserves_prim_nonprim,headers_reserves)) = yes;
 660   
 661  reserves_prim(reserves)$sum( (n,reserves_up_down,reserves_spin_nonspin,hea
      ders_reserves), reserves_data_upload(n,reserves,reserves_up_down,reserves_
      spin_nonspin,'prim',headers_reserves)) = yes;
 662  reserves_nonprim(reserves)$sum( (n,reserves_up_down,reserves_spin_nonspin,
      headers_reserves), reserves_data_upload(n,reserves,reserves_up_down,reserv
      es_spin_nonspin,'nonprim',headers_reserves)) = yes;
 663   
 664  reserves_prim_up(reserves)$sum( (n,reserves_spin_nonspin,headers_reserves)
      , reserves_data_upload(n,reserves,'up',reserves_spin_nonspin,'prim',header
      s_reserves)) = yes;
 665  reserves_prim_do(reserves)$sum( (n,reserves_spin_nonspin,headers_reserves)
      , reserves_data_upload(n,reserves,'do',reserves_spin_nonspin,'prim',header
      s_reserves)) = yes;
 666  reserves_nonprim_up(reserves)$sum( (n,reserves_spin_nonspin,headers_reserv
      es), reserves_data_upload(n,reserves,'up',reserves_spin_nonspin,'nonprim',
      headers_reserves)) = yes;
 667  reserves_nonprim_do(reserves)$sum( (n,reserves_spin_nonspin,headers_reserv
      es), reserves_data_upload(n,reserves,'do',reserves_spin_nonspin,'nonprim',
      headers_reserves)) = yes;
 668   
 669  hst(ch)$sum( (n,bu,heat_hp,heat_elec,heat_fossil,headers_heat), heat_data_
      upload(n,bu,ch,'yes',heat_hp,heat_elec,heat_fossil,headers_heat)) = yes;
 670  hp(ch)$sum( (n,bu,heat_storage,heat_elec,heat_fossil,headers_heat), heat_d
      ata_upload(n,bu,ch,heat_storage,'yes',heat_elec,heat_fossil,headers_heat))
       = yes;
 671   
 672  hel(ch)$sum( (n,bu,heat_storage,heat_hp,heat_fossil,headers_heat), heat_da
      ta_upload(n,bu,ch,heat_storage,heat_hp,'yes',heat_fossil,headers_heat)) = 
      yes;
 673  hfo(ch)$sum( (n,bu,heat_storage,heat_hp,heat_elec,headers_heat), heat_data
      _upload(n,bu,ch,heat_storage,heat_hp,heat_elec,'yes',headers_heat)) = yes;
 674   
 675   
 676   
 677   
 678  ***** Parameters *****
 679   
 680  *--- Generation technologies ---*
 681  technology_data(n,tech,headers_tech) = sum((tech_res_con,tech_dispatch), t
      echnology_data_upload(n,tech,tech_res_con,tech_dispatch,headers_tech)) ;
 682  eta(n,tech) = technology_data(n,tech,'eta_con') ;
 683  carbon_content(n,tech) = technology_data(n,tech,'carbon_content') ;
 684  c_up(n,dis) =technology_data(n,dis,'load change costs up') ;
 685  c_do(n,dis) = technology_data(n,dis,'load change costs down') ;
 686  c_fix(n,tech) = technology_data(n,tech,'fixed_costs') ;
 687  c_vom(n,tech) = technology_data(n,tech,'variable_om') ;
 688  CO2price(n,tech) = technology_data(n,tech,'CO2_price') ;
 689   
 690  c_inv_overnight(n,tech) = technology_data(n,tech,'oc') ;
 691  lifetime(n,tech) = technology_data(n,tech,'lifetime') ;
 692  recovery(n,tech) = technology_data(n,tech,'recovery_period') ;
 693  interest_rate(n,tech) = technology_data(n,tech,'interest_rate') ;
 694  m_p(n,tech) = technology_data(n,tech,'max_installable') ;
 695  m_e(n,tech) = technology_data(n,tech,'max_energy') ;
 696  grad_per_min(n,dis) = technology_data(n,dis,'load change flexibility') ;
 697  fuelprice(n,tech) = technology_data(n,tech,'fuel costs') ;
 698   
 699  c_cu(n,res) = technology_data(n,res,'curtailment_costs') ;
 700   
 701   
 702  *--- Storage technologies ---*
 703  c_m_sto(n,sto) = storage_data(n,sto,'mc');
 704  eta_sto(n,sto) = storage_data(n,sto,'efficiency');
 705  c_fix_sto(n,sto) = storage_data(n,sto,'fixed_costs');
 706  phi_sto_ini(n,sto) = storage_data(n,sto,'level_start');
 707  etop_max(n,sto) = storage_data(n,sto,'etop_max') ;
 708   
 709  c_inv_overnight_sto_e(n,sto) = storage_data(n,sto,'oc_energy');
 710  c_inv_overnight_sto_p(n,sto) = storage_data(n,sto,'oc_capacity');
 711  lifetime(n,sto) = storage_data(n,sto,'lifetime');
 712  interest_rate(n,sto) = storage_data(n,sto,'interest_rate');
 713  m_sto_e(n,sto) = storage_data(n,sto,'max_energy');
 714  m_sto_p(n,sto) = storage_data(n,sto,'max_power');
 715   
 716   
 717  *--- Reservoir technologies ---*
 718  c_m_rsvr(n,rsvr) = reservoir_data(n,rsvr,'mc');
 719  eta_rsvr(n,rsvr) = reservoir_data(n,rsvr,'efficiency');
 720  c_fix_rsvr(n,rsvr) = reservoir_data(n,rsvr,'fixed_costs');
 721  phi_rsvr_ini(n,rsvr) = reservoir_data(n,rsvr,'level_start');
 722  phi_rsvr_lev_min(n,rsvr) = reservoir_data(n,rsvr,'level_min');
 723   
 724  c_inv_overnight_rsvr_e(n,rsvr) = reservoir_data(n,rsvr,'oc_energy');
 725  c_inv_overnight_rsvr_p(n,rsvr) = reservoir_data(n,rsvr,'oc_capacity');
 726  inv_lifetime_rsvr(n,rsvr) = reservoir_data(n,rsvr,'lifetime');
 727  inv_interest_rsvr(n,rsvr) = reservoir_data(n,rsvr,'interest_rate');
 728  m_rsvr_e(n,rsvr) = reservoir_data(n,rsvr,'max_energy');
 729  m_rsvr_p(n,rsvr) = reservoir_data(n,rsvr,'max_power');
 730   
 731   
 732  *--- DSM technologies ---*
 733  dsm_curt(dsm)$sum( (n,dsm_type,headers_dsm), dsm_data_upload(n,dsm,'curt',
      headers_dsm)) = yes;
 734  dsm_shift(dsm)$sum( (n,dsm_type,headers_dsm), dsm_data_upload(n,dsm,'shift
      ',headers_dsm)) = yes;
 735  dsm_data(n,dsm,headers_dsm) = sum(dsm_type, dsm_data_upload(n,dsm,dsm_type
      ,headers_dsm) ) ;
 736   
 737  c_m_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'mc')     ;
 738  c_m_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'mc')  ;
 739  c_fix_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'fc')  ;
 740  c_fix_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'fc') ;
 741   
 742  t_dur_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'max_duration')   ;
 743  t_off_dsm_cu(n,dsm_curt) = dsm_data(n,dsm_curt,'recovery_time')   ;
 744  t_dur_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'max_duration')   ;
 745  t_off_dsm_shift(n,dsm_shift) = dsm_data(n,dsm_shift,'recovery_time')   ;
 746  eta_dsm_shift(n,dsm_shift)  = dsm_data(n,dsm_shift,'efficiency')   ;
 747   
 748  c_inv_overnight_dsm_cu(n,dsm_curt) =  dsm_data(n,dsm_curt,'oc')   ;
 749  c_inv_overnight_dsm_shift(n,dsm_shift)  =  dsm_data(n,dsm_shift,'oc')   ;
 750  inv_recovery_dsm_cu(n,dsm_curt)  =  dsm_data(n,dsm_curt,'lifetime')   ;
 751  inv_recovery_dsm_shift(n,dsm_shift)   =  dsm_data(n,dsm_shift,'lifetime') 
        ;
 752  inv_interest_dsm_cu(n,dsm_curt)   =  dsm_data(n,dsm_curt,'interest_rate') 
        ;
 753  inv_interest_dsm_shift(n,dsm_shift)  =  dsm_data(n,dsm_shift,'interest_rat
      e')   ;
 754  m_dsm_cu(n,dsm_curt) =  dsm_data(n,dsm_curt,'max_installable')   ;
 755  m_dsm_shift(n,dsm_shift) =  dsm_data(n,dsm_shift,'max_installable')   ;
 756   
 757   
 758  *--- Temporal data ---*
 759  d_y(n,year,h) = time_data_upload(h,n,year,'demand')  ;
 760  phi_res_y(n,year,res,h) = sum(headers_time$(sameas(res,headers_time)), tim
      e_data_upload(h,n,year,headers_time));
 761  rsvr_in_y(n,year,rsvr,h) = sum(headers_time$(sameas(rsvr,headers_time)), t
      ime_data_upload(h,n,year,headers_time));
 762  phi_reserves_call_y(n,year,reserves,h) = reserves_time_data_activation(h,y
      ear,reserves) ;
 763  reserves_exogenous_y(n,year,reserves,h) = reserves_time_data_provision(h,y
      ear,reserves) ;
 764   
 765   
 766  *--- Spatial data ---*
 767  inv_lifetime_ntc(l) = topology_data(l,'lifetime') ;
 768  inv_recovery_ntc(l) = topology_data(l,'recovery_period') ;
 769  inv_interest_ntc(l) = topology_data(l,'interest_rate') ;
 770  c_inv_overnight_ntc(l) = topology_data(l,'overnight_costs') ;
 771  c_fix_ntc(l) = topology_data(l,'fixed_costs') ;
 772  m_ntc(l) = topology_data(l,'max_installable') ;
 773  dist(l) = topology_data(l,'distance') ;
 774   
 775   
 776  *--- Electric vehicles ---*
 777  c_m_ev(n,ev) = ev_data(n,ev,'mc') ;
 778  pen_phevfuel(n,ev) = ev_data(n,ev,'penalty_fuel') ;
 779  eta_ev_in(n,ev) = ev_data(n,ev,'efficiency_charge') ;
 780  eta_ev_out(n,ev) = ev_data(n,ev,'efficiency_discharge') ;
 781  phi_ev_ini(n,ev) = ev_data(n,ev,'ev_start') ;
 782   
 783  n_ev_e(n,ev) = ev_data(n,ev,'ev_capacity') ;
 784  phi_ev(n,ev) = ev_data(n,ev,'share_ev') ;
 785  ev_phev(n,ev) = ev_data(n,ev,'ev_type') ;
 786   
 787  n_ev_p(n,ev,h) = ev_time_data_upload(h,'n_ev_p',ev) ;
 788  ev_ed(n,ev,h) = ev_time_data_upload(h,'ev_ed',ev) ;
 789  ev_ged_exog(n,ev,h) = ev_time_data_upload(h,'ev_ged_exog',ev) ;
 790   
 791   
 792  *--- Prosumage ---*
 793  m_res_pro(n,res) = prosumage_data_generation(n,res,'max_power') ;
 794  m_sto_pro_e(n,sto) = prosumage_data_storage(n,sto,'max_energy') ;
 795  m_sto_pro_p(n,sto) = prosumage_data_storage(n,sto,'max_power') ;
 796  phi_sto_pro_ini(n,sto) = prosumage_data_storage(n,sto,'level_start') ;
 797   
 798   
 799  *--- Reserves ---*
 800  reserves_data(n,reserves,headers_reserves) = sum((reserves_up_down,reserve
      s_spin_nonspin,reserves_prim_nonprim), reserves_data_upload(n,reserves,res
      erves_up_down,reserves_spin_nonspin,reserves_prim_nonprim,headers_reserves
      )) ;
 801  phi_reserves_share(n,reserves) = reserves_data(n,reserves,'share_sr_mr') ;
 802  reserves_intercept(n,reserves) = reserves_data(n,reserves,'intercept') ;
 803  reserves_slope(n,reserves,'wind_on') = reserves_data(n,reserves,'slope_win
      d_on') ;
 804  reserves_slope(n,reserves,'wind_off') = reserves_data(n,reserves,'slope_wi
      nd_off') ;
 805  reserves_slope(n,reserves,'pv') = reserves_data(n,reserves,'slope_pv') ;
 806  reserves_reaction(n,reserves) = reserves_data(n,reserves,'reaction_time') 
      ;
 807  phi_reserves_pr_up(n) = reserves_data(n,'PR_up','fraction_pr') ;
 808  phi_reserves_pr_do(n) = reserves_data(n,'PR_do','fraction_pr') ;
 809   
 810   
 811  *--- Heat ---*
 812  heat_data(n,bu,ch,headers_heat) = sum((heat_storage,heat_hp,heat_elec,heat
      _fossil), heat_data_upload(n,bu,ch,heat_storage,heat_hp,heat_elec,heat_fos
      sil,headers_heat)) ;
 813  phi_heat_type(n,bu,ch) = heat_data(n,bu,ch,'share') ;
 814  dh_y(n,year,bu,ch,h) = phi_heat_type(n,bu,ch) * dh_upload(h,n,year,'demand
      ',bu) ;
 815  d_dhw_y(n,year,bu,ch,h) = phi_heat_type(n,bu,ch) * d_dhw_upload(h,n,year,'
      demand',bu) ;
 816   
 817  eta_heat_stat(n,bu,ch) = heat_data(n,bu,ch,'static_efficiency') ;
 818  eta_heat_dyn(n,bu,ch) = heat_data(n,bu,ch,'dynamic_efficiency') ;
 819  eta_dhw_aux_stat(n,bu,ch) = heat_data(n,bu,ch,'static_efficiency_sets_aux_
      dhw') ;
 820  * currently not used
 821  n_heat_p_in(n,bu,ch) = heat_data(n,bu,ch,'max_power') ;
 822  n_heat_p_out(n,bu,ch) = heat_data(n,bu,ch,'max_outflow') ;
 823  n_heat_e(n,bu,ch) = heat_data(n,bu,ch,'max_level') ;
 824  n_sets_p_in(n,bu,ch) = heat_data(n,bu,ch,'max_power') ;
 825  n_sets_p_out(n,bu,ch) = heat_data(n,bu,ch,'max_outflow') ;
 826  n_sets_e(n,bu,ch) = heat_data(n,bu,ch,'max_level') ;
 827  n_sets_dhw_p_in(n,bu,ch) = heat_data(n,bu,ch,'max_power_in_sets_aux_dhw') 
      ;
 828  n_sets_dhw_p_out(n,bu,ch) = heat_data(n,bu,ch,'max_power_out_sets_aux_dhw'
      ) ;
 829  n_sets_dhw_e(n,bu,ch) = heat_data(n,bu,ch,'max_energy_sets_aux_dhw') ;
 830  phi_heat_ini(n,bu,ch) = heat_data(n,bu,ch,'level_ini') ;
 831  temp_sink(n,bu,ch) = heat_data(n,bu,ch,'temperature_sink') ;
 832   
 833  temp_source(n,bu,'hp_as',h) = temp_source_upload(h,n,'hp_as') ;
 834  temp_source(n,bu,'hp_gs',h) = heat_data(n,bu,'hp_gs','temperature_source')
       ;
 835   
 836  temp_source(n,bu,'gas_hp_gs',h) = heat_data(n,bu,'gas_hp_gs','temperature_
      source') ;
 837  temp_source(n,bu,'hp_gs_elec',h) = heat_data(n,bu,'hp_gs_elec','temperatur
      e_source') ;
 838   
 839  pen_heat_fuel(n,bu,ch) = heat_data(n,bu,ch,'penalty_non-electric_heat_supp
      ly') ;
 840   
 841  area_floor(n,bu,ch) = heat_data(n,bu,ch,'area_floor') ;
 842   
 843   
 844   
 845  ***************  CALCULATE DERIVED PARAMETERS  ***************************
      ******
 846   
 847  c_m(n,tech) = fuelprice(n,tech)/eta(n,tech) + carbon_content(n,tech)/eta(n
      ,tech)*CO2price(n,tech) + c_vom(n,tech)   ;
 848   
 849  c_i(n,tech) = c_inv_overnight(n,tech)*( interest_rate(n,tech) * (1+interes
      t_rate(n,tech))**(lifetime(n,tech)) )
 850                    / ( (1+interest_rate(n,tech))**(lifetime(n,tech))-1 )   
          ;
 851   
 852  c_i_res(n,res) = c_i(n,res) ;
 853  c_fix_res(n,res) = c_fix(n,res) ;
 854   
 855  c_i_sto_e(n,sto) = c_inv_overnight_sto_e(n,sto)*( interest_rate(n,sto) * (
      1+interest_rate(n,sto))**(lifetime(n,sto)) )
 856                   / ( (1+interest_rate(n,sto))**(lifetime(n,sto))-1 )      
       ;
 857   
 858  c_i_sto_p(n,sto) = c_inv_overnight_sto_p(n,sto)*( interest_rate(n,sto) * (
      1+interest_rate(n,sto))**(lifetime(n,sto)) )
 859                   / ( (1+interest_rate(n,sto))**(lifetime(n,sto))-1 )      
       ;
 860   
 861  c_i_rsvr_e(n,rsvr) = c_inv_overnight_rsvr_e(n,rsvr)*( inv_interest_rsvr(n,
      rsvr) * (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,rsvr)) )
 862                   / ( (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,r
      svr))-1 )       ;
 863   
 864  c_i_rsvr_p(n,rsvr) = c_inv_overnight_rsvr_p(n,rsvr)*( inv_interest_rsvr(n,
      rsvr) * (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,rsvr)) )
 865                   / ( (1+inv_interest_rsvr(n,rsvr))**(inv_lifetime_rsvr(n,r
      svr))-1 )       ;
 866   
 867  c_i_dsm_cu(n,dsm_curt) =c_inv_overnight_dsm_cu(n,dsm_curt)*( inv_interest_
      dsm_cu(n,dsm_curt) * (1+inv_interest_dsm_cu(n,dsm_curt))**(inv_recovery_ds
      m_cu(n,dsm_curt)) )
 868                   / ( (1+inv_interest_dsm_cu(n,dsm_curt))**(inv_recovery_ds
      m_cu(n,dsm_curt))-1 )       ;
 869   
 870  c_i_dsm_shift(n,dsm_shift) = c_inv_overnight_dsm_shift(n,dsm_shift)*( inv_
      interest_dsm_shift(n,dsm_shift) * (1+inv_interest_dsm_shift(n,dsm_shift))*
      *(inv_recovery_dsm_shift(n,dsm_shift)) )
 871                   / ( (1+inv_interest_dsm_shift(n,dsm_shift))**(inv_recover
      y_dsm_shift(n,dsm_shift))-1 )       ;
 872   
 873  c_i_ntc(l) = c_inv_overnight_ntc(l) * (inv_interest_ntc(l) * (1 + inv_inte
      rest_ntc(l))**(inv_lifetime_ntc(l)) )
 874                   / ((1 + inv_interest_ntc(l)) ** (inv_lifetime_ntc(l))-1 )
       ;
 875   
 876  phi_mean_reserves_call_y(n,year,reserves) = sum(h, phi_reserves_call_y(n,y
      ear,reserves,h) ) / card(h) + eps ;
 877   
 878   
 879  theta_sets(n,bu,'setsh')$(smax( (heat_storage,heat_hp,heat_elec,heat_fossi
      l,headers_heat) , heat_data_upload(n,bu,'setsh',heat_storage,heat_hp,heat_
      elec,heat_fossil,headers_heat)) > 0 AND phi_heat_type(n,bu,'setsh')) = 1;
 880  theta_dir(n,bu,'dir')$(smax((heat_storage,heat_hp,heat_elec,heat_fossil,he
      aders_heat) , heat_data_upload(n,bu,'dir',heat_storage,heat_hp,heat_elec,h
      eat_fossil,headers_heat)) > 0 AND phi_heat_type(n,bu,'dir')) = 1;
 881   
 882  theta_storage(n,bu,ch)$(sum((heat_hp,heat_elec,heat_fossil,headers_heat), 
      heat_data_upload(n,bu,ch,'yes',heat_hp,heat_elec,heat_fossil,headers_heat)
      ) AND phi_heat_type(n,bu,ch)) = 1;
 883  theta_hp(n,bu,ch)$sum( (heat_storage,heat_elec,heat_fossil,headers_heat), 
      heat_data_upload(n,bu,ch,heat_storage,'yes',heat_elec,heat_fossil,headers_
      heat) AND phi_heat_type(n,bu,ch)) = 1;
 884   
 885  theta_elec(n,bu,ch)$sum( (heat_storage,heat_hp,heat_fossil,headers_heat), 
      heat_data_upload(n,bu,ch,heat_storage,heat_hp,'yes',heat_fossil,headers_he
      at) AND phi_heat_type(n,bu,ch)) = 1;
 886  theta_fossil(n,bu,ch)$sum( (heat_storage,heat_hp,heat_elec,headers_heat), 
      heat_data_upload(n,bu,ch,heat_storage,heat_hp,heat_elec,'yes',headers_heat
      ) AND phi_heat_type(n,bu,ch)) = 1;
 887   
 888   
 889   
 890  ***************  Adjust costs to model's hourly basis ********************
      ******
 891   
 892  c_i(n,tech) = c_i(n,tech)*card(h)/8760 ;
 893  c_i_res(n,tech) = c_i_res(n,tech)*card(h)/8760 ;
 894  c_i_sto_p(n,sto) = c_i_sto_p(n,sto)*card(h)/8760 ;
 895  c_i_sto_e(n,sto) = c_i_sto_e(n,sto)*card(h)/8760 ;
 896  c_i_rsvr_e(n,rsvr) = c_i_rsvr_e(n,rsvr)*card(h)/8760 ;
 897  c_i_rsvr_p(n,rsvr) = c_i_rsvr_p(n,rsvr)*card(h)/8760 ;
 898  c_i_dsm_cu(n,dsm_curt) = c_i_dsm_cu(n,dsm_curt)*card(h)/8760 ;
 899  c_i_dsm_shift(n,dsm_shift) = c_i_dsm_shift(n,dsm_shift)*card(h)/8760 ;
 900   
 901  c_fix(n,tech) = c_fix(n,tech)*card(h)/8760 ;
 902  c_fix_sto(n,sto) = c_fix_sto(n,sto)*card(h)/8760 ;
 903  c_fix_dsm_cu(n,dsm_curt) = c_fix_dsm_cu(n,dsm_curt)*card(h)/8760 ;
 904  c_fix_dsm_shift(n,dsm_shift) = c_fix_dsm_shift(n,dsm_shift)*card(h)/8760 ;
 905  c_fix_rsvr(n,rsvr) = c_fix_rsvr(n,rsvr)*card(h)/8760 ;
 906   
 907  m_e(n,'bio') = m_e(n,'bio')*card(h)/8760 ;
 908   
 909  c_i_ntc(l) = c_i_ntc(l) * card(h)/8760 ;
 910   
 911  *t_dur_dsm_cu(n,dsm_curt) = t_dur_dsm_cu(n,dsm_curt) ;
 912  *t_off_dsm_cu(n,dsm_curt) = t_off_dsm_cu(n,dsm_curt) ;
 913  *t_dur_dsm_shift(n,dsm_shift)$(ord(dsm_shift)=2 or ord(dsm_shift)=4 or ord
      (dsm_shift)=5) = t_dur_dsm_shift(n,dsm_shift) / 2 ;
 914  *t_dur_dsm_shift(n,dsm_shift)$(ord(dsm_shift)=1 or ord(dsm_shift)=3) = 2 ;
 915   
 916   
 917   
 918  ***************  Check for parameter sanity ******************************
      ******
 919   
 920  Parameter
 921  check_heat
 922  check_heat_agg ;
 923  check_heat(n,bu) = sum( ch , phi_heat_type(n,bu,ch)) ;
 924  check_heat_agg = smax( (n,bu) , check_heat(n,bu) ) ;
 925  *abort$(check_heat_agg > 1) "DATA: heating technologies for a building typ
      e do not add up to 100 percent" ;
 926   
 927   
 928   
 929   
 930  ***************  Infeasibility *******************************************
      ******
 931   
 932  Positive variable
 933  G_INFES(n,h)
 934  ;
 935   
 936  Parameter
 937  c_infes  /100000/
 938  ;
 939   
 940   
 941   
 942   
 943   
 944   
 945   
 946   
 947   
 948   
 949   
 950   
 951   
 952   
 953   
 954   
 955   
 956   
 957  **************************************************************************
      ******
 958   
 959  *************************************
 960  ***** Features for single nodes *****
 961  *************************************
 962   
 963  Set
 964  features /dsm, ev, reserves, prosumage, rsvr_outflow, heat/
 965  ;
 966   
 967   
 968  Table
 969  feat_node(features,n)
 970                   DE
      dsm              1
      $ontext
      reserves         1
      $ontext
      ev               1
      $ontext
 983  *$ontext
 984  prosumage        1
 987  rsvr_outflow     0
      heat             1
      $ontext
 992  ;
 993   
 994   
      m_dsm_cu(n,dsm_curt)$(feat_node('dsm',n) = 0) = 0 ;
      m_dsm_shift(n,dsm_shift)$(feat_node('dsm',n) = 0) = 0 ;
      $ontext
1000   
1001  *$ontext
1002  m_res_pro(n,res)$(feat_node('prosumage',n) = 0) = 0 ;
1003  m_sto_pro_e(n,sto)$(feat_node('prosumage',n) = 0) = 0 ;
1004  m_sto_pro_p(n,sto)$(feat_node('prosumage',n) = 0) = 0 ;
1007   
1008  phi_rsvr_min(n) = 0
1009  *feat_node('rsvr_outflow',n)
1010  ;
1011   
      dh(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      d_dhw(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      $ontext
1017   
1018   
1019  Set
1020  map_n_tech(n,tech)
1021  map_n_sto(n,sto)
1022  map_n_rsvr(n,rsvr)
1023  map_n_dsm(n,dsm)
1024  map_n_ev(n,ev)
1025  map_l(l)
1026  map_n_sto_pro(n,sto)
1027  map_n_res_pro(n,tech)
1028  ;
1029   
1030  map_n_tech(n,tech) = yes$m_p(n,tech) ;
1031  map_n_sto(n,sto) = yes$m_sto_p(n,sto) ;
1032  map_n_rsvr(n,rsvr) = yes$m_rsvr_p(n,rsvr) ;
1033  map_n_dsm(n,dsm_curt) = yes$m_dsm_cu(n,dsm_curt) ;
1034  map_n_dsm(n,dsm_shift) = yes$m_dsm_shift(n,dsm_shift) ;
1035  map_n_ev(n,ev) = yes$ev_data(n,ev,'share_ev') ;
1036  map_l(l) = yes$m_ntc(l) ;
1037  map_n_sto_pro(n,sto) = yes$(yes$m_sto_pro_p(n,sto)) ;
1038  map_n_res_pro(n,res) = yes$(yes$m_res_pro(n,res)) ;
1039  ;
1040   
1041   
1042   
1043   
1044  **************************************************************************
      ******
1045   
1046  ***************************
1047  ***** Initialize data *****
1048  ***************************
1049   
1050  * Parameters for default base year
1051  d(n,h) = d_y(n,'2030',h) ;
1052  phi_res(n,res,h) = phi_res_y(n,'2030',res,h) ;
1053  rsvr_in(n,rsvr,h) = rsvr_in_y(n,'2030',rsvr,h) ;
1054  phi_reserves_call(n,reserves,h) = phi_reserves_call_y(n,'2030',reserves,h)
       ;
1055  phi_mean_reserves_call(n,reserves) = phi_mean_reserves_call_y(n,'2030',res
      erves) ;
1056  reserves_exogenous(n,reserves,h) = reserves_exogenous_y(n,'2030',reserves,
      h) ;
1057  dh(n,bu,ch,h) = dh_y(n,'2030',bu,ch,h) ;
1058  d_dhw(n,bu,ch,h) = d_dhw_y(n,'2030',bu,ch,h) ;
1059   
1060  dh(n,bu,ch,h) = area_floor(n,bu,ch) * dh(n,bu,ch,h) ;
1061  d_dhw(n,bu,ch,h) = area_floor(n,bu,ch) * d_dhw(n,bu,ch,h) ;
1062   
1063   
1064  * No interconnections between non-adjacent or nonuploaded nodes
1065  m_ntc(l)$( smax(n,inc(l,n)) = 0 OR smin(n,inc(l,n)) = 0 ) = 0 ;
1066   
1067   
1068  * Set loop parameters to default zero
1069  phi_min_res = 0 ;
1070  ev_quant = 0 ;
1071  phi_pro_self = 0 ;
1072  phi_pro_load(n) = 0 ;
1073  phi_pro_load(n)$feat_node('prosumage',n) = 0.2 ;
1074   
1075   
1076  Parameter
1077  phi_min_res_exog(n)
1078  min_flh(n,rsvr)
1079  ;
1080   
1081  phi_min_res_exog(n) = 1 ;
1082  min_flh(n,rsvr) = 0 ;
1083   
1084  *min_flh('FR',rsvr) = 1000 * card(h)/8760 ;
1085  *min_flh('AT',rsvr) = 1000 * card(h)/8760 ;
1086  *min_flh('CH',rsvr) = 1000 * card(h)/8760 ;
1087   
1088   
1089   
1090   
1091  **************************************************************************
      ******
1092  ***** Model *****
1093  **************************************************************************
      ******
1094   
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\model.gms
1096   
1097  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
1107  **************************************************************************
      ******
1108   
1109   
1110  Variables
1111  Z                Value objective function [Euro]
1112  F(l,h)           Energy flow over link l in hour h [MWh]
1113  ;
1114   
1115  Positive Variables
1116  G_L(n,tech,h)            Generation level in hour h [MWh]
1117  G_UP(n,tech,h)           Generation upshift in hour h [MWh]
1118  G_DO(n,tech,h)           Generation downshift in hour h [MWh]
1119   
1120  G_RES(n,tech,h)          Generation renewables type res in hour h [MWh]
1121  CU(n,tech,h)             Renewables curtailment technology res in hour h [
      MWh]
1122   
1123  STO_IN(n,sto,h)          Storage inflow technology sto hour h [MWh]
1124  STO_OUT(n,sto,h)         Storage outflow technology sto hour h [MWh]
1125  STO_L(n,sto,h)           Storage level technology sto hour h [MWh]
1126   
1127  EV_CHARGE(n,ev,h)        Electric vehicle charging vehicle profile ev hour
       h [MWh]
1128  EV_DISCHARGE(n,ev,h)     Electric vehicle discharging vehicle profile ev h
      our h [MWh]
1129  EV_L(n,ev,h)             Electric vehicle charging level vehicle profile e
      v hour h [MWh]
1130  EV_PHEVFUEL(n,ev,h)      Plug in hybrid electric vehicle conventional fuel
       use vehicle profile ev hour h [MWh]
1131  EV_GED(n,ev,h)           Grid electricity demand for mobility vehicle prof
      ile ev hour h [MWh]
1132   
1133  N_TECH(n,tech)           Technology tech built [MW]
1134  N_STO_E(n,sto)           Storage technology built - Energy [MWh]
1135  N_STO_P(n,sto)           Storage loading and discharging capacity built - 
      Capacity [MW]
1136   
1137  DSM_CU(n,dsm,h)          DSM: Load curtailment hour h [MWh]
1138  DSM_UP(n,dsm,h)          DSM: Load shifting up hour h technology dsm [MWh]
1139  DSM_DO(n,dsm,h,hh)       DSM: Load shifting down in hour hh to account for
       upshifts in hour h technology dsm [MWh]
1140   
1141  DSM_UP_DEMAND(n,dsm,h)   DSM: Load shifting up active for wholesale demand
       in hour h of technology dsm [MWh]
1142  DSM_DO_DEMAND(n,dsm,h)   DSM: Load shifting down active for wholesale dema
      nd in hour h of technology dsm [MWh]
1143   
1144  N_DSM_CU(n,dsm)          DSM: Load curtailment capacity [MW]
1145  N_DSM_SHIFT(n,dsm)       DSM: Load shifting capacity [MWh]
1146   
1147  RP_DIS(n,reserves,tech,h)        Reserve provision by conventionals in hou
      r h [MW]
1148  RP_NONDIS(n,reserves,tech,h)     Reserve provision by renewables in hour h
       [MW]
1149  RP_STO_IN(n,reserves,sto,h)      Reserve provision by storage in in hour h
       [MW]
1150  RP_STO_OUT(n,reserves,sto,h)     Reserve provision by storage out in hour 
      h [MW]
1151  RP_EV_V2G(n,reserves,ev,h)       Reserve provision by electric vehicles V2
      G hour h [MW]
1152  RP_EV_G2V(n,reserves,ev,h)       Reserve provision by electric vehicles G2
      V hour h [MW]
1153  RP_DSM_CU(n,reserves,dsm,h)      Reserve provision by DSM load curtailment
       in hour h [MW]
1154  RP_DSM_SHIFT(n,reserves,dsm,h)   Reserve provision by DSM load shifting in
       hour h [MW]
1155  RP_RSVR(n,reserves,rsvr,h)       Reserve provision by reservoirs h [MW]
1156  RP_SETS(n,reserves,bu,ch,h)      Reserve provision by SETS [MW]
1157  RP_SETS_AUX(n,reserves,bu,ch,h)  Reserve provision by SETS auxiliary DHW m
      odules [MW]
1158  RP_HP(n,reserves,bu,ch,h)        Reserve provision by heat pumps [MW]
1159  RP_H_ELEC(n,reserves,bu,ch,h)    Reserve provision by hybrid electric heat
      ers [MW]
1160   
1161  CU_PRO(n,tech,h)                 Prosumage: curtailment of renewable gener
      ation in hour h [MWh]
1162  G_MARKET_PRO2M(n,tech,h)         Prosumage. energy sent to market in hour 
      h [MWh]
1163  G_MARKET_M2PRO(n,h)              Prosumage: withdrawal of energy from mark
      et in hour h [MWh]
1164  G_RES_PRO(n,tech,h)              Prosumage: hourly renewables generation i
      n hour h [MWh]
1165  STO_IN_PRO2PRO(n,tech,sto,h)     Prosumage: storage loading from generatio
      n for discharging to consumption in hour h [MWh]
1166  STO_IN_PRO2M(n,tech,sto,h)       Prosumage: storage loading from generatio
      n for discharging to market in hour h [MWh]
1167  STO_IN_M2PRO(n,sto,h)            Prosumage: storage loading from market fo
      r discharging to consumption in hour h [MWh]
1168  STO_IN_M2M(n,sto,h)              Prosumage: storage loading from market fo
      r discharging to market in hour h [MWh]
1169  STO_OUT_PRO2PRO(n,sto,h)         Prosumage: storage discharging to consump
      tion from generation in hour h [MWh]
1170  STO_OUT_PRO2M(n,sto,h)           Prosumage: storage discharging to market 
      from generation in hour h [MWh]
1171  STO_OUT_M2PRO(n,sto,h)           Prosumage: storage discharging to consump
      tion from market in hour h [MWh]
1172  STO_OUT_M2M(n,sto,h)             Prosumage: storage discharging to market 
      from market in hour h [MWh]
1173  STO_L_PRO2PRO(n,sto,h)           Prosumage: storage level generation to co
      nsumption in hour h [MWh]
1174  STO_L_PRO2M(n,sto,h)             Prosumage: storage level generation to ma
      rket in hour h [MWh]
1175  STO_L_M2PRO(n,sto,h)             Prosumage: storage level market to consum
      otion in hour h [MWh]
1176  STO_L_M2M(n,sto,h)               Prosumage: storage level market to market
       in hour h [MWh]
1177  N_STO_E_PRO(n,sto)               Prosumage: installed storage energy [MWh]
1178  N_STO_P_PRO(n,sto)               Prosumage: installed storage power [MW]
1179  STO_L_PRO(n,sto,h)               Prosumage: overall storage level in hour 
      h [MWh]
1180  N_RES_PRO(n,tech)                Prosumage: installed renewables capacitie
      s [MW]
1181   
1182  NTC(l)                           Trade: installed NTC on line l [MW]
1183   
1184  RSVR_OUT(n,rsvr,h)               Reservoirs: outflow in hour h [MWh]
1185  RSVR_L(n,rsvr,h)                 Reservoirs: level in hour h [MWh]
1186  N_RSVR_E(n,rsvr)                 Reservoirs: installed energy capacity [MW
      h]
1187  N_RSVR_P(n,rsvr)                 Reservoirs: installed power capacity [MW]
1188   
1189  H_DIR(n,bu,ch,h)                 Heating: direct heating in hour h for bui
      lding type bu with haeting technology ch [MWh]
1190  H_SETS_LEV(n,bu,ch,h)            Heating: storage level SETS technologies 
      [MWh]
1191  H_SETS_IN(n,bu,ch,h)             Heating: storage inflow SETS technologies
       [MWh]
1192  H_SETS_OUT(n,bu,ch,h)            Heating: storage outflow SETS technologie
      s [MWh]
1193  H_HP_IN(n,bu,ch,hh)              Heating: electricity demand heat pump tec
      hnologies [MWh]
1194  H_STO_LEV(n,bu,ch,h)             Heating: storage level storage technologi
      es [MWh]
1195  H_STO_IN_HP(n,bu,ch,h)           Heating: storage inflow from heat pumps t
      o storage technologies [MWh]
1196  H_STO_IN_ELECTRIC(n,bu,ch,h)     Heating: storage inflow from electric hea
      ting to storage technologies [MWh]
1197  H_ELECTRIC_IN(n,bu,ch,h)         Heating: hybrid electric heaters electric
      ity demand [MWh]
1198  H_STO_IN_FOSSIL(n,bu,ch,h)       Heating: storage inflow from nonelectric 
      heating to storage technologies [MWh]
1199  H_STO_OUT(n,bu,ch,h)             Heating: storage outflow from storage tec
      hnologies [MWh]
1200   
1201  H_DHW_DIR(n,bu,ch,h)             Heating - domestic hot water: provision i
      n case of direct electric heating [MWh]
1202  H_DHW_STO_OUT(n,bu,ch,h)         Heating - domestic hot water: DHW storage
       outflow [MWh]
1203   
1204  H_DHW_AUX_ELEC_IN(n,bu,ch,h)     Heating - domestic hot water: electrical 
      energy input of auxiliary hot water tank for SETS [MWh]
1205  H_DHW_AUX_LEV(n,bu,ch,h)         Heating - domestic hot water: level of au
      xiliary hot water tank for SETS [MWh]
1206  H_DHW_AUX_OUT(n,bu,ch,h)         Heating - domestic hot water: auxiliary D
      HW provision for SETS [MWh]
1207  ;
1208   
1209   
1210   
1211   
1212  **************************************************************************
      ******
1213   
1214  Equations
1215  * Objective
1216  obj                      Objective cost minimization
1217   
1218  * Energy balance
1219  con1a_bal                Energy Balance
1220   
1221  * Load change costs
1222  con2a_loadlevel          Load change costs: Level
1223  con2b_loadlevelstart     Load change costs: Level for first period
1224   
1225  * Capacity contraints and flexibility constraints
1226  con3a_maxprod_dispatchable       Capacity Constraint conventionals
1227  con3b_minprod_dispatchable       Minimum production conventionals if reser
      ves contracted
1228  con3c_flex_reserves_spin         Flexibility of conventionals for reserves
       provision
1229  con3d_flex_reserves_nonspin      Flexibility of conventionals for reserves
       provision
1230  con3e_maxprod_res                Capacity constraints renewables
1231  con3f_minprod_res                Minimum production RES if reserves contra
      cted
1232   
1233  * Storage constraints
1234  con4a_stolev_start        Storage Level Dynamics Initial Condition
1235  con4b_stolev              Storage Level Dynamics
1236  con4c_stolev_max          Storage Power Capacity
1237  con4d_maxin_sto           Storage maximum inflow
1238  con4e_maxout_sto          Storage maximum outflow
1239  con4f_resrv_sto           Constraint on reserves (up)
1240  con4g_resrv_sto           Constraint on reserves (down)
1241  con4h_maxout_lev          Maximum storage outflow - no more than level of 
      last period
1242  con4i_maxin_lev           Maximum storage inflow - no more than ebergy cap
      acity minus level of last period
1243  con4j_ending              End level equal to initial level
1244  con4k_PHS_EtoP            Maximum E to P ratio for PHS
1245   
1246  * Minimum restrictions for renewables and biomass
1247  con5a_minRES             Minimum yearly renewables requirement
1248  con5b_max_energy         Maximum yearly biomass energy
1249   
1250  * DSM conditions: Load curtailment
1251  con6a_DSMcurt_duration_max       Maximum curtailment energy budget per tim
      e
1252  con6b_DSMcurt_max                Maximum curtailment per period
1253   
1254  * DSM conditions: Load shifting
1255  con7a_DSMshift_upanddown         Equalization of upshifts and downshifts i
      n due time
1256  con7b_DSMshift_granular_max      Maximum shifting in either direction per 
      period
1257  con7c_DSM_distrib_up             Distribution of upshifts between wholesal
      e and reserves
1258  con7d_DSM_distrib_do             Distribution of downshifts between wholes
      ale and reserves
1259  con7e_DSMshift_recovery          Recovery times
1260   
1261  * Maximum installation conditions
1262  con8a_max_I_power                Maximum installable capacity: Conventiona
      ls
1263  con8b_max_I_sto_e                Maximum installable energy: Storage in MW
      h
1264  con8c_max_I_sto_p                Maximum installable capacity: Storage inf
      low-outflow in MW
1265  con8d_max_I_dsm_cu               Maximum installable capacity: DSM load cu
      rtailment
1266  con8e_max_I_dsm_shift_pos        Maximum installable capacity: DSM load sh
      ifting
1267  con8f_max_pro_res                Maximum installable capacity: prosumage r
      enewables
1268  con8g_max_pro_sto_e              Maximum installable capacity: prosumage s
      torage energy
1269  con8h_max_sto_pro_p              Maximum installable capacity: prosumage s
      torage power
1270  con8i_max_I_ntc                  Maximum installable NTC
1271  con8j_max_I_rsvr_e               Maximum installable energy reservoirs
1272  con8k_max_I_rsvr_p               Maximum installable power reservoirs
1273   
1274  * Reserves
1275  con9a_reserve_prov_endogenous    Reserve provision SR and MR (endogenous r
      eserve provision)
1276  con9a_reserve_prov_exogenous     Reserve provision SR and MR (exogenous re
      serve provision)
1277  con9b_reserve_prov_PR_endogenous Reserve provision PR (endogenous reserve 
      provision)
1278  con9b_reserve_prov_PR_exogenous  Reserve provision PR (exogenous reserve p
      rovision)
1279   
1280  * Electric vehicles
1281  con10a_ev_ed                     Energy balance of electric vehicles
1282  con10b_ev_chargelev_start        Cumulative charging level in the first ho
      ur
1283  con10c_ev_chargelev              Cumulative charging level in hour h
1284  con10d_ev_chargelev_max          Cumulative maximal charging level
1285  con10e_ev_maxin                  Cumulative maximal charging power
1286  con10f_ev_maxout                 Cumulative maximal discharging power
1287  con10g_ev_chargelev_ending       Cumulative charging level in the last hou
      r
1288  con10h_ev_minin                  Cumulative minimal charging power
1289  con10i_ev_maxin_lev              Cumulative maximal charging limit
1290  con10j_ev_minout                 Cumulative minimal discharging power
1291  con10k_ev_maxout_lev             Cumulative maximal discharging limit
1292  con10l_ev_exog                   Exogenous EV charging
1293   
1294  * Prosumage
1295  con11a_pro_distrib                       Prosumage: distribution of genera
      ted energy
1296  con11b_pro_balance                       Prosumage: energy balance
1297  con11c_pro_selfcon                       Prosumage: minimum self-generatio
      n requirement
1298  con11d_pro_stolev_PRO2PRO                Prosumage: storage level prosumag
      er-to-prosumagers
1299  con11e_pro_stolev_PRO2M                  Prosumage: storage level prosumag
      ers-to-market
1300  con11f_pro_stolev_M2PRO                  Prosumage: storage level market-t
      o-prosumagers
1301  con11g_pro_stolev_M2M                    Prosumage: storage level market-t
      o-market
1302  con11h_1_pro_stolev_start_PRO2PRO        Prosumage: storage level initial 
      conditions
1303  con11h_2_pro_stolev_start_PRO2M          Prosumage: storage level initial 
      conditions
1304  con11h_3_pro_stolev_start_M2PRO          Prosumage: storage level initial 
      conditions
1305  con11h_4_pro_stolev_start_M2M            Prosumage: storage level initial 
      conditions
1306  con11i_pro_stolev                        Prosumage: storage level total
1307  con11j_pro_stolev_max                    Prosumage: maximum overall storag
      e level
1308  con11k_pro_maxin_sto                     Prosumage: maximum storage inflow
1309  con11l_pro_maxout_sto                    Prosumage: maximum storage outflo
      w
1310  con11m_pro_maxout_lev                    Prosumage: maximum storage outflo
      w linked to level
1311  con11n_pro_maxin_lev                     Prosumage: maximum storage inflow
       linked to level
1312  con11o_pro_ending                        Prosumage: storage ending conditi
      on
1313   
1314  * Cross-nodal trade
1315  con12a_max_f                     Maximum energy flow limited to positive N
      TC
1316  con12b_min_f                     Minimum energy flow limited to negative N
      TC
1317   
1318  * Resevoirs
1319  con13a_rsvrlev_start             Reservoir level law of motion initial con
      dition
1320  con13b_rsvrlev                   Reservoir level law of motion
1321  con13c_rsvrlev_max               Maximum reservoir energy level
1322  con13d_maxout_rsvr               Maximum hourly reservoir outflow in relat
      ion to installed power capacity
1323  con13e_resrv_rsvr                Minimum hourly reservoir outflow in relat
      ion to provided negativr reserves
1324  con13f_maxout_lev                Maximum hourly reservoir outflow in relat
      ion tom installed energy capacity
1325  con13g_ending                    Reservoir level law of motion ending cond
      ition
1326  con13h_smooth                    Smooth reservoir outflow
1327  con13i_min_level                 Reservoir minimum level
1328  con13j_min_FLH
1329   
1330  * Residential heat
1331  con14a_heat_balance              Space heating energy balance
1332  con14b_dhw_balance               Domestic hot water energy balance
1333  con14c_sets_level                SETS - level law of motion
1334  con14d_sets_level_start          SETS - storage level initial condition
1335  con14e_sets_maxin                SETS - maximum energy inflow
1336  con14f_sets_maxout               SETS - maximum energy outflow
1337  con14g_sets_minin                SETS - minimum energy inflow if reserves 
      contracted
1338  con14h_sets_maxlev               SETS - maximum storage level
1339  con14i_sets_aux_dhw_level        SETS auxiliary DHW module - storage level
       law of motion
1340  con14j_sets_aux_dhw_level_start  SETS auxiliary DHW module - storage level
       initial consition
1341  con14k_sets_aux_dhw_maxin        SETS auxiliary DHW module - maximum energ
      y inflow
1342  con14l_sets_aux_dhw_minin        SETS auxiliary DHW module - minimum energ
      y inflow if reserves contracted
1343  con14m_sets_aux_dhw_maxlev       SETS auxiliary DHW module - maximum stora
      ge level
1344  con14n_hp_in                     Heat pumps - electricity demand
1345  con14o_hp_maxin                  Heat pumps - maximum electricity demand
1346  con14p_hp_minin                  Heat pumps - minimum electricity demand i
      f reserves contracted
1347  con14q_storage_elec_in           Hybrid electric heating - electricity dem
      and
1348  con14r_storage_elec_maxin        Hybrid electric heating - maximum electri
      city demand
1349  con14s_storage_elec_minin        Hybrid electric heating - minimum electri
      city demand if reserves contracted
1350  con14t_storage_level             Storage heating - level law of motion
1351  con14u_storage_level_start       Hybrid electric heating - storage level i
      nitial condition
1352  con14v_storage_maxlev            Hybrid electric heating - maximum storage
       level
1353  ;
1354   
1355   
1356   
1357   
1358  **************************************************************************
      ******
1359   
1360  * ------------------------------------------------------------------------
      ---- *
1361  ***** Objective function *****
1362  * ------------------------------------------------------------------------
      ---- *
1363   
1364  obj..
1365           Z =E=
1366                     sum( (h,map_n_tech(n,dis)) , c_m(n,dis)*G_L(n,dis,h) )
1367                   + sum( (h,map_n_tech(n,dis))$(ord(h)>1) , c_up(n,dis)*G_U
      P(n,dis,h) )
1368                   + sum( (h,map_n_tech(n,dis)) , c_do(n,dis)*G_DO(n,dis,h) 
      )
1369                   + sum( (h,map_n_tech(n,nondis)) , c_cu(n,nondis)*CU(n,non
      dis,h) )
1370                   + sum( (h,map_n_sto(n,sto)) , c_m_sto(n,sto) * ( STO_OUT(
      n,sto,h) + STO_IN(n,sto,h) ) )
                       + sum( (h,map_n_dsm(n,dsm_curt)) , c_m_dsm_cu(n,dsm_curt)
      *DSM_CU(n,dsm_curt,h) )
                       + sum( (h,map_n_dsm(n,dsm_shift)) , c_m_dsm_shift(n,dsm_s
      hift) * DSM_UP_DEMAND(n,dsm_shift,h) )
                       + sum( (h,map_n_dsm(n,dsm_shift)) , c_m_dsm_shift(n,dsm_s
      hift) * DSM_DO_DEMAND(n,dsm_shift,h) )
      $ontext
                       + sum( (h,map_n_ev(n,ev)) , c_m_ev(n,ev) * EV_DISCHARGE(n
      ,ev,h) )
                       + sum( (h,map_n_ev(n,ev)) , pen_phevfuel(n,ev) * EV_PHEVF
      UEL(n,ev,h) )
      $ontext
1382                   + sum( map_n_tech(n,tech) , c_i(n,tech)*N_TECH(n,tech) )
1383                   + sum( map_n_tech(n,tech) , c_fix(n,tech)*N_TECH(n,tech) 
      )
1384                   + sum( map_n_sto(n,sto) , c_i_sto_e(n,sto)*N_STO_E(n,sto)
       )
1385                   + sum( map_n_sto(n,sto) , c_fix_sto(n,sto)/2*(N_STO_P(n,s
      to)+N_STO_E(n,sto)) )
1386                   + sum( map_n_sto(n,sto) , c_i_sto_p(n,sto)*N_STO_P(n,sto)
       )
                       + sum( map_n_dsm(n,dsm_curt) , c_i_dsm_cu(n,dsm_curt)*N_D
      SM_CU(n,dsm_curt) )
                       + sum( map_n_dsm(n,dsm_curt) , c_fix_dsm_cu(n,dsm_curt)*N
      _DSM_CU(n,dsm_curt) )
                       + sum( map_n_dsm(n,dsm_shift) , c_i_dsm_shift(n,dsm_shift
      )*N_DSM_SHIFT(n,dsm_shift) )
                       + sum( map_n_dsm(n,dsm_shift) , c_fix_dsm_shift(n,dsm_shi
      ft)*N_DSM_SHIFT(n,dsm_shift) )
      $ontext
                       + sum( (h,map_n_sto(n,sto),reserves_up) , phi_reserves_ca
      ll(n,reserves_up,h) * c_m_sto(n,sto) * (RP_STO_OUT(n,reserves_up,sto,h) - 
      RP_STO_IN(n,reserves_up,sto,h)) )
                       - sum( (h,map_n_sto(n,sto),reserves_do) , phi_reserves_ca
      ll(n,reserves_do,h) * c_m_sto(n,sto) * (RP_STO_OUT(n,reserves_do,sto,h) - 
      RP_STO_IN(n,reserves_do,sto,h)) )
                       + sum( (h,map_n_rsvr(n,rsvr),reserves_up) , RP_RSVR(n,res
      erves_up,rsvr,h) * phi_reserves_call(n,reserves_up,h) * c_m_rsvr(n,rsvr) )
                       - sum( (h,map_n_rsvr(n,rsvr),reserves_do) , RP_RSVR(n,res
      erves_do,rsvr,h) * phi_reserves_call(n,reserves_do,h) * c_m_rsvr(n,rsvr) )
      $ontext
      %EV%$ontext
      %EV_EXOG%        + sum( (h,map_n_ev(n,ev),reserves_up) , RP_EV_V2G(n,reser
      ves_up,ev,h) * phi_reserves_call(n,reserves_up,h) * c_m_ev(n,ev) )
      %EV_EXOG%        - sum( (h,map_n_ev(n,ev),reserves_do) , RP_EV_V2G(n,reser
      ves_do,ev,h) * phi_reserves_call(n,reserves_do,h) * c_m_ev(n,ev) )
      $ontext
      %reserves%$ontext
                       + sum( (h,map_n_dsm(n,dsm_curt),reserves_up) , RP_DSM_CU(
      n,reserves_up,dsm_curt,h) * phi_reserves_call(n,reserves_up,h) * c_m_dsm_c
      u(n,dsm_curt) )
                       + sum( (h,map_n_dsm(n,dsm_shift),reserves) , RP_DSM_SHIFT
      (n,reserves,dsm_shift,h) * phi_reserves_call(n,reserves,h) * c_m_dsm_shift
      (n,dsm_shift) )
      $ontext
1413  *$ontext
1414                   + sum( map_n_res_pro(n,res) , c_i(n,res)*N_RES_PRO(n,res)
       )
1415                   + sum( map_n_res_pro(n,res) , c_fix(n,res)*N_RES_PRO(n,re
      s) )
1416   
1417                   + sum( map_n_sto_pro(n,sto) , c_i_sto_e(n,sto)*N_STO_E_PR
      O(n,sto) )
1418                   + sum( map_n_sto_pro(n,sto) , c_fix_sto(n,sto)/2*(N_STO_P
      _PRO(n,sto) + N_STO_E_PRO(n,sto)) )
1419                   + sum( map_n_sto_pro(n,sto) , c_i_sto_p(n,sto)*N_STO_P_PR
      O(n,sto) )
1420   
1421                   + sum( (h,map_n_sto_pro(n,sto)) , c_m_sto(n,sto) * ( STO_
      OUT_PRO2PRO(n,sto,h) + STO_OUT_M2PRO(n,sto,h) + STO_OUT_PRO2M(n,sto,h) + S
      TO_OUT_M2M(n,sto,h) + sum( res , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN_PRO2
      M(n,res,sto,h)) + STO_OUT_PRO2M(n,sto,h) + STO_OUT_M2M(n,sto,h) ) )
1424                   + sum( map_l(l) , c_i_ntc(l) * NTC(l)*dist(l) )
1425   
1426                   + sum( (h,map_n_rsvr(n,rsvr)), c_m_rsvr(n,rsvr) * RSVR_OU
      T(n,rsvr,h) )
1427                   + sum( map_n_rsvr(n,rsvr) , c_i_rsvr_e(n,rsvr) * N_RSVR_E
      (n,rsvr) )
1428                   + sum( map_n_rsvr(n,rsvr) , c_i_rsvr_p(n,rsvr) * N_RSVR_P
      (n,rsvr) )
1429                   + sum( map_n_rsvr(n,rsvr) , c_fix_rsvr(n,rsvr) * N_RSVR_P
      (n,rsvr) )
                       + sum( (h,n,bu,hfo) , pen_heat_fuel(n,bu,hfo) * H_STO_IN_
      FOSSIL(n,bu,hfo,h))
      $ontext
1434                   + sum( (h,n) , c_infes * G_INFES(n,h) )
1435  ;
1436   
1437  * ------------------------------------------------------------------------
      ---- *
1438  ***** Energy balance and load levels *****
1439  * ------------------------------------------------------------------------
      ---- *
1440   
1441  * Energy balance
1442  con1a_bal(n,hh)..
1443           ( 1 - phi_pro_load(n) ) * d(n,hh) + sum( map_n_sto(n,sto) , STO_I
      N(n,sto,hh) )
               + sum( map_n_dsm(n,dsm_shift) , DSM_UP_DEMAND(n,dsm_shift,hh) )
      $ontext
               + sum( map_n_ev(n,ev) , EV_CHARGE(n,ev,hh) )
      $ontext
1452  *$ontext
1453           + G_MARKET_M2PRO(n,hh)
1454           + sum( map_n_sto_pro(n,sto) , STO_IN_M2PRO(n,sto,hh))
1455           + sum( map_n_sto_pro(n,sto) , STO_IN_M2M(n,sto,hh))
              + sum( (bu,ch) , theta_dir(n,bu,ch) * (H_DIR(n,bu,ch,hh) + H_DHW_D
      IR(n,bu,ch,hh)) )
              + sum( (bu,ch) , theta_sets(n,bu,ch) * (H_SETS_IN(n,bu,ch,hh) + H_
      DHW_AUX_ELEC_IN(n,bu,ch,hh)) )
              + sum( (bu,hp) , theta_hp(n,bu,hp) * H_HP_IN(n,bu,hp,hh) )
              + sum( (bu,hel) , theta_elec(n,bu,hel) * H_ELECTRIC_IN(n,bu,hel,hh
      ) )
      $ontext
1465           =E=
1466           sum( map_n_tech(n,dis) , G_L(n,dis,hh)) + sum( map_n_tech(n,nondi
      s) , G_RES(n,nondis,hh)) + sum( sto , STO_OUT(n,sto,hh) ) + sum( map_n_rsv
      r(n,rsvr) , RSVR_OUT(n,rsvr,hh))
1467  *       + sum( map_l(l) , inc(l,n) * F(l,hh))
      *Balancing Correction Factor
              + sum( map_n_tech(n,dis) ,
                sum( reserves_do ,  RP_DIS(n,reserves_do,dis,hh) * phi_reserves_
      call(n,reserves_do,hh))
              - sum( reserves_up ,  RP_DIS(n,reserves_up,dis,hh) * phi_reserves_
      call(n,reserves_up,hh))
               )
      $ontext
               + sum( map_n_dsm(n,dsm_curt) , DSM_CU(n,dsm_curt,hh))
               + sum( map_n_dsm(n,dsm_shift) , DSM_DO_DEMAND(n,dsm_shift,hh))
      $ontext
              + sum( map_n_ev(n,ev) , EV_DISCHARGE(n,ev,hh) )
      $ontext
1485  *$ontext
1486           + sum( map_n_res_pro(n,res) , G_MARKET_PRO2M(n,res,hh) )
1487           + sum( map_n_sto_pro(n,sto) , STO_OUT_PRO2M(n,sto,hh))
1488           + sum( map_n_sto_pro(n,sto) , STO_OUT_M2M(n,sto,hh))
1491           + G_INFES(n,hh)
1492  ;
1493   
1494  con2a_loadlevel(n,dis,h)$(ord(h) > 1 AND map_n_tech(n,dis))..
1495          G_L(n,dis,h) =E= G_L(n,dis,h-1) + G_UP(n,dis,h) - G_DO(n,dis,h)
1496  ;
1497   
1498  con2b_loadlevelstart(n,dis,h)$(ord(h) = 1 AND map_n_tech(n,dis))..
1499           G_L(n,dis,h) =E= G_UP(n,dis,h)
1500  ;
1501   
1502  * ------------------------------------------------------------------------
      ---- *
1503  ***** Hourly maximum generation caps and constraints related to reserves  
       *****
1504  * ------------------------------------------------------------------------
      ---- *
1505   
1506  con3a_maxprod_dispatchable(n,dis,h)$(map_n_tech(n,dis))..
1507          G_L(n,dis,h)
              + sum( reserves_up , RP_DIS(n,reserves_up,dis,h))
      *Balancing Correction Factor
              + sum( reserves_do ,  RP_DIS(n,reserves_do,dis,h) * phi_reserves_c
      all(n,reserves_do,h))
              - sum( reserves_up ,  RP_DIS(n,reserves_up,dis,h) * phi_reserves_c
      all(n,reserves_up,h))
      $ontext
1515          =L= N_TECH(n,dis)
1516  ;
1517   
1518  con3b_minprod_dispatchable(n,dis,h)$(map_n_tech(n,dis))..
1519          sum( reserves_do , RP_DIS(n,reserves_do,dis,h))
1520          =L= G_L(n,dis,h)
1521  * Balancing Correction Factor
1522          + sum( reserves_do ,  RP_DIS(n,reserves_do,dis,h) * phi_reserves_c
      all(n,reserves_do,h))
1523          - sum( reserves_up ,  RP_DIS(n,reserves_up,dis,h) * phi_reserves_c
      all(n,reserves_up,h))
1524  ;
1525   
1526  con3c_flex_reserves_spin(n,dis,reserves_spin,h)$(map_n_tech(n,dis))..
1527          RP_DIS(n,reserves_spin,dis,h)
1528          =L= grad_per_min(n,dis) * reserves_reaction(n,reserves_spin) * ( G
      _L(n,dis,h)
1529  * Balancing Correction Factor
1530          + sum( reserves_do ,  RP_DIS(n,reserves_do,dis,h) * phi_reserves_c
      all(n,reserves_do,h))
1531          - sum( reserves_up ,  RP_DIS(n,reserves_up,dis,h) * phi_reserves_c
      all(n,reserves_up,h)) )
1532  ;
1533   
1534  con3d_flex_reserves_nonspin(n,dis,reserves_nonspin,h)$(map_n_tech(n,dis)).
      .
1535          RP_DIS(n,reserves_nonspin,dis,h)
1536          =L= grad_per_min(n,dis) * reserves_reaction(n,reserves_nonspin) * 
      N_TECH(n,dis)
1537  ;
1538   
1539  con3e_maxprod_res(n,nondis,h)$(map_n_tech(n,nondis))..
1540          G_RES(n,nondis,h) + CU(n,nondis,h)
              + sum( reserves_up , RP_NONDIS(n,reserves_up,nondis,h))
      $ontext
1545          =E= phi_res(n,nondis,h) * N_TECH(n,nondis)
1546  ;
1547   
1548  con3f_minprod_res(n,nondis,h)$(map_n_tech(n,nondis))..
1549          sum( reserves_do , RP_NONDIS(n,reserves_do,nondis,h))
1550          =L= G_RES(n,nondis,h)
1551  ;
1552   
1553  * ------------------------------------------------------------------------
      ---- *
1554  ***** Storage constraints *****
1555  * ------------------------------------------------------------------------
      ---- *
1556   
1557  con4a_stolev_start(n,sto,h)$(map_n_sto(n,sto) AND ord(h) = 1)..
1558          STO_L(n,sto,h) =E= phi_sto_ini(n,sto) * N_STO_E(n,sto) + STO_IN(n,
      sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT(n,sto,h)/(1+eta_sto(n,sto))*2
1559  ;
1560   
1561  con4b_stolev(n,sto,h)$((ord(h)>1) AND map_n_sto(n,sto))..
1562           STO_L(n,sto,h) =E= STO_L(n,sto,h-1) + STO_IN(n,sto,h)*(1+eta_sto(
      n,sto))/2 - STO_OUT(n,sto,h)/(1+eta_sto(n,sto))*2
               + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( RP_ST
      O_IN(n,reserves_do,sto,h)*(1+eta_sto(n,sto))/2 + RP_STO_OUT(n,reserves_do,
      sto,h)/(1+eta_sto(n,sto))*2 ))
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( RP_ST
      O_IN(n,reserves_up,sto,h)*(1+eta_sto(n,sto))/2 + RP_STO_OUT(n,reserves_up,
      sto,h)/(1+eta_sto(n,sto))*2 ))
      $ontext
1568  ;
1569   
1570  con4c_stolev_max(n,sto,h)$(map_n_sto(n,sto))..
1571          STO_L(n,sto,h) =L= N_STO_E(n,sto)
1572  ;
1573   
1574  con4d_maxin_sto(n,sto,h)$(map_n_sto(n,sto))..
1575          STO_IN(n,sto,h)
              + sum( reserves_do , RP_STO_IN(n,reserves_do,sto,h))
      $ontext
1580          =L= N_STO_P(n,sto)
1581  ;
1582   
1583  con4e_maxout_sto(n,sto,h)$(map_n_sto(n,sto))..
1584          STO_OUT(n,sto,h)
              + sum( reserves_up , RP_STO_OUT(n,reserves_up,sto,h))
      $ontext
1589          =L= N_STO_P(n,sto)
1590  ;
1591   
1592  con4f_resrv_sto(n,sto,h)$(map_n_sto(n,sto))..
1593          sum( reserves_up , RP_STO_IN(n,reserves_up,sto,h))
1594          =L= STO_IN(n,sto,h)
1595  ;
1596   
1597  con4g_resrv_sto(n,sto,h)$(map_n_sto(n,sto))..
1598          sum( reserves_do , RP_STO_OUT(n,reserves_do,sto,h))
1599          =L= STO_OUT(n,sto,h)
1600  ;
1601   
1602  con4h_maxout_lev(n,sto,h)$(map_n_sto(n,sto))..
1603          ( STO_OUT(n,sto,h)
              + sum( reserves_up , RP_STO_OUT(n,reserves_up,sto,h))
      $ontext
1608          ) /(1+eta_sto(n,sto))*2
1609          =L= STO_L(n,sto,h-1)
1610  ;
1611   
1612  con4i_maxin_lev(n,sto,h)$(map_n_sto(n,sto))..
1613          ( STO_IN(n,sto,h)
              + sum( reserves_do , RP_STO_IN(n,reserves_do,sto,h))
      $ontext
1618          ) * (1+eta_sto(n,sto))/2
1619          =L= N_STO_E(n,sto) - STO_L(n,sto,h-1)
1620  ;
1621   
1622  con4j_ending(n,sto,h)$(ord(h) = card(h) AND map_n_sto(n,sto))..
1623           STO_L(n,sto,h) =E= phi_sto_ini(n,sto) * N_STO_E(n,sto)
1624  ;
1625   
1626  con4k_PHS_EtoP(n,sto)$(map_n_sto(n,sto))..
1627          N_STO_E(n,sto) =L= etop_max(n,sto) * N_STO_P(n,sto)
1628  ;
1629   
1630  * ------------------------------------------------------------------------
      ---- *
1631  ***** Quotas for renewables and biomass *****
1632  * ------------------------------------------------------------------------
      ---- *
1633   
1634  con5a_minRES(n)..
1635  sum( h , G_L(n,'bio',h) + sum( map_n_tech(n,nondis) , G_RES(n,nondis,h)) +
       sum( map_n_rsvr(n,rsvr) , RSVR_OUT(n,rsvr,h))
               - sum( reserves_do , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_do,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_do,rsvr
      ,h))) * phi_reserves_call(n,reserves_do,h))
               + sum( reserves_up , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_up,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_up,rsvr
      ,h))) * phi_reserves_call(n,reserves_up,h))
      $ontext
1641  *$ontext
1642           + sum( map_n_sto_pro(n,sto) , STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_
      PRO2M(n,sto,h)) + sum( map_n_res_pro(n,res) , G_MARKET_PRO2M(n,res,h) + G_
      RES_PRO(n,res,h))
1645  )
1646          =G= phi_min_res * phi_min_res_exog(n) * sum( h ,
1647           sum( map_n_tech(n,dis) , G_L(n,dis,h)) + sum( map_n_tech(n,nondis
      ) , G_RES(n,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RSVR_OUT(n,rsvr,h))
               - sum( reserves_do , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_do,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_do,rsvr
      ,h))) * phi_reserves_call(n,reserves_do,h))
               + sum( reserves_up , (sum( map_n_tech(n,nondis) , RP_NONDIS(n,res
      erves_up,nondis,h)) + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_up,rsvr
      ,h))) * phi_reserves_call(n,reserves_up,h))
      $ontext
1653  *$ontext
1654           + sum( map_n_res_pro(n,res) , phi_res(n,res,h) * N_RES_PRO(n,res)
       - CU_PRO(n,res,h))
1657           )
1658  ;
1659   
1660  con5b_max_energy(n,dis)$(map_n_tech(n,dis) AND m_e(n,dis))..
1661           sum( h , G_L(n,dis,h) ) =L= m_e(n,dis)
1662  ;
1663   
1664  * ------------------------------------------------------------------------
      ---- *
1665  ***** DSM constraints - curtailment *****
1666  * ------------------------------------------------------------------------
      ---- *
1667   
1668  con6a_DSMcurt_duration_max(n,dsm_curt,h)$(map_n_dsm(n,dsm_curt))..
1669           sum( hh$( ord(hh) >= ord(h) AND ord(hh) < ord(h) + t_off_dsm_cu(n
      ,dsm_curt) ) , DSM_CU(n,dsm_curt,hh)
              + sum( reserves_up , RP_DSM_CU(n,reserves_up,dsm_curt,hh) * phi_re
      serves_call(n,reserves_up,hh) )
      $ontext
1674           )
1675           =L= N_DSM_CU(n,dsm_curt) * t_dur_dsm_cu(n,dsm_curt)
1676  ;
1677   
1678  con6b_DSMcurt_max(n,dsm_curt,h)$(map_n_dsm(n,dsm_curt))..
1679          DSM_CU(n,dsm_curt,h)
              + sum( reserves_up , RP_DSM_CU(n,reserves_up,dsm_curt,h) )
      $ontext
1684            =L= N_DSM_CU(n,dsm_curt)
1685  ;
1686   
1687  * ------------------------------------------------------------------------
      ---- *
1688  ***** DSM constraints - shifting *****
1689  * ------------------------------------------------------------------------
      ---- *
1690   
1691  con7a_DSMshift_upanddown(n,dsm_shift,h)$(map_n_dsm(n,dsm_shift))..
1692           DSM_UP(n,dsm_shift,h) * (1 + eta_dsm_shift(n,dsm_shift))/2 =E= 2/
      (1+eta_dsm_shift(n,dsm_shift)) * sum( hh$( ord(hh) >= ord(h) - t_dur_dsm_s
      hift(n,dsm_shift) AND ord(hh) <= ord(h) + t_dur_dsm_shift(n,dsm_shift) ) ,
       DSM_DO(n,dsm_shift,h,hh))
1693  ;
1694   
1695  con7b_DSMshift_granular_max(n,dsm_shift,h)$(map_n_dsm(n,dsm_shift))..
1696           DSM_UP_DEMAND(n,dsm_shift,h) + DSM_DO_DEMAND(n,dsm_shift,h)
               + sum( reserves , RP_DSM_SHIFT(n,reserves,dsm_shift,h) )
      $ontext
1701           =L= N_DSM_SHIFT(n,dsm_shift)
1702  ;
1703   
1704  con7c_DSM_distrib_up(n,dsm_shift,h)$(map_n_dsm(n,dsm_shift))..
1705           DSM_UP(n,dsm_shift,h) =E= DSM_UP_DEMAND(n,dsm_shift,h)
               + sum( reserves_do , RP_DSM_SHIFT(n,reserves_do,dsm_shift,h) * ph
      i_reserves_call(n,reserves_do,h))
      $ontext
1710  ;
1711   
1712  con7d_DSM_distrib_do(n,dsm_shift,h)$(map_n_dsm(n,dsm_shift))..
1713           sum( hh$( ord(hh) >= ord(h) - t_dur_dsm_shift(n,dsm_shift) AND or
      d(hh) <= ord(h) + t_dur_dsm_shift(n,dsm_shift) ) , DSM_DO(n,dsm_shift,hh,h
      ) )
1714                   =E=
1715           DSM_DO_DEMAND(n,dsm_shift,h)
               + sum( reserves_up , RP_DSM_SHIFT(n,reserves_up,dsm_shift,h) * ph
      i_reserves_call(n,reserves_up,h))
      $ontext
1720  ;
1721   
1722  con7e_DSMshift_recovery(n,dsm_shift,h)$(map_n_dsm(n,dsm_shift))..
1723           sum( hh$( ord(hh) >= ord(h) AND ord(hh) < ord(h) + t_off_dsm_shif
      t(n,dsm_shift) ) , DSM_UP(n,dsm_shift,hh))
1724           =L= N_DSM_SHIFT(n,dsm_shift) * t_dur_dsm_shift(n,dsm_shift)
1725  ;
1726   
1727  * ------------------------------------------------------------------------
      ---- *
1728  ***** Maximum installation constraints *****
1729  * ------------------------------------------------------------------------
      ---- *
1730   
1731  con8a_max_I_power(n,tech)$(map_n_tech(n,tech))..
1732           N_TECH(n,tech) =L= m_p(n,tech)
1733  ;
1734   
1735  con8b_max_I_sto_e(n,sto)$(map_n_sto(n,sto))..
1736           N_STO_E(n,sto) =L= m_sto_e(n,sto)
1737  ;
1738   
1739  con8c_max_I_sto_p(n,sto)$(map_n_sto(n,sto))..
1740           N_STO_P(n,sto) =L= m_sto_p(n,sto)
1741  ;
1742   
1743  con8d_max_I_dsm_cu(n,dsm_curt)$(map_n_dsm(n,dsm_curt))..
1744           N_DSM_CU(n,dsm_curt) =L= m_dsm_cu(n,dsm_curt)
1745  ;
1746   
1747  con8e_max_I_dsm_shift_pos(n,dsm_shift)$(map_n_dsm(n,dsm_shift))..
1748           N_DSM_SHIFT(n,dsm_shift) =L= m_dsm_shift(n,dsm_shift)
1749  ;
1750   
1751  con8f_max_pro_res(n,res)$(map_n_res_pro(n,res))..
1752           N_RES_PRO(n,res) =L= m_res_pro(n,res)
1753  ;
1754   
1755  con8g_max_pro_sto_e(n,sto)$(map_n_sto_pro(n,sto))..
1756           N_STO_E_PRO(n,sto) =L= m_sto_pro_e(n,sto)
1757  ;
1758   
1759  con8h_max_sto_pro_p(n,sto)$(map_n_sto_pro(n,sto))..
1760           N_STO_P_PRO(n,sto) =L= m_sto_pro_p(n,sto)
1761  ;
1762   
1763  con8i_max_I_ntc(l)$(map_l(l))..
1764           NTC(l) =L= m_ntc(l)
1765  ;
1766   
1767  con8j_max_I_rsvr_e(n,rsvr)$(map_n_rsvr(n,rsvr))..
1768           N_RSVR_E(n,rsvr) =L= m_rsvr_e(n,rsvr)
1769  ;
1770   
1771  con8k_max_I_rsvr_p(n,rsvr)$(map_n_rsvr(n,rsvr))..
1772           N_RSVR_P(n,rsvr) =L= m_rsvr_p(n,rsvr)
1773  ;
1774   
1775  * ------------------------------------------------------------------------
      ---- *
1776  ***** Reserve constraints *****
1777  * ------------------------------------------------------------------------
      ---- *
1778   
1779  con9a_reserve_prov_endogenous(n,reserves_nonprim,h)..
1780            sum( map_n_tech(n,dis) , RP_DIS(n,reserves_nonprim,dis,h))
1781          + sum( map_n_tech(n,nondis) , RP_NONDIS(n,reserves_nonprim,nondis,
      h))
1782          + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_nonprim,rsvr,h))
1783          + sum( map_n_sto(n,sto) , RP_STO_IN(n,reserves_nonprim,sto,h) + RP
      _STO_OUT(n,reserves_nonprim,sto,h))
              + sum( map_n_dsm(n,dsm_curt) , RP_DSM_CU(n,reserves_nonprim,dsm_cu
      rt,h))
              + sum( map_n_dsm(n,dsm_shift) , RP_DSM_SHIFT(n,reserves_nonprim,ds
      m_shift,h) )
      $ontext
      %EV_EXOG%   + sum( map_n_ev(n,ev) , RP_EV_G2V(n,reserves_nonprim,ev,h) + R
      P_EV_V2G(n,reserves_nonprim,ev,h) )
      $ontext
              + sum( (bu,ch) , theta_sets(n,bu,ch) * ( RP_SETS(n,reserves_nonpri
      m,bu,ch,h) + RP_SETS_AUX(n,reserves_nonprim,bu,ch,h)) )
              + sum( (bu,ch) , theta_hp(n,bu,ch) * RP_HP(n,reserves_nonprim,bu,c
      h,h) )
              + sum( (bu,ch) , theta_elec(n,bu,ch) * RP_H_ELEC(n,reserves_nonpri
      m,bu,ch,h) )
      $ontext
1799          =E= (
1800              feat_node('reserves',n) *
1801              1000 * phi_reserves_share(n,reserves_nonprim) * (
1802              reserves_intercept(n,reserves_nonprim) + sum( map_n_tech(n,non
      dis) , reserves_slope(n,reserves_nonprim,nondis) * (N_TECH(n,nondis)
1803  *$ontext
1804              + N_RES_PRO(n,nondis)
1807              )/1000 ) ) )$(ord(h) > 1)
1808  ;
1809   
1810  con9a_reserve_prov_exogenous(n,reserves_nonprim,h)..
1811            sum( map_n_tech(n,dis) , RP_DIS(n,reserves_nonprim,dis,h))
1812          + sum( map_n_tech(n,nondis) , RP_NONDIS(n,reserves_nonprim,nondis,
      h))
1813          + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_nonprim,rsvr,h))
1814          + sum( map_n_sto(n,sto) , RP_STO_IN(n,reserves_nonprim,sto,h) + RP
      _STO_OUT(n,reserves_nonprim,sto,h))
              + sum( map_n_dsm(n,dsm_curt) , RP_DSM_CU(n,reserves_nonprim,dsm_cu
      rt,h))
              + sum( map_n_dsm(n,dsm_shift) , RP_DSM_SHIFT(n,reserves_nonprim,ds
      m_shift,h) )
      $ontext
      %EV_EXOG%   + sum( map_n_ev(n,ev) , RP_EV_G2V(n,reserves_nonprim,ev,h) + R
      P_EV_V2G(n,reserves_nonprim,ev,h) )
      $ontext
              + sum( (bu,ch) , theta_sets(n,bu,ch) * ( RP_SETS(n,reserves_nonpri
      m,bu,ch,h) + RP_SETS_AUX(n,reserves_nonprim,bu,ch,h)) )
              + sum( (bu,ch) , theta_hp(n,bu,ch) * RP_HP(n,reserves_nonprim,bu,c
      h,h) )
              + sum( (bu,ch) , theta_elec(n,bu,ch) * RP_H_ELEC(n,reserves_nonpri
      m,bu,ch,h) )
      $ontext
1830          =E= feat_node('reserves',n) * reserves_exogenous(n,reserves_nonpri
      m,h)$(ord(h) > 1)
1831  ;
1832   
1833  con9b_reserve_prov_PR_endogenous(n,reserves_prim,h)..
1834            sum( map_n_tech(n,dis) , RP_DIS(n,reserves_prim,dis,h))
1835          + sum( map_n_tech(n,nondis) , RP_NONDIS(n,reserves_prim,nondis,h))
1836          + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_prim,rsvr,h))
1837          + sum( map_n_sto(n,sto) , RP_STO_IN(n,reserves_prim,sto,h) + RP_ST
      O_OUT(n,reserves_prim,sto,h) )
      %EV_EXOG%   + sum( map_n_ev(n,ev) , RP_EV_G2V(n,reserves_prim,ev,h) + RP_E
      V_V2G(n,reserves_prim,ev,h) )
      $ontext
1842           =E=
1843               feat_node('reserves',n) *
1844               phi_reserves_pr_up(n)* sum( reserves_nonprim , 1000 * phi_res
      erves_share(n,reserves_nonprim) * (
1845               reserves_intercept(n,reserves_nonprim) + sum( map_n_tech(n,no
      ndis) , reserves_slope(n,reserves_nonprim,nondis) * (N_TECH(n,nondis)
1846  *$ontext
1847               + N_RES_PRO(n,nondis)
1850               )/1000 ) ) )$(ord(h) > 1)
1851  ;
1852   
1853  con9b_reserve_prov_PR_exogenous(n,reserves_prim,h)..
1854            sum( map_n_tech(n,dis) , RP_DIS(n,reserves_prim,dis,h))
1855          + sum( map_n_tech(n,nondis) , RP_NONDIS(n,reserves_prim,nondis,h))
1856          + sum( map_n_rsvr(n,rsvr) , RP_RSVR(n,reserves_prim,rsvr,h))
1857          + sum( map_n_sto(n,sto) , RP_STO_IN(n,reserves_prim,sto,h) + RP_ST
      O_OUT(n,reserves_prim,sto,h) )
      %EV_EXOG%   + sum( map_n_ev(n,ev) , RP_EV_G2V(n,reserves_prim,ev,h) + RP_E
      V_V2G(n,reserves_prim,ev,h) )
      $ontext
1862           =E= feat_node('reserves',n) * reserves_exogenous(n,reserves_prim,
      h)$(ord(h) > 1)
1863  ;
1864   
1865  * ------------------------------------------------------------------------
      ---- *
1866  ***** Electric vehicle constraints *****
1867  * ------------------------------------------------------------------------
      ---- *
1868   
1869  con10a_ev_ed(n,ev,h)$(map_n_ev(n,ev))..
1870           feat_node('ev',n) *
1871           ev_ed(n,ev,h) * phi_ev(n,ev) * ev_quant
1872           =e= EV_GED(n,ev,h) + EV_PHEVFUEL(n,ev,h)$(ev_phev(n,ev)=1)
1873  ;
1874   
1875  con10b_ev_chargelev_start(ev,h,n)$(map_n_ev(n,ev) AND ord(h) = 1 AND feat_
      node('ev',n))..
1876           EV_L(n,ev,h) =E= feat_node('ev',n) * phi_ev_ini(n,ev) * n_ev_e(n,
      ev) * phi_ev(n,ev) * ev_quant
1877           + EV_CHARGE(n,ev,h) * eta_ev_in(n,ev)
1878           - EV_DISCHARGE(n,ev,h) / eta_ev_out(n,ev)
1879           - EV_GED(n,ev,h)
1880  ;
1881   
1882  con10c_ev_chargelev(n,ev,h)$(map_n_ev(n,ev) AND ord(h) > 1 AND feat_node('
      ev',n))..
1883           EV_L(n,ev,h) =E= EV_L(n,ev,h-1)
1884           + EV_CHARGE(n,ev,h) * eta_ev_in(n,ev)
1885           - EV_DISCHARGE(n,ev,h) / eta_ev_out(n,ev)
      %EV_EXOG%   + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * (RP_
      EV_G2V(n,reserves_do,ev,h)*eta_ev_in(n,ev) + RP_EV_V2G(n,reserves_do,ev,h)
      /eta_ev_out(n,ev)) )
      %EV_EXOG%   - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * (RP_
      EV_G2V(n,reserves_up,ev,h)*eta_ev_in(n,ev) + RP_EV_V2G(n,reserves_up,ev,h)
      /eta_ev_out(n,ev)) )
      $ontext
1891           - EV_GED(n,ev,h)
1892  ;
1893   
1894  con10d_ev_chargelev_max(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1895           EV_L(n,ev,h)
1896           =L= n_ev_e(n,ev) * phi_ev(n,ev) * ev_quant
1897               * feat_node('ev',n)
1898  ;
1899   
1900  con10e_ev_maxin(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1901          EV_CHARGE(n,ev,h)
              + sum( reserves_do , RP_EV_G2V(n,reserves_do,ev,h))
      $ontext
1906          =L= n_ev_p(n,ev,h) * phi_ev(n,ev) * ev_quant
1907              * feat_node('ev',n)
1908  ;
1909   
1910  con10f_ev_maxout(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1911          EV_DISCHARGE(n,ev,h)
              + sum( reserves_up , RP_EV_V2G(n,reserves_up,ev,h))
      $ontext
1916          =L= n_ev_p(n,ev,h) * phi_ev(n,ev) * ev_quant
1917              * feat_node('ev',n)
1918  ;
1919   
1920  con10g_ev_chargelev_ending(n,ev,h)$(map_n_ev(n,ev) AND ord(h) = card(h) AN
      D feat_node('ev',n))..
1921           EV_L(n,ev,h) =E= phi_ev_ini(n,ev) * n_ev_e(n,ev) * phi_ev(n,ev) *
       ev_quant * feat_node('ev',n)
1922  ;
1923   
1924  con10h_ev_minin(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1925           0 =L= EV_CHARGE(n,ev,h)
1926          - sum( reserves_up , RP_EV_G2V(n,reserves_up,ev,h))
1927  ;
1928   
1929  con10i_ev_maxin_lev(n,ev,h)$(map_n_ev(n,ev))..
1930          ( EV_CHARGE(n,ev,h)
1931          + sum( reserves_do , RP_EV_G2V(n,reserves_do,ev,h))
1932          ) * eta_ev_in(n,ev)
1933          =L= n_ev_e(n,ev) * phi_ev(n,ev) * ev_quant - EV_L(n,ev,h-1)
1934  ;
1935   
1936  con10j_ev_minout(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1937           0 =L= EV_DISCHARGE(n,ev,h)
1938          - sum( reserves_do , RP_EV_V2G(n,reserves_do,ev,h))
1939  ;
1940   
1941  con10k_ev_maxout_lev(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1942          ( EV_DISCHARGE(n,ev,h)
1943          + sum( reserves_up , RP_EV_V2G(n,reserves_up,ev,h))
1944  ) / eta_ev_out(n,ev)
1945          =L= EV_L(n,ev,h-1)
1946  ;
1947   
1948  con10l_ev_exog(n,ev,h)$(map_n_ev(n,ev) AND feat_node('ev',n))..
1949           EV_CHARGE(n,ev,h)
1950           =E=
1951           ev_ged_exog(n,ev,h) * phi_ev(n,ev) * ev_quant
1952           * feat_node('ev',n)
1953  ;
1954   
1955  * ------------------------------------------------------------------------
      ---- *
1956  ***** Prosumage constraints *****
1957  * ------------------------------------------------------------------------
      ---- *
1958   
1959  con11a_pro_distrib(n,res,h)$(map_n_res_pro(n,res))..
1960           phi_res(n,res,h) * N_RES_PRO(n,res)
1961           =E=
1962           CU_PRO(n,res,h) + G_MARKET_PRO2M(n,res,h) + G_RES_PRO(n,res,h) + 
      sum( map_n_sto_pro(n,sto) , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN_PRO2M(n,r
      es,sto,h) )
1963  ;
1964   
1965  con11b_pro_balance(n,h)..
1966           phi_pro_load(n) * d(n,h)
1967           =E=
1968           sum( map_n_res_pro(n,res) , G_RES_PRO(n,res,h)) + sum( map_n_sto_
      pro(n,sto) , STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_M2PRO(n,sto,h) ) + G_MARKE
      T_M2PRO(n,h)
1969  ;
1970   
1971  con11c_pro_selfcon(n)..
1972           sum( (h,map_n_res_pro(n,res)) , G_RES_PRO(n,res,h) ) + sum( (h,st
      o) , STO_OUT_PRO2PRO(n,sto,h) )
1973           =G=
1974           phi_pro_self * sum( h , phi_pro_load(n) * d(n,h))
1975  ;
1976   
1977  con11d_pro_stolev_PRO2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) > 1 ).
      .
1978           STO_L_PRO2PRO(n,sto,h) =E= STO_L_PRO2PRO(n,sto,h-1) + sum( map_n_
      res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h))*(1+eta_sto(n,sto))/2 - STO_O
      UT_PRO2PRO(n,sto,h)/(1+eta_sto(n,sto))*2
1979  ;
1980   
1981  con11e_pro_stolev_PRO2M(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) > 1)..
1982           STO_L_PRO2M(n,sto,h) =E= STO_L_PRO2M(n,sto,h-1) + sum( map_n_res_
      pro(n,res) , STO_IN_PRO2M(n,res,sto,h))*(1+eta_sto(n,sto))/2 - STO_OUT_PRO
      2M(n,sto,h)/(1+eta_sto(n,sto))*2
1983  ;
1984   
1985  con11f_pro_stolev_M2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) > 1)..
1986           STO_L_M2PRO(n,sto,h) =E= STO_L_M2PRO(n,sto,h-1) + STO_IN_M2PRO(n,
      sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT_M2PRO(n,sto,h)/(1+eta_sto(n,sto))*2
1987  ;
1988   
1989  con11g_pro_stolev_M2M(n,sto,h)$(ord(h) > 1)..
1990           STO_L_M2M(n,sto,h) =E= STO_L_M2M(n,sto,h-1) + STO_IN_M2M(n,sto,h)
      *(1+eta_sto(n,sto))/2 - STO_OUT_M2M(n,sto,h)/(1+eta_sto(n,sto))*2
1991  ;
1992   
1993  con11h_1_pro_stolev_start_PRO2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h
      ) = 1)..
1994          STO_L_PRO2PRO(n,sto,h) =E=
1995  *$ontext
1996          4*
1999           0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_PRO(n,sto)
2000           + sum( map_n_res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h))*(1+eta
      _sto(n,sto))/2 - STO_OUT_PRO2PRO(n,sto,h)/(1+eta_sto(n,sto))*2
2001  ;
2002   
2003  con11h_2_pro_stolev_start_PRO2M(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) 
      = 1)..
2004          STO_L_PRO2M(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_P
      RO(n,sto) + sum( map_n_res_pro(n,res) , STO_IN_PRO2M(n,res,sto,h))*(1+eta_
      sto(n,sto))/2 - STO_OUT_PRO2M(n,sto,h)/(1+eta_sto(n,sto))*2
2005  ;
2006   
2007  con11h_3_pro_stolev_start_M2PRO(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) 
      = 1)..
2008          STO_L_M2PRO(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_P
      RO(n,sto) + STO_IN_M2PRO(n,sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT_M2PRO(n,s
      to,h)/(1+eta_sto(n,sto))*2
2009  ;
2010   
2011  con11h_4_pro_stolev_start_M2M(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) = 
      1)..
2012          STO_L_M2M(n,sto,h) =E= 0.25 * phi_sto_pro_ini(n,sto) * N_STO_E_PRO
      (n,sto) + STO_IN_M2M(n,sto,h)*(1+eta_sto(n,sto))/2 - STO_OUT_M2M(n,sto,h)/
      (1+eta_sto(n,sto))*2
2013  ;
2014   
2015  con11i_pro_stolev(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h)>1)..
2016           STO_L_PRO(n,sto,h) =E=   STO_L_PRO2PRO(n,sto,h) +  STO_L_PRO2M(n,
      sto,h) + STO_L_M2PRO(n,sto,h) + STO_L_M2M(n,sto,h)
2017  ;
2018   
2019  con11j_pro_stolev_max(n,sto,h)..
2020          STO_L_PRO(n,sto,h) =L= N_STO_E_PRO(n,sto)
2021  ;
2022   
2023  con11k_pro_maxin_sto(n,sto,h)$(map_n_sto_pro(n,sto))..
2024          sum( map_n_res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN_P
      RO2M(n,res,sto,h) ) + STO_IN_M2PRO(n,sto,h) + STO_IN_M2M(n,sto,h)
2025          =L= N_STO_P_PRO(n,sto)
2026  ;
2027   
2028  con11l_pro_maxout_sto(n,sto,h)$(map_n_sto_pro(n,sto))..
2029          STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_PRO2M(n,sto,h) + STO_OUT_M2PRO(
      n,sto,h) + STO_OUT_M2M(n,sto,h)
2030          =L= N_STO_P_PRO(n,sto)
2031  ;
2032   
2033  con11m_pro_maxout_lev(n,sto,h)$(map_n_sto_pro(n,sto))..
2034          ( STO_OUT_PRO2PRO(n,sto,h) + STO_OUT_M2PRO(n,sto,h) + STO_OUT_PRO2
      M(n,sto,h) + STO_OUT_M2M(n,sto,h) ) / (1+eta_sto(n,sto))*2
2035          =L= STO_L_PRO(n,sto,h-1)
2036  ;
2037   
2038  con11n_pro_maxin_lev(n,sto,h)$(map_n_sto_pro(n,sto))..
2039          ( sum( map_n_res_pro(n,res) , STO_IN_PRO2PRO(n,res,sto,h) + STO_IN
      _PRO2M(n,res,sto,h) ) + STO_IN_M2PRO(n,sto,h) + STO_IN_M2M(n,sto,h) ) * (1
      +eta_sto(n,sto))/2
2040          =L= N_STO_E_PRO(n,sto) - STO_L_PRO(n,sto,h-1)
2041  ;
2042   
2043  con11o_pro_ending(n,sto,h)$(map_n_sto_pro(n,sto) AND ord(h) = card(h))..
2044           STO_L_PRO(n,sto,h) =E= phi_sto_pro_ini(n,sto) * N_STO_E_PRO(n,sto
      )
2045  ;
2046   
2047  * ------------------------------------------------------------------------
      ---- *
2048  ***** NTC constraints *****
2049  * ------------------------------------------------------------------------
      ---- *
2050   
2051  ***** Constraint on energy flow between nodes ******
2052  con12a_max_f(l,h)$(map_l(l))..
2053           F(l,h) =L= NTC(l)
2054  ;
2055   
2056  con12b_min_f(l,h)$(map_l(l))..
2057           F(l,h) =G= -NTC(l)
2058  ;
2059   
2060  * ------------------------------------------------------------------------
      ---- *
2061  ***** Reservoir constraints *****
2062  * ------------------------------------------------------------------------
      ---- *
2063   
2064  con13a_rsvrlev_start(n,rsvr,h)$(map_n_rsvr(n,rsvr) AND ord(h) = 1)..
2065          RSVR_L(n,rsvr,h) =E= phi_rsvr_ini(n,rsvr) * N_RSVR_E(n,rsvr) + rsv
      r_in(n,rsvr,h)/1000 * N_RSVR_E(n,rsvr) - RSVR_OUT(n,rsvr,h)
2066  ;
2067   
2068  con13b_rsvrlev(rsvr,h,n)$(ord(h) > 1 AND map_n_rsvr(n,rsvr))..
2069           RSVR_L(n,rsvr,h) =E= RSVR_L(n,rsvr,h-1) + rsvr_in(n,rsvr,h)/1000 
      * N_RSVR_E(n,rsvr) - RSVR_OUT(n,rsvr,h)
                      - sum( reserves_up , RP_RSVR(n,reserves_up,rsvr,h) * phi_r
      eserves_call(n,reserves_up,h) )
                      + sum( reserves_do , RP_RSVR(n,reserves_do,rsvr,h) * phi_r
      eserves_call(n,reserves_do,h) )
      $ontext
2075  ;
2076   
2077  con13c_rsvrlev_max(n,rsvr,h)$(map_n_rsvr(n,rsvr))..
2078          RSVR_L(n,rsvr,h) =L= N_RSVR_E(n,rsvr)
2079  ;
2080   
2081  con13d_maxout_rsvr(rsvr,h,n)$(map_n_rsvr(n,rsvr))..
2082          RSVR_OUT(n,rsvr,h)
              + sum( reserves_up , RP_RSVR(n,reserves_up,rsvr,h))
      $ontext
2087          =L= N_RSVR_P(n,rsvr)
2088  ;
2089   
2090  con13e_resrv_rsvr(n,rsvr,h)$(map_n_rsvr(n,rsvr))..
2091          sum( reserves_do , RP_RSVR(n,reserves_do,rsvr,h))
2092          =L= RSVR_OUT(n,rsvr,h)
2093  ;
2094   
2095  con13f_maxout_lev(n,rsvr,h)$(map_n_rsvr(n,rsvr))..
2096          RSVR_OUT(n,rsvr,h)
              + sum( reserves_up , RP_RSVR(n,reserves_up,rsvr,h))
      $ontext
2101          =L= RSVR_L(n,rsvr,h-1)
2102  ;
2103   
2104  con13g_ending(n,rsvr,h)$(map_n_rsvr(n,rsvr) AND ord(h) = card(h))..
2105           RSVR_L(n,rsvr,h) =E= phi_rsvr_ini(n,rsvr) * N_RSVR_E(n,rsvr)
2106  ;
2107   
2108  con13h_smooth(n,rsvr,h)$(map_n_rsvr(n,rsvr) AND feat_node('rsvr_outflow',n
      ))..
2109           RSVR_OUT(n,rsvr,h) =G= phi_rsvr_min(n) * sum( hh , rsvr_in(n,rsvr
      ,hh)/1000/card(hh)) * N_RSVR_E(n,rsvr)
2110  ;
2111   
2112  con13i_min_level(n,rsvr,h)$(map_n_rsvr(n,rsvr))..
2113           RSVR_L(n,rsvr,h) =G= phi_rsvr_lev_min(n,rsvr) * N_RSVR_E(n,rsvr)
2114  ;
2115   
2116  con13j_min_FLH(n,rsvr)$(map_n_rsvr(n,rsvr))..
2117           sum( h , RSVR_OUT(n,rsvr,h) ) =G= min_flh(n,rsvr) * N_RSVR_P(n,rs
      vr)
2118  ;
2119   
2120   
2121  * ------------------------------------------------------------------------
      ---- *
2122  ***** Heating constraints *****
2123  * ------------------------------------------------------------------------
      ---- *
2124   
2125  * Energy balances
2126  con14a_heat_balance(n,bu,ch,h)$feat_node('heat',n)..
2127           theta_dir(n,bu,ch) * H_DIR(n,bu,ch,h) + theta_sets(n,bu,ch) * H_S
      ETS_OUT(n,bu,ch,h)+ theta_storage(n,bu,ch) * H_STO_OUT(n,bu,ch,h)
2128           + theta_sets(n,bu,ch) * (1-eta_heat_stat(n,bu,ch)) * H_SETS_LEV(n
      ,bu,ch,h-1)$(theta_sets(n,bu,ch) AND ord(h) > 1)
2129           =G= dh(n,bu,ch,h)
2130  ;
2131   
2132  con14b_dhw_balance(n,bu,ch,h)$feat_node('heat',n)..
2133           theta_storage(n,bu,ch) * H_DHW_STO_OUT(n,bu,ch,h) + theta_dir(n,b
      u,ch) * H_DHW_DIR(n,bu,ch,h) + theta_sets(n,bu,ch) * H_DHW_AUX_OUT(n,bu,ch
      ,h)
2134           =E=
2135           d_dhw(n,bu,ch,h)
2136  ;
2137   
2138  * SETS
2139  con14c_sets_level(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n,bu,ch) 
      AND ord(h) > 1)..
2140           H_SETS_LEV(n,bu,ch,h) =E= eta_heat_stat(n,bu,ch) * H_SETS_LEV(n,b
      u,ch,h-1) + eta_heat_dyn(n,bu,ch) * H_SETS_IN(n,bu,ch,h) - H_SETS_OUT(n,bu
      ,ch,h)
               - theta_sets(n,bu,ch) * eta_heat_dyn(n,bu,ch) * (sum( reserves_up
       , RP_SETS(n,reserves_up,bu,ch,h) * phi_reserves_call(n,reserves_up,h) )
               - sum( reserves_do , RP_SETS(n,reserves_do,bu,ch,h) * phi_reserve
      s_call(n,reserves_do,h) ))
      $ontext
2146  ;
2147   
2148  con14d_sets_level_start(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n,b
      u,ch) AND (ord(h) = 1 OR ord(h) = card(h)))..
2149           H_SETS_LEV(n,bu,ch,h) =E= phi_heat_ini(n,bu,ch) * n_sets_e(n,bu,c
      h)
2150  ;
2151   
2152  con14e_sets_maxin(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n,bu,ch))
      ..
2153           H_SETS_IN(n,bu,ch,h)
               + theta_sets(n,bu,ch) * sum( reserves_do , RP_SETS(n,reserves_do,
      bu,ch,h) )
      $ontext
2158           =L= n_sets_p_in(n,bu,ch)
2159  ;
2160   
2161  con14f_sets_maxout(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n,bu,ch)
      )..
2162           H_SETS_OUT(n,bu,ch,h) =L= n_sets_p_out(n,bu,ch)
2163  ;
2164   
2165  con14g_sets_minin(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n,bu,ch))
      ..
2166          sum( reserves_up , RP_SETS(n,reserves_up,bu,ch,h))
2167          =L= H_SETS_IN(n,bu,ch,h)
2168  ;
2169   
2170  con14h_sets_maxlev(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n,bu,ch)
      )..
2171           H_SETS_LEV(n,bu,ch,h) =L= n_sets_e(n,bu,ch)
2172  ;
2173   
2174  * SETS and DHW
2175  con14i_sets_aux_dhw_level(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n
      ,bu,ch) AND ord(h) > 1)..
2176           H_DHW_AUX_LEV(n,bu,ch,h) =E= eta_dhw_aux_stat(n,bu,ch) * H_DHW_AU
      X_LEV(n,bu,ch,h-1) + H_DHW_AUX_ELEC_IN(n,bu,ch,h) - H_DHW_AUX_OUT(n,bu,ch,
      h)
               - theta_sets(n,bu,ch) * (sum( reserves_up , RP_SETS_AUX(n,reserve
      s_up,bu,ch,h) * phi_reserves_call(n,reserves_up,h) )
               - sum( reserves_do , RP_SETS_AUX(n,reserves_do,bu,ch,h) * phi_res
      erves_call(n,reserves_do,h) ))
      $ontext
2182  ;
2183   
2184  con14j_sets_aux_dhw_level_start(n,bu,ch,h)$(feat_node('heat',n) AND theta_
      sets(n,bu,ch) AND (ord(h) = 1 OR ord(h) = card(h)) )..
2185           H_DHW_AUX_LEV(n,bu,ch,h) =E= phi_heat_ini(n,bu,ch) * n_sets_dhw_e
      (n,bu,ch)
2186  ;
2187   
2188  con14k_sets_aux_dhw_maxin(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(n
      ,bu,ch) )..
2189           H_DHW_AUX_ELEC_IN(n,bu,ch,h)
               + theta_sets(n,bu,ch) * sum( reserves_do , RP_SETS_AUX(n,reserves
      _do,bu,ch,h) )
      $ontext
2194           =L= n_sets_dhw_p_in(n,bu,ch)
2195  ;
2196   
2197  con14l_sets_aux_dhw_minin(n,bu,ch,h)$(feat_node('heat',n) AND feat_node('r
      eserves',n) AND theta_sets(n,bu,ch)  )..
2198          sum( reserves_up , RP_SETS_AUX(n,reserves_up,bu,ch,h))
2199          =L= H_DHW_AUX_ELEC_IN(n,bu,ch,h)
2200  ;
2201   
2202  con14m_sets_aux_dhw_maxlev(n,bu,ch,h)$(feat_node('heat',n) AND theta_sets(
      n,bu,ch) )..
2203           H_DHW_AUX_LEV(n,bu,ch,h) =L= n_sets_dhw_e(n,bu,ch)
2204  ;
2205   
2206  * HEAT PUMPS
2207  con14n_hp_in(n,bu,hp,h)$(feat_node('heat',n) AND theta_hp(n,bu,hp))..
2208           H_STO_IN_HP(n,bu,hp,h) =E= (H_HP_IN(n,bu,hp,h)
               - theta_hp(n,bu,hp) * (sum( reserves_up , RP_HP(n,reserves_up,bu,
      hp,h) * phi_reserves_call(n,reserves_up,h) )
               - sum( reserves_do , RP_HP(n,reserves_do,bu,hp,h) * phi_reserves_
      call(n,reserves_do,h) ))
      $ontext
2214           ) * eta_heat_dyn(n,bu,hp) * ((temp_sink(n,bu,hp)+273.15)/(temp_si
      nk(n,bu,hp) - temp_source(n,bu,hp,h)))
2215  ;
2216   
2217  con14o_hp_maxin(n,bu,hp,h)$(feat_node('heat',n) AND theta_hp(n,bu,hp))..
2218           H_HP_IN(n,bu,hp,h)
               + sum( reserves_do , RP_HP(n,reserves_do,bu,hp,h) )
      $ontext
2223           =L= n_heat_p_in(n,bu,hp)
2224  ;
2225   
2226  con14p_hp_minin(n,bu,hp,h)$(feat_node('heat',n) AND theta_hp(n,bu,hp))..
2227          sum( reserves_up , RP_HP(n,reserves_up,bu,hp,h))
2228          =L= H_HP_IN(n,bu,hp,h)
2229  ;
2230   
2231  * (Hybrid) ELECTRIC HEATING
2232  con14q_storage_elec_in(n,bu,hel,h)$(feat_node('heat',n) AND theta_storage(
      n,bu,hel) AND theta_elec(n,bu,hel) )..
2233           H_STO_IN_ELECTRIC(n,bu,hel,h) =E= H_ELECTRIC_IN(n,bu,hel,h)
               - theta_elec(n,bu,hel) * (sum( reserves_up , RP_H_ELEC(n,reserves
      _up,bu,hel,h) * phi_reserves_call(n,reserves_up,h) )
               - sum( reserves_do , RP_H_ELEC(n,reserves_do,bu,hel,h) * phi_rese
      rves_call(n,reserves_do,h) ))
      $ontext
2239  ;
2240   
2241  con14r_storage_elec_maxin(n,bu,hel,h)$(feat_node('heat',n) AND theta_stora
      ge(n,bu,hel) AND theta_elec(n,bu,hel ))..
2242           H_ELECTRIC_IN(n,bu,hel,h)
               + sum( reserves_do , RP_H_ELEC(n,reserves_do,bu,hel,h) )
      $ontext
2247           =L= n_heat_p_in(n,bu,hel)
2248  ;
2249   
2250  con14s_storage_elec_minin(n,bu,hel,h)$(feat_node('heat',n) AND feat_node('
      reserves',n) AND theta_storage(n,bu,hel) AND theta_elec(n,bu,hel) )..
2251          sum( reserves_up , RP_H_ELEC(n,reserves_up,bu,hel,h))
2252          =L= H_ELECTRIC_IN(n,bu,hel,h)
2253  ;
2254   
2255  * HEAT STORAGE
2256  con14t_storage_level(n,bu,hst,h)$(feat_node('heat',n) AND theta_storage(n,
      bu,hst) AND ord(h) > 1)..
2257           H_STO_LEV(n,bu,hst,h)
2258           =E=
2259           eta_heat_stat(n,bu,hst) * H_STO_LEV(n,bu,hst,h-1) + theta_hp(n,bu
      ,hst)*H_STO_IN_HP(n,bu,hst,h) + theta_elec(n,bu,hst)*H_STO_IN_ELECTRIC(n,b
      u,hst,h) + theta_fossil(n,bu,hst) * H_STO_IN_FOSSIL(n,bu,hst,h)
2260           - H_STO_OUT(n,bu,hst,h) - H_DHW_STO_OUT(n,bu,hst,h)
2261  ;
2262   
2263  con14u_storage_level_start(n,bu,hst,h)$(feat_node('heat',n) AND theta_stor
      age(n,bu,hst) AND (ord(h) = 1 OR ord(h) = card(h)))..
2264           H_STO_LEV(n,bu,hst,h) =E= phi_heat_ini(n,bu,hst) * theta_storage(
      n,bu,hst)*n_heat_e(n,bu,hst)
2265  ;
2266   
2267  con14v_storage_maxlev(n,bu,hst,h)$(feat_node('heat',n) AND theta_storage(n
      ,bu,hst))..
2268           H_STO_LEV(n,bu,hst,h) =L= n_heat_e(n,bu,hst)
2269  ;
2270   
2271   
2272   
2273   
2274  **************************************************************************
      ******
2275  ***** MODEL *****
2276  **************************************************************************
      ******
2277   
2278  model DIETER /
2279  obj
2280   
2281  con1a_bal
2282   
2283  con2a_loadlevel
2284  con2b_loadlevelstart
2285   
2286  con3a_maxprod_dispatchable
        con3b_minprod_dispatchable
        con3c_flex_reserves_spin
        con3d_flex_reserves_nonspin
      $ontext
2293  con3e_maxprod_res
        con3f_minprod_res
      $ontext
2298   
2299  con4a_stolev_start
2300  con4b_stolev
2301  con4c_stolev_max
2302  con4d_maxin_sto
2303  con4e_maxout_sto
        con4f_resrv_sto
        con4g_resrv_sto
      $ontext
2309   
2310  *con4h_maxout_lev
2311  *con4i_maxin_lev
2312  *con4j_ending
2313  *con4k_PHS_EtoP
2314   
2315  con5a_minRES
2316  con5b_max_energy
2317   
      con6a_DSMcurt_duration_max
      con6b_DSMcurt_max
       
      con7a_DSMshift_upanddown
      con7b_DSMshift_granular_max
      con7c_DSM_distrib_up
      con7d_DSM_distrib_do
      *con_7e_DSMshift_recovery
      $ontext
2329   
2330  con8a_max_I_power
2331  con8b_max_I_sto_e
2332  con8c_max_I_sto_p
        con8d_max_I_dsm_cu
        con8e_max_I_dsm_shift_pos
      $ontext
2338  con8i_max_I_ntc
2339  con8j_max_I_rsvr_e
2340  con8k_max_I_rsvr_p
2341   
       con9a_reserve_prov_endogenous
       con9b_reserve_prov_PR_endogenous
      $ontext
2347   
       con9a_reserve_prov_exogenous
       con9b_reserve_prov_PR_exogenous
      $ontext
2353   
       con10a_ev_ed
      %EV_EXOG% con10b_ev_chargelev_start
       con10c_ev_chargelev
       con10d_ev_chargelev_max
      %EV_EXOG% con10e_ev_maxin
      %EV_EXOG% con10f_ev_maxout
      %EV_EXOG% con10g_ev_chargelev_ending
      $ontext
      %reserves%$ontext
      %EV_EXOG% con10h_ev_minin
      %EV_EXOG% con10i_ev_maxin_lev
      %EV_EXOG% con10j_ev_minout
      %EV_EXOG% con10k_ev_maxout_lev
      $ontext
      %EV_EXOG%$ontext
       con10l_ev_exog
      $ontext
2377   
2378  *$ontext
2379  con8f_max_pro_res
2380  con8g_max_pro_sto_e
2381  con8h_max_sto_pro_p
2382  con11a_pro_distrib
2383  con11b_pro_balance
2384  con11c_pro_selfcon
2385  con11d_pro_stolev_PRO2PRO
2386  con11e_pro_stolev_PRO2M
2387  con11f_pro_stolev_M2PRO
2388  con11g_pro_stolev_M2M
2389  con11h_1_pro_stolev_start_PRO2PRO
2390  con11h_2_pro_stolev_start_PRO2M
2391  con11h_3_pro_stolev_start_M2PRO
2392  con11h_4_pro_stolev_start_M2M
2393  con11i_pro_stolev
2394  con11j_pro_stolev_max
2395  con11k_pro_maxin_sto
2396  con11l_pro_maxout_sto
2397  con11m_pro_maxout_lev
2398  con11n_pro_maxin_lev
2399  con11o_pro_ending
2402   
2403  con12a_max_f
2404  con12b_min_f
2405   
2406  con13a_rsvrlev_start
2407  con13b_rsvrlev
2408  con13c_rsvrlev_max
2409  con13d_maxout_rsvr
2410  con13e_resrv_rsvr
2411  con13f_maxout_lev
2412  con13g_ending
2413  *con13h_smooth
2414  con13i_min_level
2415  *con13j_min_FLH
2416   
      con14a_heat_balance
      con14b_dhw_balance
      con14c_sets_level
      con14d_sets_level_start
      con14e_sets_maxin
      con14f_sets_maxout
      con14h_sets_maxlev
       
      con14i_sets_aux_dhw_level
      con14j_sets_aux_dhw_level_start
      con14k_sets_aux_dhw_maxin
      con14l_sets_aux_dhw_minin
      con14m_sets_aux_dhw_maxlev
       
      con14n_hp_in
      con14o_hp_maxin
      con14q_storage_elec_in
      con14r_storage_elec_maxin
      con14t_storage_level
      con14u_storage_level_start
      con14v_storage_maxlev
      $ontext
2441   
      %reserves%$ontext
      con14g_sets_minin
      con14p_hp_minin
      con14s_storage_elec_minin
      $ontext
2449  /;
2450   
2451   
2452   
2453   
2454  **************************************************************************
      ******
2455  ***** Options, fixings, report preparation *****
2456  **************************************************************************
      ******
2457   
2458  * Solver options
2464   
      $onecho > cplex.opt
      lpmethod 4
      threads 4
      epgap 1e-3
      barcrossalg -1
      barepcomp 1e-8
      $offecho
      $ontext
2475   
2476  dieter.OptFile = 1;
2477  dieter.holdFixed = 1 ;
2478   
2479   
2480   
2481   
2482  **************************************************************************
      ******
2483  ***** Solve *****
2484  **************************************************************************
      ******
2485   
2486  * Preparation of GUSS tool for scenario analysis
2487  phi_min_res = eps ;
2488  ev_quant = eps ;
2489  phi_pro_self = eps ;
2490   
2492   
2493  Set
2494  modelstats       model stats collection                  /modelstat, solve
      stat, resusd/
2495  superscen        Scenarios                               /scen1*scen1000/
2496  map(superscen,loop_res_share,loop_ev,loop_prosumage)    /#superscen:(#loop
      _res_share.#loop_ev.#loop_prosumage)/
2497  ;
2498   
2499  set
2500  scen(superscen);
2501  scen(superscen) = yes$( sum((loop_res_share,loop_ev,loop_prosumage) , map(
      superscen,loop_res_share,loop_ev,loop_prosumage)) )    ;
2502   
2503  Parameters
2504  gussoptions                              /Logoption 2, Optfile 1, Skipbase
      case 1/
2505  modstats(superscen, modelstats)
2506  min_res
2507  number_ev
2508  pro_selfcon
2509  ;
2510   
2511  min_res(scen) = sum( (loop_res_share,loop_ev,loop_prosumage)$map(scen,loop
      _res_share,loop_ev,loop_prosumage) , loop_res_share.val/100 ) ;
2512  number_ev(scen) = sum( (loop_res_share,loop_ev,loop_prosumage)$map(scen,lo
      op_res_share,loop_ev,loop_prosumage) , loop_ev.val ) ;
2513  pro_selfcon(scen) = sum( (loop_res_share,loop_ev,loop_prosumage)$map(scen,
      loop_res_share,loop_ev,loop_prosumage) , loop_prosumage.val/100 ) ;
2514   
2515  Parameters
2516  * Equations
2517  marginal_con5a(superscen,*)
2518  marginal_con1a(superscen,*,*)
2519  marginal_con9a(superscen,*,*,*)
2520  marginal_con9b(superscen,*,*,*)
2521   
2522  * Basic
2523  lev_Z(superscen)
2524  lev_G_L(superscen,n,tech,h)
2525  lev_G_UP(superscen,n,tech,h)
2526  lev_G_DO(superscen,n,tech,h)
2527  lev_G_RES(superscen,n,tech,h)
2528  lev_CU(superscen,n,tech,h)
2529  lev_STO_IN(superscen,n,sto,h)
2530  lev_STO_OUT(superscen,n,sto,h)
2531  lev_STO_L(superscen,n,sto,h)
2532  lev_N_TECH(superscen,n,tech)
2533  lev_N_STO_E(superscen,n,sto)
2534  lev_N_STO_P(superscen,n,sto)
2535  lev_NTC(superscen,l)
2536  lev_F(superscen,l,h)
2537  lev_RSVR_OUT(superscen,n,rsvr,h)
2538  lev_RSVR_L(superscen,n,rsvr,h)
2539  lev_N_RSVR_E(superscen,n,rsvr)
2540  lev_N_RSVR_P(superscen,n,rsvr)
2541   
2542  * EV
2543  lev_EV_CHARGE(superscen,n,ev,h)
2544  lev_EV_DISCHARGE(superscen,n,ev,h)
2545  lev_EV_L(superscen,n,ev,h)
2546  lev_EV_PHEVFUEL(superscen,n,ev,h)
2547  lev_EV_GED(superscen,n,ev,h)
2548   
2549  * DSM
2550  lev_DSM_CU(superscen,n,dsm,h)
2551  lev_DSM_UP(superscen,n,dsm,h)
2552  lev_DSM_DO(superscen,n,dsm,h,hh)
2553  lev_DSM_UP_DEMAND(superscen,n,dsm,h)
2554  lev_DSM_DO_DEMAND(superscen,n,dsm,h)
2555  lev_N_DSM_CU(superscen,n,dsm)
2556  lev_N_DSM_SHIFT(superscen,n,dsm)
2557   
2558  * Reserves
2559  lev_RP_DIS(superscen,n,reserves,tech,h)
2560  lev_RP_NONDIS(superscen,n,reserves,tech,h)
2561  lev_RP_STO_IN(superscen,n,reserves,sto,h)
2562  lev_RP_STO_OUT(superscen,n,reserves,sto,h)
2563  lev_RP_RSVR(superscen,n,reserves,rsvr,h)
2564   
2565  * EV & reserves
2566  lev_RP_EV_V2G(superscen,n,reserves,ev,h)
2567  lev_RP_EV_G2V(superscen,n,reserves,ev,h)
2568   
2569  * DSM $ reserves
2570  lev_RP_DSM_CU(superscen,n,reserves,dsm,h)
2571  lev_RP_DSM_SHIFT(superscen,n,reserves,dsm,h)
2572   
2573  * Prosumage
2574  lev_CU_PRO(superscen,n,tech,h)
2575  lev_G_MARKET_PRO2M(superscen,n,tech,h)
2576  lev_G_MARKET_M2PRO(superscen,n,h)
2577  lev_G_RES_PRO(superscen,n,tech,h)
2578  lev_STO_IN_PRO2PRO(superscen,n,tech,sto,h)
2579  lev_STO_IN_PRO2M(superscen,n,tech,sto,h)
2580  lev_STO_IN_M2PRO(superscen,n,sto,h)
2581  lev_STO_IN_M2M(superscen,n,sto,h)
2582  lev_STO_OUT_PRO2PRO(superscen,n,sto,h)
2583  lev_STO_OUT_PRO2M(superscen,n,sto,h)
2584  lev_STO_OUT_M2PRO(superscen,n,sto,h)
2585  lev_STO_OUT_M2M(superscen,n,sto,h)
2586  lev_STO_L_PRO2PRO(superscen,n,sto,h)
2587  lev_STO_L_PRO2M(superscen,n,sto,h)
2588  lev_STO_L_M2PRO(superscen,n,sto,h)
2589  lev_STO_L_M2M(superscen,n,sto,h)
2590  lev_N_STO_E_PRO(superscen,n,sto)
2591  lev_N_STO_P_PRO(superscen,n,sto)
2592  lev_STO_L_PRO(superscen,n,sto,h)
2593  lev_N_RES_PRO(superscen,n,tech)
2594   
2595  * Heat
2596  lev_H_DIR(superscen,n,bu,ch,h)
2597  lev_H_SETS_LEV(superscen,n,bu,ch,h)
2598  lev_H_SETS_IN(superscen,n,bu,ch,h)
2599  lev_H_SETS_OUT(superscen,n,bu,ch,h)
2600  lev_H_HP_IN(superscen,n,bu,ch,h)
2601  lev_H_STO_LEV(superscen,n,bu,ch,h)
2602  lev_H_STO_IN_HP(superscen,n,bu,ch,h)
2603  lev_H_STO_IN_ELECTRIC(superscen,n,bu,ch,h)
2604  lev_H_ELECTRIC_IN(superscen,n,bu,ch,h)
2605  lev_H_STO_IN_FOSSIL(superscen,n,bu,ch,h)
2606  lev_H_STO_OUT(superscen,n,bu,ch,h)
2607   
2608  lev_H_DHW_STO(superscen,n,bu,ch,h)
2609  lev_H_DHW_STO_OUT(superscen,n,bu,ch,h)
2610  lev_H_DHW_DIR(superscen,n,bu,ch,h)
2611   
2612  lev_H_DHW_AUX_ELEC_IN(superscen,n,bu,ch,h)
2613  lev_H_DHW_AUX_LEV(superscen,n,bu,ch,h)
2614  lev_H_DHW_AUX_OUT(superscen,n,bu,ch,h)
2615   
2616   
2617  lev_RP_SETS(superscen,n,reserves,bu,ch,h)
2618  lev_RP_HP(superscen,n,reserves,bu,ch,h)
2619  lev_RP_H_ELEC(superscen,n,reserves,bu,ch,h)
2620  lev_RP_SETS_AUX(superscen,n,reserves,bu,ch,h)
2621   
2622  * Infeasibility
2623  lev_G_INFES(superscen,n,h)
2624  ;
2625   
2626   
2627  * Inclusion of scenario and fixing
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\fix.gms
2629   
2630  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
2640  **************************************************************************
      ******
2641   
2642   
2643   
2644  **************************************************************************
      ******
2645  **** Run of river  *******************************************************
      ******
2646  **************************************************************************
      ******
2647   
2648  * If $setglobal ror_parameter "*": choose appropriate value for N_CON.fx('
      ror') (but no reserve provision):
2649   
2650  *$ontext
2651  N_TECH.fx(n,'ror') = 5857.47 ;
2652  G_RES.fx(n,'ror',h) = N_TECH.l(n,'ror') * phi_res(n,'ror',h) ;
      RP_NONDIS.fx(n,reserves,'ror',h) = 0 ;
      $ontext
2657   
2658  * Fix everything to zero in case no ROR option is selected:
2659  *N_TECH.fx(n,'ror') = 0 ;
2660  *G_RES.fx(n,'ror',h) = 0 ;
2661  *RP_NONDIS.fx(n,reserves,'ror',h) = 0 ;
2662   
2663   
2664   
2665  **************************************************************************
      ******
2666  **** Exogenous EV  *******************************************************
      ******
2667  **************************************************************************
      ******
2668   
      %EV_EXOG%$ontext
      EV_DISCHARGE.fx(n,ev,h) = 0 ;
      RP_EV_G2V.fx(n,reserves,ev,h) = 0 ;
      RP_EV_V2G.fx(n,reserves,ev,h) = 0 ;
      $ontext
2676   
2677   
2678   
2679  **************************************************************************
      ******
2680  **** No storage and DSM in first period  *********************************
      ******
2681  **************************************************************************
      ******
2682   
2683  ** No storage inflow in first period **
2684  STO_IN.fx(n,sto,h)$(ord(h) = 1) = 0;
2685   
      ** No DSM load shifting in the first period **
      DSM_UP.fx(n,dsm_shift,h)$(ord(h) = 1) = 0;
      DSM_DO.fx(n,dsm_shift,h,hh)$(ord(h) = 1) = 0 ;
      DSM_DO.fx(n,dsm_shift,h,h)$(ord(h) = 1) = 0 ;
      DSM_UP_DEMAND.fx(n,dsm_shift,h)$(ord(h) = 1) = 0 ;
      DSM_DO_DEMAND.fx(n,dsm_shift,h)$(ord(h) = 1) = 0 ;
       
      ** No reserves provision by DSM in first period **
      RP_DSM_SHIFT.fx(n,reserves,dsm_shift,h)$(ord(h) = 1) = 0;
      RP_DSM_CU.fx(n,reserves,dsm_curt,h)$(ord(h) = 1) = 0 ;
      RP_DSM_CU.fx(n,reserves,dsm_curt,h)$(ord(h) = 1) = 0 ;
       
      ** No provision of PR and negative reserves by DSM load curtailment **
      RP_DSM_CU.fx(n,reserves_prim,dsm_curt,h) = 0 ;
      RP_DSM_CU.fx(n,reserves_do,dsm_curt,h) = 0 ;
       
      ** No provision of PR by DSM load shifting **
      RP_DSM_SHIFT.fx(n,reserves_prim,dsm_shift,h) = 0 ;
      $ontext
2707   
2708   
2709   
2710  **************************************************************************
      ******
2711  **** No primary reserves by heating devices  *****************************
      ******
2712  **************************************************************************
      ******
2713   
      %reserves%$ontext
      RP_HP.fx(n,reserves_prim,bu,hp,h) = 0 ;
      RP_SETS.fx(n,reserves_prim,bu,ch,h) = 0 ;
      RP_SETS_AUX.fx(n,reserves_prim,bu,ch,h) = 0 ;
      RP_H_ELEC.fx(n,reserves_prim,bu,ch,h) = 0 ;
      $ontext
2722   
2723   
2724   
2725  **************************************************************************
      ******
2726  **** Fixing to reduce model size  ****************************************
      ******
2727  **************************************************************************
      ******
2728   
2729  F.fx(l,h)$(m_ntc(l) = 0) = 0 ;
2730  NTC.fx(l)$(m_ntc(l) = 0) = 0 ;
2731   
2732  G_L.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
2733  G_UP.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
2734  G_DO.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
2735  N_TECH.fx(n,tech)$(m_p(n,tech) = 0) = 0 ;
2736  G_RES.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
2737  CU.fx(n,tech,h)$(m_p(n,tech) = 0) = 0 ;
2738   
2739  N_STO_P.fx(n,sto)$(m_sto_p(n,sto) = 0) = 0 ;
2740  N_STO_E.fx(n,sto)$(m_sto_e(n,sto) = 0) = 0 ;
2741  STO_IN.fx(n,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
2742  STO_OUT.fx(n,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
2743  STO_L.fx(n,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
2744  RP_STO_IN.fx(n,reserves,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
2745  RP_STO_OUT.fx(n,reserves,sto,h)$(m_sto_p(n,sto) = 0) = 0 ;
2746   
2747  RSVR_OUT.fx(n,rsvr,h)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
2748  RSVR_L.fx(n,rsvr,h)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
2749  N_RSVR_E.fx(n,rsvr)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
2750  N_RSVR_P.fx(n,rsvr)$(m_rsvr_p(n,rsvr) = 0) = 0 ;
2751   
      RP_DIS.fx(n,reserves,tech,h)$(feat_node('reserves',n) = 0 OR m_p(n,tech) =
       0) = 0 ;
      RP_NONDIS.fx(n,reserves,tech,h)$(feat_node('reserves',n) = 0 OR m_p(n,tech
      ) = 0) = 0 ;
      RP_STO_IN.fx(n,reserves,sto,h)$(feat_node('reserves',n) = 0 OR m_sto_p(n,s
      to) = 0) = 0 ;
      RP_STO_OUT.fx(n,reserves,sto,h)$(feat_node('reserves',n) = 0 OR m_sto_p(n,
      sto) = 0) = 0 ;
      RP_EV_V2G.fx(n,reserves,ev,h)$(feat_node('reserves',n) = 0) = 0 ;
      RP_EV_G2V.fx(n,reserves,ev,h)$(feat_node('reserves',n) = 0) = 0 ;
      RP_DSM_CU.fx(n,reserves,dsm_curt,h)$(feat_node('reserves',n) = 0 OR m_dsm_
      cu(n,dsm_curt) = 0) = 0 ;
      RP_DSM_SHIFT.fx(n,reserves,dsm_shift,h)$(feat_node('reserves',n) = 0 OR m_
      dsm_shift(n,dsm_shift) = 0) = 0 ;
      RP_RSVR.fx(n,reserves,rsvr,h)$(feat_node('reserves',n) = 0  OR m_rsvr_p(n,
      rsvr) = 0) = 0 ;
      $ontext
2764   
2765  *$ontext
2766  CU_PRO.fx(n,res,h)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,res) = 0) 
      = 0 ;
2767  G_MARKET_PRO2M.fx(n,res,h)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,re
      s) = 0) = 0 ;
2768  G_MARKET_M2PRO.fx(n,h)$(feat_node('prosumage',n) = 0) = 0 ;
2769  G_RES_PRO.fx(n,res,h)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,res) = 
      0) = 0 ;
2770  STO_IN_PRO2PRO.fx(n,res,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_
      p(n,sto) = 0) = 0 ;
2771  STO_IN_PRO2M.fx(n,res,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(
      n,sto) = 0) = 0 ;
2772  STO_IN_M2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,st
      o) = 0) = 0 ;
2773  STO_IN_M2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto)
       = 0) = 0 ;
2774  STO_OUT_PRO2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n
      ,sto) = 0) = 0 ;
2775  STO_OUT_PRO2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,s
      to) = 0) = 0 ;
2776  STO_OUT_M2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,s
      to) = 0) = 0 ;
2777  STO_OUT_M2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto
      ) = 0) = 0 ;
2778  STO_L_PRO2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,s
      to) = 0) = 0 ;
2779  STO_L_PRO2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto
      ) = 0) = 0 ;
2780  STO_L_M2PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto
      ) = 0) = 0 ;
2781  STO_L_M2M.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
2782  N_STO_E_PRO.fx(n,sto)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
2783  N_STO_P_PRO.fx(n,sto)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
2784  STO_L_PRO.fx(n,sto,h)$(feat_node('prosumage',n) = 0 OR m_sto_pro_p(n,sto) 
      = 0) = 0 ;
2785  N_RES_PRO.fx(n,res)$(feat_node('prosumage',n) = 0 OR m_res_pro(n,res) = 0)
       = 0 ;
2788   
2789  *$ontext
2790  STO_IN_PRO2M.fx(n,res,sto,h) = 0 ;
2791  STO_IN_M2PRO.fx(n,sto,h)     = 0 ;
2792  STO_IN_M2M.fx(n,sto,h)       = 0 ;
2793  STO_OUT_PRO2M.fx(n,sto,h)    = 0 ;
2794  STO_OUT_M2PRO.fx(n,sto,h)    = 0 ;
2795  STO_OUT_M2M.fx(n,sto,h)      = 0 ;
2796  STO_L_PRO2M.fx(n,sto,h)      = 0 ;
2797  STO_L_M2PRO.fx(n,sto,h)      = 0 ;
2798  STO_L_M2M.fx(n,sto,h)        = 0 ;
2801   
2802   
      EV_CHARGE.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_DISCHARGE.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_L.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_PHEVFUEL.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      EV_GED.fx(n,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      RP_EV_V2G.fx(n,reserves,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      RP_EV_G2V.fx(n,reserves,ev,h)$(feat_node('ev',n) = 0) = 0 ;
      $ontext
2813   
2814  *%heat%
      H_DIR.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_SETS_LEV.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_SETS_IN.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_SETS_OUT.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_HP_IN.up(n,bu,ch,hh)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_LEV.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_IN_HP.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_IN_ELECTRIC.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_IN_NONELECTRIC.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      H_STO_OUT.up(n,bu,ch,h)$(feat_node('heat',n) = 0) = 0 ;
      $ontext
2828   
2829   
2830   
2831  **************************************************************************
      ******
2832  **** DEFAULT LEVELS FOR REPORT PARAMETERS  *******************************
      ******
2833  **************************************************************************
      ******
2834   
2835  * Default level zero for report parameters
2836  lev_Z(scen) = 0 ;
2837  lev_G_L(scen,n,tech,h) = 0 ;
2838  lev_G_UP(scen,n,tech,h) = 0 ;
2839  lev_G_DO(scen,n,tech,h) = 0 ;
2840  lev_G_RES(scen,n,tech,h) = 0 ;
2841  lev_CU(scen,n,tech,h) = 0 ;
2842  lev_STO_IN(scen,n,sto,h) = 0 ;
2843  lev_STO_OUT(scen,n,sto,h) = 0 ;
2844  lev_STO_L(scen,n,sto,h) = 0 ;
2845  lev_N_TECH(scen,n,tech) = 0 ;
2846  lev_N_STO_E(scen,n,sto) = 0 ;
2847  lev_N_STO_P(scen,n,sto) = 0 ;
2848  marginal_con1a(scen,h,n) = 0 ;
2849  marginal_con5a(superscen,n) = 0 ;
2850  lev_NTC(superscen,l) = 0 ;
2851  lev_F(superscen,l,h) = 0 ;
2852  lev_RSVR_OUT(superscen,n,rsvr,h) = 0 ;
2853  lev_RSVR_L(superscen,n,rsvr,h) = 0 ;
2854  lev_N_RSVR_E(superscen,n,rsvr) = 0 ;
2855  lev_N_RSVR_P(superscen,n,rsvr) = 0 ;
2856  lev_G_INFES(superscen,n,h) = 0 ;
2857   
2858  * EV
2859  lev_EV_CHARGE(scen,n,ev,h) = 0 ;
2860  lev_EV_DISCHARGE(scen,n,ev,h) = 0 ;
2861  lev_EV_L(scen,n,ev,h) = 0 ;
2862  lev_EV_PHEVFUEL(scen,n,ev,h) = 0 ;
2863  lev_EV_GED(scen,n,ev,h) = 0 ;
2864   
2865  * DSM
2866  lev_DSM_CU(scen,n,dsm,h) = 0 ;
2867  lev_DSM_UP(scen,n,dsm,h) = 0 ;
2868  lev_DSM_DO(scen,n,dsm,h,hh) = 0 ;
2869  lev_DSM_UP_DEMAND(scen,n,dsm,h) = 0 ;
2870  lev_DSM_DO_DEMAND(scen,n,dsm,h) = 0 ;
2871  lev_N_DSM_CU(scen,n,dsm) = 0 ;
2872  lev_N_DSM_SHIFT(scen,n,dsm) = 0 ;
2873   
2874  * Reserves
2875  lev_RP_DIS(scen,n,reserves,dis,h) = 0 ;
2876  lev_RP_NONDIS(scen,n,reserves,nondis,h) = 0 ;
2877  lev_RP_STO_IN(scen,n,reserves,sto,h) = 0 ;
2878  lev_RP_STO_OUT(scen,n,reserves,sto,h) = 0 ;
2879  lev_RP_RSVR(superscen,n,reserves,rsvr,h) = 0 ;
2880   
2881  * EV & reserves
2882  lev_RP_EV_V2G(scen,n,reserves,ev,h) = 0 ;
2883  lev_RP_EV_G2V(scen,n,reserves,ev,h) = 0 ;
2884   
2885  * DSM & reserves
2886  lev_RP_DSM_CU(scen,n,reserves,dsm_curt,h) = 0 ;
2887  lev_RP_DSM_SHIFT(scen,n,reserves,dsm_shift,h) = 0 ;
2888   
2889  * Prosumage
2890  lev_CU_PRO(scen,n,tech,h) = 0 ;
2891  lev_G_MARKET_PRO2M(scen,n,tech,h) = 0  ;
2892  lev_G_MARKET_M2PRO(scen,n,h) = 0  ;
2893  lev_G_RES_PRO(scen,n,tech,h) = 0  ;
2894  lev_STO_IN_PRO2PRO(scen,n,tech,sto,h) = 0  ;
2895  lev_STO_IN_PRO2M(scen,n,tech,sto,h) = 0  ;
2896  lev_STO_IN_M2PRO(scen,n,sto,h) = 0   ;
2897  lev_STO_IN_M2M(scen,n,sto,h) = 0  ;
2898  lev_STO_OUT_PRO2PRO(scen,n,sto,h) = 0  ;
2899  lev_STO_OUT_PRO2M(scen,n,sto,h) = 0  ;
2900  lev_STO_OUT_M2PRO(scen,n,sto,h) = 0  ;
2901  lev_STO_OUT_M2M(scen,n,sto,h) = 0  ;
2902  lev_STO_L_PRO2PRO(scen,n,sto,h) = 0  ;
2903  lev_STO_L_PRO2M(scen,n,sto,h) = 0  ;
2904  lev_STO_L_M2PRO(scen,n,sto,h) = 0  ;
2905  lev_STO_L_M2M(scen,n,sto,h) = 0  ;
2906  lev_N_STO_E_PRO(scen,n,sto) = 0  ;
2907  lev_N_STO_P_PRO(scen,n,sto) = 0  ;
2908  lev_STO_L_PRO(scen,n,sto,h) = 0  ;
2909  lev_N_RES_PRO(scen,n,tech) = 0  ;
2910   
2911  * Heat
2912  lev_H_DIR(superscen,n,bu,ch,h) = 0 ;
2913  lev_H_SETS_LEV(superscen,n,bu,ch,h) = 0 ;
2914  lev_H_SETS_IN(superscen,n,bu,ch,h) = 0 ;
2915  lev_H_SETS_OUT(superscen,n,bu,ch,h) = 0 ;
2916  lev_H_HP_IN(superscen,n,bu,ch,h) = 0 ;
2917  lev_H_STO_LEV(superscen,n,bu,ch,h) = 0 ;
2918  lev_H_STO_IN_HP(superscen,n,bu,ch,h) = 0 ;
2919  lev_H_STO_IN_ELECTRIC(superscen,n,bu,ch,h) = 0 ;
2920  lev_H_STO_IN_FOSSIL(superscen,n,bu,ch,h) = 0 ;
2921  lev_H_STO_OUT(superscen,n,bu,ch,h) = 0 ;
2922   
2923  * Heat - DHW
2924  lev_H_DHW_DIR(superscen,n,bu,ch,h) = 0  ;
2925  lev_H_DHW_STO_OUT(superscen,n,bu,ch,h) = 0  ;
2926  lev_H_DHW_AUX_ELEC_IN(superscen,n,bu,ch,h) = 0  ;
2927  lev_H_DHW_AUX_LEV(superscen,n,bu,ch,h) = 0  ;
2928  lev_H_DHW_AUX_OUT(superscen,n,bu,ch,h) = 0  ;
2929   
2930  * Heat & reserves
2931  lev_RP_SETS_AUX(superscen,n,reserves,bu,ch,h) = 0 ;
2932  lev_RP_SETS(superscen,n,reserves,bu,ch,h) = 0 ;
2933  lev_RP_HP(superscen,n,reserves,bu,ch,h) = 0 ;
2934  lev_RP_H_ELEC(superscen,n,reserves,bu,ch,h) = 0 ;
2935   
2936   
2937  * Fixing of report parameters for run-of-river
2938  *$ontext
2939  lev_N_TECH(scen,n,'ror') = 5857.47 ;
2940  lev_G_RES(scen,n,'ror',h) = lev_N_TECH(scen,n,'ror') * phi_res(n,'ror',h) 
      ;
      lev_RP_NONDIS(scen,n,reserves,'ror',h) = 0 ;
      $ontext
2945   
2946  *lev_N_TECH(scen,n,'ror') = 0 ;
2947  *lev_G_RES(scen,n,'ror',h) = 0 ;
      %ror_parameter%%ror_variable%lev_RP_CON(scen,n,reserves,'ror',h) = 0 ;
      $ontext
2952   
2953   
2954   
2955   
2956   
2957   
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\scenario.gms
2959   
2960  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
2970  **************************************************************************
      ******
2971   
2972   
2973   
2974   
2975  *****************************************
2976  **** Scenario file                   ****
2977  ****                                 ****
2978  *****************************************
2979   
2980  Parameter
2981  m_exog_p(n,tech)
2982  m_exog_sto_e(n,sto)
2983  m_exog_sto_p(n,sto)
2984  m_exog_rsvr_p(n,rsvr)
2985  m_exog_ntc(l)
2986  ;
2987   
2988  m_exog_p(n,tech) = technology_data(n,tech,'fixed_capacities') ;
2989  m_exog_sto_e(n,sto) = storage_data(n,sto,'fixed_capacities_energy');
2990  m_exog_sto_p(n,sto) = storage_data(n,sto,'fixed_capacities_power');
2991  m_exog_rsvr_p(n,rsvr) = reservoir_data(n,rsvr,'fixed_capacities_power');
2992  m_exog_ntc(l) = topology_data(l,'fixed_capacities_ntc') ;
2993   
2994   
2995  *** Dispatch model
      N_TECH.lo(n,tech) = m_exog_p(n,tech) ;
      N_STO_P.lo(n,sto) = m_exog_sto_p(n,sto) ;
      N_STO_E.lo(n,sto) = m_exog_sto_e(n,sto) ;
      N_RSVR_P.lo(n,rsvr) =  m_exog_rsvr_p(n,rsvr) ;
      NTC.lo(l) = m_exog_ntc(l) ;
       
      N_TECH.up(n,tech) = m_exog_p(n,tech) + 0.1 ;
      N_STO_P.up(n,sto) = m_exog_sto_p(n,sto) + 0.1 ;
      N_STO_E.up(n,sto) = m_exog_sto_e(n,sto) + 0.1 ;
      N_RSVR_P.up(n,rsvr) =  m_exog_rsvr_p(n,rsvr) + 0.1 ;
      NTC.up(l) = m_exog_ntc(l) + 0.1 ;
       
      *N_TECH.lo(n,'OCGT') = m_exog_p(n,'OCGT') ;
      *N_TECH.up(n,'OCGT') = inf ;
3012   
3013  *** Investment model
3014  *$ontext
3015  N_TECH.lo(n,tech) = 0 ;
3016  N_TECH.lo(n,'wind_on') = m_exog_p(n,'wind_on') ;
3017  N_TECH.lo(n,'wind_off') = m_exog_p(n,'wind_off') ;
3018  N_TECH.lo(n,'pv') = m_exog_p(n,'pv') ;
3019  N_STO_P.lo(n,sto) = m_exog_sto_p(n,sto) ;
3020  N_STO_E.lo(n,sto) = m_exog_sto_e(n,sto) ;
3021  N_RSVR_P.lo(n,rsvr) =  m_exog_rsvr_p(n,rsvr) ;
3022  NTC.lo(l) = m_exog_ntc(l) ;
3023   
3024  N_TECH.up(n,tech) = m_exog_p(n,tech) + 0.1 ;
3025  N_TECH.up(n,'wind_on') = inf ;
3026  N_TECH.up(n,'wind_off') = inf ;
3027  N_TECH.up(n,'pv') = inf ;
3028  N_STO_P.up(n,sto) = m_exog_sto_p(n,sto) + 0.1 ;
3029  N_STO_E.up(n,sto) = m_exog_sto_e(n,sto) + 0.1 ;
3030  N_STO_P.up(n,'sto1') = inf ;
3031  N_STO_P.up(n,'sto5') = inf ;
3032  N_STO_P.up(n,'sto7') = inf ;
3033  N_STO_E.up(n,'sto1') = inf ;
3034  N_STO_E.up(n,'sto5') = inf ;
3035  N_STO_E.up(n,'sto7') = inf ;
3036  N_RSVR_P.up(n,rsvr) =  m_exog_rsvr_p(n,rsvr) + 0.1 ;
3037  NTC.up(l) = m_exog_ntc(l) + 0.1 ;
3038  *$offtext
3039   
3040   
3041  *** Reservoir assumption - not used here
3042  *phi_rsvr_lev_min(n,rsvr) = 0.0 ;
3043  *%GER_only%N_RSVR_E.lo('FR',rsvr) = 600 * m_exog_rsvr_p('FR',rsvr) ;
3044  *%GER_only%N_RSVR_E.lo('AT',rsvr) = 1700 * m_exog_rsvr_p('AT',rsvr) ;
3045  *%GER_only%N_RSVR_E.lo('CH',rsvr) = 3000 * m_exog_rsvr_p('CH',rsvr) ;
3046   
3047   
3048  *** Germany only, no infeasibility
3049  NTC.fx(l) = 0 ;
3050  F.fx(l,h) = 0 ;
3051  G_INFES.fx(n,h) = 0 ;
3052   
3053   
3054  *** Heating
3055  Parameter
3056  security_margin_n_heat_out /1.0/
3057  ;
3058   
3059  * Parameterization of water-based heat storage
3060  n_heat_p_out(n,bu,ch) = security_margin_n_heat_out * smax( h , dh(n,bu,ch,
      h) + d_dhw(n,bu,ch,h) ) ;
3061  n_heat_e(n,bu,ch) = 3 * n_heat_p_out(n,bu,ch) ;
3062  n_heat_p_in(n,bu,ch) = n_heat_p_out(n,bu,ch) ;
3063  n_heat_p_in(n,bu,'hp_gs') = n_heat_p_out(n,bu,'hp_gs') / ( eta_heat_dyn(n,
      bu,'hp_gs') * (temp_sink(n,bu,'hp_gs')+273.15) / (temp_sink(n,bu,'hp_gs') 
      - 10) ) ;
3064  * at least -5°C; applied to 98% of hoursn; minimum: -13.4
3065  n_heat_p_in(n,bu,'hp_as') = n_heat_p_out(n,bu,'hp_as') / ( eta_heat_dyn(n,
      bu,'hp_as') * (temp_sink(n,bu,'hp_as')+273.15) / (temp_sink(n,bu,'hp_as') 
      + 5) ) ;
3066   
3067  * Parameterization of SETS
3068  n_sets_p_out(n,bu,ch) = security_margin_n_heat_out * smax( h , dh(n,bu,ch,
      h) ) ;
3069  n_sets_p_in(n,bu,ch) = 2 * n_sets_p_out(n,bu,ch) ;
3070  n_sets_e(n,bu,ch) = 16 * n_sets_p_out(n,bu,ch) ;
3071   
3072  * Parameterization of DHW SETS
3073  n_sets_dhw_p_out(n,bu,ch) = security_margin_n_heat_out * smax( h , d_dhw(n
      ,bu,ch,h) ) ;
3074  n_sets_dhw_p_in(n,bu,ch) = n_sets_dhw_p_out(n,bu,ch) ;
3075  n_sets_dhw_e(n,bu,ch) = 2.2 * n_sets_dhw_p_out(n,bu,ch) ;
3076   
3077  *RP_SETS_AUX.fx(n,reserves,bu,ch,h) = 0 ;
3078  *RP_SETS.fx(n,reserves,bu,ch,h) = 0 ;
3079  *RP_HP.fx(n,reserves,bu,ch,h) = 0 ;
3080  *RP_H_ELEC.fx(n,reserves,bu,ch,h) = 0 ;
3081   
3082   
3083  * Definition of dictionary set for GUSS tool
3084  Set dict(*,*,*) /
3085  scen             .scenario       .''
3086  gussoptions      .opt            .modstats
3087   
3088  phi_min_res      .param          .min_res
      ev_quant         .param          .number_ev
      $ontext
3093  *$ontext
3094  phi_pro_self     .param          .pro_selfcon
3097   
3098  con5a_minRES     .marginal       .marginal_con5a
3099  con1a_bal        .marginal       .marginal_con1a
3100   
3101  Z                .level          .lev_Z
3102  G_L              .level          .lev_G_L
3103  G_UP             .level          .lev_G_UP
3104  G_DO             .level          .lev_G_DO
3105  G_RES            .level          .lev_G_RES
3106  CU               .level          .lev_CU
3107  STO_IN           .level          .lev_STO_IN
3108  STO_OUT          .level          .lev_STO_OUT
3109  STO_L            .level          .lev_STO_L
3110  N_TECH           .level          .lev_N_TECH
3111  N_STO_E          .level          .lev_N_STO_E
3112  N_STO_P          .level          .lev_N_STO_P
3113  NTC              .level          .lev_NTC
3114  F                .level          .lev_F
3115  RSVR_OUT         .level          .lev_RSVR_OUT
3116  RSVR_L           .level          .lev_RSVR_L
3117  N_RSVR_E         .level          .lev_N_RSVR_E
3118  N_RSVR_P         .level          .lev_N_RSVR_P
3119   
      EV_CHARGE        .level          .lev_EV_CHARGE
      EV_DISCHARGE     .level          .lev_EV_DISCHARGE
      EV_L             .level          .lev_EV_L
      EV_PHEVFUEL      .level          .lev_EV_PHEVFUEL
      EV_GED           .level          .lev_EV_GED
      $ontext
3128   
      DSM_CU           .level          .lev_DSM_CU
      DSM_UP           .level          .lev_DSM_UP
      DSM_DO           .level          .lev_DSM_DO
      DSM_UP_DEMAND    .level          .lev_DSM_UP_DEMAND
      DSM_DO_DEMAND    .level          .lev_DSM_DO_DEMAND
      N_DSM_CU         .level          .lev_N_DSM_CU
      N_DSM_SHIFT      .level          .lev_N_DSM_SHIFT
      $ontext
3139   
      RP_DIS           .level          .lev_RP_DIS
      RP_NONDIS        .level          .lev_RP_NONDIS
      RP_STO_IN        .level          .lev_RP_STO_IN
      RP_STO_OUT       .level          .lev_RP_STO_OUT
      RP_RSVR          .level          .lev_RP_RSVR
      $ontext
3148   
      con9a_reserve_prov_endogenous    .marginal       .marginal_con9a
      con9b_reserve_prov_PR_endogenous .marginal       .marginal_con9b
      $ontext
      con9a_reserve_prov_exogenous     .marginal       .marginal_con9a
      con9b_reserve_prov_PR_exogenous  .marginal       .marginal_con9b
      $ontext
3159   
      %EV%$ontext
      %EV_EXOG% RP_EV_V2G      .level          .lev_RP_EV_V2G
      %EV_EXOG% RP_EV_G2V      .level          .lev_RP_EV_G2V
      $ontext
3166   
      %DSM%$ontext
      RP_DSM_CU        .level          .lev_RP_DSM_CU
      RP_DSM_SHIFT     .level          .lev_RP_DSM_SHIFT
      $ontext
3173   
3174  *$ontext
3175  CU_PRO           .level          .lev_CU_PRO
3176  G_MARKET_PRO2M   .level          .lev_G_MARKET_PRO2M
3177  G_MARKET_M2PRO   .level          .lev_G_MARKET_M2PRO
3178  G_RES_PRO        .level          .lev_G_RES_PRO
3179  STO_IN_PRO2PRO   .level          .lev_STO_IN_PRO2PRO
3180  STO_IN_PRO2M     .level          .lev_STO_IN_PRO2M
3181  STO_IN_M2PRO     .level          .lev_STO_IN_M2PRO
3182  STO_IN_M2M       .level          .lev_STO_IN_M2M
3183  STO_OUT_PRO2PRO  .level          .lev_STO_OUT_PRO2PRO
3184  STO_OUT_PRO2M    .level          .lev_STO_OUT_PRO2M
3185  STO_OUT_M2PRO    .level          .lev_STO_OUT_M2PRO
3186  STO_OUT_M2M      .level          .lev_STO_OUT_M2M
3187  STO_L_PRO        .level          .lev_STO_L_PRO
3188  STO_L_PRO2PRO    .level          .lev_STO_L_PRO2PRO
3189  STO_L_PRO2M      .level          .lev_STO_L_PRO2M
3190  STO_L_M2PRO      .level          .lev_STO_L_M2PRO
3191  STO_L_M2M        .level          .lev_STO_L_M2M
3192  N_STO_E_PRO      .level          .lev_N_STO_E_PRO
3193  N_STO_P_PRO      .level          .lev_N_STO_P_PRO
3194  N_RES_PRO        .level          .lev_N_RES_PRO
3197   
      H_DIR                    .level          .lev_H_DIR
      H_SETS_LEV               .level          .lev_H_SETS_LEV
      H_SETS_IN                .level          .lev_H_SETS_IN
      H_SETS_OUT               .level          .lev_H_SETS_OUT
      H_HP_IN                  .level          .lev_H_HP_IN
      H_STO_LEV                .level          .lev_H_STO_LEV
      H_STO_IN_HP              .level          .lev_H_STO_IN_HP
      H_STO_IN_ELECTRIC        .level          .lev_H_STO_IN_ELECTRIC
      H_ELECTRIC_IN            .level          .lev_H_ELECTRIC_IN
      H_STO_IN_FOSSIL          .level          .lev_H_STO_IN_FOSSIL
      H_STO_OUT                .level          .lev_H_STO_OUT
       
      H_DHW_STO_OUT            .level          .lev_H_DHW_STO_OUT
      H_DHW_DIR                .level          .lev_H_DHW_DIR
       
      H_DHW_AUX_ELEC_IN        .level          .lev_H_DHW_AUX_ELEC_IN
      H_DHW_AUX_LEV            .level          .lev_H_DHW_AUX_LEV
      H_DHW_AUX_OUT            .level          .lev_H_DHW_AUX_OUT
       
      $ontext
3220   
      %reserves%$ontext
      RP_SETS          .level          .lev_RP_SETS
      RP_SETS_AUX      .level          .lev_RP_SETS_AUX
      RP_HP            .level          .lev_RP_HP
      RP_H_ELEC        .level          .lev_RP_H_ELEC
      $ontext
3229   
3230  G_INFES          .level          .lev_G_INFES
3231  /
3232  ;
3233   
3234  *$ontext
3235  phi_sto_ini(n,sto)     = 0 ;
3236  phi_sto_pro_ini(n,sto) = 0 ;
3239   
3240  solve DIETER using lp min Z scenario dict;
3241   
3242   
3243  * Reporting
INCLUDE    C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\report.gms
3245   
3246  **************************************************************************
      ******
      The Dispatch and Investment Evaluation Tool with Endogenous Renewables (DI
      ETER).
      Version 1.3.0, October 2017.
      Written by Alexander Zerrahn and Wolf-Peter Schill.
      This work is licensed under the MIT License (MIT).
      For more information on this license, visit http://opensource.org/licenses
      /mit-license.php.
      Whenever you use this code, please refer to http://www.diw.de/dieter.
      We are happy to receive feedback under azerrahn@diw.de and wschill@diw.de.
3256  **************************************************************************
      ******
3257   
3259   
3260   
3261   
3262   
3263  **************************************************************************
      ******
3264  **** Parameters for report file  *****************************************
      ******
3265  **************************************************************************
      ******
3266   
3267  Parameter
3268  corr_fac_dis             Balancing correction factor - dispatchable techno
      logies
3269  corr_fac_nondis          Balancing correction factor - nondispatchable tec
      hnologies
3270  corr_fac_sto             Balancing correction factor - storage technologie
      s
3271  corr_fac_dsm_cu          Balancing correction factor - DSM curtailment tec
      hnologies
3272  corr_fac_dsm_shift       Balancing correction factor - DSM shifting techno
      logies
3273  corr_fac_ev              Balancing correction factor - electric vehicles
3274  corr_fac_rsvr            Balancing correction factor - reservoir
3275  corr_fac_sets            Balancing correction factor - SETS
3276  corr_fac_sets_aux        Balancing correction factor - SETS auxiliary DHW
3277  corr_fac_hp              Balancing correction factor - heat pumps
3278  corr_fac_h_elec          Balancing correction factor - hybrid electric sto
      rage heating
3279   
3280  corr_fac_ev_sep
3281   
3282  gross_energy_demand                      Gross energy demand
3283  gross_energy_demand_market               Gross energy demand - market (non
      -prosumage segment)
3284  gross_energy_demand_prosumers            Gross energy demand - prosumagers
3285  gross_energy_demand_prosumers_selfgen    Gross energy demand - prosumagers
       self-generated
3286  gross_energy_demand_prosumers_market     Gross energy demand - prosumagers
       from market
3287   
3288  reserves_activated
3289   
3290  calc_maxprice
3291  calc_minprice
3292   
3293  report
3294  report_tech
3295  report_tech_hours
3296  report_hours
3297  report_node
3298  report_line
3299  report_cost
3300   
3301  report_reserves
3302  report_reserves_hours
3303  report_reserves_tech
3304  report_reserves_tech_hours
3305   
3306  report_prosumage
3307  report_prosumage_tech
3308  report_prosumage_tech_hours
3309  report_market
3310  report_market_tech
3311  report_market_tech_hours
3312   
3313  report_heat_tech_hours
3314  report_heat_tech
3315  ;
3316   
3317   
3318   
3319   
3320  **************************************************************************
      ******
3321  **** Initialize reporting paremetrs  *************************************
      ******
3322  **************************************************************************
      ******
3323   
3324  * Set reporting sensitivity. All results below will be reported as zero
3325  Scalar eps_rep_rel Sensitivity for shares defined between 0 and 1        /
       1e-4 / ;
3326  Scalar eps_rep_abs Sensitivity for absolute values - e.g. hourly         /
       1e-2 / ;
3327  Scalar eps_rep_ins Sensitivity for absolute values - e.g. installed MW   /
       1 /    ;
3328   
3329   
3330  * ------------------------------------------------------------------------
      ----
3331   
3332  * Min and max for prices
3333  calc_maxprice = 0 ;
3334  calc_minprice = 1000 ;
3335   
3336   
3337  * ------------------------------------------------------------------------
      ----
3338   
3339  * Default values for correction factors
3340  corr_fac_dis(scen,n,dis,h) = 0 ;
3341  corr_fac_nondis(scen,n,nondis,h) = 0 ;
3342  corr_fac_sto(scen,n,sto,h) = 0 ;
3343  corr_fac_dsm_cu(scen,n,dsm_curt,h) = 0 ;
3344  corr_fac_dsm_shift(scen,n,dsm_shift,h) = 0 ;
3345  corr_fac_ev(scen,n,h) = 0 ;
3346  corr_fac_rsvr(scen,n,rsvr,h) = 0 ;
3347  corr_fac_sets(scen,n,bu,ch,h) = 0 ;
3348  corr_fac_sets_aux(scen,n,bu,ch,h) = 0 ;
3349  corr_fac_hp(scen,n,bu,ch,h) = 0 ;
3350  corr_fac_h_elec(scen,n,bu,ch,h) = 0 ;
3351   
3352  corr_fac_ev_sep(scen,n,ev,h) = 0 ;
3353   
3354   
3355  * ------------------------------------------------------------------------
      ----
3356   
3357  * Parameter for hourly nodal reserves activated
3358  reserves_activated(scen,n,h) = 0 ;
      reserves_activated(scen,n,h)$(ord(h) > 1) =
      feat_node('reserves',n) * (
      sum( reserves_nonprim_up , phi_reserves_call(n,reserves_nonprim_up,h) * 10
      00 * phi_reserves_share(n,reserves_nonprim_up) * ( reserves_intercept(n,re
      serves_nonprim_up) + sum( nondis , reserves_slope(n,reserves_nonprim_up,no
      ndis) * (lev_N_TECH(scen,n,nondis) + lev_N_RES_PRO(scen,n,nondis)))/1000))
      - sum( reserves_nonprim_do , phi_reserves_call(n,reserves_nonprim_do,h) * 
      1000 * phi_reserves_share(n,reserves_nonprim_do) * ( reserves_intercept(n,
      reserves_nonprim_do) + sum( nondis , reserves_slope(n,reserves_nonprim_do,
      nondis) * (lev_N_TECH(scen,n,nondis) + lev_N_RES_PRO(scen,n,nondis)))/1000
      ))
      ) ;
      $ontext
3367   
      reserves_activated(scen,n,h)$(ord(h) > 1) =
      feat_node('reserves',n) * (
      sum( reserves_nonprim_up , phi_reserves_call(n,reserves_nonprim_up,h) * re
      serves_exogenous(n,reserves_nonprim_up,h))
      - sum( reserves_nonprim_do , phi_reserves_call(n,reserves_nonprim_do,h) * 
      reserves_exogenous(n,reserves_nonprim_do,h))
      ) ;
      $ontext
3376   
3377   
3378  * ------------------------------------------------------------------------
      ----
3379   
3380  * Prepare prosumage reporting parameters
3381  *$ontext
3382  gross_energy_demand_prosumers(scen,n) = sum( h , phi_pro_load(n) * d(n,h))
      ;
3383  gross_energy_demand_prosumers_selfgen(scen,n) = sum( (h,res) , lev_G_RES_P
      RO(scen,n,res,h)) + sum( (sto,h) , lev_STO_OUT_PRO2PRO(scen,n,sto,h) ) ;
3384  gross_energy_demand_prosumers_market(scen,n) = sum( h , lev_G_MARKET_M2PRO
      (scen,n,h)) + sum( (sto,h) , lev_STO_OUT_M2PRO(scen,n,sto,h) ) ;
3387   
3388   
3389  * ------------------------------------------------------------------------
      ----
3390   
3391  *Determine balancing correction factors
              corr_fac_dis(scen,n,tech,h) =
                sum( reserves_do ,  lev_RP_DIS(scen,n,reserves_do,tech,h) * phi_
      reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_DIS(scen,n,reserves_up,tech,h) * phi_
      reserves_call(n,reserves_up,h))
      ;
              corr_fac_nondis(scen,n,tech,h) =
                sum( reserves_do ,  lev_RP_NONDIS(scen,n,reserves_do,tech,h) * p
      hi_reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_NONDIS(scen,n,reserves_up,tech,h) * p
      hi_reserves_call(n,reserves_up,h))
      ;
              corr_fac_sto(scen,n,sto,h) =
                 sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( lev_R
      P_STO_IN(scen,n,reserves_do,sto,h) + lev_RP_STO_OUT(scen,n,reserves_do,sto
      ,h)) )
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( lev_R
      P_STO_IN(scen,n,reserves_up,sto,h) + lev_RP_STO_OUT(scen,n,reserves_up,sto
      ,h)) )
      ;
              corr_fac_rsvr(scen,n,rsvr,h) =
                sum( reserves_do ,  lev_RP_RSVR(scen,n,reserves_do,rsvr,h) * phi
      _reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_RSVR(scen,n,reserves_up,rsvr,h) * phi
      _reserves_call(n,reserves_up,h))
      ;
       
      %DSM%$ontext
              corr_fac_dsm_cu(scen,n,dsm_curt,h) =
             - sum( reserves_up , lev_RP_DSM_CU(scen,n,reserves_up,dsm_curt,h) *
       phi_reserves_call(n,reserves_up,h) )
      ;
              corr_fac_dsm_shift(scen,n,dsm_shift,h) =
                sum( reserves_do ,  lev_RP_DSM_SHIFT(scen,n,reserves_do,dsm_shif
      t,h) * phi_reserves_call(n,reserves_do,h))
              - sum( reserves_up ,  lev_RP_DSM_SHIFT(scen,n,reserves_up,dsm_shif
      t,h) * phi_reserves_call(n,reserves_up,h))
      ;
      $ontext
      %reserves%$ontext
               corr_fac_ev(scen,n,h) = sum( ev ,
               + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * (lev_RP
      _EV_G2V(scen,n,reserves_do,ev,h) + lev_RP_EV_V2G(scen,n,reserves_do,ev,h))
      )
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * (lev_RP
      _EV_G2V(scen,n,reserves_up,ev,h) + lev_RP_EV_V2G(scen,n,reserves_up,ev,h))
      ) )
      ;
       
               corr_fac_ev_sep(scen,n,ev,h) =
               + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * (lev_RP
      _EV_G2V(scen,n,reserves_do,ev,h) + lev_RP_EV_V2G(scen,n,reserves_do,ev,h))
      )
               - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * (lev_RP
      _EV_G2V(scen,n,reserves_up,ev,h) + lev_RP_EV_V2G(scen,n,reserves_up,ev,h))
      )
      ;
       
       
       
      $ontext
3436   
      %reserves%$ontext
               corr_fac_sets(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS(scen,n,reserves_up,bu,ch,h) ))
      ;
               corr_fac_sets_aux(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS_AUX(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      sets(n,bu,ch) * lev_RP_SETS_AUX(scen,n,reserves_up,bu,ch,h) ))
      ;
               corr_fac_hp(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      hp(n,bu,ch) * lev_RP_HP(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      hp(n,bu,ch) * lev_RP_HP(scen,n,reserves_up,bu,ch,h) ))
      ;
               corr_fac_h_elec(scen,n,bu,ch,h) =
              + sum( reserves_do , phi_reserves_call(n,reserves_do,h) * ( theta_
      storage(n,bu,ch) * lev_RP_H_ELEC(scen,n,reserves_do,bu,ch,h) ))
              - sum( reserves_up , phi_reserves_call(n,reserves_up,h) * ( theta_
      storage(n,bu,ch) * lev_RP_H_ELEC(scen,n,reserves_up,bu,ch,h) ))
      ;
      $ontext
3457   
3458   
3459  * ------------------------------------------------------------------------
      ----
3460   
3461  * Define gross energy demand for reporting
3462  gross_energy_demand(scen,n) = sum( h , d(n,h) + sum( sto , lev_STO_IN(scen
      ,n,sto,h) - lev_STO_OUT(scen,n,sto,h) )
3463  *$ontext
3464           + sum( sto , sum( res , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + le
      v_STO_IN_PRO2M(scen,n,res,sto,h) ) + lev_STO_IN_M2PRO(scen,n,sto,h) + lev_
      STO_IN_M2M(scen,n,sto,h) - lev_STO_OUT_PRO2PRO(scen,n,sto,h) - lev_STO_OUT
      _PRO2M(scen,n,sto,h) - lev_STO_OUT_M2PRO(scen,n,sto,h) - lev_STO_OUT_M2M(s
      cen,n,sto,h) )
               - sum( dsm_curt , lev_DSM_CU(scen,n,dsm_curt,h) )
               + sum( dsm_shift , lev_DSM_UP(scen,n,dsm_shift,h) - sum( hh$( ord
      (hh) >= ord(h) - t_dur_dsm_shift(n,dsm_shift) AND ord(hh) <= ord(h) + t_du
      r_dsm_shift(n,dsm_shift) ) , lev_DSM_DO(scen,n,dsm_shift,h,hh)) )
      $ontext
               + sum( ev , lev_EV_CHARGE(scen,n,ev,h) - lev_EV_DISCHARGE(scen,n,
      ev,h) )
      $ontext
               + reserves_activated(scen,n,h)
               + sum( sto , corr_fac_sto(scen,n,sto,h) )
      $ontext
      %reserves%$ontext
             - sum( (dsm,reserves_up) , lev_RP_DSM_CU(scen,n,reserves_up,dsm,h) 
      * phi_reserves_call(n,reserves_up,h) )
      $ontext
      %EV%$ontext
             + corr_fac_ev(scen,n,h)
      $ontext
              + sum( (bu,ch) , theta_dir(n,bu,ch) * lev_H_DIR(scen,n,bu,ch,h) + 
      theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n,bu,ch,h) + theta_hp(n,bu,ch) * 
      lev_H_HP_IN(scen,n,bu,ch,h) + theta_elec(n,bu,ch) * lev_H_ELECTRIC_IN(scen
      ,n,bu,ch,h) )
              + sum( (bu,ch) , theta_dir(n,bu,ch) * lev_H_DHW_DIR(scen,n,bu,ch,h
      ) + theta_sets(n,bu,ch) * lev_H_DHW_AUX_ELEC_IN(scen,n,bu,ch,h) )
      $ontext
      %reserves%$ontext
              + sum( (bu,ch) , corr_fac_sets(scen,n,bu,ch,h) + corr_fac_sets_aux
      (scen,n,bu,ch,h) + corr_fac_hp(scen,n,bu,ch,h) + corr_fac_h_elec(scen,n,bu
      ,ch,h) )
      $ontext
3501  )
3502  ;
3503   
3504   
3505  **************************************************************************
      ******
3506  **** Report  *************************************************************
      ******
3507  **************************************************************************
      ******
3508   
3509  * RPEORT model statistics
3510          report('model status',loop_res_share,loop_ev,loop_prosumage) = sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , modstats(scen,'m
      odelstat')) ;
3511          report('solve time',loop_res_share,loop_ev,loop_prosumage) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , modstats(scen,'res
      usd')) ;
3512          report('obj value',loop_res_share,loop_ev,loop_prosumage) = sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_Z(scen) * 1) ;
3513   
3514   
3515  * ------------------------------------------------------------------------
      ----
3516   
3517  * REPORT HOURS
3518          report_hours('demand consumers',loop_res_share,loop_ev,loop_prosum
      age,h,n) = d(n,h) ;
3519          report_hours('energy generated',loop_res_share,loop_ev,loop_prosum
      age,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , su
      m( dis , lev_G_L(scen,n,dis,h) ) + sum( nondis , lev_G_RES(scen,n,nondis,h
      ) - corr_fac_nondis(scen,n,nondis,h)) + sum( sto , lev_STO_OUT(scen,n,sto,
      h) - corr_fac_sto(scen,n,sto,h)) + sum( dsm_shift, lev_DSM_DO_DEMAND(scen,
      n,dsm_shift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) + sum( ev , lev_E
      V_DISCHARGE(scen,n,ev,h)) - corr_fac_ev(scen,n,h) + sum( rsvr , lev_RSVR_O
      UT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h)) + sum( res , lev_G_RES_P
      RO(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,res,h) + sum( sto , lev_STO_I
      N_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h))) + sum( 
      sto , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) 
      + lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_M2M(scen,n,sto,h)) ) ;
3520          report_hours('infeasibility',loop_res_share,loop_ev,loop_prosumage
      ,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      G_INFES(scen,n,h) ) ;
3521          report_hours('gross exports',loop_res_share,loop_ev,loop_prosumage
      ,h,n) = sum( l , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , -min(inc(l,n) * lev_F(scen,l,h),0) )) ;
3522          report_hours('gross imports',loop_res_share,loop_ev,loop_prosumage
      ,h,n) = sum( l , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , max(inc(l,n) * lev_F(scen,l,h),0) ) ) ;
3523          report_hours('price',loop_res_share,loop_ev,loop_prosumage,h,n) = 
      - sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , marginal_co
      n1a(scen,n,h)) ;
3524   
3525                   report_hours('energy generated',loop_res_share,loop_ev,lo
      op_prosumage,h,n)$(report_hours('energy generated',loop_res_share,loop_ev,
      loop_prosumage,h,n) < eps_rep_abs ) = 0 ;
3526                   report_hours('energy demanded',loop_res_share,loop_ev,loo
      p_prosumage,h,n)$(report_hours('energy demanded',loop_res_share,loop_ev,lo
      op_prosumage,h,n) < eps_rep_abs ) = 0 ;
3527                   report_hours('gross exports',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('gross exports',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs ) = 0 ;
3528                   report_hours('gross imports',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('gross imports',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs ) = 0 ;
3529                   report_hours('demand consumers',loop_res_share,loop_ev,lo
      op_prosumage,h,n)$(report_hours('demand consumers',loop_res_share,loop_ev,
      loop_prosumage,h,n) < eps_rep_abs) = 0 ;
3530                   report_hours('price',loop_res_share,loop_ev,loop_prosumag
      e,h,n)$(report_hours('price',loop_res_share,loop_ev,loop_prosumage,h,n) < 
      eps_rep_abs AND report_hours('price',loop_res_share,loop_ev,loop_prosumage
      ,h,n) > -eps_rep_abs) = eps ;
3531                   report_hours('infeasibility',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('infeasibility',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs) = 0 ;
3532   
3533   
3534  * ------------------------------------------------------------------------
      ----
3535   
3536  * REPORT TECH HOURS
3537          report_tech_hours('generation conventional',loop_res_share,loop_ev
      ,loop_prosumage,con,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_G_L(scen,n,con,h) + corr_fac_dis(scen,n,con,h)) ;
3538          report_tech_hours('infeasibility',loop_res_share,loop_ev,loop_pros
      umage,'',h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_G_INFES(scen,n,h) ) ;
3539          report_tech_hours('generation renewable',loop_res_share,loop_ev,lo
      op_prosumage,res,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_G_L(scen,n,res,h) + corr_fac_dis(scen,n,res,h) + lev_G_RES(
      scen,n,res,h) + lev_G_RES_PRO(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,re
      s,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(
      scen,n,res,sto,h)) ) ;
3540          report_tech_hours('generation renewable',loop_res_share,loop_ev,lo
      op_prosumage,rsvr,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_RSVR_OUT(scen,n,rsvr,h) ) ;
3541          report_tech_hours('reservoir inflow',loop_res_share,loop_ev,loop_p
      rosumage,rsvr,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , rsvr_in(n,rsvr,h)/1000 * lev_N_RSVR_E(scen,n,rsvr) ) ;
3542          report_tech_hours('reservoir level',loop_res_share,loop_ev,loop_pr
      osumage,rsvr,h,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_RSVR_L(scen,n,rsvr,h) ) ;
3543          report_tech_hours('curtailment of fluct res',loop_res_share,loop_e
      v,loop_prosumage,res,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loo
      p_prosumage)) , lev_CU(scen,n,res,h) + lev_CU_PRO(scen,n,res,h) ) ;
3544          report_tech_hours('generation storage',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_STO_OUT(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) + le
      v_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_ST
      O_OUT_M2M(scen,n,sto,h) ) ;
3545          report_tech_hours('storage loading',loop_res_share,loop_ev,loop_pr
      osumage,sto,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_STO_IN(scen,n,sto,h) + sum( res , lev_STO_IN_PRO2PRO(scen,n,res
      ,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h)) + lev_STO_IN_M2PRO(scen,n,st
      o,h) + lev_STO_IN_M2M(scen,n,sto,h) ) ;
3546          report_tech_hours('storage level',loop_res_share,loop_ev,loop_pros
      umage,sto,h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_STO_L(scen,n,sto,h) + lev_STO_L_PRO(scen,n,sto,h) ) ;
3547          report_tech_hours('netto exports',loop_res_share,loop_ev,loop_pros
      umage,'',h,n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , - sum( l , inc(l,n) * lev_F(scen,l,h)) ) ;
3548   
3549                   report_tech_hours('generation conventional',loop_res_shar
      e,loop_ev,loop_prosumage,con,h,n)$(report_tech_hours('generation conventio
      nal',loop_res_share,loop_ev,loop_prosumage,con,h,n) < eps_rep_abs) = 0 ;
3550                   report_tech_hours('generation renewable',loop_res_share,l
      oop_ev,loop_prosumage,res,h,n)$(report_tech_hours('generation renewable',l
      oop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
3551                   report_tech_hours('generation renewable',loop_res_share,l
      oop_ev,loop_prosumage,rsvr,h,n)$(report_tech_hours('generation renewable',
      loop_res_share,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0 ;
3552                   report_tech_hours('curtailment of fluct res',loop_res_sha
      re,loop_ev,loop_prosumage,res,h,n)$(report_tech_hours('curtailment of fluc
      t res',loop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
3553                   report_tech_hours('generation storage',loop_res_share,loo
      p_ev,loop_prosumage,sto,h,n)$(report_tech_hours('generation storage',loop_
      res_share,loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
3554                   report_tech_hours('storage loading',loop_res_share,loop_e
      v,loop_prosumage,sto,h,n)$(report_tech_hours('storage loading',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
3555                   report_tech_hours('storage level',loop_res_share,loop_ev,
      loop_prosumage,sto,h,n)$(report_tech_hours('storage level',loop_res_share,
      loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
3556                   report_tech_hours('netto exports',loop_res_share,loop_ev,
      loop_prosumage,'',h,n)$(abs(report_tech_hours('netto exports',loop_res_sha
      re,loop_ev,loop_prosumage,'',h,n)) < eps_rep_abs ) = 0 ;
3557                   report_tech_hours('infeasibility',loop_res_share,loop_ev,
      loop_prosumage,'',h,n)$(report_tech_hours('infeasibility',loop_res_share,l
      oop_ev,loop_prosumage,'',h,n) < eps_rep_abs ) = 0 ;
3558                   report_tech_hours('reservoir inflow',loop_res_share,loop_
      ev,loop_prosumage,rsvr,h,n)$(report_tech_hours('reservoir inflow',loop_res
      _share,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0 ;
3559                   report_tech_hours('reservoir level',loop_res_share,loop_e
      v,loop_prosumage,rsvr,h,n)$(report_tech_hours('reservoir level',loop_res_s
      hare,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0 ;
3560   
3561   
3562  * ------------------------------------------------------------------------
      ----
3563   
3564  * RPEORT LINE
3565           report_line('NTC',loop_res_share,loop_ev,loop_prosumage,l) = sum(
       scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_NTC(scen,l) 
      ) ;
3566                           report_line('NTC',loop_res_share,loop_ev,loop_pro
      sumage,l)$(report_line('NTC',loop_res_share,loop_ev,loop_prosumage,l) < ep
      s_rep_ins ) = 0 ;
3567   
3568           report_line('average line use',loop_res_share,loop_ev,loop_prosum
      age,l)$report_line('NTC',loop_res_share,loop_ev,loop_prosumage,l) = sum( s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h, abs(lev_F(
      scen,l,h)))) / sum( h , report_line('NTC',loop_res_share,loop_ev,loop_pros
      umage,l)) ;
3569                   report_line('avergae line use',loop_res_share,loop_ev,loo
      p_prosumage,l)$(report_line('average line use',loop_res_share,loop_ev,loop
      _prosumage,l) < eps_rep_rel) = 0 ;
3570   
3571   
3572  * ------------------------------------------------------------------------
      ----
3573   
3574  * REPORT NODE
3575          report_node('energy demand total',loop_res_share,loop_ev,loop_pros
      umage,n) = (sum( h , d(n,h) ) + sum( (sto,h) , sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h) + sum( res , le
      v_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h)) +
       lev_STO_IN_M2PRO(scen,n,sto,h) + lev_STO_IN_M2M(scen,n,sto,h)) )) * 1
              + sum( (dsm_shift,h) , sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage)) , lev_DSM_UP_DEMAND(scen,n,dsm_shift,h)) ) * %sec_hour%
      $ontext
               + sum( (ev,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_EV_CHARGE(scen,n,ev,h)) ) * %sec_hour%
      $ontext
               + sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , reserves_activated(scen,n,h)))
      $ontext
      *        + sum( (bu,ch,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , theta_dir(n,bu,ch) * ( lev_H_DIR(scen,n,bu,ch,h) + lev_H_DH
      W_DIR(scen,n,bu,ch,h) ) + theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n,bu,ch
      ,h) + theta_hp(n,bu,ch) * lev_H_HP_IN(scen,n,bu,ch,h) + theta_elec(n,bu,ch
      ) * lev_H_STO_IN_ELECTRIC(scen,n,bu,ch,h)) )
      $ontext
3592  ;
3593          report_node('energy demand gross',loop_res_share,loop_ev,loop_pros
      umage,n) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , g
      ross_energy_demand(scen,n)) ;
3594          report_node('energy generated net',loop_res_share,loop_ev,loop_pro
      sumage,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( dis , lev_G_L(scen,n,dis,h)) + sum( nondis , lev_G_RES(scen,n
      ,nondis,h) - corr_fac_nondis(scen,n,nondis,h)) + sum( rsvr , lev_RSVR_OUT(
      scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h)) + sum( res , phi_res(n,res,
      h) * lev_N_RES_PRO(scen,n,res) - lev_CU_PRO(scen,n,res,h)) )) ;
3595          report_node('energy generated gross',loop_res_share,loop_ev,loop_p
      rosumage,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , sum( dis , lev_G_L(scen,n,dis,h)) + sum( nondis , lev_G_RES(scen
      ,n,nondis,h) - corr_fac_nondis(scen,n,nondis,h)) + sum( rsvr , lev_RSVR_OU
      T(scen,n,rsvr,h)- corr_fac_rsvr(scen,n,rsvr,h)) + sum( sto , lev_STO_OUT(s
      cen,n,sto,h) - corr_fac_sto(scen,n,sto,h)) + sum( dsm_shift , lev_DSM_DO_D
      EMAND(scen,n,dsm_shift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) + sum(
       dsm_curt , lev_DSM_CU(scen,n,dsm_curt,h)) + sum( ev , lev_EV_DISCHARGE(sc
      en,n,ev,h)) - corr_fac_ev(scen,n,h) +  sum( res , phi_res(n,res,h) * lev_N
      _RES_PRO(scen,n,res) - lev_CU_PRO(scen,n,res,h)) + sum( sto , lev_STO_OUT_
      PRO2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) + lev_STO_OUT_M2PR
      O(scen,n,sto,h) + lev_STO_OUT_M2M(scen,n,sto,h)) )) ;
3596          report_node('net exports',loop_res_share,loop_ev,loop_prosumage,n)
       = sum( (l,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , - inc(l,n) * lev_F(scen,l,h)) ) ;
3597          report_node('gross exports',loop_res_share,loop_ev,loop_prosumage,
      n) = sum( (l,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , -min(inc(l,n) * lev_F(scen,l,h),0) ) ) ;
3598          report_node('gross imports',loop_res_share,loop_ev,loop_prosumage,
      n) = sum( (l,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , max(inc(l,n) * lev_F(scen,l,h),0) ) ) ;
3599          report_node('net import share in gross demand',loop_res_share,loop
      _ev,loop_prosumage,n) = -min(report_node('net exports',loop_res_share,loop
      _ev,loop_prosumage,n),0)/report_node('energy demand gross',loop_res_share,
      loop_ev,loop_prosumage,n) ;
3600          report_node('net export share in net generation',loop_res_share,lo
      op_ev,loop_prosumage,n) = max(report_node('net exports',loop_res_share,loo
      p_ev,loop_prosumage,n),0)/report_node('energy generated net',loop_res_shar
      e,loop_ev,loop_prosumage,n) ;
3601          report_node('trade capacity',loop_res_share,loop_ev,loop_prosumage
      ,n) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( l
       , abs(inc(l,n) * lev_NTC(scen,l))) ) ;
3602  *        report_node('gross import share',loop_res_share,loop_ev,loop_pros
      umage,n) = sum( h , report_hours('gross imports',loop_res_share,loop_ev,lo
      op_prosumage,h,n))/ sum( h , report_hours('energy demanded',loop_res_share
      ,loop_ev,loop_prosumage,h,n) ) ;
3603          report_node('gross export share in net generation',loop_res_share,
      loop_ev,loop_prosumage,n) = sum( h , report_hours('gross exports',loop_res
      _share,loop_ev,loop_prosumage,h,n))/sum( h , report_hours('energy generate
      d',loop_res_share,loop_ev,loop_prosumage,h,n) ) ;
3604          report_node('Capacity total',loop_res_share,loop_ev,loop_prosumage
      ,n) = sum( tech , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_N_TECH(scen,n,tech))) + sum( res , sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res))) + sum( sto , su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(sce
      n,n,sto) + lev_N_STO_P_PRO(scen,n,sto) )) + sum( rsvr , sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr)))
              + sum( dsm_curt , sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) ) + sum( dsm_shift , sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_SHIFT(scen,n
      ,dsm_shift)) )
      $ontext
3609  ;
3610          report_node('curtailment of fluct res absolute',loop_res_share,loo
      p_ev,loop_prosumage,n) = sum((nondis,h), sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , lev_CU_PRO(scen,n,nondis,h) + lev_CU(scen,n,no
      ndis,h))) * 1 ;
3611          report_node('curtailment of fluct res relative',loop_res_share,loo
      p_ev,loop_prosumage,n)$(sum((nondis,h), sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , phi_res(n,nondis,h) * (lev_N_TECH(scen,n,nondis
      )))) + sum((res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res))) > eps_rep_abs*card(r
      es)*card(h)) = (sum((res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loo
      p_prosumage)) , lev_CU_PRO(scen,n,res,h))) + sum((nondis,h), sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,nondis,h))))
       * 1 / (sum((res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res))) + sum((nondis,h), s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , phi_res(n,nond
      is,h) * (lev_N_TECH(scen,n,nondis))))) ;
3612          report_node('bio not utilized absolute',loop_res_share,loop_ev,loo
      p_prosumage,n)$(m_e(n,'bio')) = (m_e(n,'bio') - sum(h, sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,'bio',h)))) * 1 ;
3613          report_node('bio not utilized relative',loop_res_share,loop_ev,loo
      p_prosumage,n)$(m_e(n,'bio')) = (m_e(n,'bio') - sum(h, sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,'bio',h)))) / m_e
      (n,'bio') ;
3614          report_node('max price',loop_res_share,loop_ev,loop_prosumage,n)$s
      um(h,d(n,h)) = max( calc_maxprice , smax( h, sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , - marginal_con1a(scen,n,h))) ) ;
3615          report_node('min price',loop_res_share,loop_ev,loop_prosumage,n)$s
      um(h,d(n,h)) = min( calc_minprice , smin( h, sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , - marginal_con1a(scen,n,h))) ) ;
3616          report_node('mean price',loop_res_share,loop_ev,loop_prosumage,n)$
      sum(h,d(n,h)) = -sum(h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , marginal_con1a(scen,n,h)))/card(h) ;
3617   
3618                   report_node('energy demand total',loop_res_share,loop_ev,
      loop_prosumage,n)$(report_node('energy demand total',loop_res_share,loop_e
      v,loop_prosumage,n) < eps_rep_abs) = 0 ;
3619                   report_node('curtailment of fluct res absolute',loop_res_
      share,loop_ev,loop_prosumage,n)$(report_node('curtailment of fluct res abs
      olute',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs*card(h)*1) =
       0 ;
3620                   report_node('curtailment of fluct res relative',loop_res_
      share,loop_ev,loop_prosumage,n)$(report_node('curtailment of fluct res rel
      ative',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
3621                   report_node('bio not utilized absolute',loop_res_share,lo
      op_ev,loop_prosumage,n)$(report_node('bio not utilized absolute',loop_res_
      share,loop_ev,loop_prosumage,n) < eps_rep_abs*card(h)*1) = 0 ;
3622                   report_node('bio not utilized relative',loop_res_share,lo
      op_ev,loop_prosumage,n)$(report_node('bio not utilized relative',loop_res_
      share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
3623                   report_node('min price',loop_res_share,loop_ev,loop_prosu
      mage,n)$(report_node('min price',loop_res_share,loop_ev,loop_prosumage,n) 
      < eps_rep_abs AND report_node('min price',loop_res_share,loop_ev,loop_pros
      umage,n) > -eps_rep_abs) = eps ;
3624                   report_node('gross exports',loop_res_share,loop_ev,loop_p
      rosumage,n)$(report_node('gross exports',loop_res_share,loop_ev,loop_prosu
      mage,n) < eps_rep_abs*card(h)) = 0 ;
3625                   report_node('gross imports',loop_res_share,loop_ev,loop_p
      rosumage,n)$(report_node('gross imports',loop_res_share,loop_ev,loop_prosu
      mage,n) < eps_rep_abs*card(h)) = 0 ;
3626                   report_node('net exports',loop_res_share,loop_ev,loop_pro
      sumage,n)$(abs(report_node('net exports',loop_res_share,loop_ev,loop_prosu
      mage,n)) < eps_rep_abs*card(h)) = 0 ;
3627                   report_node('energy generated net',loop_res_share,loop_ev
      ,loop_prosumage,n)$(report_node('energy generated net',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_abs*card(h)) = 0 ;
3628                   report_node('energy generated gross',loop_res_share,loop_
      ev,loop_prosumage,n)$(report_node('energy generated gross',loop_res_share,
      loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
3629                   report_node('energy demand gross',loop_res_share,loop_ev,
      loop_prosumage,n)$(report_node('energy demand gross',loop_res_share,loop_e
      v,loop_prosumage,n) < eps_rep_abs*card(h)) = 0 ;
3630                   report_node('net import share in gross demand',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(report_node('net import share in gross dem
      and',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
3631                   report_node('net export share in net generation',loop_res
      _share,loop_ev,loop_prosumage,n)$(report_node('net export share in net gen
      eration',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
3632                   report_node('Capacity total',loop_res_share,loop_ev,loop_
      prosumage,n)$(report_node('Capacity total',loop_res_share,loop_ev,loop_pro
      sumage,n) < eps_rep_ins) = 0 ;
3633                   report_node('gross import share',loop_res_share,loop_ev,l
      oop_prosumage,n)$(report_node('gross import share',loop_res_share,loop_ev,
      loop_prosumage,n) < eps_rep_rel ) = 0 ;
3634                   report_node('gross export share in net generation',loop_r
      es_share,loop_ev,loop_prosumage,n)$(report_node('gross export share in net
       generation',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 
      ;
3635   
3636   
3637  * ------------------------------------------------------------------------
      ----
3638   
3639  * REPORT COST
3640          report_cost('Nodal cost: dispatch',loop_res_share,loop_ev,loop_pro
      sumage,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( dis , c_m(n,dis)*lev_G_L(scen,n,dis,h) + c_up(n,dis)*lev_G_UP
      (scen,n,dis,h)$(ord(h)>1) + c_do(n,dis)*lev_G_DO(scen,n,dis,h)) + sum( non
      dis , c_cu(n,nondis)*lev_CU(scen,n,nondis,h)) + sum( sto , c_m_sto(n,sto) 
      * ( lev_STO_OUT(scen,n,sto,h) + lev_STO_IN(scen,n,sto,h) ) )
                       + sum( dsm_curt , c_m_dsm_cu(n,dsm_curt)*lev_DSM_CU(scen,
      n,dsm_curt,h) ) + sum( dsm_shift , c_m_dsm_shift(n,dsm_shift)*(lev_DSM_UP_
      DEMAND(scen,n,dsm_shift,h) + lev_DSM_DO_DEMAND(scen,n,dsm_shift,h)))
      $ontext
                       + sum( ev , c_m_ev(n,ev) * lev_EV_DISCHARGE(scen,n,ev,h))
      $ontext
                       + sum( (reserves_up,sto) , phi_reserves_call(n,reserves_u
      p,h) * c_m_sto(n,sto) * (lev_RP_STO_OUT(scen,n,reserves_up,sto,h) - lev_RP
      _STO_IN(scen,n,reserves_up,sto,h)) ) - sum( (reserves_do,sto) , phi_reserv
      es_call(n,reserves_do,h) * c_m_sto(n,sto) * (lev_RP_STO_OUT(scen,n,reserve
      s_do,sto,h) - lev_RP_STO_IN(scen,n,reserves_do,sto,h)) ) + sum( (reserves_
      up,rsvr) , lev_RP_RSVR(scen,n,reserves_up,rsvr,h) * phi_reserves_call(n,re
      serves_up,h) * c_m_rsvr(n,rsvr) ) - sum( (reserves_do,rsvr) , lev_RP_RSVR(
      scen,n,reserves_do,rsvr,h) * phi_reserves_call(n,reserves_do,h) * c_m_rsvr
      (n,rsvr))
      $ontext
      %EV%$ontext
      %EV_EXOG%        + sum( (reserves_up,ev) , lev_RP_EV_V2G(scen,n,reserves_u
      p,ev,h) * phi_reserves_call(n,reserves_up,h) * c_m_ev(n,ev) ) - sum( (rese
      rves_do,ev) , lev_RP_EV_V2G(scen,n,reserves_do,ev,h) * phi_reserves_call(n
      ,reserves_do,h) * c_m_ev(n,ev) )
      %EV_EXOG%
      $ontext
      %reserves%$ontext
                       + sum( (reserves_up,dsm_curt) , lev_RP_DSM_CU(scen,n,rese
      rves_up,dsm_curt,h) * phi_reserves_call(n,reserves_up,h) * c_m_dsm_cu(n,ds
      m_curt) ) + sum( (reserves,dsm_shift) , lev_RP_DSM_SHIFT(scen,n,reserves,d
      sm_shift,h) * phi_reserves_call(n,reserves,h) * c_m_dsm_shift(n,dsm_shift)
       )
      $ontext
3664  ));
3665           report_cost('Nodal cost: investment & fix',loop_res_share,loop_ev
      ,loop_prosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( tech , c_i(n,tech)*lev_N_TECH(scen,n,tech) + c_fix(n,tech)*le
      v_N_TECH(scen,n,tech) ) + sum( sto , c_i_sto_e(n,sto)*lev_N_STO_E(scen,n,s
      to) + c_fix_sto(n,sto)/2*(lev_N_STO_P(scen,n,sto)+lev_N_STO_E(scen,n,sto))
       + c_i_sto_p(n,sto)*lev_N_STO_P(scen,n,sto) ) + sum( rsvr , c_i_rsvr_e(n,r
      svr)*lev_N_RSVR_E(scen,n,rsvr) + c_i_rsvr_p(n,rsvr)*lev_N_RSVR_P(scen,n,rs
      vr) + c_fix_rsvr(n,rsvr) * lev_N_RSVR_P(scen,n,rsvr))
                       + sum( dsm_curt , c_i_dsm_cu(n,dsm_curt)*lev_N_DSM_CU(sce
      n,n,dsm_curt) + c_fix_dsm_cu(n,dsm_curt)*lev_N_DSM_CU(scen,n,dsm_curt) ) +
       sum( dsm_shift , c_i_dsm_shift(n,dsm_shift)*lev_N_DSM_SHIFT(scen,n,dsm_sh
      ift) + c_fix_dsm_shift(n,dsm_shift)*lev_N_DSM_SHIFT(scen,n,dsm_shift) )
      $ontext
3670  *$ontext
3671                   + sum( res , c_i(n,res)*lev_N_RES_PRO(scen,n,res) + c_fix
      (n,res)*lev_N_RES_PRO(scen,n,res) ) + sum( sto , c_i_sto_e(n,sto)*lev_N_ST
      O_E_PRO(scen,n,sto) + c_fix_sto(n,sto)/2*(lev_N_STO_P_PRO(scen,n,sto) + le
      v_N_STO_E_PRO(scen,n,sto)) + c_i_sto_p(n,sto)*lev_N_STO_P_PRO(scen,n,sto))
       + sum( (sto,h) , c_m_sto(n,sto) * ( lev_STO_OUT_PRO2PRO(scen,n,sto,h) + l
      ev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) + lev_STO
      _OUT_M2M(scen,n,sto,h) + sum( res , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) +
       lev_STO_IN_PRO2M(scen,n,res,sto,h)) + lev_STO_OUT_PRO2M(scen,n,sto,h) + l
      ev_STO_OUT_M2M(scen,n,sto,h) ) )
3674  );
3675   
3676           report_cost('Nodal cost: infeasibility',loop_res_share,loop_ev,lo
      op_prosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( h , c_infes * lev_G_INFES(scen,n,h)) ) ;
3677           report_cost('Nodal cost: PHEV fuel',loop_res_share,loop_ev,loop_p
      rosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) ,
       sum( (h,ev) , pen_phevfuel(n,ev) * lev_EV_PHEVFUEL(scen,n,ev,h)) ) ;
3678           report_cost('Nodal cost: fossil heating',loop_res_share,loop_ev,l
      oop_prosumage,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , sum( (bu,hst,h) , pen_heat_fuel(n,bu,hst) * lev_H_STO_IN_FOSSIL(scen
      ,n,bu,hst,h)) ) ;
3679           report_cost('Nodal cost: total',loop_res_share,loop_ev,loop_prosu
      mage,n) = report_cost('Nodal cost: dispatch',loop_res_share,loop_ev,loop_p
      rosumage,n) + report_cost('Nodal cost: investment & fix',loop_res_share,lo
      op_ev,loop_prosumage,n) + report_cost('Nodal cost: infeasibility',loop_res
      _share,loop_ev,loop_prosumage,n) + report_cost('Nodal cost: PHEV fuel',loo
      p_res_share,loop_ev,loop_prosumage,n) + report_cost('Nodal cost: fossil he
      ating',loop_res_share,loop_ev,loop_prosumage,n) ;
3680           report_cost('Costs lines',loop_res_share,loop_ev,loop_prosumage,l
      ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , c_i_ntc(l
      ) * lev_NTC(scen,l)*dist(l) ) ;
3681   
3682                   report_cost('Nodal cost: dispatch',loop_res_share,loop_ev
      ,loop_prosumage,n)$(report_cost('Nodal cost: dispatch',loop_res_share,loop
      _ev,loop_prosumage,n) < card(h) * eps_rep_abs) = 0 ;
3683                   report_cost('Nodal cost: investment & fix',loop_res_share
      ,loop_ev,loop_prosumage,n)$(report_cost('Nodal cost: investment & fix',loo
      p_res_share,loop_ev,loop_prosumage,n) < eps_rep_ins) = 0 ;
3684                   report_cost('Nodal cost: infeasibility',loop_res_share,lo
      op_ev,loop_prosumage,n)$(report_cost('Nodal cost: infeasibility',loop_res_
      share,loop_ev,loop_prosumage,n) < card(h) * eps_rep_abs) = 0 ;
3685                   report_cost('Nodal cost: PHEV fuel',loop_res_share,loop_e
      v,loop_prosumage,n)$(report_cost('Nodal cost: PHEV fuel',loop_res_share,lo
      op_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
3686                   report_cost('Nodal cost: fossil heating',loop_res_share,l
      oop_ev,loop_prosumage,n)$(report_cost('Nodal cost: fossil heating',loop_re
      s_share,loop_ev,loop_prosumage,n) < card(h) * eps_rep_abs) = 0 ;
3687                   report_cost('Nodal cost: total',loop_res_share,loop_ev,lo
      op_prosumage,n)$(report_cost('Nodal cost: total',loop_res_share,loop_ev,lo
      op_prosumage,n) < eps_rep_abs) = 0 ;
3688                   report_cost('Costs lines',loop_res_share,loop_ev,loop_pro
      sumage,l)$(report_cost('Costs lines',loop_res_share,loop_ev,loop_prosumage
      ,l) < eps_rep_ins) = 0 ;
3689   
3690   
3691  * ------------------------------------------------------------------------
      ----
3692   
3693  * REPORT TECH
3694          report_tech('capacities conventional',loop_res_share,loop_ev,loop_
      prosumage,con,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_N_TECH(scen,n,con)) ;
3695          report_tech('capacities renewable',loop_res_share,loop_ev,loop_pro
      sumage,res,n) = 0 + sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_N_TECH(scen,n,res) + lev_N_RES_PRO(scen,n,res)) ;
3696          report_tech('capacities reservoir MW',loop_res_share,loop_ev,loop_
      prosumage,rsvr,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_N_RSVR_P(scen,n,rsvr));
3697          report_tech('capacities reservoir MWh',loop_res_share,loop_ev,loop
      _prosumage,rsvr,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_N_RSVR_E(scen,n,rsvr));
3698          report_tech('capacities storage MW',loop_res_share,loop_ev,loop_pr
      osumage,sto,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , lev_N_STO_P(scen,n,sto)+ lev_N_STO_P_PRO(scen,n,sto)) ;
3699          report_tech('capacities storage MWh',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_N_STO_E(scen,n,sto)+ lev_N_STO_E_PRO(scen,n,sto)) * 1 ;
3700   
3701          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,con,n) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_TECH(scen,n,con) ) / report_node('Capacity total',loop_res_share,loop_
      ev,loop_prosumage,n) + 1e-9 ;
3702          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,res,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _N_TECH(scen,n,res)) / report_node('Capacity total',loop_res_share,loop_ev
      ,loop_prosumage,n) + 1e-9 ;
3703          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,rsvr,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_RSVR_P(scen,n,rsvr)) / report_node('Capacity total',loop_res_share,loo
      p_ev,loop_prosumage,n) + 1e-9 ;
3704          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,res,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _N_TECH(scen,n,res) + lev_N_RES_PRO(scen,n,res) ) / report_node('Capacity 
      total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
3705          report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,sto,n) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _N_STO_P(scen,n,sto) + lev_N_STO_P_PRO(scen,n,sto) ) / report_node('Capaci
      ty total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
3706   
3707          report_tech('renshares in nodal gross demand',loop_res_share,loop_
      ev,loop_prosumage,res,n) = sum( h, sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,re
      s,h) + lev_G_RES_PRO(scen,n,res,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,
      res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h)) + lev_G_RES(scen,n,res,h)
       - corr_fac_nondis(scen,n,res,h))) / sum( scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , gross_energy_demand(scen,n) ) ;
3708          report_tech('renshares in nodal gross demand',loop_res_share,loop_
      ev,loop_prosumage,rsvr,n) = sum( h, sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,
      rsvr,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) ,
       gross_energy_demand(scen,n) ) ;
3709          report_tech('conshares in nodal gross demand',loop_res_share,loop_
      ev,loop_prosumage,con,n) = sum( h, sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,con,h)) ) / sum( scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , gross_energy_demand(scen,n) ) ;
3710          report_tech('renshares in nodal net generation',loop_res_share,loo
      p_ev,loop_prosumage,res,n)$report_node('energy generated net',loop_res_sha
      re,loop_ev,loop_prosumage,n) = sum( h, sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,
      n,res,h) + lev_G_RES_PRO(scen,n,res,h) + sum( sto , lev_STO_IN_PRO2PRO(sce
      n,n,res,sto,h)) + lev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h))
      ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , report_n
      ode('energy generated net',loop_res_share,loop_ev,loop_prosumage,n) ) ;
3711          report_tech('renshares in nodal net generation',loop_res_share,loo
      p_ev,loop_prosumage,rsvr,n)$report_node('energy generated net',loop_res_sh
      are,loop_ev,loop_prosumage,n) = sum( h, sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(sce
      n,n,rsvr,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , report_node('energy generated net',loop_res_share,loop_ev,loop_prosum
      age,n) ) ;
3712          report_tech('conshares in nodal net generation',loop_res_share,loo
      p_ev,loop_prosumage,con,n)$report_node('energy generated net',loop_res_sha
      re,loop_ev,loop_prosumage,n) = sum( h, sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_G_L(scen,n,con,h)) ) / sum( scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , report_node('energy generated net
      ',loop_res_share,loop_ev,loop_prosumage,n) ) ;
3713   
3714          report_tech('curtailment of fluct res absolute',loop_res_share,loo
      p_ev,loop_prosumage,res,n) =  sum(h, sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_CU(scen,n,res,h) + lev_CU_PRO(scen,n,res,h) ))
       * 1 ;
3715          report_tech('curtailment of fluct res relative',loop_res_share,loo
      p_ev,loop_prosumage,res,n)$(report_tech('curtailment of fluct res absolute
      ',loop_res_share,loop_ev,loop_prosumage,res,n) AND sum(h, sum(scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES_PRO(scen,n,res,h) +
       lev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) ) + sum(h, sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PRO(scen,n,
      res,h) + lev_CU(scen,n,res,h))) > card(h)*eps_rep_abs ) =  sum(h, sum(scen
      $(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,res,h) 
      + lev_CU_PRO(scen,n,res,h) ))/( sum( h , sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , phi_res(n,res,h) * (lev_N_TECH(scen,n,res) + l
      ev_N_RES_PRO(scen,n,res) ))) ) ;
3716   
3717          report_tech('Storage out total non-reserves',loop_res_share,loop_e
      v,loop_prosumage,sto,n) = sum(h, report_tech_hours('generation storage',lo
      op_res_share,loop_ev,loop_prosumage,sto,h,n) ) * 1 ;
3718          report_tech('Storage in total non-reserves',loop_res_share,loop_ev
      ,loop_prosumage,sto,n) = sum(h, report_tech_hours('storage loading',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n) ) * 1 ;
3719   
3720          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,con,n)$(su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen
      ,n,con)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,con,h)) ) / sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,con)) ;
3721          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,res,n)$(su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen
      ,n,res)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,re
      s,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,res,sto,h)) + lev_G_RES_PRO(sc
      en,n,res,h) + lev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h))) / 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(sc
      en,n,res)) ;
3722          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,rsvr,n)$(s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(s
      cen,n,rsvr)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen
      ,n,rsvr,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_N_RSVR_P(scen,n,rsvr)) ;
3723          report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(sce
      n,n,sto)) > eps_rep_ins) = ( report_tech('Storage out total non-reserves',
      loop_res_share,loop_ev,loop_prosumage,sto,n)) / sum(scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) ;
3724   
3725   
3726                   report_tech('capacities conventional',loop_res_share,loop
      _ev,loop_prosumage,con,n)$(report_tech('capacities conventional',loop_res_
      share,loop_ev,loop_prosumage,con,n) < eps_rep_ins) = 0 ;
3727                   report_tech('capacities renewable',loop_res_share,loop_ev
      ,loop_prosumage,res,n)$(report_tech('capacities renewable',loop_res_share,
      loop_ev,loop_prosumage,res,n) < eps_rep_ins) = 0 ;
3728                   report_tech('capacities storage MW',loop_res_share,loop_e
      v,loop_prosumage,sto,n)$(report_tech('capacities storage MW',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) < eps_rep_ins) = 0 ;
3729                   report_tech('capacities storage MWh',loop_res_share,loop_
      ev,loop_prosumage,sto,n)$(report_tech('capacities storage MWh',loop_res_sh
      are,loop_ev,loop_prosumage,sto,n) < eps_rep_ins) = 0 ;
3730                   report_tech('capacities reservoir MW',loop_res_share,loop
      _ev,loop_prosumage,rsvr,n)$(report_tech('capacities reservoir MW',loop_res
      _share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_ins) = 0 ;
3731                   report_tech('capacities reservoir MWh',loop_res_share,loo
      p_ev,loop_prosumage,rsvr,n)$(report_tech('capacities reservoir MWh',loop_r
      es_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_ins) = 0 ;
3732                   report_tech('renshares in nodal gross demand',loop_res_sh
      are,loop_ev,loop_prosumage,res,n)$(report_tech('renshares in nodal gross d
      emand',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) = 0 ;
3733                   report_tech('renshares in nodal gross demand',loop_res_sh
      are,loop_ev,loop_prosumage,rsvr,n)$(report_tech('renshares in nodal gross 
      demand',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
3734                   report_tech('conshares in nodal gross demand',loop_res_sh
      are,loop_ev,loop_prosumage,con,n)$(report_tech('conshares in nodal gross d
      emand',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_rel) = 0 ;
3735                   report_tech('renshares in nodal net generation',loop_res_
      share,loop_ev,loop_prosumage,res,n)$(report_tech('renshares in nodal net g
      eneration',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) = 0
       ;
3736                   report_tech('renshares in nodal net generation',loop_res_
      share,loop_ev,loop_prosumage,rsvr,n)$(report_tech('renshares in nodal net 
      generation',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_rel) =
       0 ;
3737                   report_tech('conshares in nodal net generation',loop_res_
      share,loop_ev,loop_prosumage,con,n)$(report_tech('conshares in nodal net g
      eneration',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_rel) = 0
       ;
3738                   report_tech('curtailment of fluct res absolute',loop_res_
      share,loop_ev,loop_prosumage,res,n)$(report_tech('curtailment of fluct res
       absolute',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_abs*card
      (h)*1) = 0 ;
3739                   report_tech('curtailment of fluct res relative',loop_res_
      share,loop_ev,loop_prosumage,res,n)$(report_tech('curtailment of fluct res
       relative',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) = 0
       ;
3740                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,con,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loop
      _prosumage,con,n) < eps_rep_rel) = 0 ;
3741                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,res,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loop
      _prosumage,res,n) < eps_rep_rel) = 0 ;
3742                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,rsvr,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loo
      p_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
3743                   report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,sto,n)$(report_tech('Capacity share',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_rel) = 0 ;
3744                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,c
      on,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,con,n) < ep
      s_rep_abs) = 0 ;
3745                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,r
      es,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,res,n) < ep
      s_rep_abs) = 0 ;
3746                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,r
      svr,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < 
      eps_rep_abs) = 0 ;
3747                   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,s
      to,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n) < ep
      s_rep_abs) = 0 ;
3748                   report_tech('Storage out total non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage out total non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs*card(h)*1)
       = 0 ;
3749                   report_tech('Storage in total non-reserves',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage in total non-reserve
      s',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs*card(h)*1) =
       0 ;
3750   
3751   
3752  * ------------------------------------------------------------------------
      ----
3753   
3754  * REPORT NODE
3755          report_node('renshare in nodal gross demand',loop_res_share,loop_e
      v,loop_prosumage,n) = sum(res, report_tech('renshares in nodal gross deman
      d',loop_res_share,loop_ev,loop_prosumage,res,n)) + sum( rsvr , report_tech
      ('renshares in nodal gross demand',loop_res_share,loop_ev,loop_prosumage,r
      svr,n)) ;
3756          report_node('conshare in nodal gross demand',loop_res_share,loop_e
      v,loop_prosumage,n) = sum(con, report_tech('conshares in nodal gross deman
      d',loop_res_share,loop_ev,loop_prosumage,con,n) ) ;
3757          report_node('net import share in nodal gross demand',loop_res_shar
      e,loop_ev,loop_prosumage,n) = - report_node('net exports',loop_res_share,l
      oop_ev,loop_prosumage,n) / sum( scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , gross_energy_demand(scen,n) ) ;
3758          report_node('renshare in nodal net generation',loop_res_share,loop
      _ev,loop_prosumage,n) = sum(res, report_tech('renshares in nodal net gener
      ation',loop_res_share,loop_ev,loop_prosumage,res,n)) + sum( rsvr , report_
      tech('renshares in nodal net generation',loop_res_share,loop_ev,loop_prosu
      mage,rsvr,n)) ;
3759          report_node('conshare in nodal net generation',loop_res_share,loop
      _ev,loop_prosumage,n) = sum(con, report_tech('conshares in nodal net gener
      ation',loop_res_share,loop_ev,loop_prosumage,con,n) ) ;
3760   
3761                   report_node('renshare in nodal gross demand',loop_res_sha
      re,loop_ev,loop_prosumage,n) $(report_node('renshare in nodal gross demand
      ',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
3762                   report_node('conshare in nodal gross demand',loop_res_sha
      re,loop_ev,loop_prosumage,n)$(report_node('conshare in nodal gross demand'
      ,loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
3763                   report_node('renshare in nodal net generation',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(report_node('renshare in nodal net generat
      ion',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
3764                   report_node('conshare in nodal net generation',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(report_node('conshare in nodal net generat
      ion',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel ) = 0 ;
3765   
3766   
3767   
3768  * ------------------------------------------------------------------------
      ----
3769   
3770  * REPORT TECH
3771          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      con,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_G_L(scen,n,con,h) ) ) ;
3772          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      res,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,res,h) + sum(sto , 
      lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN_PRO2M(scen,n,res,sto,h))
       + lev_G_RES_PRO(scen,n,res,h) + lev_G_RES(scen,n,res,h) - corr_fac_nondis
      (scen,n,res,h))) ;
3773          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      rsvr,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h) ) ) ;
3774          report_tech('Yearly energy',loop_res_share,loop_ev,loop_prosumage,
      sto,n) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_PRO2M(scen,n,sto,h) +
       lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_M2M(scen,n,sto,h) + lev_STO
      _OUT(scen,n,sto,h) - corr_fac_sto(scen,n,sto,h)) ) ;
3775   
3776          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,con,n) = sum( h , sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_G_L(scen,n,con,h) ) ) / report_node('ene
      rgy generated gross',loop_res_share,loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
3777          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,res,n) = sum( h , sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(s
      cen,n,res,h) + sum(sto , lev_STO_IN_PRO2PRO(scen,n,res,sto,h) + lev_STO_IN
      _PRO2M(scen,n,res,sto,h)) + lev_G_RES_PRO(scen,n,res,h) + lev_G_RES(scen,n
      ,res,h) - corr_fac_nondis(scen,n,res,h))) / report_node('energy generated 
      gross',loop_res_share,loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
3778          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,rsvr,n) = sum( h , sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr
      (scen,n,rsvr,h) ) ) / report_node('energy generated gross',loop_res_share,
      loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
3779          report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) = sum( h , sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_
      OUT_PRO2M(scen,n,sto,h) + lev_STO_OUT_M2PRO(scen,n,sto,h) + lev_STO_OUT_M2
      M(scen,n,sto,h) + lev_STO_OUT(scen,n,sto,h) - corr_fac_sto(scen,n,sto,h)) 
      ) / report_node('energy generated gross',loop_res_share,loop_ev,loop_prosu
      mage,n) * 1 + 1e-9 ;
3780   report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto
      ) + lev_N_STO_P_PRO(scen,n,sto) ) > eps_rep_ins) = report_tech('Storage ou
      t total non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n) / sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n
      ,sto) + lev_N_STO_P_PRO(scen,n,sto) ) ;
3781   report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumage,sto,n)
      $(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E
      (scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) > eps_rep_ins) = report_tech(
      'Storage out total non-reserves',loop_res_share,loop_ev,loop_prosumage,sto
      ,n) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_S
      TO_E(scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) * 1 ;
3782   
3783                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,con,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,con,n) < eps_rep_ins ) = 0 ;
3784                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,res,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,res,n) < eps_rep_ins ) = 0 ;
3785                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,rsvr,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_
      prosumage,rsvr,n) < eps_rep_ins ) = 0 ;
3786                   report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,sto,n)$(report_tech('Yearly energy',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_ins ) = 0 ;
3787   
3788                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,con,n)$(report_tech('Energy share in nod
      al gross generation',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_re
      p_rel) = 0 ;
3789                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,res,n)$(report_tech('Energy share in nod
      al gross generation',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_re
      p_rel) = 0 ;
3790                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,rsvr,n)$(report_tech('Energy share in no
      dal gross generation',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_
      rep_rel) = 0 ;
3791                   report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Energy share in nod
      al gross generation',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_re
      p_rel) = 0 ;
3792         report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(rep
      ort_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs)
       = 0 ;
3793         report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumage,
      sto,n)$(report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumage
      ,sto,n) < eps_rep_abs) = 0 ;
3794   
3795   
3796  * ------------------------------------------------------------------------
      ----
3797   
3798  * RPEORT
3799          report('curtailment of fluct res absolute',loop_res_share,loop_ev,
      loop_prosumage) = sum( n , report_node('curtailment of fluct res absolute'
      ,loop_res_share,loop_ev,loop_prosumage,n) ) ;
3800          report('curtailment of fluct res relative',loop_res_share,loop_ev,
      loop_prosumage) = sum( n , report_node('curtailment of fluct res absolute'
      ,loop_res_share,loop_ev,loop_prosumage,n) ) / sum((res,h,n), sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , phi_res(n,res,h) * (lev_N_
      TECH(scen,n,res) + lev_N_RES_PRO(scen,n,res)) )) ;
3801          report('bio not utilized absolute',loop_res_share,loop_ev,loop_pro
      sumage)$(sum( n , m_e(n,'bio'))) = sum( n , report_node('bio not utilized 
      absolute',loop_res_share,loop_ev,loop_prosumage,n) ) ;
3802          report('bio not utilized relative',loop_res_share,loop_ev,loop_pro
      sumage)$(sum( n , m_e(n,'bio'))) = report('bio not utilized absolute',loop
      _res_share,loop_ev,loop_prosumage) / sum( n , m_e(n,'bio')) ;
3803          report('Capacity total',loop_res_share,loop_ev,loop_prosumage) = s
      um( n , report_node('Capacity total',loop_res_share,loop_ev,loop_prosumage
      ,n)) ;
3804          report('energy demand gross',loop_res_share,loop_ev,loop_prosumage
      ) = sum( n , report_node('energy demand gross',loop_res_share,loop_ev,loop
      _prosumage,n) ) ;
3805          report('energy demand total',loop_res_share,loop_ev,loop_prosumage
      ) = sum ( n , report_node('energy demand total',loop_res_share,loop_ev,loo
      p_prosumage,n) ) ;
3806          report('energy generated net',loop_res_share,loop_ev,loop_prosumag
      e) =  sum( n , report_node('energy generated net',loop_res_share,loop_ev,l
      oop_prosumage,n)) ;
3807          report('energy generated gross',loop_res_share,loop_ev,loop_prosum
      age) =  sum( n , report_node('energy generated gross',loop_res_share,loop_
      ev,loop_prosumage,n)) ;
3808  *        report('gross trade share',loop_res_share,loop_ev,loop_prosumage)
       = sum( (h,n) , report_hours('gross imports',loop_res_share,loop_ev,loop_p
      rosumage,h,n))/ sum( (h,n) , report_hours('energy demanded',loop_res_share
      ,loop_ev,loop_prosumage,h,n) ) ;
3809          report('renshare total',loop_res_share,loop_ev,loop_prosumage) = s
      um( (h,n) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , s
      um( res , lev_G_L(scen,n,res,h) + lev_G_RES(scen,n,res,h) - corr_fac_nondi
      s(scen,n,res,h) + phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res) - lev_CU_PR
      O(scen,n,res,h)) + sum( rsvr , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr
      (scen,n,rsvr,h)))) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , sum( n , gross_energy_demand(scen,n)) ) ;
3810          report('conshare total',loop_res_share,loop_ev,loop_prosumage) = s
      um( (h,n) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , s
      um( con , lev_G_L(scen,n,con,h)) )) / sum( scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , sum( n, gross_energy_demand(scen,n)) ) ;
3811          report('Energy total',loop_res_share,loop_ev,loop_prosumage) = sum
      ( n , report_node('Energy total',loop_res_share,loop_ev,loop_prosumage,n) 
      ) ;
3812   
3813                   report('curtailment of fluct res absolute',loop_res_share
      ,loop_ev,loop_prosumage)$(report('curtailment of fluct res absolute',loop_
      res_share,loop_ev,loop_prosumage) < eps_rep_abs*card(h)) = 0 ;
3814                   report('curtailment of fluct res relative',loop_res_share
      ,loop_ev,loop_prosumage)$(report('curtailment of fluct res relative',loop_
      res_share,loop_ev,loop_prosumage) < eps_rep_rel) = 0 ;
3815                   report('bio not utilized absolute',loop_res_share,loop_ev
      ,loop_prosumage)$(report('bio not utilized absolute',loop_res_share,loop_e
      v,loop_prosumage) < eps_rep_abs*card(h)) = 0 ;
3816                   report('bio not utilized relative',loop_res_share,loop_ev
      ,loop_prosumage)$(report('bio not utilized relative',loop_res_share,loop_e
      v,loop_prosumage) < eps_rep_rel) = 0 ;
3817                   report('Capacity total',loop_res_share,loop_ev,loop_prosu
      mage)$(report('Capacity total',loop_res_share,loop_ev,loop_prosumage) < ep
      s_rep_ins) = 0 ;
3818                   report('gross trade share',loop_res_share,loop_ev,loop_pr
      osumage)$(report('gross trade share',loop_res_share,loop_ev,loop_prosumage
      ) < eps_rep_rel ) = 0 ;
3819                   report('renshare total',loop_res_share,loop_ev,loop_prosu
      mage)$(report('renshare total',loop_res_share,loop_ev,loop_prosumage) < ep
      s_rep_rel ) = 0 ;
3820                   report('conshare total',loop_res_share,loop_ev,loop_prosu
      mage)$(report('conshare total',loop_res_share,loop_ev,loop_prosumage) < ep
      s_rep_rel ) = 0 ;
3821                   report('Energy total',loop_res_share,loop_ev,loop_prosuma
      ge)$(report('Energy total',loop_res_share,loop_ev,loop_prosumage) < eps_re
      p_abs) = 0 ;
3822   
3823   
3824  * ------------------------------------------------------------------------
      ----
3825   
3826  * DSM
              report_tech_hours('load curtailment (non-reserves)',loop_res_share
      ,loop_ev,loop_prosumage,dsm_curt,h,n)$(feat_node('dsm',n)) = sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,dsm_curt
      ,h)) ;
              report_tech_hours('load shift pos (non-reserves)',loop_res_share,l
      oop_ev,loop_prosumage,dsm_shift,h,n)$(feat_node('dsm',n)) = sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP_DEMAND(scen,n,ds
      m_shift,h)) ;
              report_tech_hours('load shift neg (non-reserves)',loop_res_share,l
      oop_ev,loop_prosumage,dsm_shift,h,n)$(feat_node('dsm',n)) = sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND(scen,n,ds
      m_shift,h)) ;
       
              report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,dsm_shift,
      n)$(feat_node('dsm',n) AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) > eps_rep_ins) = sum( (h,
      hh) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM
      _DO(scen,n,dsm_shift,h,hh)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) ;
              report_tech('capacities load curtailment',loop_res_share,loop_ev,l
      oop_prosumage,dsm_curt,n)$(feat_node('dsm',n)) =  sum(scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) ;
              report_tech('capacities load shift',loop_res_share,loop_ev,loop_pr
      osumage,dsm_shift,n)$(feat_node('dsm',n)) =  sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) ;
              report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,dsm_curt,n)$(feat_node('dsm',n)) = sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) / report_node('Capac
      ity total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_tech('Capacity share',loop_res_share,loop_ev,loop_prosumage
      ,dsm_shift,n)$(feat_node('dsm',n)) = sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift)) / report_node('
      Capacity total',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,dsm_curt,n)$(feat_node('dsm',n)) = sum( h , sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,
      dsm_curt,h) - corr_fac_dsm_cu(scen,n,dsm_curt,h)) )  / report_node('energy
       generated gross',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 
      1e-9 ;
              report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n)) = sum( h , sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND
      (scen,n,dsm_shift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) ) / report_
      node('energy generated gross',loop_res_share,loop_ev,loop_prosumage,n) * %
      sec_hour% + 1e-9 ;
              report_tech('Load shift pos absolute (total)',loop_res_share,loop_
      ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n)) = sum( h , sum(scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP(scen,n,dsm_sh
      ift,h)) ) ;
              report_tech('Load shift neg absolute (total)',loop_res_share,loop_
      ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n)) = sum( (h,hh) , sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO(scen,n,d
      sm_shift,h,hh)) ) ;
       
              report_node('load curtailment absolute (non-reserves)',loop_res_sh
      are,loop_ev,loop_prosumage,n)$(feat_node('dsm',n)) =  sum((dsm_curt,h), su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen
      ,n,dsm_curt,h))) * %sec_hour% ;
              report_node('load shift pos absolute (non-reserves)',loop_res_shar
      e,loop_ev,loop_prosumage,n)$(feat_node('dsm',n)) =  sum((dsm_shift,h), sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP_DEMAN
      D(scen,n,dsm_shift,h))) * %sec_hour% ;
              report_node('load shift neg absolute (non-reserves)',loop_res_shar
      e,loop_ev,loop_prosumage,n)$(feat_node('dsm',n)) =  sum((dsm_shift,h), sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAN
      D(scen,n,dsm_shift,h))) * %sec_hour% ;
       
                       report_tech_hours('load curtailment (non-reserves)',loop_
      res_share,loop_ev,loop_prosumage,dsm_curt,h,n)$(report_tech_hours('load cu
      rtailment (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_curt,h
      ,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('load shift pos (non-reserves)',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,h,n)$(report_tech_hours('load shi
      ft pos (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,h,n
      ) < eps_rep_abs) = 0 ;
                       report_tech_hours('load shift neg (non-reserves)',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,h,n)$(report_tech_hours('load shi
      ft neg (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,h,n
      ) < eps_rep_abs) = 0 ;
       
                       report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,d
      sm_shift,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,dsm_s
      hift,n) < eps_rep_abs) = 0 ;
                       report_tech('capacities load curtailment',loop_res_share,
      loop_ev,loop_prosumage,dsm_curt,n)$(report_tech('capacities load curtailme
      nt',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n) < eps_rep_ins) = 0 ;
                       report_tech('capacities load shift',loop_res_share,loop_e
      v,loop_prosumage,dsm_shift,n)$(report_tech('capacities load shift',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_ins) = 0 ;
                       report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,dsm_curt,n)$(report_tech('Capacity share',loop_res_share,loop_ev
      ,loop_prosumage,dsm_curt,n) < eps_rep_rel) = 0 ;
                       report_tech('Capacity share',loop_res_share,loop_ev,loop_
      prosumage,dsm_shift,n)$(report_tech('Capacity share',loop_res_share,loop_e
      v,loop_prosumage,dsm_shift,n) < eps_rep_rel) = 0 ;
                       report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,dsm_curt,n)$(report_tech('Energy share i
      n nodal gross generation',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n
      ) < eps_rep_rel) = 0 ;
                       report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Energy share 
      in nodal gross generation',loop_res_share,loop_ev,loop_prosumage,dsm_shift
      ,n) < eps_rep_rel) = 0 ;
                       report_tech('Load shift pos absolute (total)',loop_res_sh
      are,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos absol
      ute (total)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < card(h)*
      eps_rep_abs) = 0 ;
                       report_tech('Load shift neg absolute (total)',loop_res_sh
      are,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift neg absol
      ute (total)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < card(h)*
      eps_rep_abs) = 0 ;
      *                 report_tech('Load shift pos absolute (wholesale)',loop_r
      es_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos 
      absolute (wholesale)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) <
       card(h)*eps_rep_abs) = 0 ;
      *                 report_tech('Load shift neg absolute (wholesale)',loop_r
      es_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift neg 
      absolute (wholesale)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) <
       card(h)*eps_rep_abs) = 0 ;
      *                 report_tech('Load shift pos absolute (reserves)',loop_re
      s_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos a
      bsolute (reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < c
      ard(h)*eps_rep_abs) = 0 ;
       
                       report_node('load curtailment absolute (non-reserves)',lo
      op_res_share,loop_ev,loop_prosumage,n)$(report_node('load curtailment abso
      lute (non-reserves)',loop_res_share,loop_ev,loop_prosumage,n) < card(h)*ep
      s_rep_abs*%sec_hour%) = 0 ;
                       report_node('load shift pos absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,n)$(report_node('load shift pos absolute
       (non-reserves)',loop_res_share,loop_ev,loop_prosumage,n) < card(h)*eps_re
      p_abs*%sec_hour%) = 0 ;
                       report_node('load shift neg absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,n)$(report_node('load shift neg absolute
       (non-reserves)',loop_res_share,loop_ev,loop_prosumage,n) < card(h)*eps_re
      p_abs*%sec_hour%) = 0 ;
      $ontext
3868   
3869   
3870  * ------------------------------------------------------------------------
      ----
3871   
3872  * EV
              report_tech_hours('EV charge',loop_res_share,loop_ev,loop_prosumag
      e,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_EV_CHARGE(scen,n,ev,h)) ;
              report_tech_hours('EV discharge',loop_res_share,loop_ev,loop_prosu
      mage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_EV_DISCHARGE(scen,n,ev,h)) ;
              report_tech_hours('EV phevfuel consumption',loop_res_share,loop_ev
      ,loop_prosumage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_EV_PHEVFUEL(scen,n,ev,h));
              report_tech_hours('EV electrical consumption',loop_res_share,loop_
      ev,loop_prosumage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_EV_GED(scen,n,ev,h));
              report_tech_hours('EV battery level',loop_res_share,loop_ev,loop_p
      rosumage,ev,h,n)$(feat_node('ev',n)) =  sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_EV_L(scen,n,ev,h)) ;
       
              report_tech('Energy share in nodal gross generation',loop_res_shar
      e,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = (sum( (h,ev) , 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_EV_DISCHA
      RGE(scen,n,ev,h))) - sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( h , corr_fac_ev(scen,n,h))))/ report_node('energy generated g
      ross',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
              report_tech('EV charge total wholesale',loop_res_share,loop_ev,loo
      p_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tech_hour
      s('EV charge',loop_res_share,loop_ev,loop_prosumage,ev,h,n) ) * %sec_hour%
       ;
              report_tech('EV discharge total wholesale',loop_res_share,loop_ev,
      loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tech_h
      ours('EV discharge',loop_res_share,loop_ev,loop_prosumage,ev,h,n) ) * %sec
      _hour% ;
              report_tech('EV phevfuel total consumption',loop_res_share,loop_ev
      ,loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tech_
      hours('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,ev,h
      ,n) ) * %sec_hour% ;
              report_tech('EV electrical total consumption',loop_res_share,loop_
      ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n)) = sum((h,ev), report_tec
      h_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosumage,
      ev,h,n) ) * %sec_hour% ;
              report_tech('EV share of electrical consumption',loop_res_share,lo
      op_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND sum((h,ev), report
      _tech_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosum
      age,ev,h,n) + report_tech_hours('EV phevfuel consumption',loop_res_share,l
      oop_ev,loop_prosumage,ev,h,n)) > card(h)*eps_rep_abs) = sum((h,ev), report
      _tech_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosum
      age,ev,h,n) ) * %sec_hour% / (sum((h,ev), report_tech_hours('EV electrical
       consumption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) + report_tech_
      hours('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,ev,h
      ,n) ) ) ;
              report_tech('EV share of phevfuel consumption',loop_res_share,loop
      _ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND sum((h,ev), report_t
      ech_hours('EV electrical consumption',loop_res_share,loop_ev,loop_prosumag
      e,ev,h,n) + report_tech_hours('EV phevfuel consumption',loop_res_share,loo
      p_ev,loop_prosumage,ev,h,n)) > card(h)*eps_rep_abs) = sum((h,ev), report_t
      ech_hours('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,
      ev,h,n) ) * %sec_hour% / (sum((h,ev), report_tech_hours('EV electrical con
      sumption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) + report_tech_hour
      s('EV phevfuel consumption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) 
      ) ) ;
       
              report_node('gross_energy_demand w/o EV',loop_res_share,loop_ev,lo
      op_prosumage,n)$feat_node('ev',n) = sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , gross_energy_demand(scen,n)) - sum( (ev,h) , sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_EV_GED(scen,n,e
      v,h)) ) ;
              report_node('EV electricity demand',loop_res_share,loop_ev,loop_pr
      osumage,n)$(feat_node('ev',n)) = sum( (ev,h) , sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_EV_GED(scen,n,ev,h)) ) ;
              report_node('renshare EV',loop_res_share,loop_ev,loop_prosumage,n)
      $feat_node('ev',n) = (report_node('renshare in nodal gross demand',loop_re
      s_share,loop_ev,loop_prosumage,n) - report_node('gross_energy_demand w/o E
      V',loop_res_share,loop_ev,loop_prosumage,n) * report_node('EV electricity 
      demand',loop_res_share,loop_ev,loop_prosumage,n) ) / report_node('energy d
      emand gross',loop_res_share,loop_ev,loop_prosumage,n) ;
              report_node('conshare EV',loop_res_share,loop_ev,loop_prosumage,n)
      $feat_node('ev',n) = 1 - report_node('renshare EV',loop_res_share,loop_ev,
      loop_prosumage,n) ;
      %EV_FREE%%EV_DEFAULT%        report_node('renshare EV',loop_res_share,loop
      _ev,loop_prosumage,n)$(feat_node('ev',n)) = 1 ;
      %EV_FREE%%EV_DEFAULT%        report_node('conshare EV',loop_res_share,loop
      _ev,loop_prosumage,n)$(feat_node('ev',n)) = 0 ;
       
                       report_tech_hours('EV charge',loop_res_share,loop_ev,loop
      _prosumage,ev,h,n)$(report_tech_hours('EV charge',loop_res_share,loop_ev,l
      oop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV discharge',loop_res_share,loop_ev,l
      oop_prosumage,ev,h,n)$(report_tech_hours('EV discharge',loop_res_share,loo
      p_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV phevfuel consumption',loop_res_shar
      e,loop_ev,loop_prosumage,ev,h,n)$(report_tech_hours('EV phevfuel consumpti
      on',loop_res_share,loop_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV electrical consumption',loop_res_sh
      are,loop_ev,loop_prosumage,ev,h,n)$(report_tech_hours('EV electrical consu
      mption',loop_res_share,loop_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech_hours('EV battery level',loop_res_share,loop_
      ev,loop_prosumage,ev,h,n)$(report_tech_hours('EV battery level',loop_res_s
      hare,loop_ev,loop_prosumage,ev,h,n) < eps_rep_abs) = 0 ;
                       report_tech('Energy share in nodal gross generation',loop
      _res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('Energy share i
      n nodal gross generation',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n
      ) < eps_rep_rel) = 0 ;
                       report_tech('EV charge total wholesale',loop_res_share,lo
      op_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV charge total wholesale',
      loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_abs*card(h)*%s
      ec_hour%) = 0 ;
                       report_tech('EV discharge total wholesale',loop_res_share
      ,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV discharge total whole
      sale',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_abs*card
      (h)*%sec_hour%) = 0 ;
                       report_tech('EV phevfuel total consumption',loop_res_shar
      e,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV phevfuel total consu
      mption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_abs*ca
      rd(h)*%sec_hour%) = 0 ;
                       report_tech('EV electrical total consumption',loop_res_sh
      are,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV electrical total c
      onsumption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_ab
      s*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV share of electrical consumption',loop_res
      _share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV share of electr
      ical consumption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_
      rep_rel) = 0 ;
                       report_tech('EV share of phevfuel consumption',loop_res_s
      hare,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV share of phevfuel
       consumption',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n) < eps_rep_
      rel) = 0 ;
                       report_node('EV_electricity_demand',loop_res_share,loop_e
      v,loop_prosumage,n)$(report_node('EV_electricity_demand',loop_res_share,lo
      op_ev,loop_prosumage,n) < card(h)*eps_rep_abs) = 0 ;
                       report_node('renshare EV',loop_res_share,loop_ev,loop_pro
      sumage,n)$(report_node('renshare EV',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_rel) = eps ;
                       report_node('conshare EV',loop_res_share,loop_ev,loop_pro
      sumage,n)$(report_node('conshare EV',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_rel) = eps ;
                       report_node('gross_energy_demand w/o EV',loop_res_share,l
      oop_ev,loop_prosumage,n)$(report_node('gross_energy_demand w/o EV',loop_re
      s_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
      $ontext
3913   
3914   
3915  * ------------------------------------------------------------------------
      ----
3916   
3917  * Reserves
               report_reserves('reserve provision requirements',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,n) = feat_node('reserves',n) * phi_res
      erves_pr_up(n) * sum( reserves_nonprim ,  (1000 * phi_reserves_share(n,res
      erves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum( nondis , r
      eserves_slope(n,reserves_nonprim,nondis) * sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondis) + lev_N_RES_PRO(
      scen,n,nondis)))/1000) )) ) ;
               report_reserves('reserve provision requirements',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,n) = feat_node('reserves',n) * 1000
       * phi_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves
      _nonprim) + sum( nondis , reserves_slope(n,reserves_nonprim,nondis) * sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen
      ,n,nondis) + lev_N_RES_PRO(scen,n,nondis)))/1000) ) ;
      * ## marginals missing
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('re
      serves',n) * (report_reserves('reserve provision requirements',loop_res_sh
      are,loop_ev,loop_prosumage,reserves,n)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('r
      eserves',n) * (phi_reserves_call(n,reserves,h) * report_reserves('reserve 
      provision requirements',loop_res_share,loop_ev,loop_prosumage,reserves,n))
       ;
      $ontext
               report_reserves_hours('reserve provision requirements',loop_res_s
      hare,loop_ev,loop_prosumage,reserves_prim,h,n) = feat_node('reserves',n) *
       reserves_exogenous(n,reserves_prim,h) ;
               report_reserves_hours('reserve provision requirements',loop_res_s
      hare,loop_ev,loop_prosumage,reserves_nonprim,h,n) = feat_node('reserves',n
      ) * reserves_exogenous(n,reserves_nonprim,h) ;
               report_reserves_hours('reserve prices',loop_res_share,loop_ev,loo
      p_prosumage,reserves_nonprim,h,n) = feat_node('reserves',n) * sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , marginal_con9a(scen,reser
      ves_nonprim,h,n) );
               report_reserves_hours('reserve prices',loop_res_share,loop_ev,loo
      p_prosumage,reserves_prim,h,n) = feat_node('reserves',n) * sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , marginal_con9b(scen,reserves
      _prim,h,n) );
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('re
      serves',n) * (report_reserves_hours('reserve provision requirements',loop_
      res_share,loop_ev,loop_prosumage,reserves,h,n)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,'required',h,n)$(ord(h) > 1) = feat_node('r
      eserves',n) * (phi_reserves_call(n,reserves,h) * report_reserves_hours('re
      serve provision requirements',loop_res_share,loop_ev,loop_prosumage,reserv
      es,h,n)) ;
      $ontext
3935   
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dis,h,n)$(feat_node('reserves',n)) = sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(scen,n,re
      serves,dis,h)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,dis,h,n)$(feat_node('reserves',n)) = sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(scen,n,r
      eserves,dis,h))*phi_reserves_call(n,reserves,h) ;
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,nondis,h,n)$(feat_node('reserves',n)) = sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(sce
      n,n,reserves,nondis,h)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,nondis,h,n)$(feat_node('reserves',n)) = sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(sc
      en,n,reserves,nondis,h))*phi_reserves_call(n,reserves,h) ;
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,rsvr,h,n)$(feat_node('reserves',n)) = sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n,
      reserves,rsvr,h)) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,rsvr,h,n)$(feat_node('reserves',n)) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n
      ,reserves,rsvr,h))*phi_reserves_call(n,reserves,h) ;
               report_reserves_tech_hours('Reserves provision',loop_res_share,lo
      op_ev,loop_prosumage,reserves,sto,h,n)$(feat_node('reserves',n)) = (sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_STO_IN(scen,
      n,reserves,sto,h)) + sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_RP_STO_OUT(scen,n,reserves,sto,h))) ;
               report_reserves_tech_hours('Reserves activation',loop_res_share,l
      oop_ev,loop_prosumage,reserves,sto,h,n)$(feat_node('reserves',n)) = ((sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_STO_IN(sce
      n,n,reserves,sto,h)) + sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_RP_STO_OUT(scen,n,reserves,sto,h)))*phi_reserves_call(n,rese
      rves,h)) ;
       
               report_reserves_tech('Reserves provision ratio',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dis,n)$(feat_node('reserves',n) AND sum( h ,
       sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen
      ,n,dis,h) + corr_fac_dis(scen,n,dis,h))) > card(h)*eps_rep_abs)= sum( h , 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(sc
      en,n,reserves,dis,h)) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_G_L(scen,n,dis,h) + corr_fac_dis(scen,n,dis,h)) 
      ) ;
               report_reserves_tech('Reserves activation ratio',loop_res_share,l
      oop_ev,loop_prosumage,reserves,dis,n)$(feat_node('reserves',n) AND sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(sce
      n,n,dis,h) + corr_fac_dis(scen,n,dis,h))) > card(h)*eps_rep_abs) = sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS(
      scen,n,reserves,dis,h)) * phi_reserves_call(n,reserves,h)) / sum( h , sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,di
      s,h) + corr_fac_dis(scen,n,dis,h)) ) ;
               report_reserves_tech('Reserves provision ratio',loop_res_share,lo
      op_ev,loop_prosumage,reserves,nondis,n)$(feat_node('reserves',n) AND sum( 
      h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES
      (scen,n,nondis,h))) >  card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(scen,n,reserves,no
      ndis,h)) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_G_RES(scen,n,nondis,h)) ) ;
               report_reserves_tech('Reserves activation ratio',loop_res_share,l
      oop_ev,loop_prosumage,reserves,nondis,n)$(feat_node('reserves',n) AND sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RE
      S(scen,n,nondis,h))) > card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_RP_NONDIS(scen,n,reserves,no
      ndis,h)) * phi_reserves_call(n,reserves,h) ) / sum( h , sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES(scen,n,nondis,h)) ) ;
               report_reserves_tech('Reserves provision ratio',loop_res_share,lo
      op_ev,loop_prosumage,reserves,rsvr,n)$(feat_node('reserves',n) AND sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RSVR_OU
      T(scen,n,rsvr,h))) >  card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n,reserves,rsvr,
      h)) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_RSVR_OUT(scen,n,rsvr,h)) ) ;
               report_reserves_tech('Reserves activation ratio',loop_res_share,l
      oop_ev,loop_prosumage,reserves,rsvr,n)$(feat_node('reserves',n) AND sum( h
       , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RSVR_O
      UT(scen,n,rsvr,h))) >  card(h)*eps_rep_abs) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RSVR(scen,n,reserves,rsvr
      ,h)) * phi_reserves_call(n,reserves,h) ) / sum( h , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage out posit
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) =
       sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _RP_STO_OUT(scen,n,reserves_up,sto,h)) ) / sum( h , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage out negat
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) =
       sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev
      _RP_STO_OUT(scen,n,reserves_do,sto,h)) ) / sum( h , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage in positi
      ve reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(fe
      at_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_up,sto,h)) ) / sum( h , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves provision ratio (storage in negati
      ve reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(fe
      at_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_do,sto,h)) ) / sum( h , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage out posi
      tive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(
      feat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_STO_OUT(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,reserves_up,
      h) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage out nega
      tive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(
      feat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h))) > card(h)*eps_rep_abs ) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_STO_OUT(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,reserves_do,
      h) ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_STO_OUT(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage in posit
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_up,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_STO_IN(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,reserves_up,h) 
      ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_STO_IN(scen,n,sto,h)) ) ;
               report_reserves_tech('Reserves activation ratio (storage in negat
      ive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves_do,sto,n)$(f
      eat_node('reserves',n) AND  sum(h,sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_STO_IN(scen,n,sto,h))) > card(h)*eps_rep_abs ) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_STO_IN(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,reserves_do,h) 
      ) / sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_STO_IN(scen,n,sto,h)) ) ;
      $ontext
3962   
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_DIS(scen,n,reserves_nonprim,dis,h))) / ((card(h)-1) * 1000 * phi_reserve
      s_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + su
      m( nondis ,reserves_slope(n,reserves_nonprim,nondis) * sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondis) + le
      v_N_RES_PRO(scen,n,nondis)))/1000) ) ) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n)) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_NONDIS(scen,n,reserves_nonprim,nondis,h))) / ((card(h)-1) * 1000 * ph
      i_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonp
      rim) + sum( nondisnondis ,reserves_slope(n,reserves_nonprim,nondisnondis) 
      * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TEC
      H(scen,n,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_RSVR(scen,n,reserves_nonprim,rsvr,h))) / ((card(h)-1) * 1000 * phi_rese
      rves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) +
       sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n
      ,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h
      ))) / ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (rese
      rves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,res
      erves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,lo
      op_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,no
      ndisnondis)))/1000) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_D
      IS(scen,n,reserves_prim,dis,h))) / (phi_reserves_pr_up(n)* sum( reserves_n
      onprim ,  ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (
      reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n
      ,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,
      n,nondisnondis)))/1000) )) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_NONDIS(scen,n,reserves_prim,nondis,h))) / (phi_reserves_pr_up(n) * sum( 
      reserves_nonprim ,  ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_no
      nprim) * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserv
      es_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES
      _PRO(scen,n,nondisnondis)))/1000) )) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = sum
      ( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      RSVR(scen,n,reserves_prim,rsvr,h))) / (phi_reserves_pr_up(n) * sum( reserv
      es_nonprim ,  ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim)
       * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slo
      pe(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(s
      cen,n,nondisnondis)))/1000) )) )) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_S
      TO_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h))) / (ph
      i_reserves_pr_up(n) * sum( reserves_nonprim ,  ((card(h)-1) * 1000 * phi_r
      eserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim
      ) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(sce
      n,n,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ));
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum
      (h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS
      (scen,n,reserves_prim,dis,h))*phi_reserves_call(n,reserves_prim,h)) / sum(
       h , phi_reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n) * sum( 
      reserves_nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( reser
      ves_intercept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,re
      serves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,n
      ondisnondis)))/1000 ) ) )   ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      NONDIS(scen,n,reserves_prim,nondis,h))*phi_reserves_call(n,reserves_prim,h
      )) / sum( h , phi_reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n
      )* sum( reserves_nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) *
       ( reserves_intercept(n,reserves_nonprim) + sum(nondisnondis , reserves_sl
      ope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis) + lev_N_RES_PR
      O(scen,n,nondisnondis)))/1000 ) ) )   ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = su
      m(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RS
      VR(scen,n,reserves_prim,rsvr,h))*phi_reserves_call(n,reserves_prim,h)) / s
      um( h , phi_reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n)* sum
      ( reserves_nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( res
      erves_intercept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,
      reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis) + lev_N_RES_PRO(scen
      ,n,nondisnondis)))/1000 ) ) )   ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum
      (h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_ST
      O_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h)))*phi_re
      serves_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_pr
      im,h) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserv
      es_share(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + 
      sum( nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen
      ,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   );
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      DIS(scen,n,reserves_nonprim,dis,h))*phi_reserves_call(n,reserves_nonprim,h
      )) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_reserve
      s_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + su
      m(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,no
      ndisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n))
       = sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_NONDIS(scen,n,reserves_nonprim,nondis,h))*phi_reserves_call(n,reserves_
      nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * ph
      i_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonp
      rim) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(
      scen,n,nondisnondis) + lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) =
       sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _RSVR(scen,n,reserves_nonprim,rsvr,h))*phi_reserves_call(n,reserves_nonpri
      m,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_rese
      rves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) +
       sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n
      ,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = 
      sum(h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_shar
      e,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h)
      ))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n
      ,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (re
      serves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,r
      eserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,
      nondisnondis)))/1000) )) ;
      $ontext
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_DIS(scen,n,reserves_nonprim,dis,h))) / sum( h$(ord(h) > 1), reserves_exo
      genous(n,reserves_nonprim,h))  ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n)) 
      = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_RP_NONDIS(scen,n,reserves_nonprim,nondis,h))) / sum( h$(ord(h) > 1), res
      erves_exogenous(n,reserves_nonprim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) = 
      sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_RSVR(scen,n,reserves_nonprim,rsvr,h))) / sum( h$(ord(h) > 1), reserves_
      exogenous(n,reserves_nonprim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h
      ))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_D
      IS(scen,n,reserves_prim,dis,h))) / sum( h$(ord(h) > 1), reserves_exogenous
      (n,reserves_prim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = s
      um( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_R
      P_NONDIS(scen,n,reserves_prim,nondis,h))) / sum( h$(ord(h) > 1), reserves_
      exogenous(n,reserves_prim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = sum
      ( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      RSVR(scen,n,reserves_prim,rsvr,h))) / sum( h$(ord(h) > 1), reserves_exogen
      ous(n,reserves_prim,h)) ;
               report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum(
       h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_S
      TO_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h))) / sum
      ( h$(ord(h) > 1), reserves_exogenous(n,reserves_prim,h)) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,dis,n)$(feat_node('reserves',n)) = sum
      (h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_DIS
      (scen,n,reserves_prim,dis,h))*phi_reserves_call(n,reserves_prim,h)) / sum(
       h , phi_reserves_call(n,reserves_prim,h) * reserves_exogenous(n,reserves_
      prim,h) )     ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,nondis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      NONDIS(scen,n,reserves_prim,nondis,h))*phi_reserves_call(n,reserves_prim,h
      )) / sum( h , phi_reserves_call(n,reserves_prim,h) * reserves_exogenous(n,
      reserves_prim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,rsvr,n)$(feat_node('reserves',n)) = su
      m(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_RS
      VR(scen,n,reserves_prim,rsvr,h))*phi_reserves_call(n,reserves_prim,h)) / s
      um( h , phi_reserves_call(n,reserves_prim,h) * reserves_exogenous(n,reserv
      es_prim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_prim,sto,n)$(feat_node('reserves',n)) = sum
      (h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_ST
      O_IN(scen,n,reserves_prim,sto,h)) + sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_prim,sto,h)))*phi_re
      serves_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_pr
      im,h) * reserves_exogenous(n,reserves_prim,h) );
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,dis,n)$(feat_node('reserves',n)) = 
      sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_
      DIS(scen,n,reserves_nonprim,dis,h))*phi_reserves_call(n,reserves_nonprim,h
      )) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_exogenous
      (n,reserves_nonprim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(feat_node('reserves',n))
       = sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      RP_NONDIS(scen,n,reserves_nonprim,nondis,h))*phi_reserves_call(n,reserves_
      nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_
      exogenous(n,reserves_nonprim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(feat_node('reserves',n)) =
       sum(h,sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _RSVR(scen,n,reserves_nonprim,rsvr,h))*phi_reserves_call(n,reserves_nonpri
      m,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_exogen
      ous(n,reserves_nonprim,h) ) ;
               report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,sto,n)$(feat_node('reserves',n)) = 
      sum(h,(sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP
      _STO_IN(scen,n,reserves_nonprim,sto,h)) + sum(scen$(map(scen,loop_res_shar
      e,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_nonprim,sto,h)
      ))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n
      ,reserves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h) ) ;
      $ontext
4001   
               report_tech('Storage positive reserves activation by storage in',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = s
      um( (h,reserves_up) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_RP_STO_IN(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,re
      serves_up,h)) * %sec_hour% ;
               report_tech('Storage negative reserves activation by storage in',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = s
      um( (h,reserves_do) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_RP_STO_IN(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,re
      serves_do,h)) * %sec_hour% ;
               report_tech('Storage positive reserves activation by storage out'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = 
      sum( (h,reserves_up) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_RP_STO_OUT(scen,n,reserves_up,sto,h)) * phi_reserves_call(n,
      reserves_up,h)) * %sec_hour% ;
               report_tech('Storage negative reserves activation by storage out'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('reserves',n)) = 
      sum( (h,reserves_do) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pros
      umage)) , lev_RP_STO_OUT(scen,n,reserves_do,sto,h)) * phi_reserves_call(n,
      reserves_do,h)) * %sec_hour% ;
               report_tech('Load shift pos absolute (non-reserves)',loop_res_sha
      re,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('reserves',n)) = sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_UP_
      DEMAND(scen,n,dsm_shift,h)) ) ;
               report_tech('Load shift neg absolute (non-reserves)',loop_res_sha
      re,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('reserves',n)) = sum( h 
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_
      DEMAND(scen,n,dsm_shift,h)) ) ;
       
               report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n)$(f
      eat_node('reserves',n) AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_P(scen,n,sto)) > eps_rep_ins) = ( report_tech('Sto
      rage out total non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n)
                              + sum( (h,reserves_up) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_up,sto,
      h)) * phi_reserves_call(n,reserves_up,h)) * %sec_hour%
                              - sum( (h,reserves_do) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_do,sto,
      h)) * phi_reserves_call(n,reserves_do,h)) * %sec_hour%
                              ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_N_STO_P(scen,n,sto)) ;
               report_tech('Storage cycles',loop_res_share,loop_ev,loop_prosumag
      e,sto,n)$(feat_node('reserves',n) AND sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) > eps_rep_ins) = ( repor
      t_tech('Storage out total non-reserves',loop_res_share,loop_ev,loop_prosum
      age,sto,n)
                              + sum( (h,reserves_up) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_up,sto,
      h)) * phi_reserves_call(n,reserves_up,h)) * %sec_hour%
                              - sum( (h,reserves_do) , sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_RP_STO_OUT(scen,n,reserves_do,sto,
      h)) * phi_reserves_call(n,reserves_do,h)) * %sec_hour%
                              ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_N_STO_E(scen,n,sto)) * %sec_hour% ;
               report_tech('Storage EP-ratio',loop_res_share,loop_ev,loop_prosum
      age,sto,n)$(feat_node('reserves',n) AND sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto) + lev_N_STO_P_PRO(scen,
      n,sto) ) > eps_rep_ins AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_E(scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) * %s
      ec_hour% > eps_rep_ins ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_N_STO_E(scen,n,sto) + lev_N_STO_E_PRO(scen,n,sto) ) * %s
      ec_hour% / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_STO_P(scen,n,sto) + lev_N_STO_P_PRO(scen,n,sto) ) ;
       
       
      %reserves_exogenous%                 report_reserves('reserve provision re
      quirements',loop_res_share,loop_ev,loop_prosumage,reserves_prim,n)$(feat_n
      ode('reserves',n) AND report_reserves('reserve provision requirements',loo
      p_res_share,loop_ev,loop_prosumage,reserves_prim,n) < eps_rep_abs) = 0 ;
      %reserves_exogenous%                 report_reserves('reserve provision re
      quirements',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,n)$(fea
      t_node('reserves',n) AND report_reserves('reserve provision requirements',
      loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,n) < eps_rep_abs) =
       0 ;
      %reserves_endogenous%                report_reserves_hours('reserve provis
      ion requirements',loop_res_share,loop_ev,loop_prosumage,reserves_prim,h,n)
      $(feat_node('reserves',n) AND report_reserves_hours('reserve provision req
      uirements',loop_res_share,loop_ev,loop_prosumage,reserves_prim,h,n) < eps_
      rep_abs) = 0 ;
      %reserves_endogenous%                report_reserves_hours('reserve provis
      ion requirements',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,h
      ,n)$(feat_node('reserves',n) AND report_reserves_hours('reserve provision 
      requirements',loop_res_share,loop_ev,loop_prosumage,reserves_nonprim,h,n) 
      < eps_rep_abs) = 0 ;
       
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,'required',h,n)$(report_reserves_tec
      h_hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserve
      s,'required',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,'required',h,n)$(report_reserves_te
      ch_hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reser
      ves,'required',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,dis,h,n)$(report_reserves_tech_hours
      ('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,dis,h
      ,n) < eps_rep_abs ) = 0;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,dis,h,n)$(report_reserves_tech_hour
      s('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,dis
      ,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,nondis,h,n)$(report_reserves_tech_ho
      urs('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,no
      ndis,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,nondis,h,n)$(report_reserves_tech_h
      ours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,
      nondis,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,sto,h,n)$(report_reserves_tech_hours
      ('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,sto,h
      ,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,sto,h,n)$(report_reserves_tech_hour
      s('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,sto
      ,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,rsvr,h,n)$(report_reserves_tech_hour
      s('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,rsvr
      ,h,n) < eps_rep_abs) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,rsvr,h,n)$(report_reserves_tech_hou
      rs('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,rs
      vr,h,n) < eps_rep_abs) = 0 ;
       
                       report_reserves_tech('Reserves provision ratio',loop_res_
      share,loop_ev,loop_prosumage,reserves,dis,n)$(report_reserves_tech('Reserv
      es provision ratio',loop_res_share,loop_ev,loop_prosumage,reserves,dis,n) 
      < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio',loop_res
      _share,loop_ev,loop_prosumage,reserves,dis,n)$(report_reserves_tech('Reser
      ves activation ratio',loop_res_share,loop_ev,loop_prosumage,reserves,dis,n
      ) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio',loop_res_
      share,loop_ev,loop_prosumage,reserves,nondis,n)$(report_reserves_tech('Res
      erves provision ratio',loop_res_share,loop_ev,loop_prosumage,reserves,nond
      is,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio',loop_res
      _share,loop_ev,loop_prosumage,reserves,nondis,n)$(report_reserves_tech('Re
      serves activation ratio',loop_res_share,loop_ev,loop_prosumage,reserves,no
      ndis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio',loop_res_
      share,loop_ev,loop_prosumage,reserves,rsvr,n)$(report_reserves_tech('Reser
      ves provision ratio',loop_res_share,loop_ev,loop_prosumage,reserves,rsvr,n
      ) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio',loop_res
      _share,loop_ev,loop_prosumage,reserves,rsvr,n)$(report_reserves_tech('Rese
      rves activation ratio',loop_res_share,loop_ev,loop_prosumage,reserves,rsvr
      ,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage o
      ut positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves provision ratio (storage out positive r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage o
      ut negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves provision ratio (storage out negative r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage i
      n positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n
      )$(report_reserves_tech('Reserves provision ratio (storage in positive res
      erves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_re
      l) = 0 ;
                       report_reserves_tech('Reserves provision ratio (storage i
      n negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n
      )$(report_reserves_tech('Reserves provision ratio (storage in negative res
      erves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_re
      l) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      out positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto
      ,n)$(report_reserves_tech('Reserves activation ratio (storage out positive
       reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_re
      p_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      out negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto
      ,n)$(report_reserves_tech('Reserves activation ratio (storage out negative
       reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_re
      p_rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      in positive reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves activation ratio (storage in positive r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('Reserves activation ratio (storage 
      in negative reserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,
      n)$(report_reserves_tech('Reserves activation ratio (storage in negative r
      eserves)',loop_res_share,loop_ev,loop_prosumage,reserves,sto,n) < eps_rep_
      rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,dis,n)$(report_reserves_tech
      ('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _nonprim,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_nonprim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(report_reserves_tec
      h('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserve
      s_nonprim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,sto,n)$(report_reserves_tech
      ('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _nonprim,sto,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,dis,n)$(report_reserves_tech('r
      eserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_pr
      im,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,nondis,n)$(report_reserves_tech
      ('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _prim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,rsvr,n)$(report_reserves_tech('
      reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_p
      rim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,sto,n)$(report_reserves_tech('r
      eserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserves_pr
      im,sto,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,dis,n)$(report_reserves_tech('
      reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_
      prim,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,nondis,n)$(report_reserves_tec
      h('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_prim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,rsvr,n)$(report_reserves_tech(
      'reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves
      _prim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,sto,n)$(report_reserves_tech('
      reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserves_
      prim,sto,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,dis,n)$(report_reserves_tec
      h('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_nonprim,dis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,nondis,n)$(report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,nondis,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,rsvr,n)$(report_reserves_te
      ch('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_nonprim,rsvr,n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,sto,n)$(report_reserves_tec
      h('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_nonprim,sto,n) < eps_rep_rel) = 0 ;
       
                       report_tech('Storage positive reserves activation by stor
      age in',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage
       positive reserves activation by storage in',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('Storage negative reserves activation by stor
      age in',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storage
       negative reserves activation by storage in',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('Storage positive reserves activation by stor
      age out',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storag
      e positive reserves activation by storage out',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('Storage negative reserves activation by stor
      age out',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_tech('Storag
      e negative reserves activation by storage out',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,s
      to,n)$(report_tech('FLH',loop_res_share,loop_ev,loop_prosumage,sto,n) < ep
      s_rep_abs) = 0 ;
                       report_tech('Storage cycles',loop_res_share,loop_ev,loop_
      prosumage,sto,n)$(report_tech('Storage cycles',loop_res_share,loop_ev,loop
      _prosumage,sto,n) < eps_rep_abs) = 0 ;
                       report_tech('Storage EP-ratio',loop_res_share,loop_ev,loo
      p_prosumage,sto,n)$(report_tech('Storage EP-ratio',loop_res_share,loop_ev,
      loop_prosumage,sto,n) < eps_rep_rel) = 0 ;
                       report_tech('Load shift pos absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift po
      s absolute (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift
      ,n) < card(h) * eps_rep_abs) = 0 ;
                       report_tech('Load shift neg absolute (non-reserves)',loop
      _res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift ne
      g absolute (non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift
      ,n) < card(h) * eps_rep_abs) = 0 ;
      $ontext
4079   
4080   
4081  * ------------------------------------------------------------------------
      ----
4082   
4083  * Reserves and DSM
      %reserves_endogenous%$ontext
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND f
      eat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h)))
       / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserv
      es_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reser
      ves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nond
      isnondis)))/1000) )))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shift
      ,h))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (r
      eserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,
      reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n
      ,nondisnondis)))/1000) )))   ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h))
      *phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,r
      eserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (rese
      rves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,res
      erves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,lo
      op_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,no
      ndisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND
       feat_node('reserves',n)) = (sum( h , sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shif
      t,h)) * phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_c
      all(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) 
      * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slop
      e(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sc
      en,n,nondisnondis)))/1000) )))   ;
      $ontext
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND f
      eat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h))) 
      / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shift,
      h))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h))   ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(feat_node('dsm',n) AND 
      feat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , lev_RP_DSM_CU(scen,n,reserves_nonprim,dsm_curt,h))*
      phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,re
      serves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(feat_node('dsm',n) AND
       feat_node('reserves',n)) = sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_RP_DSM_SHIFT(scen,n,reserves_nonprim,dsm_shift
      ,h)) * phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_ca
      ll(n,reserves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h))   ;
      $ontext
      %reserves%$ontext
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,dsm_shift,h,n)$(feat_node('dsm',n) AND feat_n
      ode('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_RP_DSM_SHIFT(scen,n,reserves,dsm_shift,h))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dsm_shift,h,n)$(feat_node('dsm',n) AND feat_
      node('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_RP_DSM_SHIFT(scen,n,reserves,dsm_shift,h))*phi_reserves_call(
      n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,dsm_curt,h,n)$(feat_node('dsm',n) AND feat_no
      de('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_RP_DSM_CU(scen,n,reserves,dsm_curt,h))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,dsm_curt,h,n)$(feat_node('dsm',n) AND feat_n
      ode('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_RP_DSM_CU(scen,n,reserves,dsm_curt,h))*phi_reserves_call(n,res
      erves,h)  ;
       
              report_tech('Load shift pos absolute (reserves)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n) AND feat_node('reser
      ves',n)) = report_tech('Load shift pos absolute (total)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n) - report_tech('Load shift pos absolute (
      non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) ;
              report_tech('Load shift neg absolute (reserves)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n)$(feat_node('dsm',n) AND feat_node('reser
      ves',n)) = report_tech('Load shift neg absolute (total)',loop_res_share,lo
      op_ev,loop_prosumage,dsm_shift,n) - report_tech('Load shift neg absolute (
      non-reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) ;
       
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(report_reserves
      _tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,dsm_curt,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(report_reserve
      s_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,re
      serves_nonprim,dsm_shift,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,dsm_curt,n)$(report_reserve
      s_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,r
      eserves_nonprim,dsm_curt,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,dsm_shift,n)$(report_reserv
      es_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,
      reserves_nonprim,dsm_shift,n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,dsm_shift,h,n)$(report_reserves_tech
      _hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves
      ,dsm_shift,h,n) < eps_rep_abs) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,dsm_shift,h,n)$(report_reserves_tec
      h_hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserv
      es,dsm_shift,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,dsm_curt,h,n)$(report_reserves_tech_
      hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,
      dsm_curt,h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,dsm_curt,h,n)$(report_reserves_tech
      _hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserve
      s,dsm_curt,h,n) < eps_rep_abs ) = 0 ;
                       report_tech('Load shift neg absolute (reserves)',loop_res
      _share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift neg ab
      solute (reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < ca
      rd(h)*eps_rep_abs) = 0 ;
                       report_tech('Load shift pos absolute (reserves)',loop_res
      _share,loop_ev,loop_prosumage,dsm_shift,n)$(report_tech('Load shift pos ab
      solute (reserves)',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < ca
      rd(h)*eps_rep_abs) = 0 ;
      $ontext
4121   
4122   
4123  * ------------------------------------------------------------------------
      ----
4124   
4125  * Reserves and EV
      %reserves%$ontext
             report_reserves_tech_hours('Reserves provision',loop_res_share,loop
      _ev,loop_prosumage,reserves,'ev_cum',h,n)$(feat_node('ev',n) AND feat_node
      ('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( ev , lev_RP_EV_V2G(scen,n,reserves,ev,h)))+ sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , sum( ev , lev_RP_EV_G2V(scen,n,re
      serves,ev,h)))  ;
             report_reserves_tech_hours('Reserves activation',loop_res_share,loo
      p_ev,loop_prosumage,reserves,'ev_cum',h,n)$(feat_node('ev',n) AND feat_nod
      e('reserves',n)) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumag
      e)) , sum( ev , phi_reserves_call(n,reserves,h) * lev_RP_EV_V2G(scen,n,res
      erves,ev,h)))+ sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) 
      , sum( ev , phi_reserves_call(n,reserves,h) * lev_RP_EV_G2V(scen,n,reserve
      s,ev,h)))  ;
      $ontext
      %reserves_endogenous%$ontext
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat_n
      ode('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,re
      serves_prim,ev,h))) / (phi_reserves_pr_up(n) * sum( reserves_nonprim ,  ((
      card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_int
      ercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves_no
      nprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnond
      is)))/1000) )) ));
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))) / (phi_re
      serves_pr_up(n) * sum( reserves_nonprim ,  ((card(h)-1) * 1000 * phi_reser
      ves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + 
      sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,
      nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ));
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))) / (phi_re
      serves_pr_up(n) * sum( reserves_nonprim ,  ((card(h)-1) * 1000 * phi_reser
      ves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + 
      sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,
      nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ));
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(sc
      en,n,reserves_nonprim,ev,h))) / ((card(h)-1) * 1000 * phi_reserves_share(n
      ,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum(nondisn
      ondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondi
      s)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))) / 
      ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_i
      ntercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves_
      nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisno
      ndis)))/1000) )) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))) / 
      ((card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_i
      ntercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves_
      nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisno
      ndis)))/1000) )) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum((h,ev),(sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,re
      serves_prim,ev,h)))*phi_reserves_call(n,reserves_prim,h)) / sum( h , phi_r
      eserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n) * sum( reserves_n
      onprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( reserves_interc
      ept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,reserves_non
      prim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondi
      s)))/1000 ) ) )   ) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND feat
      _node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))*phi_reserve
      s_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_prim,h)
       *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_sh
      are(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum(n
      ondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,non
      disnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND feat
      _node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))*phi_reserve
      s_call(n,reserves_prim,h)) /  sum( h , phi_reserves_call(n,reserves_prim,h
      ) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_s
      hare(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum(
      nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,no
      ndisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = (sum((h,ev),(sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(sc
      en,n,reserves_nonprim,ev,h)))*phi_reserves_call(n,reserves_nonprim,h)) / s
      um( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_reserves_shar
      e(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum(nond
      isnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisno
      ndis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) ))) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND f
      eat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))*phi_
      reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reserv
      es_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_
      intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves
      _nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisn
      ondis)))/1000) ))) ;
             report_reserves_tech('reserve activation shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND f
      eat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))*phi_
      reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reserv
      es_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves_
      intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserves
      _nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisn
      ondis)))/1000) ))) ;
      $ontext
      %reserves_exogenous%$ontext
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat_n
      ode('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,re
      serves_prim,ev,h))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_p
      rim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))) / sum( h$
      (ord(h) > 1), reserves_exogenous(n,reserves_prim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND feat_
      node('reserves',n)) = sum( (h,ev), sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))) / sum( h$
      (ord(h) > 1), reserves_exogenous(n,reserves_prim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(sc
      en,n,reserves_nonprim,ev,h))) / sum( h$(ord(h) > 1), reserves_exogenous(n,
      reserves_nonprim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))) / 
      sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
             report_reserves_tech('reserve provision shares',loop_res_share,loop
      _ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND fe
      at_node('reserves',n)) = sum( (h,ev) , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))) / 
      sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
      *** ### not completed
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(feat_node('ev',n) AND feat
      _node('reserves',n)) = sum((h,ev),(sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))+ sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,r
      eserves_prim,ev,h)))*phi_reserves_call(n,reserves_prim,h)) / sum( h , phi_
      reserves_call(n,reserves_prim,h) *  phi_reserves_pr_up(n) * sum( reserves_
      nonprim , 1000 * phi_reserves_share(n,reserves_nonprim) * ( reserves_inter
      cept(n,reserves_nonprim) + sum(nondisnondis , reserves_slope(n,reserves_no
      nprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnond
      is)))/1000 ) ) )   ) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_prim,ev,h))*phi_reserv
      es_call(n,reserves_prim,h)) / sum( h , phi_reserves_call(n,reserves_prim,h
      ) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_s
      hare(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum(
      nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,no
      ndisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(feat_node('ev',n) AND fea
      t_node('reserves',n)) = sum((h,ev),sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_prim,ev,h))*phi_reserv
      es_call(n,reserves_prim,h)) /  sum( h , phi_reserves_call(n,reserves_prim,
      h) *  phi_reserves_pr_up(n) * sum( reserves_nonprim , 1000 * phi_reserves_
      share(n,reserves_nonprim) * ( reserves_intercept(n,reserves_nonprim) + sum
      (nondisnondis , reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen
      $(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,n
      ondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000 ) ) )   ) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(feat_node('ev',n) AND f
      eat_node('reserves',n)) = (sum((h,ev),(sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))+ su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(s
      cen,n,reserves_nonprim,ev,h)))*phi_reserves_call(n,reserves_nonprim,h)) / 
      sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_reserves_sha
      re(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + sum(non
      disnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisn
      ondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) ))) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(feat_node('ev',n) AND 
      feat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_nonprim,ev,h))*phi
      _reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reser
      ves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves
      _intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserve
      s_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondis
      nondis)))/1000) ))) ;
      *       report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(feat_node('ev',n) AND 
      feat_node('reserves',n)) = (sum((h,ev),sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_nonprim,ev,h))*phi
      _reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_call(n,reser
      ves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) * (reserves
      _intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n,reserve
      s_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondis
      nondis)))/1000) ))) ;
      $ontext
      %reserves%$ontext
             report_tech('EV positive reserves activation by charging',loop_res_
      share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_node(
      'reserves',n)) = sum( (ev,h,reserves_up) ,  sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_up,ev,h)) * p
      hi_reserves_call(n,reserves_up,h)) * %sec_hour% ;
             report_tech('EV negative reserves activation by charging',loop_res_
      share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_node(
      'reserves',n)) = sum( (ev,h,reserves_do) ,  sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_RP_EV_G2V(scen,n,reserves_do,ev,h)) * p
      hi_reserves_call(n,reserves_do,h)) * %sec_hour% ;
             report_tech('EV positive reserves activation by discharging',loop_r
      es_share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_no
      de('reserves',n)) = sum( (ev,h,reserves_up) , sum(scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_up,ev,h)) *
       phi_reserves_call(n,reserves_up,h)) * %sec_hour% ;
             report_tech('EV negative reserves activation by discharging',loop_r
      es_share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('ev',n) AND feat_no
      de('reserves',n)) = sum( (ev,h,reserves_do) , sum(scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , lev_RP_EV_V2G(scen,n,reserves_do,ev,h)) *
       phi_reserves_call(n,reserves_do,h)) * %sec_hour% ;
       
                       report_reserves_tech_hours('Reserves provision',loop_res_
      share,loop_ev,loop_prosumage,reserves,'ev_cum',h,n)$(report_reserves_tech_
      hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,
      'ev_cum',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech_hours('Reserves activation',loop_res
      _share,loop_ev,loop_prosumage,reserves,'ev_cum',h,n)$(report_reserves_tech
      _hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserve
      s,'ev_cum',h,n) < eps_rep_abs ) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(report_reserves_te
      ch('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_prim,'ev_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_prim,'G2V_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_prim,'V2G_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(report_reserves
      _tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,'ev_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(report_reserve
      s_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,re
      serves_nonprim,'G2V_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve provision shares',loop_res_
      share,loop_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(report_reserve
      s_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,re
      serves_nonprim,'V2G_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,'ev_cum',n)$(report_reserves_t
      ech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,rese
      rves_prim,'ev_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,'G2V_cum',n)$(report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_prim,'G2V_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_prim,'V2G_cum',n)$(report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_prim,'V2G_cum',n) < eps_rep_rel) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'ev_cum',n)$(report_reserve
      s_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,r
      eserves_nonprim,'ev_cum',n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'G2V_cum',n)$(report_reserv
      es_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,
      reserves_nonprim,'G2V_cum',n) < eps_rep_rel ) = 0 ;
                       report_reserves_tech('reserve activation shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'V2G_cum',n)$(report_reserv
      es_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,
      reserves_nonprim,'V2G_cum',n) < eps_rep_rel ) = 0 ;
                       report_tech('EV positive reserves activation by charging'
      ,loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV positi
      ve reserves activation by charging',loop_res_share,loop_ev,loop_prosumage,
      'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV negative reserves activation by charging'
      ,loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV negati
      ve reserves activation by charging',loop_res_share,loop_ev,loop_prosumage,
      'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV positive reserves activation by dischargi
      ng',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV pos
      itive reserves activation by discharging',loop_res_share,loop_ev,loop_pros
      umage,'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
                       report_tech('EV negative reserves activation by dischargi
      ng',loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(report_tech('EV neg
      ative reserves activation by discharging',loop_res_share,loop_ev,loop_pros
      umage,'ev_cum',n) < eps_rep_abs*card(h)*%sec_hour%) = 0 ;
      $ontext
4192   
4193   
4194  * ------------------------------------------------------------------------
      ----
4195   
4196  * PROSUMAGE
4197  *$ontext
4198          report_hours('demand prosumers',loop_res_share,loop_ev,loop_prosum
      age,h,n)$feat_node('prosumage',n) = phi_pro_load(n) * d(n,h) ;
4199          report_hours('demand market',loop_res_share,loop_ev,loop_prosumage
      ,h,n)$feat_node('prosumage',n) = (1 - phi_pro_load(n)) * d(n,h) ;
4200          gross_energy_demand_market(scen,n) = gross_energy_demand(scen,n) -
       gross_energy_demand_prosumers_selfgen(scen,n) ;
4201   
4202          report_prosumage_tech_hours('generation prosumers',loop_res_share,
      loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) = sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , phi_res(n,res,h) * lev_N_RES
      _PRO(scen,n,res) ) ;
4203          report_prosumage_tech_hours('curtailment of fluct res prosumers',l
      oop_res_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) =  
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PRO(sc
      en,n,res,h)) ;
4204          report_prosumage_tech_hours('generation prosumers self-consumption
      ',loop_res_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) 
      = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES_P
      RO(scen,n,res,h) ) ;
4205          report_prosumage_tech_hours('generation prosumers to market',loop_
      res_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) = sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_MARKET_PRO2M
      (scen,n,res,h) ) ;
4206          report_prosumage_tech_hours('withdrawal prosumers from market',loo
      p_res_share,loop_ev,loop_prosumage,'',h,n)$feat_node('prosumage',n) = sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G_MARKET_M2PR
      O(scen,n,h) ) ;
4207          report_prosumage_tech_hours('storage loading prosumers PRO2PRO',lo
      op_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( res , lev
      _STO_IN_PRO2PRO(scen,n,res,sto,h))) ;
4208          report_prosumage_tech_hours('storage loading prosumers PRO2M',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( res , lev_S
      TO_IN_PRO2M(scen,n,res,sto,h))) ;
4209          report_prosumage_tech_hours('storage loading prosumers M2PRO',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN_M2PRO
      (scen,n,sto,h)) ;
4210          report_prosumage_tech_hours('storage loading prosumers M2M',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN_M2M(sce
      n,n,sto,h)) ;
4211          report_prosumage_tech_hours('storage generation prosumers PRO2PRO'
      ,loop_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =
        sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT
      _PRO2PRO(scen,n,sto,h)) ;
4212          report_prosumage_tech_hours('storage generation prosumers PRO2M',l
      oop_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT_P
      RO2M(scen,n,sto,h)) ;
4213          report_prosumage_tech_hours('storage generation prosumers M2PRO',l
      oop_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT_M
      2PRO(scen,n,sto,h)) ;
4214          report_prosumage_tech_hours('storage generation prosumers M2M',loo
      p_res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT_M2M
      (scen,n,sto,h)) ;
4215          report_prosumage_tech_hours('storage level prosumers',loop_res_sha
      re,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_PRO(scen,n,sto
      ,h)) ;
4216          report_prosumage_tech_hours('storage level prosumers PRO2PRO',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum
      (scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_PRO2PR
      O(scen,n,sto,h)) ;
4217          report_prosumage_tech_hours('storage level prosumers PRO2M',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_PRO2M(sc
      en,n,sto,h)) ;
4218          report_prosumage_tech_hours('storage level prosumers M2PRO',loop_r
      es_share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_M2PRO(sc
      en,n,sto,h)) ;
4219          report_prosumage_tech_hours('storage level prosumers M2M',loop_res
      _share,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L_M2M(scen,n
      ,sto,h)) ;
4220   
4221          report_market_tech_hours('generation market',loop_res_share,loop_e
      v,loop_prosumage,con,h,n)$feat_node('prosumage',n) = sum(scen$(map(scen,lo
      op_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,con,h) + corr_fac_d
      is(scen,n,con,h)) ;
4222          report_market_tech_hours('generation market',loop_res_share,loop_e
      v,loop_prosumage,res,h,n)$feat_node('prosumage',n) = sum(scen$(map(scen,lo
      op_res_share,loop_ev,loop_prosumage)) , lev_G_L(scen,n,res,h) + corr_fac_d
      is(scen,n,res,h) + lev_G_RES(scen,n,res,h)) ;
4223          report_market_tech_hours('generation market',loop_res_share,loop_e
      v,loop_prosumage,rsvr,h,n)$feat_node('prosumage',n) = sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) + cor
      r_fac_rsvr(scen,n,rsvr,h)) ;
4224          report_market_tech_hours('curtailment of fluct res market',loop_re
      s_share,loop_ev,loop_prosumage,res,h,n)$feat_node('prosumage',n) =  sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,res,h
      )) ;
4225          report_market_tech_hours('generation storage market',loop_res_shar
      e,loop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_OUT(scen,n,sto,h)
      ) ;
4226          report_market_tech_hours('storage loading market',loop_res_share,l
      oop_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h)) ;
4227          report_market_tech_hours('storage level market',loop_res_share,loo
      p_ev,loop_prosumage,sto,h,n)$feat_node('prosumage',n) =  sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_L(scen,n,sto,h)) ;
4228          report_market_tech_hours('market to prosumer storage M2PRO',loop_r
      es_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_nod
      e('prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( sto , lev_STO_IN_M2PRO(scen,n,sto,h)) ) ;
4229          report_market_tech_hours('market to prosumer storage M2M',loop_res
      _share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node(
      'prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( sto , lev_STO_IN_M2M(scen,n,sto,h)) ) ;
4230          report_market_tech_hours('prosumer storage to market PRO2M',loop_r
      es_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_nod
      e('prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( sto , lev_STO_OUT_PRO2M(scen,n,sto,h)) ) ;
4231          report_market_tech_hours('prosumer storage to market M2M',loop_res
      _share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node(
      'prosumage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( sto , lev_STO_OUT_M2M(scen,n,sto,h)) ) ;
4232          report_market_tech_hours('energy market to prosumer',loop_res_shar
      e,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node('pros
      umage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_G_MARKET_M2PRO(scen,n,h) )   ;
4233          report_market_tech_hours('energy prosumer to market',loop_res_shar
      e,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$feat_node('pros
      umage',n) =  sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      sum( res , lev_G_MARKET_PRO2M(scen,n,res,h)) )  ;
4234   
4235          report_node('gross energy demand market',loop_res_share,loop_ev,lo
      op_prosumage,n)$feat_node('prosumage',n) = sum( scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n)) ;
4236          report_node('gross energy demand prosumers self generation',loop_r
      es_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_pros
      umers_selfgen(scen,n)) ;
4237   
4238          report_prosumage_tech('capacities renewable prosumers',loop_res_sh
      are,loop_ev,loop_prosumage,res,n)$feat_node('prosumage',n) =  sum( scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res
      ) ) ;
4239          report_prosumage_tech('capacities storage MW prosumers',loop_res_s
      hare,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,
      sto)) ;
4240          report_prosumage_tech('capacities storage MWh prosumers',loop_res_
      share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n
      ,sto)) * 1 ;
4241          report_prosumage_tech('Storage in total prosumers PRO2PRO',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, r
      eport_prosumage_tech_hours('storage loading prosumers PRO2PRO',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n)) ;
4242          report_prosumage_tech('Storage in total prosumers PRO2PRO',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, r
      eport_prosumage_tech_hours('storage loading prosumers PRO2PRO',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n));
4243          report_prosumage_tech('Storage in total prosumers PRO2M',loop_res_
      share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, rep
      ort_prosumage_tech_hours('storage loading prosumers PRO2M',loop_res_share,
      loop_ev,loop_prosumage,sto,h,n));
4244          report_prosumage_tech('Storage in total prosumers M2PRO',loop_res_
      share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, rep
      ort_prosumage_tech_hours('storage loading prosumers M2PRO',loop_res_share,
      loop_ev,loop_prosumage,sto,h,n));
4245          report_prosumage_tech('Storage in total prosumers M2M',loop_res_sh
      are,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, repor
      t_prosumage_tech_hours('storage loading prosumers M2M',loop_res_share,loop
      _ev,loop_prosumage,sto,h,n));
4246          report_prosumage_tech('Storage out total prosumers PRO2PRO',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, 
      report_prosumage_tech_hours('storage generation prosumers PRO2PRO',loop_re
      s_share,loop_ev,loop_prosumage,sto,h,n)) ;
4247          report_prosumage_tech('Storage out total prosumers PRO2M',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, re
      port_prosumage_tech_hours('storage generation prosumers PRO2M',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n)) ;
4248          report_prosumage_tech('Storage out total prosumers M2PRO',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum( h, re
      port_prosumage_tech_hours('storage generation prosumers M2PRO',loop_res_sh
      are,loop_ev,loop_prosumage,sto,h,n)) ;
4249          report_prosumage_tech('Storage out total prosumers M2M',loop_res_s
      hare,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( h, rep
      ort_prosumage_tech_hours('storage generation prosumers M2M',loop_res_share
      ,loop_ev,loop_prosumage,sto,h,n)) ;
4250          report_prosumage_tech('Storage out total prosumers',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = report_prosumage
      _tech('Storage out total prosumers PRO2PRO',loop_res_share,loop_ev,loop_pr
      osumage,sto,n) + report_prosumage_tech('Storage out total prosumers PRO2M'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n) + report_prosumage_tech('Sto
      rage out total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,
      n) + report_prosumage_tech('Storage out total prosumers M2M',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) ;
4251          report_prosumage_tech('Generation total prosumers PRO2M',loop_res_
      share,loop_ev,loop_prosumage,'',n)$feat_node('prosumage',n) =  sum( (h,res
      ) , report_prosumage_tech_hours('generation prosumers to market',loop_res_
      share,loop_ev,loop_prosumage,res,h,n)) ;
4252          report_prosumage_tech('Withdrawal total prosumers M2PRO',loop_res_
      share,loop_ev,loop_prosumage,'',n)$feat_node('prosumage',n) =  sum( h , re
      port_prosumage_tech_hours('withdrawal prosumers from market',loop_res_shar
      e,loop_ev,loop_prosumage,'',h,n)) ;
4253          report_prosumage_tech('generation prosumers self-consumption',loop
      _res_share,loop_ev,loop_prosumage,'',n)$feat_node('prosumage',n) =  sum( (
      res,h) , report_prosumage_tech_hours('generation prosumers self-consumptio
      n',loop_res_share,loop_ev,loop_prosumage,res,h,n)) ;
4254          report_prosumage_tech('consumption share prosumers',loop_res_share
      ,loop_ev,loop_prosumage,res,n)$(feat_node('prosumage',n) AND sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , phi_pro_load(n) 
      * d(n,h) )) ) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( h , lev_G_RES_PRO(scen,n,res,h)) ) / sum( scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , sum( h , phi_pro_load(n) * d(n,h) ) );
4255          report_prosumage_tech('consumption share prosumers',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , phi_pro_load(n) 
      * d(n,h) )) ) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( h , lev_STO_OUT_PRO2PRO(scen,n,sto,h) + lev_STO_OUT_M2PRO(scen,n,
      sto,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      sum( h , phi_pro_load(n) * d(n,h) ) );
4256          report_prosumage_tech('consumption share prosumers',loop_res_share
      ,loop_ev,loop_prosumage,'market',n)$sum( scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , sum( h , phi_pro_load(n) * d(n,h) ) ) = sum( scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , lev_G_MARKET_
      M2PRO(scen,n,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , sum( h , phi_pro_load(n) * d(n,h) ) );
4257          report_prosumage_tech('curtailment of fluct res absolute prosumers
      ',loop_res_share,loop_ev,loop_prosumage,res,n)$feat_node('prosumage',n) = 
       sum(h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_C
      U_PRO(scen,n,res,h) )) * 1 ;
4258          report_prosumage_tech('curtailment of fluct res relative prosumers
      ',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('cur
      tailment of fluct res absolute prosumers',loop_res_share,loop_ev,loop_pros
      umage,res,n) AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_N_RES_PRO(scen,n,res)) > eps_rep_abs ) =  sum(h, sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PRO(scen,n,res,h) ))/ s
      um(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h , phi_r
      es(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4259          report_prosumage_tech('average market value storage in PRO2PRO',lo
      op_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage
       in total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) 
      > eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop
      _ev,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_p
      rosumage)) , sum( res , lev_STO_IN_PRO2PRO(scen,n,res,sto,h)))) / report_p
      rosumage_tech('Storage in total prosumers PRO2PRO',loop_res_share,loop_ev,
      loop_prosumage,sto,n) ;
4260          report_prosumage_tech('average market value storage in PRO2M',loop
      _res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage i
      n total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > ep
      s_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,
      loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , sum( res , lev_STO_IN_PRO2M(scen,n,res,sto,h)))) / report_prosuma
      ge_tech('Storage in total prosumers PRO2M',loop_res_share,loop_ev,loop_pro
      sumage,sto,n) ;
4261          report_prosumage_tech('average market value storage in M2PRO',loop
      _res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage i
      n total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) > ep
      s_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,
      loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosu
      mage)) , lev_STO_IN_M2PRO(scen,n,sto,h))) / report_prosumage_tech('Storage
       in total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) ;
4262          report_prosumage_tech('average market value storage in M2M',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage in 
      total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > eps_re
      p_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,loop
      _prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , lev_STO_IN_M2M(scen,n,sto,h))) / report_prosumage_tech('Storage in to
      tal prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) ;
4263          report_prosumage_tech('average market value storage out PRO2PRO',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storag
      e out total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n
      ) > eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,lo
      op_ev,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_STO_OUT_PRO2PRO(scen,n,sto,h))) / report_prosumage_tech
      ('Storage in total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumag
      e,sto,n) ;
4264          report_prosumage_tech('average market value storage out PRO2M',loo
      p_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage 
      out total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > 
      eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_e
      v,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_STO_OUT_PRO2M(scen,n,sto,h))) / report_prosumage_tech('Stor
      age in total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n)
       ;
4265          report_prosumage_tech('average market value storage out M2PRO',loo
      p_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage 
      out total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n) > 
      eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_e
      v,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_STO_OUT_M2PRO(scen,n,sto,h))) / report_prosumage_tech('Stor
      age in total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)
       ;
4266          report_prosumage_tech('average market value storage out M2M',loop_
      res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage ou
      t total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) > eps_
      rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,lo
      op_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_STO_OUT_M2M(scen,n,sto,h))) / report_prosumage_tech('Storage in
       total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n) ;
4267          report_prosumage_tech('average market value generation PRO2M',loop
      _res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Generation
       total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,'',n) > eps_
      rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,lo
      op_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( res , lev_G_MARKET_PRO2M(scen,n,res,h)))) / report_prosumage_t
      ech('Generation total prosumers PRO2M',loop_res_share,loop_ev,loop_prosuma
      ge,'',n) ;
4268          report_prosumage_tech('average market value withdrawal M2PRO',loop
      _res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Withdrawal
       total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,'',n) > eps_
      rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loop_ev,lo
      op_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , lev_G_MARKET_M2PRO(scen,n,h))) / report_prosumage_tech('Withdrawal 
      total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,'',n) ;
4269          report_prosumage_tech('average market value generation PRO2PRO',lo
      op_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('generati
      on prosumers self-consumption',loop_res_share,loop_ev,loop_prosumage,'',n)
       > eps_rep_abs*card(h)) = sum( h , report_hours('price',loop_res_share,loo
      p_ev,loop_prosumage,h,n) * sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , sum( res , lev_G_RES_PRO(scen,n,res,h)))) / report_prosumage
      _tech('generation prosumers self-consumption',loop_res_share,loop_ev,loop_
      prosumage,'',n) ;
4270          report_prosumage_tech('FLH prosumers',loop_res_share,loop_ev,loop_
      prosumage,res,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res) > eps_rep_ins)
      ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_G_MARKET_PRO2M(scen,n,res,h) + sum( sto , lev_STO_IN_PRO2PRO(scen,n,re
      s,sto,h)) + lev_G_RES_PRO(scen,n,res,h) )) / sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res) ) ;
4271   report_prosumage_tech('FLH prosumers',loop_res_share,loop_ev,loop_prosuma
      ge,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto)) > eps_rep_ins) = r
      eport_prosumage_tech('Storage out total prosumers',loop_res_share,loop_ev,
      loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_N_STO_P_PRO(scen,n,sto)) ;
4272   report_prosumage_tech('Storage cycles prosumers',loop_res_share,loop_ev,l
      oop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,loop
      _res_share,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n,sto)) > eps_r
      ep_ins) = report_prosumage_tech('Storage out total prosumers',loop_res_sha
      re,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n,sto)) * 1 ;
4273          report_prosumage_tech('Storage EP-ratio prosumers',loop_res_share,
      loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto)
       ) > eps_rep_ins AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , lev_N_STO_E_PRO(scen,n,sto) ) * 1 > eps_rep_ins ) = sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E_PRO(scen,n,sto)
       ) * 1 / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      N_STO_P_PRO(scen,n,sto) ) ;
4274   
4275          report_market_tech('capacities renewable market',loop_res_share,lo
      op_ev,loop_prosumage,res,n)$feat_node('prosumage',n) =  sum( scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,res) ) ;
4276          report_market_tech('capacities reservoir MW market',loop_res_share
      ,loop_ev,loop_prosumage,rsvr,n)$feat_node('prosumage',n) =  sum( scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr) 
      );
4277          report_market_tech('capacities reservoir MWh market',loop_res_shar
      e,loop_ev,loop_prosumage,rsvr,n)$feat_node('prosumage',n) =  sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_E(scen,n,rsvr)
       );
4278          report_market_tech('capacities storage MW market',loop_res_share,l
      oop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) ;
4279          report_market_tech('capacities storage MWh market',loop_res_share,
      loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) =  sum( scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) * 1
       ;
4280          report_market_tech('curtailment of fluct res absolute market',loop
      _res_share,loop_ev,loop_prosumage,res,n)$feat_node('prosumage',n) =  sum(h
      , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen
      ,n,res,h) )) * 1 ;
4281          report_market_tech('curtailment of fluct res relative market',loop
      _res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech('curtailment 
      of fluct res absolute market',loop_res_share,loop_ev,loop_prosumage,res,n)
       AND sum(h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , l
      ev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) ) + sum(h, sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,res,h)
      )) > card(h)*eps_rep_abs ) =  sum(h, sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , lev_CU(scen,n,res,h) ))/( sum(h,  sum(scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_G_RES(scen,n,res,h) - cor
      r_fac_nondis(scen,n,res,h)) ) + sum(h,sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , lev_CU(scen,n,res,h)  )) ) ;
4282          report_market_tech('capacities conventional market',loop_res_share
      ,loop_ev,loop_prosumage,con,n)$feat_node('prosumage',n) =  sum( scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,con)) ;
4283          report_market_tech('Storage out total market non-reserves',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum(h, re
      port_market_tech_hours('generation storage market',loop_res_share,loop_ev,
      loop_prosumage,sto,h,n) ) * 1 ;
4284          report_market_tech('Storage in total market non-reserves',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$feat_node('prosumage',n) = sum(h, rep
      ort_market_tech_hours('storage loading market',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) ) * 1 ;
4285          report_market_tech('FLH market non-reserves',loop_res_share,loop_e
      v,loop_prosumage,res,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,res)) > eps_rep
      _ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_G_RES(scen,n,res,h) + lev_G_L(scen,n,res,h)- corr_fac_dis(scen,n,r
      es,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_TECH(scen,n,res)) ;
4286          report_market_tech('FLH market non-reserves',loop_res_share,loop_e
      v,loop_prosumage,con,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,con)) > eps_rep
      _ins) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , lev_G_L(scen,n,con,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage)) , lev_N_TECH(scen,n,con)) ;
4287   report_market_tech('FLH market non-reserves',loop_res_share,loop_ev,loop_
      prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) > eps_rep_ins) 
      = report_market_tech('Storage out total market non-reserves',loop_res_shar
      e,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , lev_N_STO_P(scen,n,sto)) ;
4288   report_market_tech('Storage cycles market non-reserves',loop_res_share,lo
      op_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(sc
      en,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) > ep
      s_rep_ins) = report_market_tech('Storage out total market non-reserves',lo
      op_res_share,loop_ev,loop_prosumage,sto,n) / sum(scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto)) * 1 ;
4289          report_market_tech('Storage EP-ratio market',loop_res_share,loop_e
      v,loop_prosumage,sto,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto) ) > eps_r
      ep_ins AND sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , le
      v_N_STO_E(scen,n,sto) ) * 1 > eps_rep_ins ) = sum(scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , lev_N_STO_E(scen,n,sto) ) * 1 / sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto
      ) ) ;
4290   
4291          report_prosumage('gross energy demand prosumers',loop_res_share,lo
      op_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(scen,
      n)) ;
4292          report_prosumage('gross energy demand prosumers from market',loop_
      res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(
      map(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_pro
      sumers_market(scen,n)) ;
4293          report_prosumage('gross energy demand prosumers self generation',l
      oop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand
      _prosumers_selfgen(scen,n)) ;
4294          report_prosumage('self-generation share prosumers total',loop_res_
      share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosu
      mers(scen,n) )) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , gross_energy_demand_prosumers_selfgen(scen,n)) / sum( scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(sc
      en,n) ) ;
4295          report_prosumage('market share prosumers',loop_res_share,loop_ev,l
      oop_prosumage,n)$(feat_node('prosumage',n) AND  sum(scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(scen,n) )
      ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , gross_ene
      rgy_demand_prosumers_market(scen,n)) / sum( scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , gross_energy_demand_prosumers(scen,n) ) ;
4296          report_prosumage('curtailment of fluct res absolute prosumers',loo
      p_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum((res,
      h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU_PR
      O(scen,n,res,h))) * 1 ;
4297          report_prosumage('curtailment of fluct res relative prosumers',loo
      p_res_share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_
      res(n,res,h) * lev_N_RES_PRO(scen,n,res))))  = sum(scen$(map(scen,loop_res
      _share,loop_ev,loop_prosumage)) , sum( (h,res) , lev_CU_PRO(scen,n,res,h) 
      )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (re
      s,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4298          report_prosumage('share self-generation curtailed',loop_res_share,
      loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,res,h)
       * lev_N_RES_PRO(scen,n,res)) )) = sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( (h,res) , lev_CU_PRO(scen,n,res,h) )) / sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_r
      es(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4299          report_prosumage('share self-generation direct consumption',loop_r
      es_share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res
      (n,res,h) * lev_N_RES_PRO(scen,n,res)) )) = sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , sum( (h,res) , lev_G_RES_PRO(scen,n,res,h) 
      )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (re
      s,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4300          report_prosumage('share self-generation to market',loop_res_share,
      loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,res,h)
       * lev_N_RES_PRO(scen,n,res))) ) = sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( (h,res) , lev_G_MARKET_PRO2M(scen,n,res,h) )) /
       sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h)
       , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4301          report_prosumage('share self-generation stored PRO2PRO',loop_res_s
      hare,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,r
      es,h) * lev_N_RES_PRO(scen,n,res))) ) = sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , sum( (h,sto,res) , lev_STO_IN_PRO2PRO(scen,n,re
      s,sto,h) )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) ,
       sum( (res,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4302          report_prosumage('share self-generation stored PRO2M',loop_res_sha
      re,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(map(s
      cen,loop_res_share,loop_ev,loop_prosumage)) , sum( (res,h) , phi_res(n,res
      ,h) * lev_N_RES_PRO(scen,n,res))) ) = sum(scen$(map(scen,loop_res_share,lo
      op_ev,loop_prosumage)) , sum( (h,sto,res) , lev_STO_IN_PRO2M(scen,n,res,st
      o,h) )) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum
      ( (res,h) , phi_res(n,res,h) * lev_N_RES_PRO(scen,n,res)) ) ;
4303          report_prosumage('Capacity total prosumers',loop_res_share,loop_ev
      ,loop_prosumage,n)$feat_node('prosumage',n) = sum( res , sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res)) ) +
       sum( sto , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , l
      ev_N_STO_P_PRO(scen,n,sto)) ) ;
4304   
4305          report_prosumage_tech('Capacity share prosumers',loop_res_share,lo
      op_ev,loop_prosumage,res,n)$report_prosumage('Capacity total prosumers',lo
      op_res_share,loop_ev,loop_prosumage,n) = sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , lev_N_RES_PRO(scen,n,res) ) / report_prosumage
      ('Capacity total prosumers',loop_res_share,loop_ev,loop_prosumage,n) + 1e-
      9 ;
4306          report_prosumage_tech('Capacity share prosumers',loop_res_share,lo
      op_ev,loop_prosumage,sto,n)$report_prosumage('Capacity total prosumers',lo
      op_res_share,loop_ev,loop_prosumage,n) = sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , lev_N_STO_P_PRO(scen,n,sto) ) / report_prosuma
      ge('Capacity total prosumers',loop_res_share,loop_ev,loop_prosumage,n) + 1
      e-9 ;
4307   
4308          report_market('gross energy demand market',loop_res_share,loop_ev,
      loop_prosumage,n)$feat_node('prosumage',n) = sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n)) ;
4309          report_market('curtailment of fluct res absolute market',loop_res_
      share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = sum((res,h), su
      m(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_CU(scen,n,r
      es,h))) * 1 ;
4310          report_market('curtailment of fluct res relative market',loop_res_
      share,loop_ev,loop_prosumage,n)$(feat_node('prosumage',n) AND sum(scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( (h,res) , phi_res(n,
      res,h)*lev_N_TECH(scen,n,res)) ) > eps_rep_abs*card(res)*card(h) ) = sum( 
      (res,h), sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_
      CU(scen,n,res,h)))/ sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( (res,h) , phi_res(n,res,h) * lev_N_TECH(scen,n,res)) ) ;
4311          report_market('Share market energy transferred to prosumer consump
      tion',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = 
      sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_G
      _MARKET_M2PRO(scen,n,h)) ) / sum( scen$(map(scen,loop_res_share,loop_ev,lo
      op_prosumage)) , gross_energy_demand_market(scen,n) ) ;
4312          report_market('Share market energy transferred to prosumer storage
       M2PRO',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) 
      = sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum
      ( sto , lev_STO_IN_M2PRO(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
4313          report_market('Share market energy transferred to prosumer storage
       M2M',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = 
      sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( 
      sto , lev_STO_IN_M2M(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_res_shar
      e,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
4314          report_market('Share market energy tranferred from prosumer genera
      tion',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) = 
      sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( 
      res , lev_G_MARKET_PRO2M(scen,n,res,h))) ) / sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
4315          report_market('Share market energy transferred from prosumer stora
      ge PRO2M',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n
      ) = sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , s
      um( sto , lev_STO_OUT_PRO2M(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
4316          report_market('Share market energy transferred from prosumer stora
      ge M2M',loop_res_share,loop_ev,loop_prosumage,n)$feat_node('prosumage',n) 
      = sum( h, sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum
      ( sto , lev_STO_OUT_M2M(scen,n,sto,h))) ) / sum( scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , gross_energy_demand_market(scen,n) ) ;
4317          report_market('Capacity total market',loop_res_share,loop_ev,loop_
      prosumage,n)$feat_node('prosumage',n) = sum( tech , sum(scen$(map(scen,loo
      p_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,tech))) + sum( st
      o , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_STO
      _P(scen,n,sto) )) + sum( rsvr ,  sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr))) + sum( dsm_curt ,  sum(sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_CU(scen,n,
      dsm_curt))) + sum( dsm_shift ,  sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage)) , lev_N_DSM_SHIFT(scen,n,dsm_shift))) ;
4318          report_market('Energy demand total market',loop_res_share,loop_ev,
      loop_prosumage,n)$feat_node('prosumage',n) = (sum( h , (1 - phi_pro_load(n
      )) * d(n,h) ) + sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_G_MARKET_M2PRO(scen,n,h))) + sum( (sto,h) , sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_STO_IN(scen,n,sto,h) + 
      lev_STO_IN_M2M(scen,n,sto,h) + lev_STO_IN_M2PRO(scen,n,sto,h) ) )) * 1
4319  *$ontext
              + sum( (dsm_shift,h) , sum(scen$(map(scen,loop_res_share,loop_ev,l
      oop_prosumage)) , lev_DSM_UP_DEMAND(scen,n,dsm_shift,h)) ) * %sec_hour%
      $ontext
4324  *$ontext
               + sum( (ev,h) , sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , lev_EV_CHARGE(scen,n,ev,h)) ) * %sec_hour%
      $ontext
4329  *$ontext
               + sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , reserves_activated(scen,n,h)))
      $ontext
4334  *$ontext
4335  ;
4336          report_market('energy generated gross market',loop_res_share,loop_
      ev,loop_prosumage,n)$feat_node('prosumage',n) = sum( h , sum(scen$(map(sce
      n,loop_res_share,loop_ev,loop_prosumage)) , sum( dis ,lev_G_L(scen,n,dis,h
      )) + sum( nondis ,lev_G_RES(scen,n,nondis,h)) + sum( res , lev_G_MARKET_PR
      O2M(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) + sum( rsvr , lev_RSVR_
      OUT(scen,n,rsvr,h)- corr_fac_rsvr(scen,n,rsvr,h)) + sum( sto , lev_STO_OUT
      _M2M(scen,n,sto,h) + lev_STO_OUT(scen,n,sto,h) - corr_fac_sto(scen,n,sto,h
      )) + sum( dsm_shift , lev_DSM_DO_DEMAND(scen,n,dsm_shift,h) - corr_fac_dsm
      _shift(scen,n,dsm_shift,h)) + sum( dsm_curt , lev_DSM_CU(scen,n,dsm_curt,h
      )) + sum( ev , lev_EV_DISCHARGE(scen,n,ev,h)) - corr_fac_ev(scen,n,h) )) ;
4337   
4338          report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,tech,n)$(feat_node('prosumage',n) AND report_market('Capaci
      ty total market',loop_res_share,loop_ev,loop_prosumage,n)) = sum( scen$(ma
      p(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_TECH(scen,n,tech) )
       / report_market('Capacity total market',loop_res_share,loop_ev,loop_prosu
      mage,n) + 1e-9 ;
4339          report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,rsvr,n)$feat_node('prosumage',n) = sum(scen$(map(scen,loop_
      res_share,loop_ev,loop_prosumage)) , lev_N_RSVR_P(scen,n,rsvr) ) / report_
      market('Capacity total market',loop_res_share,loop_ev,loop_prosumage,n) + 
      1e-9 ;
4340          report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,sto,n)$feat_node('prosumage',n) = sum(scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , lev_N_STO_P(scen,n,sto) ) / report_mar
      ket('Capacity total market',loop_res_share,loop_ev,loop_prosumage,n) + 1e-
      9 ;
4341          report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,con,n)$(feat_node('prosumage',n) AN
      D report_market('energy generated gross market',loop_res_share,loop_ev,loo
      p_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_G_L(scen,n,con,h)) ) / report_market('energy generated g
      ross market',loop_res_share,loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
4342          report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,res,n)$(feat_node('prosumage',n) AN
      D report_market('energy generated gross market',loop_res_share,loop_ev,loo
      p_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_G_L(scen,n,res,h) + lev_G_MARKET_PRO2M(scen,n,res,h) + l
      ev_G_RES(scen,n,res,h) - corr_fac_nondis(scen,n,res,h)) ) / report_market(
      'energy generated gross market',loop_res_share,loop_ev,loop_prosumage,n) *
       1 + 1e-9 ;
4343          report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,rsvr,n)$(feat_node('prosumage',n) A
      ND report_market('energy generated gross market',loop_res_share,loop_ev,lo
      op_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop
      _prosumage)) , lev_RSVR_OUT(scen,n,rsvr,h) - corr_fac_rsvr(scen,n,rsvr,h))
       ) / report_market('energy generated gross market',loop_res_share,loop_ev,
      loop_prosumage,n) * 1 + 1e-9 ;
4344          report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(feat_node('prosumage',n) AN
      D report_market('energy generated gross market',loop_res_share,loop_ev,loo
      p_prosumage,n)) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_
      prosumage)) , lev_STO_OUT_M2M(scen,n,sto,h) + lev_STO_OUT(scen,n,sto,h) - 
      corr_fac_sto(scen,n,sto,h)) ) / report_market('energy generated gross mark
      et',loop_res_share,loop_ev,loop_prosumage,n) * 1 + 1e-9 ;
4345   
4346                   report_hours('demand prosumers',loop_res_share,loop_ev,lo
      op_prosumage,h,n)$(report_hours('demand prosumers',loop_res_share,loop_ev,
      loop_prosumage,h,n) < eps_rep_abs) = 0 ;
4347                   report_hours('demand market',loop_res_share,loop_ev,loop_
      prosumage,h,n)$(report_hours('demand market',loop_res_share,loop_ev,loop_p
      rosumage,h,n) < eps_rep_abs) = 0 ;
4348   
4349                   report_prosumage_tech_hours('generation prosumers',loop_r
      es_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumage_tech_hours('gen
      eration prosumers',loop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_re
      p_abs) = 0 ;
4350                   report_prosumage_tech_hours('curtailment of fluct res pro
      sumers',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumage_t
      ech_hours('curtailment of fluct res prosumers',loop_res_share,loop_ev,loop
      _prosumage,res,h,n) < eps_rep_abs) = 0 ;
4351                   report_prosumage_tech_hours('generation prosumers self-co
      nsumption',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumag
      e_tech_hours('generation prosumers self-consumption',loop_res_share,loop_e
      v,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
4352                   report_prosumage_tech_hours('generation prosumers to mark
      et',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_prosumage_tech_
      hours('generation prosumers to market',loop_res_share,loop_ev,loop_prosuma
      ge,res,h,n) < eps_rep_abs) = 0 ;
4353                   report_prosumage_tech_hours('withdrawal prosumers from ma
      rket',loop_res_share,loop_ev,loop_prosumage,'',h,n)$(report_prosumage_tech
      _hours('withdrawal prosumers from market',loop_res_share,loop_ev,loop_pros
      umage,'',h,n) < eps_rep_abs) = 0 ;
4354                   report_prosumage_tech_hours('storage loading prosumers PR
      O2PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_te
      ch_hours('storage loading prosumers PRO2PRO',loop_res_share,loop_ev,loop_p
      rosumage,sto,h,n) < eps_rep_abs) = 0 ;
4355                   report_prosumage_tech_hours('storage loading prosumers PR
      O2M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech
      _hours('storage loading prosumers PRO2M',loop_res_share,loop_ev,loop_prosu
      mage,sto,h,n) < eps_rep_abs) = 0 ;
4356                   report_prosumage_tech_hours('storage loading prosumers M2
      PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech
      _hours('storage loading prosumers M2PRO',loop_res_share,loop_ev,loop_prosu
      mage,sto,h,n) < eps_rep_abs) = 0 ;
4357                   report_prosumage_tech_hours('storage loading prosumers M2
      M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_h
      ours('storage loading prosumers M2M',loop_res_share,loop_ev,loop_prosumage
      ,sto,h,n) < eps_rep_abs) = 0 ;
4358                   report_prosumage_tech_hours('storage generation prosumers
       PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage
      _tech_hours('storage generation prosumers PRO2PRO',loop_res_share,loop_ev,
      loop_prosumage,sto,h,n) < eps_rep_abs) = 0 ;
4359                   report_prosumage_tech_hours('storage generation prosumers
       PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_t
      ech_hours('storage generation prosumers PRO2M',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) < eps_rep_abs) = 0 ;
4360                   report_prosumage_tech_hours('storage generation prosumers
       M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_t
      ech_hours('storage generation prosumers M2PRO',loop_res_share,loop_ev,loop
      _prosumage,sto,h,n) < eps_rep_abs) = 0 ;
4361                   report_prosumage_tech_hours('storage generation prosumers
       M2M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tec
      h_hours('storage generation prosumers M2M',loop_res_share,loop_ev,loop_pro
      sumage,sto,h,n) < eps_rep_abs) = 0 ;
4362                   report_prosumage_tech_hours('storage level prosumers',loo
      p_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_hours('
      storage level prosumers',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < 
      eps_rep_abs) = 0 ;
4363                   report_prosumage_tech_hours('storage level prosumers PRO2
      PRO',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech
      _hours('storage level prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosu
      mage,sto,h,n) < eps_rep_abs) = 0 ;
4364                   report_prosumage_tech_hours('storage level prosumers PRO2
      M',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_h
      ours('storage level prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage
      ,sto,h,n) < eps_rep_abs) = 0 ;
4365                   report_prosumage_tech_hours('storage level prosumers M2PR
      O',loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_h
      ours('storage level prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage
      ,sto,h,n) < eps_rep_abs) = 0 ;
4366                   report_prosumage_tech_hours('storage level prosumers M2M'
      ,loop_res_share,loop_ev,loop_prosumage,sto,h,n)$(report_prosumage_tech_hou
      rs('storage level prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto
      ,h,n) < eps_rep_abs) = 0 ;
4367   
4368                   report_market_tech_hours('generation market',loop_res_sha
      re,loop_ev,loop_prosumage,con,h,n)$(report_market_tech_hours('generation m
      arket',loop_res_share,loop_ev,loop_prosumage,con,h,n) < eps_rep_abs) = 0 ;
4369                   report_market_tech_hours('generation market',loop_res_sha
      re,loop_ev,loop_prosumage,res,h,n)$(report_market_tech_hours('generation m
      arket',loop_res_share,loop_ev,loop_prosumage,res,h,n) < eps_rep_abs) = 0 ;
4370                   report_market_tech_hours('generation market',loop_res_sha
      re,loop_ev,loop_prosumage,rsvr,h,n)$(report_market_tech_hours('generation 
      market',loop_res_share,loop_ev,loop_prosumage,rsvr,h,n) < eps_rep_abs) = 0
       ;
4371                   report_market_tech_hours('curtailment of fluct res market
      ',loop_res_share,loop_ev,loop_prosumage,res,h,n)$(report_market_tech_hours
      ('curtailment of fluct res market',loop_res_share,loop_ev,loop_prosumage,r
      es,h,n) < eps_rep_abs) =  0 ;
4372                   report_market_tech_hours('generation storage market',loop
      _res_share,loop_ev,loop_prosumage,sto,h,n)$(report_market_tech_hours('gene
      ration storage market',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < ep
      s_rep_abs) =  0 ;
4373                   report_market_tech_hours('storage loading market',loop_re
      s_share,loop_ev,loop_prosumage,sto,h,n)$(report_market_tech_hours('storage
       loading market',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < eps_rep_
      abs) = 0 ;
4374                   report_market_tech_hours('storage level market',loop_res_
      share,loop_ev,loop_prosumage,sto,h,n)$(report_market_tech_hours('storage l
      evel market',loop_res_share,loop_ev,loop_prosumage,sto,h,n) < eps_rep_abs)
       = 0 ;
4375                   report_market_tech_hours('market to prosumer storage M2PR
      O',loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)
      $(report_market_tech_hours('market to prosumer storage M2PRO',loop_res_sha
      re,loop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs)
       = 0 ;
4376                   report_market_tech_hours('market to prosumer storage M2M'
      ,loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(
      report_market_tech_hours('market to prosumer storage M2M',loop_res_share,l
      oop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0
       ;
4377                   report_market_tech_hours('prosumer storage to market PRO2
      M',loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)
      $(report_market_tech_hours('prosumer storage to market PRO2M',loop_res_sha
      re,loop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs)
       = 0 ;
4378                   report_market_tech_hours('prosumer storage to market M2M'
      ,loop_res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(
      report_market_tech_hours('prosumer storage to market M2M',loop_res_share,l
      oop_ev,loop_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0
       ;
4379                   report_market_tech_hours('energy market to prosumer',loop
      _res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(repor
      t_market_tech_hours('energy market to prosumer',loop_res_share,loop_ev,loo
      p_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0 ;
4380                   report_market_tech_hours('energy prosumer to market',loop
      _res_share,loop_ev,loop_prosumage,'Interaction with prosumers',h,n)$(repor
      t_market_tech_hours('energy prosumer to market',loop_res_share,loop_ev,loo
      p_prosumage,'Interaction with prosumers',h,n) < eps_rep_abs) = 0 ;
4381   
4382                   report_prosumage_tech('capacities renewable prosumers',lo
      op_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('capacit
      ies renewable prosumers',loop_res_share,loop_ev,loop_prosumage,res,n) < ep
      s_rep_ins) =  0 ;
4383                   report_prosumage_tech('capacities storage MW prosumers',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('capaci
      ties storage MW prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < 
      eps_rep_ins) =  0 ;
4384                   report_prosumage_tech('capacities storage MWh prosumers',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('capac
      ities storage MWh prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) 
      < eps_rep_ins) =  0 ;
4385                   report_prosumage_tech('consumption share prosumers',loop_
      res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('consumptio
      n share prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_
      rel) = 0 ;
4386                   report_prosumage_tech('consumption share prosumers',loop_
      res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('consumptio
      n share prosumers',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_
      rel) = 0 ;
4387                   report_prosumage_tech('consumption share prosumers',loop_
      res_share,loop_ev,loop_prosumage,'market',n)$(report_prosumage_tech('consu
      mption share prosumers',loop_res_share,loop_ev,loop_prosumage,'market',n) 
      < eps_rep_rel) = 0 ;
4388                   report_prosumage_tech('curtailment of fluct res absolute 
      prosumers',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_
      tech('curtailment of fluct res absolute prosumers',loop_res_share,loop_ev,
      loop_prosumage,res,n) < eps_rep_ins) = 0 ;
4389                   report_prosumage_tech('curtailment of fluct res relative 
      prosumers',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_prosumage_
      tech('curtailment of fluct res relative prosumers',loop_res_share,loop_ev,
      loop_prosumage,res,n) < eps_rep_rel) = 0 ;
4390                   report_prosumage_tech('Storage in total prosumers PRO2PRO
      ',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Sto
      rage in total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,sto
      ,n)< eps_rep_abs*card(h)) = 0 ;
4391                   report_prosumage_tech('Storage in total prosumers PRO2M',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stora
      ge in total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n)<
       eps_rep_abs*card(h)) = 0 ;
4392                   report_prosumage_tech('Storage in total prosumers M2PRO',
      loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stora
      ge in total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)<
       eps_rep_abs*card(h)) = 0 ;
4393                   report_prosumage_tech('Storage in total prosumers M2M',lo
      op_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage
       in total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n)< eps
      _rep_abs*card(h)) = 0 ;
4394                   report_prosumage_tech('Storage out total prosumers PRO2PR
      O',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('St
      orage out total prosumers PRO2PRO',loop_res_share,loop_ev,loop_prosumage,s
      to,n)< eps_rep_abs*card(h)) = 0 ;
4395                   report_prosumage_tech('Storage out total prosumers PRO2M'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stor
      age out total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,sto,n
      )< eps_rep_abs*card(h)) = 0 ;
4396                   report_prosumage_tech('Storage out total prosumers M2PRO'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Stor
      age out total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n
      )< eps_rep_abs*card(h)) = 0 ;
4397                   report_prosumage_tech('Storage out total prosumers M2M',l
      oop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storag
      e out total prosumers M2M',loop_res_share,loop_ev,loop_prosumage,sto,n)< e
      ps_rep_abs*card(h)) = 0 ;
4398                   report_prosumage_tech('Storage out total prosumers',loop_
      res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage ou
      t total prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n)< eps_rep_a
      bs*card(h)) = 0 ;
4399                   report_prosumage_tech('Generation total prosumers PRO2M',
      loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Genera
      tion total prosumers PRO2M',loop_res_share,loop_ev,loop_prosumage,'',n) < 
      eps_rep_abs*card(h)) = 0 ;
4400                   report_prosumage_tech('Withdrawal total prosumers M2PRO',
      loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('Withdr
      awal total prosumers M2PRO',loop_res_share,loop_ev,loop_prosumage,'',n) < 
      eps_rep_abs*card(h)) = 0 ;
4401                   report_prosumage_tech('generation prosumers self-consumpt
      ion',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('g
      eneration prosumers self-consumption',loop_res_share,loop_ev,loop_prosumag
      e,'',n) < eps_rep_abs * card(h)) = 0 ;
4402                   report_prosumage_tech('average market value storage in PR
      O2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech
      ('average market value storage in PRO2PRO',loop_res_share,loop_ev,loop_pro
      sumage,sto,n) < eps_rep_abs) = 0 ;
4403                   report_prosumage_tech('average market value storage in PR
      O2M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('
      average market value storage in PRO2M',loop_res_share,loop_ev,loop_prosuma
      ge,sto,n) < eps_rep_abs) = 0 ;
4404                   report_prosumage_tech('average market value storage in M2
      PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('
      average market value storage in M2PRO',loop_res_share,loop_ev,loop_prosuma
      ge,sto,n) < eps_rep_abs) = 0 ;
4405                   report_prosumage_tech('average market value storage in M2
      M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('av
      erage market value storage in M2M',loop_res_share,loop_ev,loop_prosumage,s
      to,n) < eps_rep_abs) = 0 ;
4406                   report_prosumage_tech('average market value storage out P
      RO2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tec
      h('average market value storage out PRO2PRO',loop_res_share,loop_ev,loop_p
      rosumage,sto,n) < eps_rep_abs) = 0 ;
4407                   report_prosumage_tech('average market value storage out P
      RO2M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech(
      'average market value storage out PRO2M',loop_res_share,loop_ev,loop_prosu
      mage,sto,n) < eps_rep_abs) = 0 ;
4408                   report_prosumage_tech('average market value storage out M
      2PRO',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech(
      'average market value storage out M2PRO',loop_res_share,loop_ev,loop_prosu
      mage,sto,n) < eps_rep_abs) = 0 ;
4409                   report_prosumage_tech('average market value storage out M
      2M',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('a
      verage market value storage out M2M',loop_res_share,loop_ev,loop_prosumage
      ,sto,n) < eps_rep_abs) = 0 ;
4410                   report_prosumage_tech('average market value generation PR
      O2M',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('a
      verage market value generation PRO2M',loop_res_share,loop_ev,loop_prosumag
      e,'',n) < eps_rep_abs) = 0 ;
4411                   report_prosumage_tech('average market value withdrawal M2
      PRO',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech('a
      verage market value withdrawal M2PRO',loop_res_share,loop_ev,loop_prosumag
      e,'',n) < eps_rep_abs) = 0 ;
4412                   report_prosumage_tech('average market value generation PR
      O2PRO',loop_res_share,loop_ev,loop_prosumage,'',n)$(report_prosumage_tech(
      'average market value generation PRO2PRO',loop_res_share,loop_ev,loop_pros
      umage,'',n) < eps_rep_abs) = 0 ;
4413                   report_prosumage_tech('Capacity share prosumers',loop_res
      _share,loop_ev,loop_prosumage,res,n)$(report_prosumage_tech('Capacity shar
      e prosumers',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_rel) =
       0 ;
4414                   report_prosumage_tech('Capacity share prosumers',loop_res
      _share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Capacity shar
      e prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_rel) =
       0 ;
4415                   report_prosumage_tech('FLH prosumers',loop_res_share,loop
      _ev,loop_prosumage,res,n)$(report_prosumage_tech('FLH prosumers',loop_res_
      share,loop_ev,loop_prosumage,res,n) < eps_rep_abs) = 0 ;
4416         report_prosumage_tech('Storage cycles prosumers',loop_res_share,loo
      p_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage cycles prosumer
      s',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs) = 0 ;
4417         report_prosumage_tech('FLH',loop_res_share,loop_ev,loop_prosumage,s
      to,n)$(report_prosumage_tech('FLH',loop_res_share,loop_ev,loop_prosumage,s
      to,n) < eps_rep_abs) = 0 ;
4418                   report_prosumage_tech('Storage EP-ratio prosumers',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_prosumage_tech('Storage EP-
      ratio prosumers',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_re
      l) = 0 ;
4419   
4420                   report_market_tech('capacities renewable market',loop_res
      _share,loop_ev,loop_prosumage,res,n)$(report_market_tech('capacities renew
      able market',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_abs) =
        0 ;
4421                   report_market_tech('capacities reservoir MW market',loop_
      res_share,loop_ev,loop_prosumage,rsvr,n)$(report_market_tech('capacities r
      eservoir MW market',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_re
      p_ins) = 0 ;
4422                   report_market_tech('capacities reservoir MWh market',loop
      _res_share,loop_ev,loop_prosumage,rsvr,n)$(report_market_tech('capacities 
      reservoir MWh market',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_
      rep_ins) = 0 ;
4423                   report_market_tech('capacities storage MW market',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities stor
      age MW market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs)
       =  0 ;
4424                   report_market_tech('capacities storage MWh market',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities sto
      rage MWh market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_ab
      s) =  0 ;
4425                   report_market_tech('curtailment of fluct res absolute mar
      ket',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech('cur
      tailment of fluct res absolute market',loop_res_share,loop_ev,loop_prosuma
      ge,res,n) < eps_rep_abs*card(h)) = 0 ;
4426                   report_market_tech('curtailment of fluct res relative mar
      ket',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech('cur
      tailment of fluct res relative market',loop_res_share,loop_ev,loop_prosuma
      ge,res,n) < eps_rep_rel) = 0 ;
4427                   report_market_tech('capacities conventional market',loop_
      res_share,loop_ev,loop_prosumage,con,n)$(report_market_tech('capacities co
      nventional market',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_
      ins) = 0 ;
4428                   report_market_tech('capacities renewable market',loop_res
      _share,loop_ev,loop_prosumage,res,n)$(report_market_tech('capacities renew
      able market',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_ins) =
       0 ;
4429                   report_market_tech('capacities storage MW market',loop_re
      s_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities stor
      age MW market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_ins)
       =  0 ;
4430                   report_market_tech('capacities storage MWh market',loop_r
      es_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('capacities sto
      rage MWh market',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_in
      s) = 0 ;
4431                   report_market_tech('Storage out total market non-reserves
      ',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storag
      e out total market non-reserves',loop_res_share,loop_ev,loop_prosumage,sto
      ,n) < eps_rep_abs*card(h)) = 0 ;
4432                   report_market_tech('Storage in total market non-reserves'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storage
       in total market non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n
      ) < eps_rep_abs*card(h)) = 0 ;
4433                   report_market_tech('FLH market non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,res,n)$(report_market_tech('FLH market non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,res,n) < eps_rep_abs) = 0 ;
4434                   report_market_tech('FLH market non-reserves',loop_res_sha
      re,loop_ev,loop_prosumage,con,n)$(report_market_tech('FLH market non-reser
      ves',loop_res_share,loop_ev,loop_prosumage,con,n) < eps_rep_abs) = 0 ;
4435         report_market_tech('FLH market non-reserves',loop_res_share,loop_ev
      ,loop_prosumage,sto,n)$(report_market_tech('FLH market non-reserves',loop_
      res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_abs) = 0 ;
4436         report_market_tech('Storage cycles market non-reserves',loop_res_sh
      are,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storage cycles mark
      et non-reserves',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_ab
      s) = 0 ;
4437                   report_market_tech('Storage EP-ratio market',loop_res_sha
      re,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Storage EP-ratio mar
      ket',loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_rel) = 0 ;
4438   
4439                   report_prosumage('gross energy demand prosumers',loop_res
      _share,loop_ev,loop_prosumage,n)$(report_prosumage('gross energy demand pr
      osumers',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_ins) = 0 ;
4440                   report_prosumage('gross energy demand prosumers from mark
      et',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('gross ener
      gy demand prosumers from market',loop_res_share,loop_ev,loop_prosumage,n) 
      < eps_rep_ins) = 0 ;
4441                   report_prosumage('gross energy demand prosumers self gene
      ration',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('gross 
      energy demand prosumers self generation',loop_res_share,loop_ev,loop_prosu
      mage,n) < eps_rep_ins) = 0 ;
4442                   report_prosumage('self-generation share prosumage total',
      loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('self-generatio
      n share prosumage total',loop_res_share,loop_ev,loop_prosumage,n) < eps_re
      p_rel) = 0 ;
4443                   report_prosumage('market share prosumage',loop_res_share,
      loop_ev,loop_prosumage,n)$(report_prosumage('market share prosumage',loop_
      res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4444                   report_prosumage('curtailment of fluct res absolute prosu
      mers',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('curtailm
      ent of fluct res absolute prosumers',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_ins) = 0 ;
4445                   report_prosumage('curtailment of fluct res relative prosu
      mers',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('curtailm
      ent of fluct res relative prosumers',loop_res_share,loop_ev,loop_prosumage
      ,n) < eps_rep_rel) = 0 ;
4446                   report_prosumage('share self-generation curtailed',loop_r
      es_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-generatio
      n curtailed',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4447                   report_prosumage('share self-generation direct consumptio
      n',loop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-
      generation direct consumption',loop_res_share,loop_ev,loop_prosumage,n) < 
      eps_rep_rel) = 0 ;
4448                   report_prosumage('share self-generation to market',loop_r
      es_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-generatio
      n to market',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4449                   report_prosumage('share self-generation stored PRO2PRO',l
      oop_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-gene
      ration stored PRO2PRO',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_
      rel) = 0 ;
4450                   report_prosumage('share self-generation stored PRO2M',loo
      p_res_share,loop_ev,loop_prosumage,n)$(report_prosumage('share self-genera
      tion stored PRO2M',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_rel)
       = 0 ;
4451                   report_prosumage('Capacity total prosumers',loop_res_shar
      e,loop_ev,loop_prosumage,n)$(report_prosumage('Capacity total prosumers',l
      oop_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
4452   
4453                   report_market('gross energy demand market',loop_res_share
      ,loop_ev,loop_prosumage,n)$(report_market('gross energy demand market',loo
      p_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
4454                   report_market('curtailment of fluct res absolute market',
      loop_res_share,loop_ev,loop_prosumage,n)$(report_market('curtailment of fl
      uct res absolute market',loop_res_share,loop_ev,loop_prosumage,n) < eps_re
      p_abs) = 0 ;
4455                   report_market('curtailment of fluct res relative market',
      loop_res_share,loop_ev,loop_prosumage,n)$(report_market('curtailment of fl
      uct res relative market',loop_res_share,loop_ev,loop_prosumage,n) < eps_re
      p_rel) = 0 ;
4456                   report_market('Share market energy transferred to prosume
      r consumption',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('Sh
      are market energy transferred to prosumer consumption',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4457                   report_market('Share market energy transferred to prosume
      r storage M2PRO',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('
      Share market energy transferred to prosumer storage M2PRO',loop_res_share,
      loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4458                   report_market('Share market energy transferred to prosume
      r storage M2M',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('Sh
      are market energy transferred to prosumer storage M2M',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4459                   report_market('Share market energy tranferred from prosum
      er generation',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('Sh
      are market energy tranferred from prosumer generation',loop_res_share,loop
      _ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4460                   report_market('Share market energy transferred from prosu
      mer storage PRO2M',loop_res_share,loop_ev,loop_prosumage,n)$(report_market
      ('Share market energy transferred from prosumer storage PRO2M',loop_res_sh
      are,loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4461                   report_market('Share market energy transferred from prosu
      mer storage M2M',loop_res_share,loop_ev,loop_prosumage,n)$(report_market('
      Share market energy transferred from prosumer storage M2M',loop_res_share,
      loop_ev,loop_prosumage,n) < eps_rep_rel) = 0 ;
4462                   report_market('Capacity total market',loop_res_share,loop
      _ev,loop_prosumage,n)$(report_market('Capacity total market',loop_res_shar
      e,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
4463                   report_market('Energy demand total market',loop_res_share
      ,loop_ev,loop_prosumage,n)$(report_market('Energy demand total market',loo
      p_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
4464                   report_market('energy generated gross market',loop_res_sh
      are,loop_ev,loop_prosumage,n)$(report_market('energy generated gross marke
      t',loop_res_share,loop_ev,loop_prosumage,n) < eps_rep_abs) = 0 ;
4465   
4466                   report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,tech,n)$(report_market_tech('Capacity share market
      ',loop_res_share,loop_ev,loop_prosumage,tech,n) < eps_rep_rel) = 0 ;
4467                   report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,sto,n)$(report_market_tech('Capacity share market'
      ,loop_res_share,loop_ev,loop_prosumage,sto,n) < eps_rep_rel) = 0 ;
4468                   report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,rsvr,n)$(report_market_tech('Capacity share market
      ',loop_res_share,loop_ev,loop_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
4469                   report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,con,n)$(report_market_tech
      ('Energy share in gross nodal market generation',loop_res_share,loop_ev,lo
      op_prosumage,con,n) < eps_rep_rel) = 0 ;
4470                   report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,res,n)$(report_market_tech
      ('Energy share in gross nodal market generation',loop_res_share,loop_ev,lo
      op_prosumage,res,n) < eps_rep_rel) = 0 ;
4471                   report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,sto,n)$(report_market_tech
      ('Energy share in gross nodal market generation',loop_res_share,loop_ev,lo
      op_prosumage,sto,n) < eps_rep_rel) = 0 ;
4472                   report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,rsvr,n)$(report_market_tec
      h('Energy share in gross nodal market generation',loop_res_share,loop_ev,l
      oop_prosumage,rsvr,n) < eps_rep_rel) = 0 ;
4475   
4476   
4477  * ------------------------------------------------------------------------
      ----
4478   
4479  * PROSUMAGE & DSM
4480  *$ontext
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,dsm_curt,n)$(feat_node('prosumage',n) AND feat_node('dsm',n
      ) AND report_market('Capacity total market',loop_res_share,loop_ev,loop_pr
      osumage,n)) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) 
      , lev_N_DSM_CU(scen,n,dsm_curt) ) / report_market('Capacity total market',
      loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_market_tech('Capacity share market',loop_res_share,loop_ev,
      loop_prosumage,dsm_shift,n)$(feat_node('prosumage',n) AND feat_node('dsm',
      n) AND report_market('Capacity total market',loop_res_share,loop_ev,loop_p
      rosumage,n)) = sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , lev_N_DSM_SHIFT(scen,n,dsm_shift) ) / report_market('Capacity total mar
      ket',loop_res_share,loop_ev,loop_prosumage,n) + 1e-9 ;
              report_market_tech('capacities load curtailment',loop_res_share,lo
      op_ev,loop_prosumage,dsm_curt,n)$(feat_node('prosumage',n) AND feat_node('
      dsm',n)) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , 
      lev_N_DSM_CU(scen,n,dsm_curt) );
              report_market_tech('capacities load shift',loop_res_share,loop_ev,
      loop_prosumage,dsm_shift,n)$(feat_node('prosumage',n) AND feat_node('dsm',
      n)) =  sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N
      _DSM_SHIFT(scen,n,dsm_shift) );
              report_market_tech('FLH market',loop_res_share,loop_ev,loop_prosum
      age,dsm_curt,n)$(feat_node('prosumage',n) AND feat_node('dsm',n) AND sum(s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_CU(scen,
      n,dsm_curt)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,dsm_curt,h) - corr_fac_dsm_cu(
      scen,n,dsm_curt,h)) ) / sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , lev_N_DSM_CU(scen,n,dsm_curt)) ;
              report_market_tech('FLH market',loop_res_share,loop_ev,loop_prosum
      age,dsm_shift,n)$(feat_node('prosumage',n) AND feat_node('dsm',n) AND sum(
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_SHIFT(s
      cen,n,dsm_shift)) > eps_rep_ins) = sum( h , sum(scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND(scen,n,dsm_shift,h)) ) / 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , lev_N_DSM_SHI
      FT(scen,n,dsm_shift)) ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,dsm_curt,n)$(feat_node('prosumage',
      n) AND feat_node('dsm',n) AND report_market('energy generated gross market
      ',loop_res_share,loop_ev,loop_prosumage,n)) = sum( h , sum(scen$(map(scen,
      loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_CU(scen,n,dsm_curt,h) - 
      corr_fac_dsm_cu(scen,n,dsm_curt,h)) ) / report_market('energy generated gr
      oss market',loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,dsm_shift,n)$(feat_node('prosumage'
      ,n) AND feat_node('dsm',n) AND report_market('energy generated gross marke
      t',loop_res_share,loop_ev,loop_prosumage,n)) = sum( h , sum(scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , lev_DSM_DO_DEMAND(scen,n,dsm_sh
      ift,h) - corr_fac_dsm_shift(scen,n,dsm_shift,h)) ) / report_market('energy
       generated gross market',loop_res_share,loop_ev,loop_prosumage,n) * %sec_h
      our% + 1e-9 ;
       
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,dsm_curt,n)$(report_market_tech('Capacity share ma
      rket',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n) < eps_rep_rel) = 0
       ;
                       report_market_tech('Capacity share market',loop_res_share
      ,loop_ev,loop_prosumage,dsm_shift,n)$(report_market_tech('Capacity share m
      arket',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_rel) =
       0 ;
                       report_market_tech('capacities load curtailment',loop_res
      _share,loop_ev,loop_prosumage,dsm_curt,n)$(report_market_tech('capacities 
      load curtailment',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n) < eps_
      rep_ins) = 0 ;
                       report_market_tech('capacities load shift',loop_res_share
      ,loop_ev,loop_prosumage,dsm_shift,n)$(report_market_tech('capacities load 
      shift',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_ins) =
       0 ;
                       report_market_tech('FLH market',loop_res_share,loop_ev,lo
      op_prosumage,dsm_curt,n)$(report_market_tech('FLH market',loop_res_share,l
      oop_ev,loop_prosumage,dsm_curt,n) < eps_rep_abs) = 0 ;
                       report_market_tech('FLH market',loop_res_share,loop_ev,lo
      op_prosumage,dsm_shift,n)$(report_market_tech('FLH market',loop_res_share,
      loop_ev,loop_prosumage,dsm_shift,n) < eps_rep_abs) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,dsm_curt,n)$(report_market
      _tech('Energy share in gross nodal market generation',loop_res_share,loop_
      ev,loop_prosumage,dsm_curt,n) < eps_rep_rel) = 0 ;
                       report_market_tech('Energy share in gross nodal market ge
      neration',loop_res_share,loop_ev,loop_prosumage,dsm_shift,n)$(report_marke
      t_tech('Energy share in gross nodal market generation',loop_res_share,loop
      _ev,loop_prosumage,dsm_shift,n) < eps_rep_rel) = 0 ;
      $ontext
4501   
4502   
4503  * ------------------------------------------------------------------------
      ----
4504   
4505  * PROSUMAGE & EV
4506  *$ontext
              report_market_tech('Energy share in gross nodal market generation'
      ,loop_res_share,loop_ev,loop_prosumage,'ev_cum',n)$(feat_node('prosumage',
      n) AND feat_node('ev',n) AND report_market('energy generated gross market'
      ,loop_res_share,loop_ev,loop_prosumage,n)) = (sum( (h,ev) , sum(scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , lev_EV_DISCHARGE(scen,n,ev,
      h))) - sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , sum( h
       , corr_fac_ev(scen,n,h))))/ report_market('energy generated gross market'
      ,loop_res_share,loop_ev,loop_prosumage,n) * %sec_hour% + 1e-9 ;
      $ontext
4511   
4512   
4513  * ------------------------------------------------------------------------
      ----
4514   
4515  * HEAT
               report_heat_tech_hours('heat demand - heating',loop_res_share,loo
      p_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = dh(n,bu,ch,h) ;
               report_heat_tech_hours('heat supply direct electric heating',loop
      _res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch) 
      * lev_H_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('heat supply SETS',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_r
      es_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * (lev_H_SETS_OUT(
      scen,n,bu,ch,h) + (1-eta_heat_stat(n,bu,ch)) * lev_H_SETS_LEV(scen,n,bu,ch
      ,h-1)) ) ;
               report_heat_tech_hours('heat supply storage heating',loop_res_sha
      re,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(
      scen,loop_res_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * le
      v_H_STO_OUT(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand direct electric',loop_
      res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch) *
       lev_H_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand SETS',loop_res_share,l
      oop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen
      ,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * (lev_H_SE
      TS_IN(scen,n,bu,ch,h) + corr_fac_sets(scen,n,bu,ch,h)) ) ;
               report_heat_tech_hours('electricity demand HP',loop_res_share,loo
      p_ev,loop_prosumage,n,bu,hp,h)$feat_node('heat',n) = sum( scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , theta_hp(n,bu,hp) * ( lev_H_HP_IN
      (scen,n,bu,hp,h) + corr_fac_hp(scen,n,bu,hp,h)) ) ;
               report_heat_tech_hours('electricity demand hybrid heating',loop_r
      es_share,loop_ev,loop_prosumage,n,bu,hel,h)$feat_node('heat',n) = sum( sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_elec(n,bu,hel)
       * (lev_H_ELECTRIC_IN(scen,n,bu,hel,h) + corr_fac_h_elec(scen,n,bu,hel,h))
       ) ;
               report_heat_tech_hours('fossil fuel demand hybrid heating',loop_r
      es_share,loop_ev,loop_prosumage,n,bu,hfo,h)$feat_node('heat',n) = sum( sce
      n$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_fossil(n,bu,hf
      o) * lev_H_STO_IN_FOSSIL(scen,n,bu,hfo,h) ) ;
               report_heat_tech_hours('SETS inflow',loop_res_share,loop_ev,loop_
      prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_sh
      are,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n,
      bu,ch,h) ) ;
               report_heat_tech_hours('SETS level',loop_res_share,loop_ev,loop_p
      rosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_sha
      re,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * lev_H_SETS_LEV(scen,n,
      bu,ch,h) ) ;
               report_heat_tech_hours('SETS outflow',loop_res_share,loop_ev,loop
      _prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_s
      hare,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * (lev_H_SETS_OUT(scen
      ,n,bu,ch,h) + (1-eta_heat_stat(n,bu,ch)) * lev_H_SETS_LEV(scen,n,bu,ch,h-1
      ) ) ) ;
               report_heat_tech_hours('Storage inflow',loop_res_share,loop_ev,lo
      op_prosumage,n,bu,hst,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , theta_hp(n,bu,hst) * lev_H_STO_IN_HP(sc
      en,n,bu,hst,h) + theta_elec(n,bu,hst) * lev_H_STO_IN_ELECTRIC(scen,n,bu,hs
      t,h) + theta_elec(n,bu,hst) * lev_H_STO_IN_FOSSIL(scen,n,bu,hst,h) ) ;
               report_heat_tech_hours('Storage level',loop_res_share,loop_ev,loo
      p_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_
      share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * lev_H_STO_LEV(sc
      en,n,bu,ch,h) ) ;
               report_heat_tech_hours('Storage outflow',loop_res_share,loop_ev,l
      oop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map(scen,loop_re
      s_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * lev_H_STO_OUT(
      scen,n,bu,ch,h) ) ;
       
               report_heat_tech_hours('heat demand - DHW',loop_res_share,loop_ev
      ,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = d_dhw(n,bu,ch,h) ;
               report_heat_tech_hours('DHW supply - direct electric',loop_res_sh
      are,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch) * lev_H
      _DHW_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('DHW supply - SETS aux electric',loop_res_
      share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(m
      ap(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,ch) * le
      v_H_DHW_AUX_OUT(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('DHW supply - storage heating',loop_res_sh
      are,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum( scen$(map
      (scen,loop_res_share,loop_ev,loop_prosumage)) , theta_storage(n,bu,ch) * l
      ev_H_DHW_STO_OUT(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand DHW - direct electric'
      ,loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = su
      m( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu
      ,ch) * lev_H_DHW_DIR(scen,n,bu,ch,h) ) ;
               report_heat_tech_hours('electricity demand DHW - SETS aux electri
      c',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = 
      sum( scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n
      ,bu,ch) * (lev_H_DHW_AUX_ELEC_IN(scen,n,bu,ch,h) + corr_fac_sets_aux(scen,
      n,bu,ch,h)) ) ;
               report_heat_tech_hours('DHW - SETS aux hot water storage level',l
      oop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$feat_node('heat',n) = sum(
       scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_sets(n,bu,
      ch) * lev_H_DHW_AUX_LEV(scen,n,bu,ch,h) ) ;
       
               report_heat_tech_hours('price heat electricity consumption',loop_
      res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(feat_node('heat',n) AND sum( 
      scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch
      ) * lev_H_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * lev_H_SETS_IN(scen,n
      ,bu,ch,h) + theta_storage(n,bu,ch) * lev_H_HP_IN(scen,n,bu,ch,h) + theta_s
      torage(n,bu,ch) * lev_H_ELECTRIC_IN(scen,n,bu,ch,h)) > 0.25 ) = sum( scen$
      (map(scen,loop_res_share,loop_ev,loop_prosumage)) , - marginal_con1a(scen,
      n,h)) ;
               report_heat_tech_hours('price DHW electricity consumption',loop_r
      es_share,loop_ev,loop_prosumage,n,bu,ch,h)$(feat_node('heat',n) AND sum( s
      cen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_dir(n,bu,ch)
       * lev_H_DHW_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * lev_H_DHW_AUX_ELE
      C_IN(scen,n,bu,ch,h)) > 0.25 ) = sum( scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , - marginal_con1a(scen,n,h)) ;
       
                       report_heat_tech_hours('heat demand - heating',loop_res_s
      hare,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat deman
      d - heating',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_ab
      s) = 0 ;
                       report_heat_tech_hours('heat supply direct electric heati
      ng',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hou
      rs('heat supply direct electric heating',loop_res_share,loop_ev,loop_prosu
      mage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('heat supply SETS',loop_res_share,
      loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat supply SET
      S',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('heat supply storage heating',loop
      _res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat
       supply storage heating',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) 
      < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand direct electri
      c',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hour
      s('electricity demand direct electric',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand SETS',loop_res
      _share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('electric
      ity demand SETS',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_re
      p_abs) = 0 ;
                       report_heat_tech_hours('electricity demand HP',loop_res_s
      hare,loop_ev,loop_prosumage,n,bu,hp,h)$(report_heat_tech_hours('electricit
      y demand HP',loop_res_share,loop_ev,loop_prosumage,n,bu,hp,h) < eps_rep_ab
      s) = 0 ;
                       report_heat_tech_hours('electricity demand hybrid heating
      ',loop_res_share,loop_ev,loop_prosumage,n,bu,hel,h)$(report_heat_tech_hour
      s('electricity demand hybrid heating',loop_res_share,loop_ev,loop_prosumag
      e,n,bu,hel,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('fossil fuel demand hybrid heating
      ',loop_res_share,loop_ev,loop_prosumage,n,bu,hfo,h)$(report_heat_tech_hour
      s('fossil fuel demand hybrid heating',loop_res_share,loop_ev,loop_prosumag
      e,n,bu,hfo,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('SETS inflow',loop_res_share,loop_
      ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('SETS inflow',loop_re
      s_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('SETS level',loop_res_share,loop_e
      v,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('SETS level',loop_res_
      share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('SETS outflow',loop_res_share,loop
      _ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('SETS outflow',loop_
      res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('Storage inflow',loop_res_share,lo
      op_ev,loop_prosumage,n,bu,hst,h)$(report_heat_tech_hours('Storage inflow',
      loop_res_share,loop_ev,loop_prosumage,n,bu,hst,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('Storage level',loop_res_share,loo
      p_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('Storage level',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('Storage outflow',loop_res_share,l
      oop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('Storage outflow'
      ,loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
       
                       report_heat_tech_hours('heat demand - DHW',loop_res_share
      ,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('heat demand - 
      DHW',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW supply - direct electric',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('DHW
       supply - direct electric',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h
      ) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW supply - SETS aux electric',l
      oop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('D
      HW supply - SETS aux electric',loop_res_share,loop_ev,loop_prosumage,n,bu,
      ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW supply - storage heating',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hours('DHW
       supply - storage heating',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h
      ) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand DHW - direct e
      lectric',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tec
      h_hours('electricity demand DHW - direct electric',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('electricity demand DHW - SETS aux
       electric',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_t
      ech_hours('electricity demand DHW - SETS aux electric',loop_res_share,loop
      _ev,loop_prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('DHW - SETS aux hot water storage 
      level',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_
      hours('DHW - SETS aux hot water storage level',loop_res_share,loop_ev,loop
      _prosumage,n,bu,ch,h) < eps_rep_abs) = 0 ;
       
                       report_heat_tech_hours('price heat electricity consumptio
      n',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$(report_heat_tech_hour
      s('price heat electricity consumption',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,ch,h) < eps_rep_abs) = 0 ;
                       report_heat_tech_hours('price DHW electricity consumption
      ',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h)$( report_heat_tech_hour
      s('price DHW electricity consumption',loop_res_share,loop_ev,loop_prosumag
      e,n,bu,ch,h)< eps_rep_abs) = 0 ;
       
       
               report_heat_tech('heat supply',loop_res_share,loop_ev,loop_prosum
      age,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( h , theta_dir(n,bu,ch) * lev_H_DIR(scen,n,bu,c
      h,h) + theta_sets(n,bu,ch) * (lev_H_SETS_OUT(scen,n,bu,ch,h) + (1-eta_heat
      _stat(n,bu,ch)) * lev_H_SETS_LEV(scen,n,bu,ch,h-1)) + theta_storage(n,bu,c
      h) * lev_H_STO_OUT(scen,n,bu,ch,h) )) ;
               report_heat_tech('DHW supply',loop_res_share,loop_ev,loop_prosuma
      ge,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( h , theta_dir(n,bu,ch) * lev_H_DHW_DIR(scen,n,b
      u,ch,h) + theta_sets(n,bu,ch) * lev_H_DHW_AUX_OUT(scen,n,bu,ch,h) + theta_
      storage(n,bu,ch) * lev_H_DHW_STO_OUT(scen,n,bu,ch,h) )) ;
               report_heat_tech('total costs',loop_res_share,loop_ev,loop_prosum
      age,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( h , report_heat_tech_hours('price heat electri
      city consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) * ( the
      ta_dir(n,bu,ch) * lev_H_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H
      _SETS_IN(scen,n,bu,ch,h) + corr_fac_sets(scen,n,bu,ch,h)) + theta_hp(n,bu,
      ch) * ( lev_H_HP_IN(scen,n,bu,ch,h) + corr_fac_hp(scen,n,bu,ch,h)) + theta
      _elec(n,bu,ch) * lev_H_ELECTRIC_IN(scen,n,bu,ch,h) + corr_fac_h_elec(scen,
      n,bu,ch,h)) + report_heat_tech_hours('price DHW electricity consumption',l
      oop_res_share,loop_ev,loop_prosumage,n,bu,ch,h) * (theta_dir(n,bu,ch) * le
      v_H_DHW_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H_DHW_AUX_ELEC_IN
      (scen,n,bu,ch,h) + corr_fac_sets_aux(scen,n,bu,ch,h))) )) ;
               report_heat_tech('total electricity consumption',loop_res_share,l
      oop_ev,loop_prosumage,n,bu,ch)$feat_node('heat',n) = sum( scen$(map(scen,l
      oop_res_share,loop_ev,loop_prosumage)) , sum( h , theta_dir(n,bu,ch) * lev
      _H_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H_SETS_IN(scen,n,bu,ch
      ,h) + corr_fac_sets(scen,n,bu,ch,h)) + theta_hp(n,bu,ch) * ( lev_H_HP_IN(s
      cen,n,bu,ch,h) + corr_fac_hp(scen,n,bu,ch,h)) + theta_elec(n,bu,ch) * lev_
      H_ELECTRIC_IN(scen,n,bu,ch,h) + corr_fac_h_elec(scen,n,bu,ch,h) + theta_di
      r(n,bu,ch) * lev_H_DHW_DIR(scen,n,bu,ch,h) + theta_sets(n,bu,ch) * (lev_H_
      DHW_AUX_ELEC_IN(scen,n,bu,ch,h) + corr_fac_sets_aux(scen,n,bu,ch,h)) )) ;
               report_heat_tech('average price heat electricity consumption',loo
      p_res_share,loop_ev,loop_prosumage,n,bu,ch)$(feat_node('heat',n) AND repor
      t_heat_tech('total electricity consumption',loop_res_share,loop_ev,loop_pr
      osumage,n,bu,ch)) = report_heat_tech('total costs',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch) / report_heat_tech('total electricity consumption'
      ,loop_res_share,loop_ev,loop_prosumage,n,bu,ch) ;
               report_heat_tech('average price heat electricity consumption over
       all bu',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch)$(feat_n
      ode('heat',n) AND report_heat_tech('total electricity consumption',loop_re
      s_share,loop_ev,loop_prosumage,n,'bu1',ch)) = sum( bu, report_heat_tech('a
      verage price heat electricity consumption',loop_res_share,loop_ev,loop_pro
      sumage,n,bu,ch) * report_heat_tech('total electricity consumption',loop_re
      s_share,loop_ev,loop_prosumage,n,bu,ch) ) / sum( bu, report_heat_tech('tot
      al electricity consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,ch)
       ) ;
               report_heat_tech('Storage cycles (inflow)',loop_res_share,loop_ev
      ,loop_prosumage,n,bu,ch)$(feat_node('heat',n) AND n_heat_e(n,bu,ch)) = sum
      ( h , sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)) , theta_s
      ets(n,bu,ch) * (lev_H_SETS_IN(scen,n,bu,ch,h) + corr_fac_sets(scen,n,bu,ch
      ,h)) + theta_hp(n,bu,ch) * ( lev_H_HP_IN(scen,n,bu,ch,h) + corr_fac_hp(sce
      n,n,bu,ch,h))) )/n_heat_e(n,bu,ch);
       
                       report_heat_tech('heat supply',loop_res_share,loop_ev,loo
      p_prosumage,n,bu,ch)$(report_heat_tech('heat supply',loop_res_share,loop_e
      v,loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('DHW supply',loop_res_share,loop_ev,loop
      _prosumage,n,bu,ch)$(report_heat_tech('DHW supply',loop_res_share,loop_ev,
      loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('total costs',loop_res_share,loop_ev,loo
      p_prosumage,n,bu,ch)$(report_heat_tech('total costs',loop_res_share,loop_e
      v,loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('total electricity consumption',loop_res
      _share,loop_ev,loop_prosumage,n,bu,ch)$(report_heat_tech('total electricit
      y consumption',loop_res_share,loop_ev,loop_prosumage,n,bu,ch) < eps_rep_ab
      s) = 0 ;
                       report_heat_tech('average price heat electricity consumpt
      ion',loop_res_share,loop_ev,loop_prosumage,n,bu,ch)$(report_heat_tech('ave
      rage price heat electricity consumption',loop_res_share,loop_ev,loop_prosu
      mage,n,bu,ch) < eps_rep_abs) = 0 ;
                       report_heat_tech('average price heat electricity consumpt
      ion over all bu',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch)
      $(report_heat_tech('average price heat electricity consumption over all bu
      ',loop_res_share,loop_ev,loop_prosumage,n,'over all bu',ch) < eps_rep_abs)
       = 0 ;
                       report_heat_tech('Storage cycles (inflow)',loop_res_share
      ,loop_ev,loop_prosumage,n,bu,ch)$(report_heat_tech('Storage cycles (inflow
      )',loop_res_share,loop_ev,loop_prosumage,n,bu,ch) < eps_rep_abs) = 0 ;
      $ontext
4589   
4590   
4591  * ------------------------------------------------------------------------
      ----
4592   
4593   
4594  * Reserves and heat
      %reserves_endogenous%$ontext
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND fe
      at_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(sc
      en,n,reserves_nonprim,bu,'setsh',h)))) / ( (card(h)-1) * 1000 * phi_reserv
      es_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) + s
      um(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(scen
      $(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,n
      ondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND f
      eat_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loo
      p_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(s
      cen,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserves_nonpri
      m,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * phi_rese
      rves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonprim) +
       sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * sum(sc
      en$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(scen,n
      ,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
      *        report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,n
      ,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hst
      ,h) )))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) *
       (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope
      (n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sce
      n,n,nondisnondis)))/1000) ))  ;
      *        report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND fea
      t_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,
      n,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hs
      t,h)  ))*phi_reserves_call(n,reserves_nonprim,h))) / sum( h , phi_reserves
      _call(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim
      ) * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_sl
      ope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(
      scen,n,nondisnondis)))/1000) ))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat_
      node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(sce
      n,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst,
      h))))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) * (
      reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope(n
      ,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(scen,
      n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(sc
      en,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst
      ,h))))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_ca
      ll(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim) *
       (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope
      (n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sce
      n,n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) AN
      D feat_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SET
      S_AUX(scen,n,reserves_nonprim,bu,'setsh',h)))) / ( (card(h)-1) * 1000 * ph
      i_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_nonp
      rim) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) * 
      sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TECH(
      scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) A
      ND feat_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share
      ,loop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SE
      TS_AUX(scen,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserve
      s_nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * 1000 * 
      phi_reserves_share(n,reserves_nonprim) * (reserves_intercept(n,reserves_no
      nprim) + sum(nondisnondis,reserves_slope(n,reserves_nonprim,nondisnondis) 
      * sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))  , (lev_N_TEC
      H(scen,n,nondisnondis)+lev_N_RES_PRO(scen,n,nondisnondis)))/1000) )))  ;
      $ontext
      %reserves_exogenous%$ontext
      *** ### Noch nicht vollständig
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND fe
      at_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(sce
      n,n,reserves_nonprim,bu,'setsh',h)))) / sum( h$(ord(h) > 1), reserves_exog
      enous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets',n)$(feat_node('heat',n) AND f
      eat_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(sc
      en,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserves_nonprim
      ,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves_exogeno
      us(n,reserves_nonprim,h) )  ;
      *        report_reserves_tech('reserve provision shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_e
      v,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,n
      ,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hst
      ,h) )))) / ( (card(h)-1) * 1000 * phi_reserves_share(n,reserves_nonprim) *
       (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_slope
      (n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,loop
      _ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(sce
      n,n,nondisnondis)))/1000) ))  ;
      *        report_reserves_tech('reserve activation shares',loop_res_share,l
      oop_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND fea
      t_node('reserves',n) ) = (sum( h , sum(scen$(map(scen,loop_res_share,loop_
      ev,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_HP(scen,
      n,reserves_nonprim,bu,hst,h) + lev_RP_H_ELEC(scen,n,reserves_nonprim,bu,hs
      t,h)  ))*phi_reserves_call(n,reserves_nonprim,h))) / sum( h , phi_reserves
      _call(n,reserves_nonprim,h) * 1000 * phi_reserves_share(n,reserves_nonprim
      ) * (reserves_intercept(n,reserves_nonprim) + sum(nondisnondis,reserves_sl
      ope(n,reserves_nonprim,nondisnondis) * sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage))  , (lev_N_TECH(scen,n,nondisnondis)+lev_N_RES_PRO(
      scen,n,nondisnondis)))/1000) ))  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat_
      node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev,
      loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(scen
      ,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst,h
      ))))) / sum( h$(ord(h) > 1), reserves_exogenous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,hst,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,loop_ev
      ,loop_prosumage)) , sum( bu , theta_storage(n,bu,hst) * (lev_RP_H_ELEC(sce
      n,n,reserves_nonprim,bu,hst,h) + lev_RP_HP(scen,n,reserves_nonprim,bu,hst,
      h))))*phi_reserves_call(n,reserves_nonprim,h)) / sum( h , phi_reserves_cal
      l(n,reserves_nonprim,h) * reserves_exogenous(n,reserves_nonprim,h) )  ;
              report_reserves_tech('reserve provision shares',loop_res_share,loo
      p_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) AN
      D feat_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,l
      oop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS
      _AUX(scen,n,reserves_nonprim,bu,'setsh',h)))) / sum( h$(ord(h) > 1), reser
      ves_exogenous(n,reserves_nonprim,h)) ;
              report_reserves_tech('reserve activation shares',loop_res_share,lo
      op_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$(feat_node('heat',n) A
      ND feat_node('reserves',n) ) = sum( h , sum(scen$(map(scen,loop_res_share,
      loop_ev,loop_prosumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SET
      S_AUX(scen,n,reserves_nonprim,bu,'setsh',h)))*phi_reserves_call(n,reserves
      _nonprim,h)) / sum( h , phi_reserves_call(n,reserves_nonprim,h) * reserves
      _exogenous(n,reserves_nonprim,h) )  ;
      $ontext
4620   
      %reserves%$ontext
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,'sets aux',h,n)$(feat_node('heat',n) AND feat
      _node('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pro
      sumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS_AUX(scen,n,res
      erves,bu,'setsh',h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'sets aux',h,n)$(feat_node('heat',n) AND fea
      t_node('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_pr
      osumage)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS_AUX(scen,n,re
      serves,bu,'setsh',h)))*phi_reserves_call(n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,'sets',h,n)$(feat_node('heat',n) AND feat_nod
      e('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosuma
      ge)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(scen,n,reserves,bu
      ,'setsh',h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,'sets',h,n)$(feat_node('heat',n) AND feat_no
      de('reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosum
      age)) , sum( bu , theta_sets(n,bu,'setsh') * lev_RP_SETS(scen,n,reserves,b
      u,'setsh',h)))*phi_reserves_call(n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,hp,h,n)$(feat_node('heat',n) AND feat_node('r
      eserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage))
       , sum( bu , theta_hp(n,bu,hp) * lev_RP_HP(scen,n,reserves,bu,hp,h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,hp,h,n)$(feat_node('heat',n) AND feat_node('
      reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( bu , theta_hp(n,bu,hp) * lev_RP_HP(scen,n,reserves,bu,hp,h)))*phi
      _reserves_call(n,reserves,h)  ;
              report_reserves_tech_hours('Reserves provision',loop_res_share,loo
      p_ev,loop_prosumage,reserves,hel,h,n)$(feat_node('heat',n) AND feat_node('
      reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage)
      ) , sum( bu , theta_storage(n,bu,hel) * lev_RP_H_ELEC(scen,n,reserves,bu,h
      el,h)))  ;
              report_reserves_tech_hours('Reserves activation',loop_res_share,lo
      op_ev,loop_prosumage,reserves,hel,h,n)$(feat_node('heat',n) AND feat_node(
      'reserves',n) ) = sum(scen$(map(scen,loop_res_share,loop_ev,loop_prosumage
      )) , sum( bu , theta_storage(n,bu,hel) * lev_RP_H_ELEC(scen,n,reserves,bu,
      hel,h)))*phi_reserves_call(n,reserves,h)  ;
       
                        report_reserves_tech('reserve provision shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'sets',n)$( report_reserves
      _tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,'sets',n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve activation shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,'sets',n)$( report_reserve
      s_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,r
      eserves_nonprim,'sets',n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve provision shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,hst,n)$( report_reserves_te
      ch('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reserv
      es_nonprim,hst,n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve activation shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,hst,n)$( report_reserves_t
      ech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,rese
      rves_nonprim,hst,n) < eps_rep_rel) = 0 ;
      *                  report_reserves_tech('reserve provision shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,hel,n)$( report_reserves_t
      ech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage,reser
      ves_nonprim,hel,n) < eps_rep_rel) = 0 ;
      *                  report_reserves_tech('reserve activation shares',loop_r
      es_share,loop_ev,loop_prosumage,reserves_nonprim,hel,n)$( report_reserves_
      tech('reserve activation shares',loop_res_share,loop_ev,loop_prosumage,res
      erves_nonprim,hel,n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve provision shares',loop_res
      _share,loop_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$( report_rese
      rves_tech('reserve provision shares',loop_res_share,loop_ev,loop_prosumage
      ,reserves_nonprim,'sets aux',n) < eps_rep_rel) = 0 ;
                        report_reserves_tech('reserve activation shares',loop_re
      s_share,loop_ev,loop_prosumage,reserves_nonprim,'sets aux',n)$( report_res
      erves_tech('reserve activation shares',loop_res_share,loop_ev,loop_prosuma
      ge,reserves_nonprim,'sets aux',n) < eps_rep_rel) = 0 ;
       
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,'sets aux',h,n)$(report_reserves_te
      ch_hours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserv
      es,'sets aux',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,'sets aux',h,n)$(report_reserves_t
      ech_hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,rese
      rves,'sets aux',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,'sets',h,n)$(report_reserves_tech_h
      ours('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,'
      sets',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,'sets',h,n)$( report_reserves_tech
      _hours('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserve
      s,'sets',h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,hp,h,n)$( report_reserves_tech_hour
      s('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,hp,h
      ,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,hp,h,n)$( report_reserves_tech_hou
      rs('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,hp
      ,h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves provision',loop_res
      _share,loop_ev,loop_prosumage,reserves,hel,h,n)$( report_reserves_tech_hou
      rs('Reserves provision',loop_res_share,loop_ev,loop_prosumage,reserves,hel
      ,h,n) < eps_rep_abs) = 0 ;
                        report_reserves_tech_hours('Reserves activation',loop_re
      s_share,loop_ev,loop_prosumage,reserves,hel,h,n)$( report_reserves_tech_ho
      urs('Reserves activation',loop_res_share,loop_ev,loop_prosumage,reserves,h
      el,h,n) < eps_rep_abs) = 0 ;
      $ontext
4651   
4652   
4653  * ------------------------------------------------------------------------
      ---- *
4654  * ------------------------------------------------------------------------
      ---- *
4655  * ------------------------------------------------------------------------
      ---- *
4656   
4657   
4658  execute_unload "results", report, report_tech, report_node, report_line, r
      eport_tech_hours, report_hours, report_cost
4659  *$ontext
4660  , report_prosumage, report_prosumage_tech, report_prosumage_tech_hours, re
      port_market, report_market_tech, report_market_tech_hours
      , report_heat_tech_hours, report_heat_tech
      $ontext
      , report_reserves, report_reserves_tech, report_reserves_tech_hours
      $ontext
      , report_reserves_tech, report_reserves_tech_hours, report_reserves_hours
      $ontext
4675  ;
4676   
      $include report_to_excel.gms
      $ontext
4681   
4682   
4683   
4684  * ------------------------------------------------------------------------
      ---- *
4685  * ------------------------------------------------------------------------
      ---- *
4686  * ------------------------------------------------------------------------
      ---- *
GAMS 24.2.3  r46072 Released May 22, 2014 WEX-WEI x86_64/MS Windows 12/01/18 12:34:17 Page 2
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Include File Summary


   SEQ   GLOBAL TYPE      PARENT   LOCAL  FILENAME

     1        1 INPUT          0       0  C:\Users\cguenther\Documents\GitHub\pr
                                          osumage\Code\Prosumage_Opt\Dieter_Modu
                                          le\Original\DIETER.gms
     2      165 INCLUDE        1     165  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\dataload.gms
     3      570 GDXIN          2     405  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\Data_input.gdx
     4      622 GDXIN          2     457  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\time_series.gdx
     5     1095 INCLUDE        1     308  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\model.gms
     6     2628 INCLUDE        1     487  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\fix.gms
     7     2958 INCLUDE        1     488  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\scenario.gms
     8     3244 INCLUDE        1     652  .C:\Users\cguenther\Documents\GitHub\p
                                           rosumage\Code\Prosumage_Opt\Dieter_Mo
                                           dule\Original\report.gms


COMPILATION TIME     =        0.094 SECONDS     25 MB  24.2.3 r46072 WEX-WEI
GAMS 24.2.3  r46072 Released May 22, 2014 WEX-WEI x86_64/MS Windows 12/01/18 12:34:17 Page 3
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Model Statistics    SOLVE DIETER Using LP From line 3240


MODEL STATISTICS

BLOCKS OF EQUATIONS          50     SINGLE EQUATIONS      350,430
BLOCKS OF VARIABLES          25     SINGLE VARIABLES      429,260  5 projected
NON ZERO ELEMENTS     1,586,616     NON LINEAR N-Z         96,362
DERIVATIVE POOL              10     CONSTANT POOL              18
CODE LENGTH             131,408


GENERATION TIME      =       44.522 SECONDS    334 MB  24.2.3 r46072 WEX-WEI


EXECUTION TIME       =       45.255 SECONDS    334 MB  24.2.3 r46072 WEX-WEI
GAMS 24.2.3  r46072 Released May 22, 2014 WEX-WEI x86_64/MS Windows 12/01/18 12:34:17 Page 4
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Solution Report     SOLVE DIETER Using LP From line 3240


               S O L V E      S U M M A R Y

     MODEL   DIETER              OBJECTIVE  Z
     TYPE    LP                  DIRECTION  MINIMIZE
     SOLVER  CPLEX               FROM LINE  3240

**** SOLVER STATUS     1 Normal Completion         
**** MODEL STATUS      14 No Solution Returned     
**** OBJECTIVE VALUE                0.0000

 RESOURCE USAGE, LIMIT         87.735  10000000.000
 ITERATION COUNT, LIMIT         0    2000000000

GUSS             24.2.3 r46072 Released May 22, 2014 WEI x86_64/MS Windows    
Reading parameter(s) from scenario dictionary
>>  Logoption 2
>>  Optfile 1
>>  Skipbasecase 1
--- Scenario Variable with potential updates identified: phi_min_res
--- Scenario Variable with potential updates identified: phi_pro_self

IBM ILOG CPLEX   24.2.3 r46072 Released May 22, 2014 WEI x86_64/MS Windows    
--- GAMS/Cplex licensed for continuous and discrete problems.
Cplex 12.6.0.0

Reading parameter(s) from "C:\Users\cguenther\Documents\GitHub\prosumage\Code\Pr
                                   osumage_Opt\Dieter_Module\Original\cplex.opt"
>>  lpmethod 4
>>  threads 4
>>  epgap 1e-3
Finished reading from "C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosum
                                       age_Opt\Dieter_Module\Original\cplex.opt"
Space for names approximately 26.31 Mb
Use option 'names no' to turn use of names off
LP status(1): optimal
Cplex Time: 25.71sec (det. 22501.88 ticks)
Optimal solution found.
Objective : 36495692189.775856

--- Scenario scen1:     Records read:    2
--- Solution statistics for scenario scen1
---   Solver Status    1 Normal Completion         
---   Model Status     1 Optimal                   
---   Objective Value  36495692189.7759
---   Resource Usage   26270
---   Total Time (ms)  26380

IBM ILOG CPLEX   24.2.3 r46072 Released May 22, 2014 WEI x86_64/MS Windows    
--- GAMS/Cplex licensed for continuous and discrete problems.
Cplex 12.6.0.0

Reading parameter(s) from "C:\Users\cguenther\Documents\GitHub\prosumage\Code\Pr
                                   osumage_Opt\Dieter_Module\Original\cplex.opt"
>>  lpmethod 4
>>  threads 4
>>  epgap 1e-3
Finished reading from "C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosum
                                       age_Opt\Dieter_Module\Original\cplex.opt"
Space for names approximately 26.31 Mb
Use option 'names no' to turn use of names off
LP status(1): optimal
Cplex Time: 61.03sec (det. 80465.96 ticks)
Optimal solution found.
Objective : 40418350835.296867

--- Scenario scen2:     Records read:    2
--- Solution statistics for scenario scen2
---   Solver Status    1 Normal Completion         
---   Model Status     1 Optimal                   
---   Objective Value  40418350835.2969
---   Resource Usage   61527
---   Total Time (ms)  61621

No solution returned
GAMS 24.2.3  r46072 Released May 22, 2014 WEX-WEI x86_64/MS Windows 12/01/18 12:34:17 Page 5
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
E x e c u t i o n


EXECUTION TIME       =        2.433 SECONDS    258 MB  24.2.3 r46072 WEX-WEI


USER: Medium MUD - 10 User License                   S180308:0349AO-GEN
      Deutsches Institut fuer Wirtschaftsforschung DIW, AbteilungDC3975
      License for teaching and research at degree granting institutions


**** FILE SUMMARY

Input      C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\DIETER.gms
Output     C:\Users\cguenther\Documents\GitHub\prosumage\Code\Prosumage_Opt\Diet
           er_Module\Original\DIETER.lst
